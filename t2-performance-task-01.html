<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">T2 Performance Task 01</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Input Styles */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .table-input {
            width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;
            text-align: right; font-size: 0.85rem; background-color: #fff;
        }
        .text-input {
            width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 0.85rem; background-color: #fff;
        }
        .header-bg { background-color: #0f172a; color: white; }
        .footer-bg { background-color: #334155; color: white; }
        
        /* Journal Specifics */
        .journal-indent-credit { text-indent: 2rem; } /* Approx 5 spaces */
        .journal-indent-expl { padding-left: 3rem; font-style: italic; font-size: 0.8em; color: #555; } /* Approx 8 spaces */

        /* Task 1 Split Layout */
        .task1-panels {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            height: 75vh; /* Fixed height for internal scrolling */
        }
        @media (min-width: 1024px) {
            .task1-panels { grid-template-columns: 45% 55%; }
        }

        .journal-panel, .ledger-panel {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #fff;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Sticky PCTB */
        .sticky-pctb {
            position: sticky;
            top: 0;
            background-color: #f0f9ff;
            border-bottom: 2px solid #3b82f6;
            z-index: 20;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Validation Icons */
        .validation-icon {
            display: inline-block; margin-left: 4px; font-weight: bold;
        }

        /* Print Styles */
        @media print {
            @page { margin: 0.5in; size: auto; }
            body { background-color: white; color: black; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .printable-area { box-shadow: none !important; border: none !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; }
            
            .task1-panels { display: block; height: auto; }
            .journal-panel, .ledger-panel { border: none; overflow: visible; height: auto; margin-bottom: 20px; }
            .sticky-pctb { position: static; border: 1px solid #000; background-color: #fff; }
            
            /* Inputs become text */
            input, select { border: none !important; background: transparent !important; padding: 0 !important; }
            input[type="checkbox"] { appearance: auto; }
            
            /* Explanations Section */
            #wrong-answers-section { display: block !important; margin-top: 20px; page-break-before: always; }
            .explanation-item { border-bottom: 1px solid #ccc; padding: 5px 0; font-size: 0.8rem; }
            
            #print-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 10px; }
        }
    </style>
</head>
<body class="p-2 md:p-6">

    <!-- Timer & Header -->
    <div id="timer-box" class="no-print bg-red-800 text-white p-2 rounded-lg shadow mb-4 text-center font-mono font-bold sticky top-0 z-50">
        Time Remaining: <span id="countdown">--:--:--</span>
    </div>

    <div id="app" class="max-w-7xl mx-auto printable-area bg-white shadow-xl rounded-xl p-4 md:p-8 relative">
        
        <!-- Header -->
        <header id="main-header" class="text-center mb-6 pb-4 border-b-4 border-indigo-600 header-bg rounded-t-lg p-4">
            <h1 class="text-2xl md:text-3xl font-extrabold text-yellow-300">T2 Performance Task 01</h1>
            <h2 id="company-name" class="text-xl font-semibold text-gray-200 mt-1">[Company Name]</h2>
            <div id="student-print-info" class="hidden print:block mt-4 text-left text-black text-sm font-mono border p-2 bg-white"></div>
        </header>

        <!-- Dynamic Content -->
        <div id="task-container"></div>

        <!-- Action Area -->
        <div id="action-area" class="mt-6 pt-4 border-t border-gray-300 no-print flex flex-col md:flex-row justify-between items-center gap-4">
            <div id="message-box" class="text-lg font-medium text-gray-700"></div>
            <button id="main-action-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow disabled:opacity-50 transition">
                Login to Start
            </button>
        </div>

        <!-- Screen Footer -->
        <footer class="mt-8 pt-4 border-t-2 border-indigo-100 text-center text-xs text-gray-400 no-print">
            System Version 2025.11.29 | Rounds to nearest Peso
        </footer>

        <!-- Print Footer -->
        <div id="print-footer" class="hidden">
            <div class="flex justify-between w-full px-4">
                <span>FABM 1</span>
                <span>Page <span class="page-number"></span></span>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
            authDomain: "jlvcpa-quizzes.firebaseapp.com",
            projectId: "jlvcpa-quizzes",
            storageBucket: "jlvcpa-quizzes.appspot.com",
            messagingSenderId: "629158256557",
            appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- State Management ---
        const state = {
            step: 0, // 0:Login, 1:Task1, 2:Task2, 3:Preview
            attendanceId: null,
            studentInfo: null,
            
            // Data
            chartOfAccounts: [],
            journalEntries: [], // Generated entries
            pctb: [], // Generated Post Closing Trial Balance items
            
            // User Inputs
            journalPR: {}, // { entryId: boolean }
            ledgers: [], // Array of ledger objects
            trialBalanceInputs: {}, // { accountName: amount, side: 'dr'|'cr' }
            
            // Scoring
            task1Scores: { A:0, B:0, C:0, totalA:0, totalB:0, totalC:0, grades:{A:'',B:'',C:''} },
            task2Score: { score:0, total:0, grade:'' },
            wrongAnswers: [], // { location: string, input: string, correct: string, reason: string }
            
            isTask1Locked: false,
            isTask2Locked: false
        };

        // --- Constants ---
        const ACCOUNTS = {
            ASSETS: ['Cash', 'Accounts Receivable', 'Supplies', 'Prepaid Rent', 'Equipment', 'Accumulated Depreciation'],
            LIAB: ['Accounts Payable', 'Accrued Expenses Payable', 'Unearned Service Revenue', 'Salaries Payable'],
            EQUITY: ['Capital', 'Withdrawals', 'Income Summary'],
            REV: ['Service Revenue'],
            EXP: ['Salaries Expense', 'Rent Expense', 'Utilities Expense', 'Supplies Expense', 'Miscellaneous Expense']
        };

        // --- Utilities ---
        const formatMoney = (num) => Math.round(num).toLocaleString('en-US'); // No centavos
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const getEl = (id) => document.getElementById(id);

        // --- Generators ---
        function generateData() {
            const familyName = state.studentInfo.fullName.split(',')[0].trim();
            const capitalAcc = `${familyName}.Capital`;
            const withdrawalsAcc = `${familyName}.Withdrawals`;

            // 1. Generate PCTB (Beginning Balances)
            state.pctb = [
                { name: 'Cash', type: 'Dr', amount: rand(100000, 200000) },
                { name: 'Accounts Receivable', type: 'Dr', amount: rand(20000, 50000) },
                { name: 'Supplies', type: 'Dr', amount: rand(5000, 15000) },
                { name: 'Equipment', type: 'Dr', amount: rand(50000, 100000) },
                { name: 'Accumulated Depreciation', type: 'Cr', amount: rand(5000, 20000) },
                { name: 'Accounts Payable', type: 'Cr', amount: rand(10000, 30000) },
                { name: 'Accrued Expenses Payable', type: 'Cr', amount: rand(2000, 8000) },
                { name: 'Unearned Service Revenue', type: 'Cr', amount: rand(5000, 15000) },
            ];
            
            // Calculate Capital to balance
            const totalDr = state.pctb.reduce((sum, a) => a.type === 'Dr' ? sum + a.amount : sum, 0);
            const totalCr = state.pctb.reduce((sum, a) => a.type === 'Cr' ? sum + a.amount : sum, 0);
            state.pctb.push({ name: capitalAcc, type: 'Cr', amount: totalDr - totalCr });

            // 2. Generate 15 Journal Entries
            const entries = [];
            const transactions = [
                { text: "Rendered services for cash", dr: 'Cash', cr: 'Service Revenue' },
                { text: "Rendered services on account", dr: 'Accounts Receivable', cr: 'Service Revenue' },
                { text: "Purchased supplies for cash", dr: 'Supplies', cr: 'Cash' },
                { text: "Paid accounts payable", dr: 'Accounts Payable', cr: 'Cash' },
                { text: "Collected accounts receivable", dr: 'Cash', cr: 'Accounts Receivable' },
                { text: "Paid salaries", dr: 'Salaries Expense', cr: 'Cash' },
                { text: "Paid rent for the year", dr: 'Prepaid Rent', cr: 'Cash' },
                { text: "Owner withdrew cash", dr: withdrawalsAcc, cr: 'Cash' },
                { text: "Paid utilities", dr: 'Utilities Expense', cr: 'Cash' },
                { text: "Paid miscellaneous expenses", dr: 'Miscellaneous Expense', cr: 'Cash' }
            ];

            let dateCounter = 1;
            for(let i=0; i<15; i++) {
                const trans = transactions[rand(0, transactions.length - 1)];
                dateCounter += rand(1, 2);
                if(dateCounter > 30) dateCounter = 30;
                const amt = rand(1000, 20000);
                
                // Specific logic for realistic amounts
                let finalAmt = amt;
                if(trans.text.includes("Rent")) finalAmt = rand(12000, 24000); // 12 month rent
                
                entries.push({
                    id: `je_${i}`,
                    day: dateCounter,
                    drAccount: trans.dr,
                    crAccount: trans.cr,
                    amount: finalAmt,
                    explanation: trans.text
                });
            }
            state.journalEntries = entries;

            // 3. Initialize Default Ledgers (5 empty)
            for(let i=0; i<5; i++) addLedger();
        }

        // --- Logic: Task 1 (Journal & Ledger) ---
        
        function addLedger() {
            state.ledgers.push({
                id: `ledger_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                accountName: '',
                rows: [] 
            });
            if(state.step === 1) renderLedgers();
        }

        function addLedgerRow(ledgerId) {
            const ledger = state.ledgers.find(l => l.id === ledgerId);
            if(ledger) {
                ledger.rows.push({
                    id: `row_${Date.now()}`,
                    year: '2025',
                    date: '',
                    particulars: '',
                    pr: false,
                    debit: '',
                    credit: ''
                });
                renderLedgers();
            }
        }

        function updateLedgerField(ledgerId, field, value) {
            const ledger = state.ledgers.find(l => l.id === ledgerId);
            if(ledger) ledger[field] = value;
        }

        function updateLedgerRow(ledgerId, rowIndex, field, value) {
            const ledger = state.ledgers.find(l => l.id === ledgerId);
            if(ledger && ledger.rows[rowIndex]) {
                ledger.rows[rowIndex][field] = value;
            }
        }

        function toggleLedgerPR(ledgerId, rowIndex) {
            const ledger = state.ledgers.find(l => l.id === ledgerId);
            if(ledger && ledger.rows[rowIndex]) {
                ledger.rows[rowIndex].pr = !ledger.rows[rowIndex].pr;
                renderLedgers(); // Re-render to show check
            }
        }

        // --- Logic: Validation ---

        function recordWrongAnswer(location, input, correct, reason) {
            state.wrongAnswers.push({ location, input, correct, reason });
        }

        function getGrade(score, total) {
            if(total === 0) return 'N/A';
            const pct = (score/total) * 100;
            if(pct >= 95) return 'A';
            if(pct >= 85) return 'B';
            if(pct >= 75) return 'C';
            return 'D'; // Fail
        }

        function validateTask1() {
            state.wrongAnswers = []; // Reset
            let scoreA = 0, totalA = 0; // Setup
            let scoreB = 0, totalB = 0; // Beg Bal
            let scoreC = 0, totalC = 0; // Posting

            // A. Setup: Check if ledgers exist for all used accounts
            const requiredAccounts = new Set([...state.pctb.map(p=>p.name), ...state.journalEntries.map(j=>j.drAccount), ...state.journalEntries.map(j=>j.crAccount)]);
            totalA = requiredAccounts.size;
            
            requiredAccounts.forEach(reqAcc => {
                const found = state.ledgers.find(l => l.accountName.trim() === reqAcc);
                if(found) scoreA++;
                else recordWrongAnswer("Task 1 - Ledger Setup", "Missing", reqAcc, `Ledger for ${reqAcc} was not created.`);
            });

            // B. Beginning Balances
            totalB = state.pctb.length * 4; // 4 pts per correct beg bal
            state.pctb.forEach(bal => {
                const ledger = state.ledgers.find(l => l.accountName.trim() === bal.name);
                if(ledger) {
                    // Find a row that looks like beginning balance
                    const row = ledger.rows.find(r => r.particulars.toLowerCase().includes('begin') || r.date.includes('Jan 1'));
                    if(row) {
                        const amount = parseFloat(bal.type === 'Dr' ? row.debit : row.credit) || 0;
                        if(Math.abs(amount - bal.amount) < 1) {
                            scoreB += 4;
                        } else {
                            recordWrongAnswer(`Ledger: ${bal.name} (Beg Bal)`, amount, bal.amount, "Incorrect beginning balance amount or side.");
                        }
                    } else {
                        recordWrongAnswer(`Ledger: ${bal.name} (Beg Bal)`, "Missing", "Row Entry", "Beginning balance row missing.");
                    }
                }
            });

            // C. Posting
            totalC = state.journalEntries.length * 2; // 1 pt for Dr, 1 pt for Cr
            state.journalEntries.forEach(entry => {
                // Check Dr
                const drLedger = state.ledgers.find(l => l.accountName.trim() === entry.drAccount);
                if(drLedger) {
                    const match = drLedger.rows.find(r => Math.abs((parseFloat(r.debit)||0) - entry.amount) < 1 && r.date.includes(entry.day));
                    if(match) {
                        scoreC++;
                        if(!state.journalPR[entry.id]) recordWrongAnswer(`Journal Entry ${entry.day}`, "PR Unchecked", "Checked", "PR box in Journal not checked.");
                    } else {
                        recordWrongAnswer(`Ledger: ${entry.drAccount}`, "Missing/Wrong", entry.amount, `Posting for Jan ${entry.day} missing or incorrect.`);
                    }
                }
                
                // Check Cr
                const crLedger = state.ledgers.find(l => l.accountName.trim() === entry.crAccount);
                if(crLedger) {
                    const match = crLedger.rows.find(r => Math.abs((parseFloat(r.credit)||0) - entry.amount) < 1 && r.date.includes(entry.day));
                    if(match) scoreC++;
                    else recordWrongAnswer(`Ledger: ${entry.crAccount}`, "Missing/Wrong", entry.amount, `Posting for Jan ${entry.day} missing or incorrect.`);
                }
            });

            state.task1Scores = {
                A: scoreA, totalA, gradeA: getGrade(scoreA, totalA),
                B: scoreB, totalB, gradeB: getGrade(scoreB, totalB),
                C: scoreC, totalC, gradeC: getGrade(scoreC, totalC)
            };

            return (scoreA+scoreB+scoreC) / (totalA+totalB+totalC) > 0.5; // Pass threshold
        }

        function validateTask2() {
            // Calculate Correct Final Balances
            const finalBalances = {};
            // Init with PCTB
            state.pctb.forEach(p => {
                if(!finalBalances[p.name]) finalBalances[p.name] = 0;
                finalBalances[p.name] += (p.type === 'Dr' ? p.amount : -p.amount);
            });
            // Add Journal Entries
            state.journalEntries.forEach(j => {
                if(!finalBalances[j.drAccount]) finalBalances[j.drAccount] = 0;
                finalBalances[j.drAccount] += j.amount;
                
                if(!finalBalances[j.crAccount]) finalBalances[j.crAccount] = 0;
                finalBalances[j.crAccount] -= j.amount;
            });

            let score = 0;
            let total = Object.keys(finalBalances).length;

            Object.entries(finalBalances).forEach(([accName, netAmount]) => {
                const input = state.trialBalanceInputs[accName] || { amount: 0, side: 'Dr' };
                const userVal = parseFloat(input.amount) || 0;
                const userSide = input.side;
                
                const correctSide = netAmount >= 0 ? 'Dr' : 'Cr';
                const correctAbs = Math.abs(netAmount);

                if(userSide === correctSide && Math.abs(userVal - correctAbs) < 1) {
                    score++;
                } else {
                    recordWrongAnswer(`Trial Balance: ${accName}`, `${userSide} ${userVal}`, `${correctSide} ${correctAbs}`, "Incorrect final balance or side.");
                }
            });

            state.task2Score = {
                score, total, grade: getGrade(score, total)
            };

            return true; 
        }

        // --- UI Rendering ---

        function renderLogin() {
            getEl('task-container').innerHTML = `
                <div class="max-w-md mx-auto bg-gray-50 p-6 rounded shadow">
                    <label class="block mb-2 font-bold">Attendance ID</label>
                    <input type="text" id="att-id" class="text-input mb-4 p-2" placeholder="Paste ID here">
                    <label class="block mb-2 font-bold">Student ID</label>
                    <input type="text" id="stu-id" class="text-input mb-4 p-2" placeholder="Your ID Number">
                </div>
            `;
            
            getEl('main-action-btn').innerText = "Verify & Login";
            getEl('main-action-btn').onclick = async () => {
                const attId = getEl('att-id').value;
                const stuId = getEl('stu-id').value;
                
                // --- Mock Validation for Demo (Replace with actual Firebase check) ---
                // In real app, un-comment Firebase code below
                /* const docSnap = await getDoc(doc(db, "attendance", attId));
                if(docSnap.exists()) { ... logic ... }
                */
               
                // Simulating Success
                state.attendanceId = attId;
                state.studentInfo = { fullName: "Dela Cruz, Juan", idNumber: stuId, section: "ABM-12" };
                state.step = 1;
                generateData();
                getEl('company-name').innerText = state.studentInfo.fullName.split(',')[0].trim() + " Service Company";
                renderTask1();
                startTimer();
            };
        }

        function renderTask1() {
            getEl('page-title').innerText = "Task 1: Posting to General Ledger";
            
            // Journal HTML
            const journalRows = state.journalEntries.map((je, idx) => `
                <div class="border-b border-gray-100 p-2 text-sm hover:bg-gray-50">
                    <div class="grid grid-cols-12 gap-1 mb-1 font-bold bg-gray-100 p-1">
                        <div class="col-span-2 text-center text-xs">Jan ${je.day}</div>
                        <div class="col-span-10 text-xs text-gray-500">Entry #${idx+1}</div>
                    </div>
                    <div class="grid grid-cols-12 gap-1 items-center">
                        <div class="col-span-6 pl-2">${je.drAccount}</div>
                        <div class="col-span-2 text-center">
                            <input type="checkbox" ${state.journalPR[je.id]?'checked':''} 
                                onchange="window.updateJournalPR('${je.id}', this.checked)"
                                class="cursor-pointer" ${state.isTask1Locked?'disabled':''}>
                        </div>
                        <div class="col-span-4 text-right pr-2">${formatMoney(je.amount)}</div>
                    </div>
                    <div class="grid grid-cols-12 gap-1 items-center">
                        <div class="col-span-6 journal-indent-credit">${je.crAccount}</div>
                        <div class="col-span-2 text-center">
                           <input type="checkbox" ${state.journalPR[je.id+'_cr']?'checked':''} 
                                class="cursor-pointer" disabled title="Credit PR auto-checked by system logic in real ledger usually, but here mapped to debit check for simplicity or separate">
                        </div>
                        <div class="col-span-4 text-right pr-2">${formatMoney(je.amount)}</div>
                    </div>
                    <div class="journal-indent-expl mt-1">${je.explanation}</div>
                </div>
            `).join('');

            // PCTB HTML
            const pctbHtml = `
                <div class="text-xs font-mono">
                    <div class="flex justify-between font-bold border-b mb-1">
                        <span>Account</span><span>Balance</span>
                    </div>
                    ${state.pctb.map(p => `
                        <div class="flex justify-between py-1 border-b border-dashed border-gray-200">
                            <span>${p.name}</span>
                            <span class="${p.type==='Cr'?'text-red-600':''}">${p.type} ${formatMoney(p.amount)}</span>
                        </div>
                    `).join('')}
                    <div class="flex justify-between font-bold mt-2 bg-yellow-50 p-1">
                        <span>Total Dr/Cr</span>
                        <span>${formatMoney(state.pctb.reduce((s,x)=>x.type==='Dr'?s+x.amount:s,0))}</span>
                    </div>
                </div>
            `;

            getEl('task-container').innerHTML = `
                <div class="task1-panels">
                    <!-- Left: Journal -->
                    <div class="journal-panel">
                        <div class="sticky top-0 bg-indigo-600 text-white p-2 font-bold z-10 flex justify-between">
                            <span>General Journal</span>
                            <span>Page 1</span>
                        </div>
                        <div class="p-2 space-y-2">
                            ${journalRows}
                        </div>
                    </div>

                    <!-- Right: PCTB & Ledgers -->
                    <div class="ledger-panel">
                        <div class="sticky-pctb">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm text-indigo-800">Post Closing Trial Balance</h3>
                                <button onclick="window.addLedger()" ${state.isTask1Locked?'disabled':''} class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                                    <i class="fas fa-plus"></i> Add Ledger
                                </button>
                            </div>
                            <div class="max-h-32 overflow-y-auto border border-gray-300 rounded p-1 bg-white">
                                ${pctbHtml}
                            </div>
                        </div>
                        
                        <div id="ledger-list" class="p-2 space-y-4 bg-gray-50 flex-1">
                            <!-- Ledgers injected via JS -->
                        </div>
                    </div>
                </div>
            `;
            
            renderLedgers();

            getEl('main-action-btn').innerText = "Validate Task 1";
            getEl('main-action-btn').onclick = () => {
                validateTask1();
                state.isTask1Locked = true;
                state.step = 2;
                renderTask2();
            };
        }

        function renderLedgers() {
            const container = getEl('ledger-list');
            if(!container) return;

            container.innerHTML = state.ledgers.map((l, lIdx) => `
                <div class="bg-white border shadow-sm rounded p-2 text-sm">
                    <div class="mb-2">
                        <input type="text" value="${l.accountName}" 
                            placeholder="Account Title"
                            onchange="window.updateLedgerField('${l.id}', 'accountName', this.value)"
                            class="text-input font-bold text-center border-b-2 border-indigo-200"
                            ${state.isTask1Locked?'disabled':''}>
                    </div>
                    <table class="w-full text-xs border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b">
                                <th class="p-1 text-left w-12">Date</th>
                                <th class="p-1 text-left">Particulars</th>
                                <th class="p-1 w-6">PR</th>
                                <th class="p-1 text-right w-20">Debit</th>
                                <th class="p-1 text-right w-20">Credit</th>
                                <th class="p-1 text-right w-24">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${l.rows.map((row, rIdx) => `
                                <tr class="border-b">
                                    <td class="p-1"><input type="text" value="${row.date}" class="w-full bg-transparent" placeholder="dd" onchange="window.updateLedgerRow('${l.id}', ${rIdx}, 'date', this.value)" ${state.isTask1Locked?'disabled':''}></td>
                                    <td class="p-1"><input type="text" value="${row.particulars}" class="w-full bg-transparent" onchange="window.updateLedgerRow('${l.id}', ${rIdx}, 'particulars', this.value)" ${state.isTask1Locked?'disabled':''}></td>
                                    <td class="p-1 text-center"><input type="checkbox" ${row.pr?'checked':''} onchange="window.toggleLedgerPR('${l.id}', ${rIdx})" ${state.isTask1Locked?'disabled':''}></td>
                                    <td class="p-1"><input type="number" value="${row.debit}" class="w-full text-right" onchange="window.updateLedgerRow('${l.id}', ${rIdx}, 'debit', this.value)" ${state.isTask1Locked?'disabled':''}></td>
                                    <td class="p-1"><input type="number" value="${row.credit}" class="w-full text-right" onchange="window.updateLedgerRow('${l.id}', ${rIdx}, 'credit', this.value)" ${state.isTask1Locked?'disabled':''}></td>
                                    <td class="p-1 bg-gray-50"><input type="number" value="${row.balance||''}" class="w-full text-right font-bold" disabled placeholder="calc..."></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-right">
                        <button onclick="window.addLedgerRow('${l.id}')" ${state.isTask1Locked?'disabled':''} class="text-xs text-blue-600 hover:underline">+ Add Row</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTask2() {
            getEl('page-title').innerText = "Task 2: Preparing Trial Balance";
            
            // Collect all unique accounts from Task 1
            const uniqueAccounts = [...new Set([
                ...state.pctb.map(a=>a.name),
                ...state.journalEntries.map(j=>j.drAccount),
                ...state.journalEntries.map(j=>j.crAccount)
            ])].sort();

            const rows = uniqueAccounts.map(acc => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-2 border-r">${acc}</td>
                    <td class="p-1 border-r">
                        <input type="number" 
                            onchange="window.updateTB('${acc}', 'Dr', this.value)"
                            class="table-input" placeholder="0">
                    </td>
                    <td class="p-1">
                        <input type="number" 
                            onchange="window.updateTB('${acc}', 'Cr', this.value)"
                            class="table-input" placeholder="0">
                    </td>
                </tr>
            `).join('');

            getEl('task-container').innerHTML = `
                <div class="max-w-3xl mx-auto bg-white border p-4 shadow">
                    <div class="text-center mb-4">
                        <h3 class="font-bold uppercase">${getEl('company-name').innerText}</h3>
                        <h4>Trial Balance</h4>
                        <p class="text-sm">January 31, 2025</p>
                    </div>
                    <table class="w-full text-sm border">
                        <thead class="bg-indigo-900 text-white">
                            <tr>
                                <th class="p-2 text-left">Account Titles</th>
                                <th class="p-2 w-32">Debit</th>
                                <th class="p-2 w-32">Credit</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot class="font-bold bg-gray-100">
                            <tr>
                                <td class="p-2 text-right">TOTALS</td>
                                <td class="p-2 text-right text-indigo-700" id="tb-total-dr">0</td>
                                <td class="p-2 text-right text-indigo-700" id="tb-total-cr">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            getEl('main-action-btn').innerText = "Validate & Finish";
            getEl('main-action-btn').onclick = async () => {
                validateTask2();
                await saveToFirebase();
                renderPrintView();
            };
        }

        function renderPrintView() {
            state.step = 3;
            document.body.classList.add('print-mode');
            getEl('timer-box').style.display = 'none';
            getEl('action-area').style.display = 'none';
            getEl('print-footer').classList.remove('hidden');
            getEl('student-print-info').innerHTML = `
                <div>Name: ${state.studentInfo.fullName}</div>
                <div>ID: ${state.studentInfo.idNumber} | Section: ${state.studentInfo.section}</div>
                <div>Date: ${new Date().toLocaleDateString()}</div>
            `;

            // HTML Construction
            let html = `
                <div class="mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-center mb-2">SCORE SUMMARY</h2>
                    <div class="grid grid-cols-2 gap-4 text-sm max-w-lg mx-auto border p-2">
                        <div>Task 1A (Setup): <span class="font-bold">${state.task1Scores.A}/${state.task1Scores.totalA} (${state.task1Scores.gradeA})</span></div>
                        <div>Task 1B (Beg Bal): <span class="font-bold">${state.task1Scores.B}/${state.task1Scores.totalB} (${state.task1Scores.gradeB})</span></div>
                        <div>Task 1C (Posting): <span class="font-bold">${state.task1Scores.C}/${state.task1Scores.totalC} (${state.task1Scores.gradeC})</span></div>
                        <div>Task 2 (Trial Bal): <span class="font-bold">${state.task2Score.score}/${state.task2Score.total} (${state.task2Score.grade})</span></div>
                    </div>
                </div>

                <div class="mb-4">
                     <h3 class="font-bold bg-gray-200 p-1">GENERAL JOURNAL RECORD</h3>
                     <!-- Re-render static journal here -->
                     <table class="w-full text-xs border mt-2">
                        <thead><tr class="bg-black text-white"><th>Date</th><th>Account</th><th>PR</th><th>Dr</th><th>Cr</th></tr></thead>
                        <tbody>
                            ${state.journalEntries.map(j => `
                                <tr>
                                    <td class="border p-1">Jan ${j.day}</td>
                                    <td class="border p-1">
                                        <div>${j.drAccount}</div>
                                        <div class="pl-4">${j.crAccount}</div>
                                        <div class="pl-6 italic text-gray-500">${j.explanation}</div>
                                    </td>
                                    <td class="border p-1 text-center">${state.journalPR[j.id]?'âœ”':''}</td>
                                    <td class="border p-1 text-right">${formatMoney(j.amount)}</td>
                                    <td class="border p-1 text-right"><br>${formatMoney(j.amount)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                     </table>
                </div>

                <div class="mb-4">
                     <h3 class="font-bold bg-gray-200 p-1">GENERAL LEDGERS</h3>
                     <div class="grid grid-cols-2 gap-4 mt-2">
                        ${state.ledgers.map(l => `
                            <div class="border text-xs p-1">
                                <div class="font-bold text-center border-b">${l.accountName || 'Untitled'}</div>
                                <table class="w-full">
                                    <tr class="border-b"><td>Date</td><td>Part.</td><td>Dr</td><td>Cr</td></tr>
                                    ${l.rows.map(r => `
                                        <tr>
                                            <td>${r.date}</td>
                                            <td>${r.particulars}</td>
                                            <td class="text-right">${r.debit}</td>
                                            <td class="text-right">${r.credit}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                        `).join('')}
                     </div>
                </div>
            `;

            // Append Wrong Answers
            if(state.wrongAnswers.length > 0) {
                html += `
                    <div id="wrong-answers-section">
                        <h3 class="font-bold text-red-700 border-b-2 border-red-700 mb-2 mt-6">AREAS FOR IMPROVEMENT</h3>
                        <table class="w-full text-xs text-left border-collapse">
                            <thead>
                                <tr class="bg-red-50">
                                    <th class="border p-1 w-1/4">Location</th>
                                    <th class="border p-1 w-1/4">Your Input</th>
                                    <th class="border p-1 w-1/4">Correct Value</th>
                                    <th class="border p-1 w-1/4">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.wrongAnswers.map(w => `
                                    <tr class="explanation-item">
                                        <td class="border p-1 font-semibold">${w.location}</td>
                                        <td class="border p-1 text-red-600">${w.input}</td>
                                        <td class="border p-1 text-green-700">${w.correct}</td>
                                        <td class="border p-1 italic">${w.reason}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            getEl('task-container').innerHTML = html;
            window.print();
        }

        // --- Event Handlers (Global) ---
        window.updateJournalPR = (id, checked) => { state.journalPR[id] = checked; };
        window.addLedger = addLedger;
        window.addLedgerRow = addLedgerRow;
        window.updateLedgerField = updateLedgerField;
        window.updateLedgerRow = updateLedgerRow;
        window.toggleLedgerPR = toggleLedgerPR;
        
        window.updateTB = (acc, side, val) => {
            if(!state.trialBalanceInputs[acc]) state.trialBalanceInputs[acc] = {amount:0, side:''};
            if(side === 'Dr' && val) { state.trialBalanceInputs[acc].amount = val; state.trialBalanceInputs[acc].side = 'Dr'; }
            if(side === 'Cr' && val) { state.trialBalanceInputs[acc].amount = val; state.trialBalanceInputs[acc].side = 'Cr'; }
            
            // Update Totals
            let dr = 0, cr = 0;
            Object.values(state.trialBalanceInputs).forEach(v => {
                if(v.side === 'Dr') dr += parseFloat(v.amount)||0;
                if(v.side === 'Cr') cr += parseFloat(v.amount)||0;
            });
            getEl('tb-total-dr').innerText = formatMoney(dr);
            getEl('tb-total-cr').innerText = formatMoney(cr);
        };

        async function saveToFirebase() {
            try {
                const resultsRef = doc(db, `results_${state.attendanceId}`, state.studentInfo.idNumber);
                await setDoc(resultsRef, {
                    student: state.studentInfo,
                    task1: state.task1Scores,
                    task2: state.task2Score,
                    journalEntries: state.journalEntries,
                    ledgers: state.ledgers,
                    pctb: state.pctb,
                    wrongAnswers: state.wrongAnswers,
                    timestamp: new Date().toISOString()
                });
                console.log("Saved to Firebase");
            } catch(e) {
                console.error("Save failed", e);
                alert("Note: Data saved locally only (Demo mode or Network error).");
            }
        }

        // --- Timer Logic ---
        function startTimer() {
            let duration = 3600; // 60 mins
            const display = getEl('countdown');
            const timer = setInterval(() => {
                if(state.step === 3) { clearInterval(timer); return; } // Stop on preview
                
                const m = Math.floor(duration / 60);
                const s = duration % 60;
                display.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                
                if(duration <= 0) {
                    clearInterval(timer);
                    alert("Time's Up!");
                    renderPrintView();
                }
                duration--;
            }, 1000);
        }

        // --- Init ---
        renderLogin();

    </script>
</body>
</html>
