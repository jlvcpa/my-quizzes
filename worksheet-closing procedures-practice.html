<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Cycle Performance Task (PHP)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Style for inputs in tables */
        .table-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            font-size: 0.85rem;
            background-color: #f0f9ff; /* light blue background for input areas */
        }
        .text-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: #f0f9ff;
        }
        .header-bg { background-color: #0f172a; color: white; }
        .footer-bg { background-color: #334155; color: white; }

        /* Print-specific styles */
        @media print {
            .no-print { display: none !important; }
            .printable-area { width: 100%; margin: 0; padding: 0; }
            body { background-color: white; color: black; }
            .shadow-xl, .rounded-xl, .border { border: none !important; box-shadow: none !important; }
            .header-bg, .footer-bg { background-color: #fff !important; color: #000 !important; }
            /* Force table inputs to be black text on white background when printing */
            .table-input, .text-input {
                border-color: #000 !important;
                background-color: white !important;
                color: black !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Firebase SDK Imports (Mandatory setup, even if not using database for this specific task) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Set log level to reduce console noise

                // Authentication Setup
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        // Sign in anonymously if no user is found
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken)
                                .catch(e => { console.error("Error signing in with custom token:", e); });
                        } else {
                            signInAnonymously(auth)
                                .catch(e => { console.error("Error signing in anonymously:", e); });
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }
    </script>

    <!-- Main Application Container -->
    <div id="app" class="max-w-7xl mx-auto printable-area bg-white shadow-xl rounded-xl p-6 md:p-10 border border-gray-200">

        <header class="text-center mb-8 pb-4 border-b-4 border-indigo-600 header-bg rounded-t-lg p-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-yellow-300">
                Accounting Cycle Performance Task
            </h1>
            <h2 class="text-xl md:text-2xl font-semibold text-gray-200 mt-1">
                A & M Cleaning Services - Year End (₱)
            </h2>
            <p class="text-sm font-light text-gray-400 mt-2">
                Sole Proprietorship Service Business | For the Year Ended December 31, 2024
            </p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="task-container">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <!-- Feedback and Actions Area -->
        <div id="action-area" class="mt-8 pt-6 border-t border-gray-300 no-print flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <div id="message-box" class="text-lg font-medium text-gray-700 min-h-8">
                <!-- Validation messages go here -->
            </div>
            <button id="next-step-btn" onclick="handleNextStep()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition duration-200 disabled:opacity-50" disabled>
                Proceed to Step 1: Student Info
            </button>
        </div>

        <footer class="mt-8 pt-4 border-t-4 border-indigo-600 footer-bg rounded-b-lg p-4 text-center">
            <p class="text-sm text-gray-400">
                Instruction: Fill up all required fields. Use the 'Print to PDF' option after each completed step.
            </p>
        </footer>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- GLOBAL STATE AND CONSTANTS ---
        let state = {
            currentStep: 0, // 0: Student Info, 1: Worksheet, 2: Financial Statements, etc.
            studentInfo: null,
            isAuthReady: false,
            // Initial Trial Balance Data (PHP)
            initialTB: [
                { name: 'Cash', type: 'asset', isFS: 'BS', isClosing: false, TB_DR: 120000, TB_CR: 0 },
                { name: 'Accounts Receivable', type: 'asset', isFS: 'BS', isClosing: false, TB_DR: 30000, TB_CR: 0 },
                { name: 'Supplies', type: 'asset', isFS: 'BS', isClosing: false, TB_DR: 15000, TB_CR: 0 },
                { name: 'Prepaid Rent', type: 'asset', isFS: 'BS', isClosing: false, TB_DR: 60000, TB_CR: 0 },
                { name: 'Equipment', type: 'asset', isFS: 'BS', isClosing: false, TB_DR: 200000, TB_CR: 0 },
                { name: 'Accumulated Depreciation-Equip.', type: 'contra-asset', isFS: 'BS', isClosing: false, TB_DR: 0, TB_CR: 20000 },
                { name: 'Accounts Payable', type: 'liability', isFS: 'BS', isClosing: false, TB_DR: 0, TB_CR: 15000 },
                { name: 'Unearned Service Revenue', type: 'liability', isFS: 'BS', isClosing: false, TB_DR: 0, TB_CR: 10000 },
                { name: 'A, Capital', type: 'equity', isFS: 'BS', isClosing: false, TB_DR: 0, TB_CR: 320000 },
                { name: 'A, Withdrawals', type: 'equity', isFS: 'BS', isClosing: true, TB_DR: 50000, TB_CR: 0 },
                { name: 'Service Revenue', type: 'revenue', isFS: 'IS', isClosing: true, TB_DR: 0, TB_CR: 180000 },
                { name: 'Salaries Expense', type: 'expense', isFS: 'IS', isClosing: true, TB_DR: 30000, TB_CR: 0 },
                { name: 'Utilities Expense', type: 'expense', isFS: 'IS', isClosing: true, TB_DR: 10000, TB_CR: 0 },
                { name: 'Totals', TB_DR: 515000, TB_CR: 515000 }
            ],
            // New accounts added through adjustments
            newAccounts: [
                { name: 'Supplies Expense', type: 'expense', isFS: 'IS', isClosing: true },
                { name: 'Rent Expense', type: 'expense', isFS: 'IS', isClosing: true },
                { name: 'Depreciation Expense', type: 'expense', isFS: 'IS', isClosing: true },
                { name: 'Salaries Payable', type: 'liability', isFS: 'BS', isClosing: false },
                { name: 'Accounts Receivable', type: 'asset', isFS: 'BS', isClosing: false }, // Already exists, will just be adjusted
                { name: 'Service Revenue', type: 'revenue', isFS: 'IS', isClosing: true }, // Already exists, will just be adjusted
                { name: 'Accrued Service Revenue', type: 'asset', isFS: 'BS', isClosing: false }, // Explicit new account for accrued revenue for clarity in journal
            ],
            // Adjustment requirements and answers (for validation)
            adjustments: [
                { desc: "A. Supplies on hand, counted on Dec 31, ₱ 5,000. (Initial Supplies ₱ 15,000)", dr: 'Supplies Expense', cr: 'Supplies', amount: 10000, isReversing: false },
                { desc: "B. One month of rent has expired. (Prepaid Rent was for 6 months, dated Dec 1)", dr: 'Rent Expense', cr: 'Prepaid Rent', amount: 10000, isReversing: true }, // Reversing candidate
                { desc: "C. Depreciation of equipment for the year, ₱ 15,000.", dr: 'Depreciation Expense', cr: 'Accumulated Depreciation-Equip.', amount: 15000, isReversing: false },
                { desc: "D. Accrued salaries not yet paid, ₱ 8,000.", dr: 'Salaries Expense', cr: 'Salaries Payable', amount: 8000, isReversing: true }, // Reversing candidate
                { desc: "E. Unearned Service Revenue earned during the period, ₱ 6,000.", dr: 'Unearned Service Revenue', cr: 'Service Revenue', amount: 6000, isReversing: false },
                { desc: "F. Services rendered but unbilled/uncollected (Accrued Revenue), ₱ 4,000. (Using Accrued Service Revenue account for clarity)", dr: 'Accrued Service Revenue', cr: 'Service Revenue', amount: 4000, isReversing: true }, // Reversing candidate (if using Accrued AR)
            ],
            worksheetInputs: {}, // Stores user input for worksheet columns
            journalEntries: { adjusting: [], closing: [], reversing: [] }, // Stores user input for journal entries
        };

        // --- UTILITY FUNCTIONS ---

        /** Formats a number as Philippine Peso (₱). */
        const formatPHP = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return '';
            return '₱ ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        /** Gets the display name for the current step. */
        const getStepTitle = (step) => {
            const titles = [
                "Student Information",
                "Step 1: 10-Column Worksheet",
                "Step 2: Financial Statements",
                "Step 3: Journalizing Adjusting Entries",
                "Step 4: Journalizing Closing Entries",
                "Step 5: Post-Closing Trial Balance",
                "Step 6: Journalizing Reversing Entries",
                "Task Complete!"
            ];
            return titles[step] || "Unknown Step";
        };

        /** Renders a simple message box for print/validation feedback. */
        const renderMessageBox = (message, isError = false) => {
            const box = document.getElementById('message-box');
            box.className = `text-lg font-medium min-h-8 ${isError ? 'text-red-600' : 'text-green-600'}`;
            box.innerHTML = message;
        };

        // --- STEP RENDERING FUNCTIONS ---

        /** Step 0: Student Information Collection */
        const renderStudentInfo = () => {
            document.getElementById('task-container').innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700">Enter Required Student Details</h3>
                    <p class="text-sm text-gray-500">You must complete this step to unlock the Performance Task.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                        <div class="col-span-1">
                            <label for="idNumber" class="block text-sm font-medium text-gray-700">ID Number (One Box)</label>
                            <input type="text" id="idNumber" class="text-input" placeholder="e.g., 2024-00123">
                        </div>
                        <div class="col-span-1">
                            <label for="classNumber" class="block text-sm font-medium text-gray-700">Class Number (One Box)</label>
                            <input type="text" id="classNumber" class="text-input" placeholder="e.g., 5">
                        </div>
                        <div class="col-span-2">
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Last Name and First Name (One Box)</label>
                            <input type="text" id="fullName" class="text-input" placeholder="e.g., Dela Cruz, Juan Santos">
                        </div>
                        <div class="col-span-2">
                            <label for="gradeSection" class="block text-sm font-medium text-gray-700">Grade Level and Section (One Box)</label>
                            <input type="text" id="gradeSection" class="text-input" placeholder="e.g., Grade 12 - STEM 1">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Submit Info & Proceed to Step 1";
            document.getElementById('next-step-btn').disabled = false; // Always enabled for initial info collection
            renderMessageBox("Please fill in your information to start the task.");
        };

        /** Step 1: 10-Column Worksheet */
        const renderWorksheet = () => {
            const accounts = [...state.initialTB.slice(0, -1)]; // Exclude 'Totals' for now

            // Add new required accounts for adjustments, if they don't already exist
            state.newAccounts.forEach(newAcc => {
                if (!accounts.some(acc => acc.name === newAcc.name) && newAcc.name !== 'Accounts Receivable' && newAcc.name !== 'Service Revenue') {
                    accounts.push({ ...newAcc, TB_DR: 0, TB_CR: 0 });
                }
            });

            // Re-sort to put expenses/revenues after equity (for better worksheet flow)
            accounts.sort((a, b) => {
                const order = { 'asset': 1, 'contra-asset': 2, 'liability': 3, 'equity': 4, 'revenue': 5, 'expense': 6 };
                return order[a.type] - order[b.type];
            });

            const renderRow = (acc, index, isTotal = false) => {
                const isContra = acc.type === 'contra-asset' || acc.type === 'liability' || acc.type === 'equity' || acc.type === 'revenue';
                const baseId = `wks_${index}_`;
                const isIncomeStatement = acc.isFS === 'IS';
                const isBalanceSheet = acc.isFS === 'BS';

                return `
                    <tr class="${isTotal ? 'font-bold bg-indigo-50/50' : (acc.TB_DR === 0 && acc.TB_CR === 0 ? 'bg-yellow-50/50' : 'hover:bg-gray-50')}">
                        <td class="p-2 border border-gray-300 text-left ${isTotal ? 'text-center' : ''} whitespace-nowrap">
                            ${isTotal ? 'TOTALS' : acc.name}
                        </td>
                        <!-- Trial Balance (Given) -->
                        <td class="p-2 border border-gray-300 text-right">${formatPHP(acc.TB_DR)}</td>
                        <td class="p-2 border border-gray-300 text-right">${formatPHP(acc.TB_CR)}</td>

                        <!-- Adjustments (Input) -->
                        <td class="p-0 border border-gray-300"><input type="number" id="${baseId}ADJ_DR" oninput="saveWorksheetInput('${baseId}ADJ_DR', this.value)" class="table-input" ${isTotal ? 'disabled' : ''}></td>
                        <td class="p-0 border border-gray-300"><input type="number" id="${baseId}ADJ_CR" oninput="saveWorksheetInput('${baseId}ADJ_CR', this.value)" class="table-input" ${isTotal ? 'disabled' : ''}></td>

                        <!-- Adjusted Trial Balance (Input) -->
                        <td class="p-0 border border-gray-300"><input type="number" id="${baseId}ATB_DR" oninput="saveWorksheetInput('${baseId}ATB_DR', this.value)" class="table-input" ${isTotal ? 'disabled' : ''}></td>
                        <td class="p-0 border border-gray-300"><input type="number" id="${baseId}ATB_CR" oninput="saveWorksheetInput('${baseId}ATB_CR', this.value)" class="table-input" ${isTotal ? 'disabled' : ''}></td>

                        <!-- Income Statement (Input) -->
                        <td class="p-0 border border-gray-300 ${!isIncomeStatement && !isTotal ? 'bg-gray-100' : ''}">
                            <input type="number" id="${baseId}IS_DR" oninput="saveWorksheetInput('${baseId}IS_DR', this.value)" class="table-input" ${!isIncomeStatement || isTotal ? 'disabled' : ''}>
                        </td>
                        <td class="p-0 border border-gray-300 ${!isIncomeStatement && !isTotal ? 'bg-gray-100' : ''}">
                            <input type="number" id="${baseId}IS_CR" oninput="saveWorksheetInput('${baseId}IS_CR', this.value)" class="table-input" ${!isIncomeStatement || isTotal ? 'disabled' : ''}>
                        </td>

                        <!-- Balance Sheet (Input) -->
                        <td class="p-0 border border-gray-300 ${!isBalanceSheet && !isTotal ? 'bg-gray-100' : ''}">
                            <input type="number" id="${baseId}BS_DR" oninput="saveWorksheetInput('${baseId}BS_DR', this.value)" class="table-input" ${!isBalanceSheet || isTotal ? 'disabled' : ''}>
                        </td>
                        <td class="p-0 border border-gray-300 ${!isBalanceSheet && !isTotal ? 'bg-gray-100' : ''}">
                            <input type="number" id="${baseId}BS_CR" oninput="saveWorksheetInput('${baseId}BS_CR', this.value)" class="table-input" ${!isBalanceSheet || isTotal ? 'disabled' : ''}>
                        </td>
                    </tr>
                `;
            };

            document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 1: 10-Column Worksheet Preparation</h3>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-bold text-lg text-blue-700 mb-2">Required Adjustments:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            ${state.adjustments.map(adj => `<li>${adj.desc}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs border-collapse border border-gray-400">
                            <thead>
                                <tr class="header-bg text-center">
                                    <th rowspan="2" class="p-2 border border-gray-300 w-[150px]">Account Titles</th>
                                    <th colspan="2" class="p-2 border border-gray-300">Trial Balance</th>
                                    <th colspan="2" class="p-2 border border-gray-300">Adjustments</th>
                                    <th colspan="2" class="p-2 border border-gray-300">Adjusted Trial Balance</th>
                                    <th colspan="2" class="p-2 border border-gray-300">Income Statement</th>
                                    <th colspan="2" class="p-2 border border-gray-300">Balance Sheet</th>
                                </tr>
                                <tr class="bg-indigo-100 text-indigo-900 text-center">
                                    <th class="p-1 border border-gray-300">Debit (₱)</th>
                                    <th class="p-1 border border-gray-300">Credit (₱)</th>
                                    <th class="p-1 border border-gray-300">Debit (₱)</th>
                                    <th class="p-1 border border-gray-300">Credit (₱)</th>
                                    <th class="p-1 border border-gray-300">Debit (₱)</th>
                                    <th class="p-1 border border-gray-300">Credit (₱)</th>
                                    <th class="p-1 border border-gray-300">Debit (₱)</th>
                                    <th class="p-1 border border-gray-300">Credit (₱)</th>
                                    <th class="p-1 border border-gray-300">Debit (₱)</th>
                                    <th class="p-1 border border-gray-300">Credit (₱)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accounts.map((acc, i) => renderRow(acc, i)).join('')}
                                ${renderRow(state.initialTB.at(-1), accounts.length, true)} <!-- Total Row -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Validate Worksheet & Print Step 1";
            renderMessageBox("Complete the Adjustments, Adjusted Trial Balance, Income Statement, and Balance Sheet columns.");
        };

        /** Step 2: Financial Statements (Placeholder for complex logic, will just prompt for printing here) */
        const renderFinancialStatements = () => {
            const worksheetData = calculateFSFromWorksheet();
            document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 2: Financial Statements Preparation</h3>

                    <div class="bg-green-50 p-6 rounded-lg border border-green-200 shadow-lg">
                        <p class="text-base text-green-800">
                            Based on your completed Worksheet (which has been validated), you are now required to prepare the following financial statements:
                        </p>
                        <ul class="list-disc list-inside mt-3 space-y-1 font-semibold text-gray-700">
                            <li>Income Statement</li>
                            <li>Statement of Changes in Equity</li>
                            <li>Statement of Financial Position (Balance Sheet)</li>
                        </ul>
                        <p class="mt-4 text-sm text-gray-600">
                            In a real-world scenario, you would draft these reports now. For this interactive task, proceed to the next step to simulate the completion of this report set.
                        </p>
                    </div>

                    <!-- Display Key Results from Worksheet -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-indigo-500">
                            <p class="text-sm font-medium text-gray-500">Total Service Revenue</p>
                            <p class="text-2xl font-bold text-indigo-600">${formatPHP(worksheetData.totalRevenue)}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                            <p class="text-2xl font-bold text-red-600">${formatPHP(worksheetData.totalExpenses)}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-md border-b-4 border-green-500">
                            <p class="text-sm font-medium text-gray-500">${worksheetData.netIncome > 0 ? 'Net Income' : 'Net Loss'}</p>
                            <p class="text-3xl font-extrabold text-green-600">${formatPHP(Math.abs(worksheetData.netIncome))}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Simulate FS Completion & Print Step 2";
            renderMessageBox("Prepare and review your Financial Statements. Print this page before proceeding.");
        };

        /** Step 3: Adjusting Entries */
        const renderAdjustingEntries = () => {
             document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 3: Journalizing Adjusting Entries</h3>

                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <h4 class="font-bold text-lg text-red-700 mb-2">Instructions:</h4>
                        <p class="text-sm text-gray-600">Journalize the 6 adjusting entries described in Step 1. Ensure Debits equal Credits for each entry. The order of entries does not matter.</p>
                        <p class="text-sm text-gray-600 mt-2">Example: <span class="font-mono bg-gray-200 p-1 rounded">Date, Account Name (DR), P 10,000 | Date, Account Name (CR), P 10,000</span></p>
                    </div>

                    <div id="journal-entries-container" class="space-y-4">
                        ${[...Array(6).keys()].map(i => renderJournalEntryInput('ADJ', i)).join('')}
                    </div>
                    <button onclick="addJournalEntryInput('ADJ')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium no-print">
                        + Add Another Entry (if needed)
                    </button>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Validate Adjusting Entries & Print Step 3";
            renderMessageBox("Journalize all required adjusting entries.");
        };

        /** Step 4: Closing Entries */
        const renderClosingEntries = () => {
            document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 4: Journalizing Closing Entries</h3>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-bold text-lg text-yellow-700 mb-2">Instructions:</h4>
                        <p class="text-sm text-gray-600">Journalize the 4 required closing entries for Revenue, Expenses, Income Summary, and Withdrawals.</p>
                        <p class="text-sm text-gray-600 mt-2">Use 'Income Summary' as the intermediate account.</p>
                    </div>

                    <div id="journal-entries-container" class="space-y-4">
                        ${[...Array(4).keys()].map(i => renderJournalEntryInput('CLS', i)).join('')}
                    </div>
                    <button onclick="addJournalEntryInput('CLS')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium no-print">
                        + Add Another Entry (if needed)
                    </button>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Validate Closing Entries & Print Step 4";
            renderMessageBox("Journalize all 4 required closing entries.");
        };

        /** Step 5: Post-Closing Trial Balance */
        const renderPCTB = () => {
            const worksheetData = calculateFSFromWorksheet();
            const accounts = worksheetData.BSAccounts.filter(acc => acc.name !== 'A, Withdrawals');

            document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 5: Post-Closing Trial Balance (PCTB)</h3>

                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-lg text-purple-700 mb-2">Instructions:</h4>
                        <p class="text-sm text-gray-600">List all permanent (Balance Sheet) accounts with their adjusted, post-closing balances. Remember: Capital must be updated for Net Income/Loss and Withdrawals.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border-collapse border border-gray-400">
                            <thead>
                                <tr class="header-bg text-center">
                                    <th class="p-2 border border-gray-300 w-[200px]">Account Titles</th>
                                    <th class="p-2 border border-gray-300">Debit (₱)</th>
                                    <th class="p-2 border border-gray-300">Credit (₱)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accounts.map((acc, i) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-2 border border-gray-300 text-left">${acc.name}</td>
                                        <td class="p-0 border border-gray-300"><input type="number" id="pctb_dr_${i}" oninput="savePCTBInput('${i}', 'DR', this.value)" class="table-input"></td>
                                        <td class="p-0 border border-gray-300"><input type="number" id="pctb_cr_${i}" oninput="savePCTBInput('${i}', 'CR', this.value)" class="table-input"></td>
                                    </tr>
                                `).join('')}
                                <tr class="font-bold bg-indigo-50/50">
                                    <td class="p-2 border border-gray-300 text-center">TOTALS</td>
                                    <td class="p-0 border border-gray-300"><input type="number" id="pctb_total_dr" disabled class="table-input font-bold bg-gray-200"></td>
                                    <td class="p-0 border border-gray-300"><input type="number" id="pctb_total_cr" disabled class="table-input font-bold bg-gray-200"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Validate PCTB & Print Step 5";
            renderMessageBox("List all permanent accounts and their post-closing balances.");
        };

        /** Step 6: Reversing Entries */
        const renderReversingEntries = () => {
            document.getElementById('task-container').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700">STEP 6: Journalizing Reversing Entries</h3>

                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                        <h4 class="font-bold text-lg text-teal-700 mb-2">Instructions:</h4>
                        <p class="text-sm text-gray-600">Journalize the *optional* reversing entries for appropriate accruals and deferrals.</p>
                        <p class="text-sm text-gray-600 mt-2">Identify which of your adjusting entries qualify for reversing.</p>
                    </div>

                    <div id="journal-entries-container" class="space-y-4">
                        ${[...Array(3).keys()].map(i => renderJournalEntryInput('REV', i)).join('')}
                    </div>
                    <button onclick="addJournalEntryInput('REV')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium no-print">
                        + Add Another Entry (if needed)
                    </button>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Validate Reversing Entries & Complete Task";
            renderMessageBox("Journalize the necessary reversing entries.");
        };

        /** Final Step: Completion */
        const renderCompletion = () => {
            document.getElementById('task-container').innerHTML = `
                <div class="text-center py-16 px-4 bg-indigo-50 rounded-lg shadow-2xl border-4 border-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mx-auto text-indigo-600 mb-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="text-3xl font-bold text-indigo-800 mb-3">CONGRATULATIONS!</h3>
                    <p class="text-xl text-gray-700 mb-6">You have successfully completed the Accounting Cycle Performance Task for A & M Cleaning Services.</p>

                    <div class="inline-block text-left bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h4 class="font-semibold text-lg text-gray-800 border-b pb-2 mb-2">Student Submission Details:</h4>
                        <p><strong>Name:</strong> ${state.studentInfo.fullName}</p>
                        <p><strong>ID:</strong> ${state.studentInfo.idNumber}</p>
                        <p><strong>Class:</strong> ${state.studentInfo.classNumber}</p>
                        <p><strong>Section:</strong> ${state.studentInfo.gradeSection}</p>
                    </div>

                    <p class="mt-6 text-sm text-gray-600">Please click the button below to generate the final PDF report for submission.</p>
                </div>
            `;
            document.getElementById('next-step-btn').innerText = "Print Final Report to PDF";
            document.getElementById('next-step-btn').onclick = () => {
                window.print();
                renderMessageBox("Final report printed. Great job!");
            };
            renderMessageBox("Task completed! Print your final submission.");
        };

        // --- COMMON JOURNAL ENTRY RENDERING ---
        const renderJournalEntryInput = (type, index) => {
            const baseId = `${type}_${index}`;
            return `
                <div class="journal-entry bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-3">Entry ${index + 1} (${type === 'ADJ' ? 'Adjusting' : type === 'CLS' ? 'Closing' : 'Reversing'})</h4>
                    <div class="grid grid-cols-6 gap-2 items-center text-sm">
                        <div class="col-span-1 font-medium text-gray-500">Date:</div>
                        <div class="col-span-5"><input type="text" id="${baseId}_date" oninput="saveJournalInput('${type}', ${index}, 'date', this.value)" class="text-input" value="Dec 31, 2024" placeholder="Date"></div>

                        <!-- DEBIT Row -->
                        <div class="col-span-1 font-medium text-red-600">Debit:</div>
                        <div class="col-span-3"><input type="text" id="${baseId}_dr_acc" oninput="saveJournalInput('${type}', ${index}, 'dr_acc', this.value)" class="text-input" placeholder="Account Debited"></div>
                        <div class="col-span-2"><input type="number" id="${baseId}_dr_amt" oninput="saveJournalInput('${type}', ${index}, 'dr_amt', this.value)" class="table-input" placeholder="Amount"></div>

                        <!-- CREDIT Row -->
                        <div class="col-span-1 font-medium text-green-600">Credit:</div>
                        <div class="col-span-3 pl-4"><input type="text" id="${baseId}_cr_acc" oninput="saveJournalInput('${type}', ${index}, 'cr_acc', this.value)" class="text-input" placeholder="Account Credited"></div>
                        <div class="col-span-2"><input type="number" id="${baseId}_cr_amt" oninput="saveJournalInput('${type}', ${index}, 'cr_amt', this.value)" class="table-input" placeholder="Amount"></div>
                    </div>
                </div>
            `;
        };

        const addJournalEntryInput = (type) => {
            const container = document.getElementById('journal-entries-container');
            const currentIndex = container.children.length;
            const entryHtml = renderJournalEntryInput(type, currentIndex);
            container.insertAdjacentHTML('beforeend', entryHtml);
            // Initialize state for the new entry
            if (!state.journalEntries[type]) state.journalEntries[type] = [];
            state.journalEntries[type][currentIndex] = { date: 'Dec 31, 2024' };
        }

        // --- VALIDATION AND STATE HANDLERS ---

        /** Calculates the final ATB, Net Income, and Ending Capital (The key answers) */
        const calculateFSFromWorksheet = () => {
            const accounts = [...state.initialTB.slice(0, -1)];

            // Consolidate all accounts (initial + new)
            state.newAccounts.forEach(newAcc => {
                if (!accounts.some(acc => acc.name === newAcc.name)) {
                    accounts.push({ ...newAcc, TB_DR: 0, TB_CR: 0 });
                }
            });

            const accountMap = new Map();
            accounts.forEach(acc => accountMap.set(acc.name, { ...acc, ATB_DR: acc.TB_DR, ATB_CR: acc.TB_CR }));

            // Apply Adjustments to generate ATB
            state.adjustments.forEach(adj => {
                const drAcc = accountMap.get(adj.dr);
                const crAcc = accountMap.get(adj.cr);

                if (drAcc) drAcc.ATB_DR += adj.amount;
                if (crAcc) crAcc.ATB_CR += adj.amount;
            });

            let totalRevenue = 0;
            let totalExpenses = 0;
            let BSAccounts = [];

            // Calculate IS components and identify BS accounts
            accountMap.forEach(acc => {
                if (acc.isFS === 'IS') {
                    if (acc.type === 'revenue') {
                        totalRevenue += (acc.ATB_CR - acc.ATB_DR);
                    } else if (acc.type === 'expense') {
                        totalExpenses += (acc.ATB_DR - acc.ATB_CR);
                    }
                } else if (acc.isFS === 'BS') {
                    // Filter out zero-balance items only if they were newly created and unused
                    if (acc.name === 'A, Withdrawals' || acc.ATB_DR !== 0 || acc.ATB_CR !== 0) {
                        BSAccounts.push(acc);
                    }
                }
            });

            const netIncome = totalRevenue - totalExpenses;
            let endingCapital = accountMap.get('A, Capital').ATB_CR;
            let withdrawals = accountMap.get('A, Withdrawals').ATB_DR;

            endingCapital += netIncome;
            endingCapital -= withdrawals;

            return {
                netIncome: netIncome,
                totalRevenue: totalRevenue,
                totalExpenses: totalExpenses,
                endingCapital: endingCapital,
                accountMap: accountMap,
                BSAccounts: BSAccounts
            };
        };

        /** Handles input for the PCTB (Step 5) */
        const savePCTBInput = (index, type, value) => {
            const accounts = calculateFSFromWorksheet().BSAccounts;
            const accountName = accounts[index].name;
            if (!state.pctbInputs) state.pctbInputs = {};
            if (!state.pctbInputs[accountName]) state.pctbInputs[accountName] = { DR: 0, CR: 0 };
            state.pctbInputs[accountName][type] = Number(value) || 0;

            // Recalculate totals for display
            let totalDR = 0;
            let totalCR = 0;
            Object.values(state.pctbInputs).forEach(input => {
                totalDR += input.DR;
                totalCR += input.CR;
            });

            document.getElementById('pctb_total_dr').value = totalDR.toFixed(2);
            document.getElementById('pctb_total_cr').value = totalCR.toFixed(2);
        };

        /** Handles input for the Journal Entries (Steps 3, 4, 6) */
        const saveJournalInput = (type, index, field, value) => {
            if (!state.journalEntries[type]) state.journalEntries[type] = [];
            if (!state.journalEntries[type][index]) state.journalEntries[type][index] = {};
            
            // Convert amount fields to numbers, others to strings
            if (field.includes('amt')) {
                state.journalEntries[type][index][field] = Number(value) || 0;
            } else {
                state.journalEntries[type][index][field] = value;
            }
        };

        /** Handles input for the Worksheet (Step 1) */
        const saveWorksheetInput = (id, value) => {
            state.worksheetInputs[id] = Number(value) || 0;
        };

        /** Handles the main navigation button logic */
        const handleNextStep = () => {
            let isValid = false;
            let message = "";

            if (state.currentStep === 0) {
                isValid = validateStudentInfo();
                message = isValid ? "Information recorded. Preparing Step 1..." : "Please fill in ALL student information fields.";
            } else if (state.currentStep === 1) {
                isValid = validateWorksheet();
                message = isValid ? "Worksheet validated! Proceeding to Step 2..." : "Worksheet validation failed. Check your totals and column balances.";
            } else if (state.currentStep === 2) {
                // FS step is print-only simulation
                isValid = true;
                message = "Financial Statements prepared. Proceeding to Step 3...";
            } else if (state.currentStep === 3) {
                isValid = validateJournalEntries('ADJ');
                message = isValid ? "Adjusting Entries validated! Proceeding to Step 4..." : "Adjusting Entries validation failed. Check DR/CR balance and accuracy.";
            } else if (state.currentStep === 4) {
                isValid = validateJournalEntries('CLS');
                message = isValid ? "Closing Entries validated! Proceeding to Step 5..." : "Closing Entries validation failed. Check the 4 required entries and amounts.";
            } else if (state.currentStep === 5) {
                isValid = validatePCTB();
                message = isValid ? "Post-Closing TB validated! Proceeding to Step 6..." : "Post-Closing TB validation failed. Check account balances and the final total.";
            } else if (state.currentStep === 6) {
                isValid = validateJournalEntries('REV');
                message = isValid ? "Reversing Entries validated! Task is complete!" : "Reversing Entries validation failed. Check only for entries that meet the reversing criteria.";
            }

            if (isValid) {
                renderMessageBox(message);
                // Trigger print ONLY for steps 1 through 6
                if (state.currentStep > 0 && state.currentStep < 7) {
                    window.print();
                }
                state.currentStep++;
                renderStep();
            } else {
                renderMessageBox(message, true);
            }
        };

        // --- VALIDATION FUNCTIONS ---

        const validateStudentInfo = () => {
            const idNumber = document.getElementById('idNumber').value.trim();
            const classNumber = document.getElementById('classNumber').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const gradeSection = document.getElementById('gradeSection').value.trim();

            if (idNumber === "" || classNumber === "" || fullName === "" || gradeSection === "") {
                return false;
            }

            state.studentInfo = { idNumber, classNumber, fullName, gradeSection };
            return true;
        };

        const validateWorksheet = () => {
            const accountData = calculateFSFromWorksheet();
            const accounts = Array.from(accountData.accountMap.values());
            const acceptableError = 0.01; // Allow for slight floating point error if calculations were complex

            let valid = true;
            let ATB_DR_Total = 0;
            let ATB_CR_Total = 0;
            let IS_DR_Total = 0;
            let IS_CR_Total = 0;
            let BS_DR_Total = 0;
            let BS_CR_Total = 0;
            let ADJ_DR_Total = 0;
            let ADJ_CR_Total = 0;

            // 1. Check Adjustment Totals
            state.adjustments.forEach(adj => {
                ADJ_DR_Total += adj.amount;
                ADJ_CR_Total += adj.amount;
            });
            const inputADJ_DR_Total = accounts.reduce((sum, acc, i) => sum + (state.worksheetInputs[`wks_${i}_ADJ_DR`] || 0), 0);
            const inputADJ_CR_Total = accounts.reduce((sum, acc, i) => sum + (state.worksheetInputs[`wks_${i}_ADJ_CR`] || 0), 0);
            if (Math.abs(inputADJ_DR_Total - ADJ_DR_Total) > acceptableError || Math.abs(inputADJ_CR_Total - ADJ_CR_Total) > acceptableError) {
                console.error("Adjustment totals error");
                valid = false;
            }

            // 2. Check ATB, IS, and BS accuracy
            accounts.forEach((acc, i) => {
                const baseId = `wks_${i}_`;
                const ATB_DR = acc.ATB_DR;
                const ATB_CR = acc.ATB_CR;
                const input_ATB_DR = state.worksheetInputs[baseId + 'ATB_DR'] || 0;
                const input_ATB_CR = state.worksheetInputs[baseId + 'ATB_CR'] || 0;

                // ATB Check
                if (Math.abs(input_ATB_DR - ATB_DR) > acceptableError || Math.abs(input_ATB_CR - ATB_CR) > acceptableError) {
                    console.error(`ATB error for ${acc.name}`);
                    valid = false;
                }

                ATB_DR_Total += input_ATB_DR;
                ATB_CR_Total += input_ATB_CR;

                // IS/BS Check
                if (acc.isFS === 'IS') {
                    const IS_DR = acc.type === 'expense' ? (ATB_DR - ATB_CR) : 0;
                    const IS_CR = acc.type === 'revenue' ? (ATB_CR - ATB_DR) : 0;
                    IS_DR_Total += state.worksheetInputs[baseId + 'IS_DR'] || 0;
                    IS_CR_Total += state.worksheetInputs[baseId + 'IS_CR'] || 0;
                    if (Math.abs(IS_DR - (state.worksheetInputs[baseId + 'IS_DR'] || 0)) > acceptableError || Math.abs(IS_CR - (state.worksheetInputs[baseId + 'IS_CR'] || 0)) > acceptableError) {
                        console.error(`IS error for ${acc.name}`);
                        valid = false;
                    }
                } else if (acc.isFS === 'BS') {
                    const BS_DR = ATB_DR > ATB_CR ? (ATB_DR - ATB_CR) : 0;
                    const BS_CR = ATB_CR > ATB_DR ? (ATB_CR - ATB_DR) : 0;
                    BS_DR_Total += state.worksheetInputs[baseId + 'BS_DR'] || 0;
                    BS_CR_Total += state.worksheetInputs[baseId + 'BS_CR'] || 0;
                    if (Math.abs(BS_DR - (state.worksheetInputs[baseId + 'BS_DR'] || 0)) > acceptableError || Math.abs(BS_CR - (state.worksheetInputs[baseId + 'BS_CR'] || 0)) > acceptableError) {
                         console.error(`BS error for ${acc.name}`);
                         valid = false;
                    }
                }
            });

            // 3. Check Final Balances and Net Income
            if (Math.abs(ATB_DR_Total - ATB_CR_Total) > acceptableError) {
                console.error("Final ATB totals do not match.");
                valid = false;
            }

            const NetIncome = accountData.netIncome;
            const IS_DR_Bal = IS_DR_Total - IS_CR_Total;
            const BS_CR_Bal = BS_CR_Total - BS_DR_Total;

            // Check if student calculated Net Income/Loss correctly
            if (Math.abs(NetIncome - IS_DR_Bal) > acceptableError || Math.abs(NetIncome - BS_CR_Bal) > acceptableError) {
                 console.error("Net Income/Loss calculation is wrong.");
                 // This is a common error, so we allow it to pass if all individual ATB/IS/BS entries are correct, and only flag the final totals check, but for a simple task, we use the final total check.
            }

            // Check the final row input for the ATB totals
            const totalIndex = accounts.length;
            const inputTotalATB_DR = state.worksheetInputs[`wks_${totalIndex}_ATB_DR`] || 0;
            const inputTotalATB_CR = state.worksheetInputs[`wks_${totalIndex}_ATB_CR`] || 0;

            if (Math.abs(inputTotalATB_DR - ATB_DR_Total) > acceptableError || Math.abs(inputTotalATB_CR - ATB_CR_Total) > acceptableError) {
                console.error("Student did not enter correct ATB totals in the final row.");
                valid = false;
            }

            // Check final IS/BS column equality (after adding the Net Income/Loss row)
            if (Math.abs((IS_CR_Total + NetIncome) - IS_DR_Total) > acceptableError || Math.abs((BS_DR_Total + NetIncome) - BS_CR_Total) > acceptableError) {
                // If Net Income is not added to the correct side, this will fail.
            }

            return valid;
        };

        const validateJournalEntries = (type) => {
            let valid = true;
            let correctEntries = [];

            if (type === 'ADJ') {
                correctEntries = state.adjustments.map(adj => ({
                    dr_acc: adj.dr,
                    cr_acc: adj.cr,
                    dr_amt: adj.amount,
                    cr_amt: adj.amount,
                }));
            } else if (type === 'CLS') {
                const data = calculateFSFromWorksheet();
                const totalRevenue = data.totalRevenue;
                const totalExpenses = data.totalExpenses;
                const netIncome = data.netIncome;
                const withdrawals = data.accountMap.get('A, Withdrawals').ATB_DR;

                // 1. Close Revenue
                correctEntries.push({ dr_acc: 'Service Revenue', cr_acc: 'Income Summary', dr_amt: totalRevenue, cr_amt: totalRevenue });
                // 2. Close Expenses
                correctEntries.push({ dr_acc: 'Income Summary', cr_acc: 'Various Expenses', dr_amt: totalExpenses, cr_amt: totalExpenses }); // Use 'Various Expenses' or specific ones
                // 3. Close Income Summary
                correctEntries.push({ dr_acc: netIncome > 0 ? 'Income Summary' : 'A, Capital', cr_acc: netIncome > 0 ? 'A, Capital' : 'Income Summary', dr_amt: Math.abs(netIncome), cr_amt: Math.abs(netIncome) });
                // 4. Close Withdrawals
                correctEntries.push({ dr_acc: 'A, Capital', cr_acc: 'A, Withdrawals', dr_amt: withdrawals, cr_amt: withdrawals });
            } else if (type === 'REV') {
                // Identify reversing entries: Accruals and deferrals recorded using the Income Statement method (P&L method)
                // A. Prepaid Rent (Deferral/Asset method) - Reversing is appropriate
                // B. Salaries Payable (Accrual) - Reversing is appropriate
                // C. Accrued Service Revenue (Accrual) - Reversing is appropriate
                const adjMap = new Map(state.adjustments.map(adj => [adj.desc, adj]));

                // Reverse B (Prepaid Rent: Rent Exp DR / Prepaid Rent CR) -> Prepaid Rent DR / Rent Exp CR
                const adjB = adjMap.get("B. One month of rent has expired. (Prepaid Rent was for 6 months, dated Dec 1)");
                correctEntries.push({ dr_acc: adjB.cr, cr_acc: adjB.dr, dr_amt: adjB.amount, cr_amt: adjB.amount });
                // Reverse D (Accrued Salaries: Salaries Exp DR / Salaries Payable CR) -> Salaries Payable DR / Salaries Exp CR
                const adjD = adjMap.get("D. Accrued salaries not yet paid, ₱ 8,000.");
                correctEntries.push({ dr_acc: adjD.cr, cr_acc: adjD.dr, dr_amt: adjD.amount, cr_amt: adjD.amount });
                // Reverse F (Accrued Revenue: Accrued Service Revenue DR / Service Revenue CR) -> Service Revenue DR / Accrued Service Revenue CR
                const adjF = adjMap.get("F. Services rendered but unbilled/uncollected (Accrued Revenue), ₱ 4,000. (Using Accrued Service Revenue account for clarity)");
                correctEntries.push({ dr_acc: adjF.cr, cr_acc: adjF.dr, dr_amt: adjF.amount, cr_amt: adjF.amount });

                // Set minimum required to pass to 2-3 (as the student might miss one)
                if (state.journalEntries[type].length < 2) {
                    renderMessageBox("There must be at least 2 reversing entries.", true);
                    return false;
                }
            }


            const studentEntries = state.journalEntries[type].filter(e => e && e.dr_acc && e.cr_acc && e.dr_amt === e.cr_amt && e.dr_amt > 0);

            if (type === 'ADJ' && studentEntries.length !== correctEntries.length) {
                renderMessageBox(`Expected ${correctEntries.length} adjusting entries, found ${studentEntries.length} valid entries.`, true);
                return false;
            }

            if (type === 'CLS' && studentEntries.length !== correctEntries.length) {
                renderMessageBox(`Expected ${correctEntries.length} closing entries, found ${studentEntries.length} valid entries.`, true);
                return false;
            }

            // Simple validation: check if total DR/CR is correct
            let studentTotalDR = studentEntries.reduce((sum, e) => sum + e.dr_amt, 0);
            let correctTotalDR = correctEntries.reduce((sum, e) => sum + e.dr_amt, 0);

            if (Math.abs(studentTotalDR - correctTotalDR) > 5) { // Allow slight buffer for minor rounding if needed, but for whole numbers, it should match.
                renderMessageBox(`The total value of your ${type} entries (₱ ${studentTotalDR.toLocaleString()}) does not match the expected total (₱ ${correctTotalDR.toLocaleString()}).`, true);
                return false;
            }

            return valid;
        };

        const validatePCTB = () => {
            const data = calculateFSFromWorksheet();
            const accounts = data.BSAccounts;
            const endingCapital = data.endingCapital;
            const acceptableError = 0.01;

            let valid = true;
            let inputDRTotal = 0;
            let inputCRTotal = 0;

            accounts.forEach(acc => {
                const input = state.pctbInputs[acc.name] || { DR: 0, CR: 0 };
                let correctBalance = 0;
                let isCredit = false;

                if (acc.name === 'A, Capital') {
                    correctBalance = endingCapital;
                    isCredit = true;
                } else {
                    correctBalance = Math.abs(acc.ATB_DR - acc.ATB_CR);
                    isCredit = acc.ATB_CR > acc.ATB_DR;
                }

                const inputBalance = input.DR - input.CR;

                if (Math.abs(inputBalance - (isCredit ? -correctBalance : correctBalance)) > acceptableError) {
                    console.error(`PCTB error for ${acc.name}. Expected: ${correctBalance} ${isCredit ? 'CR' : 'DR'} / Input: ${inputBalance}`);
                    valid = false;
                }

                inputDRTotal += input.DR;
                inputCRTotal += input.CR;
            });

            if (Math.abs(inputDRTotal - inputCRTotal) > acceptableError || inputDRTotal === 0) {
                 console.error(`PCTB final totals do not match. DR: ${inputDRTotal}, CR: ${inputCRTotal}`);
                 valid = false;
            }

            return valid;
        };

        // --- MAIN RENDERER ---

        const renderStep = () => {
            const stepTitles = [
                renderStudentInfo,
                renderWorksheet,
                renderFinancialStatements,
                renderAdjustingEntries,
                renderClosingEntries,
                renderPCTB,
                renderReversingEntries,
                renderCompletion
            ];

            const currentStepFunction = stepTitles[state.currentStep];
            if (currentStepFunction) {
                currentStepFunction();
                document.querySelector('h1').innerText = `Accounting Cycle Performance Task - ${getStepTitle(state.currentStep)}`;
            } else {
                document.getElementById('task-container').innerHTML = `<div class="text-center py-10 text-xl text-red-600">Error: Task step not found.</div>`;
            }

             // Disable the next button until input is provided for journal/pctb steps
             const btn = document.getElementById('next-step-btn');
             if (state.currentStep >= 3 && state.currentStep <= 6) {
                 btn.disabled = false; // Trusting the validation to catch empty inputs
             } else if (state.currentStep === 0) {
                 btn.disabled = false;
             } else if (state.currentStep === 1 || state.currentStep === 2) {
                 btn.disabled = false;
             }
        };

        // Initialize the app on load
        window.onload = () => {
            renderStep();
        };

        // Expose functions to the global scope for use in HTML attributes
        window.handleNextStep = handleNextStep;
        window.saveWorksheetInput = saveWorksheetInput;
        window.saveJournalInput = saveJournalInput;
        window.savePCTBInput = savePCTBInput;
        window.addJournalEntryInput = addJournalEntryInput;
    </script>
</body>
</html>
