<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; display: flex; gap: 20px; }
    #leftPanel { flex: 1; }
    #rightPanel {
      flex: 1;
      max-height: 80vh;
      overflow-y: auto;
      border-left: 2px solid #ccc;
      padding-left: 20px;
    }
    .result-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .question-block {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    .correct { color: #28a745; }
    .incorrect { color: #d9534f; }
    .explanation { font-style: italic; margin-top: 5px; color: #555; }
  </style>
</head>
<body>
  <div id="leftPanel">
    <h2>Teacher Dashboard</h2>
    <label for="studentFilter">Filter by Student ID:</label><br>
    <input type="text" id="studentFilter" placeholder="e.g. 50-VILLARTA-Joselito"><br><br>

    <label for="quizFilter">Filter by Quiz Title:</label><br>
    <input type="text" id="quizFilter" placeholder="e.g. FABM 1 Midterm"><br><br>

    <button onclick="loadResults()">Load Results</button>
    <div id="resultsContainer"></div>
  </div>

  <div id="rightPanel">
    <h3>üìÑ Test Paper Preview</h3>
    <div id="previewContainer">Select a result to view answers.</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
      authDomain: "jlvcpa-quizzes.firebaseapp.com",
      projectId: "jlvcpa-quizzes",
      storageBucket: "jlvcpa-quizzes.firebasestorage.app",
      messagingSenderId: "629158256557",
      appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadResults() {
      const studentFilter = document.getElementById("studentFilter").value.trim();
      const quizFilter = document.getElementById("quizFilter").value.trim();
      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      const snapshot = await db.collection("results").get();

      snapshot.forEach(doc => {
        const studentId = doc.id;
        const data = doc.data();

        if (studentFilter && !studentId.includes(studentFilter)) return;

        Object.entries(data).forEach(([quizId, result]) => {
          if (quizFilter && !result.quizTitle.includes(quizFilter)) return;

          const div = document.createElement("div");
          div.className = "result-block";
          div.innerHTML = `
            <strong>${result.quizTitle}</strong><br>
            Student: ${studentId}<br>
            Score: ${result.score}<br>
            Grade: ${result.grade}<br>
            Submitted: ${new Date(result.timestamp).toLocaleString()}<br>
            <button onclick="viewAnswers('${studentId}', '${quizId}')">View Answers</button>
          `;
          container.appendChild(div);
        });
      });
    }

    async function viewAnswers(studentId, quizId) {
      const docSnap = await db.collection("results").doc(studentId).get();
      const resultData = docSnap.data()[quizId];
      const container = document.getElementById("previewContainer");
      container.innerHTML = "";

      if (!resultData.questions || !Array.isArray(resultData.questions)) {
        container.innerHTML = "<p>No question data available in this result.</p>";
        return;
      }

      resultData.questions.forEach((q, i) => {
        const userAnswer = resultData.responses[i];
        const isCorrect = userAnswer === q.answer;
        const label = ['A', 'B', 'C', 'D'];
        const correctLabel = label[q.options.indexOf(q.answer)];
        const userLabel = label[q.options.indexOf(userAnswer)];

        const block = document.createElement("div");
        block.className = "question-block";
        block.innerHTML = `
          <strong>Q${i + 1}:</strong> ${q.question}<br>
          ${q.options.map((opt, idx) => `<div>${label[idx]}. ${opt}</div>`).join('')}
          <div class="${isCorrect ? 'correct' : 'incorrect'}">
            Answered: ${userLabel || '‚Äî'} ${isCorrect ? '‚úîÔ∏è' : `‚ùå (Correct: ${correctLabel})`}
          </div>
          ${q.explanation ? `<div class="explanation">Explanation: ${q.explanation}</div>` : ''}
        `;
        container.appendChild(block);
      });
    }
  </script>
</body>
</html>
