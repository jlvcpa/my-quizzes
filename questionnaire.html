<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Questionnaire</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="header">
      <h1>Questionnaire</h1>
      <div id="idle-warning" style="color: red; font-weight: bold;"></div>
      <div id="timer">Time Remaining: <span id="time">30:00</span></div>
      <button id="submit-btn" style="position: absolute; top: 10px; left: 10px;">Submit</button>
    </div>

    <div id="question-box">
      <!-- Questions will be injected here -->
    </div>

    <div id="navigation">
      <button id="prev-btn" style="font-size: 1.2em;">Previous</button>
      <button id="next-btn" style="font-size: 1.2em;">Next</button>
    </div>
  </div>

  <script>
    (function () {
      // ðŸ”¥ Firebase Configuration
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ðŸ“§ EmailJS Initialization
      emailjs.init("YOUR_EMAILJS_USER_ID");

      // ðŸ§  Variables
      let questions = [];
      let currentIndex = 0;
      let answers = {};
      let idleTime = 0;
      let timerInterval;
      let idleInterval;
      const totalTime = 30 * 60;
            // ðŸ”„ Load Questions Dynamically from Firestore
      function loadQuestions() {
        db.collection("questionBank").orderBy("topic").get().then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.text && data.options && data.id) {
              questions.push(data);
            }
          });
          renderQuestion();
        }).catch(err => {
          console.error("Error loading questions:", err);
        });
      }

      // ðŸ§ª Render Current Question
      function renderQuestion() {
        const q = questions[currentIndex];
        const box = document.getElementById("question-box");
        box.innerHTML = `
          <h2>${q.topic ? `[${q.topic}]` : ""} ${q.text}</h2>
          ${q.options.map((opt, i) => `
            <label>
              <input type="radio" name="answer" value="${opt}" ${answers[q.id] === opt ? "checked" : ""}/>
              ${opt}
            </label><br/>
          `).join("")}
        `;
      }

      // ðŸ§¾ Log Activity
      function logActivity(action) {
        db.collection("activityLogs").add({
          timestamp: new Date(),
          action,
          questionId: questions[currentIndex]?.id || null
        });
      }

      // â±ï¸ Start Timer
      function startTimer() {
        let timeLeft = totalTime;
        timerInterval = setInterval(() => {
          timeLeft--;
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          document.getElementById("time").textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            submitAnswers();
          }
        }, 1000);
      }

      // ðŸ’¤ Idle Monitor
      function startIdleMonitor() {
        idleInterval = setInterval(() => {
          idleTime++;
          if (idleTime >= 60) {
            document.getElementById("idle-warning").textContent = "You've been idle for a while!";
          }
        }, 1000);

        ["mousemove", "keydown", "click"].forEach(evt =>
          document.addEventListener(evt, () => {
            idleTime = 0;
            document.getElementById("idle-warning").textContent = "";
          })
        );
      }
            // âœ… Navigation Buttons
      document.getElementById("next-btn").addEventListener("click", () => {
        const selected = document.querySelector("input[name='answer']:checked");
        if (selected) {
          answers[questions[currentIndex].id] = selected.value;
          localStorage.setItem("quizAnswers", JSON.stringify(answers));
        }
        if (currentIndex < questions.length - 1) {
          currentIndex++;
          renderQuestion();
          logActivity("Next");
        }
      });

      document.getElementById("prev-btn").addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderQuestion();
          logActivity("Previous");
        }
      });

      // ðŸ“¤ Submit Answers
      function submitAnswers() {
        const attemptId = `attempt_${Date.now()}`;
        const payload = {
          answers,
          timestamp: new Date(),
          attemptId
        };

        db.collection("submissions").doc(attemptId).set(payload).then(() => {
          emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
            attempt_id: attemptId,
            message: JSON.stringify(answers)
          });

          localStorage.removeItem("quizAnswers");
          window.location.href = `results.html?attempt=${attemptId}`;
        }).catch(err => {
          console.error("Submission failed:", err);
        });
      }

      // ðŸ” Resubmit Tool: Recover from localStorage
      window.addEventListener("load", () => {
        const saved = localStorage.getItem("quizAnswers");
        if (saved) {
          answers = JSON.parse(saved);
        }
      });

      // ðŸ§¹ Submit Button
      document.getElementById("submit-btn").addEventListener("click", submitAnswers);

      // ðŸš€ Initialize
      loadQuestions();
      startTimer();
      startIdleMonitor();
    })();
  </script>
</body>
</html>
