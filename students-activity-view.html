<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Challenge UI</title>
  <style>
  body {
    font-family: Arial, sans-serif;
    padding: 1em;
    background: #f9f9f9;
    max-width: 600px;
    margin: auto;
  }

  #loginPanel, #activityPanel {
    background: white;
    padding: 1em;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-bottom: 1em;
  }

  #questionPanel {
    margin-top: 1em;
    padding: 1em;
    background: #fffbe6;
    border: 2px solid #ffd700;
    border-radius: 8px;
    text-align: center;
  }

  #questionText {
    font-size: 2em;
    font-weight: bold;
    margin: 1em 0;
  }

  #timerDisplay {
    font-size: 1.2em;
    font-weight: bold;
    color: #d00;
    margin-bottom: 0.5em;
  }

  #answerPanel {
    margin-top: 1em;
  }

  #submitBtn {
    display: block;
    margin: 0 auto 1em auto;
    padding: 0.8em 1.5em;
    font-size: 1em;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #submitBtn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .effectsGroup {
    margin-top: 0.5em;
  }

  .effectRow {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
    margin-left: 1em;
    margin-top: 0.3em;
  }

  .fieldGroup {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-width: 120px;
  }

  .fieldGroup label {
    margin-bottom: 0.2em;
    font-size: 0.9em;
  }

  .fieldGroup select,
  .fieldGroup input {
    padding: 0.3em;
    font-size: 0.95em;
  }

  .groupLabel {
    font-weight: bold;
    margin-bottom: 0.2em;
    display: block;
    font-size: 1em;
  }

  @media (min-width: 600px) {
    .effectRow {
      flex-wrap: nowrap;
      gap: 1em;
    }

    .fieldGroup {
      min-width: 150px;
    }
  }
</style>
</head>
<body>

<!-- üîê Login Panel -->
<div id="loginPanel">
  <h2>Student Login</h2>
  <form id="studentLoginForm">
    <input type="text" id="Idnumber" placeholder="Your ID number" required /><br><br>
    <input type="text" id="sectionCode" placeholder="Section code" required /><br><br>
    <input type="password" id="passWord" placeholder="Your password" required /><br><br>
    <button type="submit">Login</button>
  </form>
</div>

<!-- üéØ activity Panel -->
<div id="activityPanel" style="display:none;">
  <button id="submitBtn" disabled>Submit Answer</button>

  <div id="questionPanel">
    <div id="timerDisplay">Remaining Time: -- seconds</div>
    <div id="questionText">Waiting for an active activity...</div>
    <button id="prevBtn">‚¨ÖÔ∏è Prev</button>
    <button id="nextBtn">Next ‚û°Ô∏è</button>
  </div>

  <div id="answerPanel" style="display: flex; flex-direction: column; gap: 1em;">
  <!-- üìù Constructed Response Panel -->
  <div id="constructedResponsePanel">
    <textarea id="answerInput" rows="10" style="width:100%;" placeholder="Type your answer here..." disabled></textarea>
  </div>

  <!-- üß© Structured Effects Panel -->
  <div id="effectsPanel">
    <div>
      <label for="typeSelect">Type:</label>
      <select id="typeSelect" disabled></select>
    </div>

    <div id="effectsRowsContainer">
      <!-- Dynamic rows will be added here -->
    </div>

    <button id="addEffectRowBtn" disabled>‚ûï Add Effect Row</button>
  </div>
</div>
</div>

<!-- üîß Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, collection, getDocs, setDoc
  } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
    authDomain: "jlvcpa-quizzes.firebaseapp.com",
    projectId: "jlvcpa-quizzes",
    storageBucket: "jlvcpa-quizzes.appspot.com",
    messagingSenderId: "629158256557",
    appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener("DOMContentLoaded", () => {
    
    // üîÄ Shuffle utility
    const shuffleArray = array =>
      array.map(item => ({ item, sortKey: Math.random() }))
           .sort((a, b) => a.sortKey - b.sortKey)
           .map(({ item }) => item);

    // üß≠ DOM elements
    const loginForm = document.getElementById("studentLoginForm");
    const loginStatus = document.createElement("p");
    loginForm.appendChild(loginStatus);

    const questionText = document.getElementById("questionText");
    const activityPanel = document.getElementById("activityPanel");
    const loginPanel = document.getElementById("loginPanel");

    const answerInput = document.getElementById("answerInput");
    const typeSelect = document.getElementById("typeSelect");
    const addEffectRowBtn = document.getElementById("addEffectRowBtn");
    const submitBtn = document.getElementById("submitBtn");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    let shuffledQuestions = [];
    let currentStudent = null;
    let currentQuestionIndex = 0;
    let activityResultsData = {};
    let title = "";
    let attendanceId = "";

    typeSelect.addEventListener("change", updateConstructedResponse);
    addEffectRowBtn.addEventListener("click", () => addEffectRow());

    submitBtn.addEventListener("click", async () => {
      await submitStudentAnswer();
    });

    prevBtn.addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion(currentQuestionIndex);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQuestionIndex < shuffledQuestions.length - 1) {
        currentQuestionIndex++;
        displayQuestion(currentQuestionIndex);
      }
    });

    function displayQuestion(index) {
      const q = shuffledQuestions[index];
      questionText.textContent = q?.question || "‚ùì Question text missing.";
      prevBtn.disabled = index === 0;
      nextBtn.disabled = index === shuffledQuestions.length - 1;
      typeSelect.value = "";
      document.getElementById("effectsRowsContainer").innerHTML = "";

      const storedAnswer = q?.studentAnswer;
      if (storedAnswer?.type) typeSelect.value = storedAnswer.type;
      if (Array.isArray(storedAnswer?.effects)) {
        storedAnswer.effects.forEach(effect => {
          addEffectRow(effect.element, effect.account, effect.isDebitCredit, effect.amount);
        });
      }
    }

    async function validateStudent(id, password, sectionCode) {
      const attendanceRef = doc(db, "attendance", sectionCode);
      const attendanceSnap = await getDoc(attendanceRef);
      if (!attendanceSnap.exists()) throw new Error("Attendance record not found.");

      const student = attendanceSnap.data().students.find(s =>
        s.Idnumber === id && s.passWord === password
      );

      if (!student) throw new Error("Invalid credentials.");
      if (student.status === "A") throw new Error("Marked absent.");

      attendanceId = sectionCode;
      return student;
    }

    async function findActiveActivity(sectionCode) {
      const activitiesSnap = await getDocs(collection(db, "activities"));
      const now = Date.now();
      let matchedActivity = null;

      activitiesSnap.forEach(doc => {
        const activityId = doc.id;
        const data = doc.data();
        if (activityId.endsWith(`_${sectionCode}`)) {
          const endTimeMillis = new Date(data.endTime).getTime();
          if (endTimeMillis > now) {
            matchedActivity = data;
            title = data.title || "Untitled";
            activityResultsData = data;
          }
        }
      });

      if (!matchedActivity) throw new Error("No active activity found.");
      return matchedActivity;
    }

    function startActivity(questions) {
      if (!questions || questions.length === 0) {
        questionText.textContent = "‚ùå No questions found in this activity.";
        return;
      }

      shuffledQuestions = shuffleArray(questions);
      currentQuestionIndex = 0;
      displayQuestion(currentQuestionIndex);

      loginPanel.style.display = "none";
      activityPanel.style.display = "block";

      answerInput.disabled = false;
      typeSelect.disabled = false;
      addEffectRowBtn.disabled = false;
      submitBtn.disabled = false;

      setupAutoSubmit(new Date(activityResultsData.endTime).getTime());
    }

    function extractAndRenderMetadata(questions) {
      const types = new Set();
      const elements = new Set();
      const accounts = new Set();
      const isDebitCredit = new Set();

      questions.forEach(q => {
        const answersArray = Array.isArray(q.answer) ? q.answer : [q.answer];
        answersArray.forEach(a => {
          if (a?.type) types.add(a.type);
          if (a?.account) accounts.add(a.account);
          if (a?.element) elements.add(a.element);
          if (a?.isDebitCredit) isDebitCredit.add(a.isDebitCredit);
          if (Array.isArray(a.effects)) {
            a.effects.forEach(effect => {
              if (effect?.element) elements.add(effect.element);
              if (effect?.account) accounts.add(effect.account);
              if (effect?.isDebitCredit) isDebitCredit.add(effect.isDebitCredit);
            });
          }
        });
      });

      populateSelect("typeSelect", [...types].sort());
      window.availableElements = [...elements].sort();
      window.availableAccounts = [...accounts].sort();
      window.availableisDebitCredit = [...isDebitCredit].sort();
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("Idnumber").value.trim();
      const sectionCode = document.getElementById("sectionCode").value.trim();
      const password = document.getElementById("passWord").value.trim();

      loginStatus.textContent = "üîç Validating...";
      try {
        currentStudent = await validateStudent(id, password, sectionCode);
        loginStatus.textContent = "‚úÖ Login successful. Checking for activity...";
        const activity = await findActiveActivity(sectionCode);
        const questions = activity.questions || [];
        startActivity(questions);
        extractAndRenderMetadata(questions);
      } catch (err) {
        console.error("üî• Error:", err.message);
        loginStatus.textContent = `üö´ ${err.message}`;
      }
    });

    function populateSelect(selectId, options, selectedValue = "") {
      const select = document.getElementById(selectId);
      select.innerHTML = "";
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "Select from options";
      defaultOption.disabled = true;
      defaultOption.selected = selectedValue === "";
      select.appendChild(defaultOption);

      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        if (opt === selectedValue) option.selected = true;
        select.appendChild(option);
      });
    }

    function addEffectRow(elementValue = "", accountValue = "", isDebitCreditValue = "", amountValue = "") {
      const container = document.getElementById("effectsRowsContainer");
      const row = document.createElement("div");
      row.className = "effectRow";
      row.style.display = "flex";
      row.style.gap = "0.02em";
      row.style.marginTop = "0.05em";
      row.style.alignItems = "center";

      row.innerHTML = `
        <label>Effect:</label>
        <select class="elementSelect">
          <option value="" disabled ${elementValue === "" ? "selected" : ""}>Increase or Decrease</option>
          ${window.availableElements.map(e => `<option value="${e}" ${e === elementValue ? "selected" : ""}>${e}</option>`).join("")}
        </select>
        <select class="accountSelect">
          <option value="" disabled ${accountValue === "" ? "selected" : ""}>
          Which account?</option>
          ${window.availableAccounts.map(a => `<option value="${a}" ${a === accountValue ? "selected" : ""}>${a}</option>`).join("")}
        </select>
        <select class="isDebitCreditSelect" style="width: 8em;">
          <option value="" disabled ${isDebitCreditValue === "" ? "selected" : ""}>Debit or Credit</option>
          ${window.availableisDebitCredit.map(dc => `<option value="${dc}" ${dc === isDebitCreditValue ? "selected" : ""}>${dc}</option>`).join("")}
        </select>
        <input
          type="text"
          class="amountInput"
          placeholder="0.00"
          value="${amountValue}"
          style="width: 8em; min-width: 3em; padding: 0.02em 0.02em; font-size: 0.9em; text-align: right;"
        />
      `;

      container.appendChild(row);

      row.querySelector(".elementSelect").addEventListener("change", updateConstructedResponse);
      row.querySelector(".accountSelect").addEventListener("change", updateConstructedResponse);
      row.querySelector(".isDebitCreditSelect").addEventListener("change", updateConstructedResponse);
      row.querySelector(".amountInput").addEventListener("blur", updateConstructedResponse);
    }

    function updateConstructedResponse() {
      const formatted = formatStructuredAnswerForStudent();
      document.getElementById("answerInput").value = formatted;
    }

    function formatStructuredAnswerForStudent() {
      const type = document.getElementById("typeSelect").value;
      const rows = document.querySelectorAll(".effectRow");

      const effects = Array.from(rows).map(row => {
        const element = row.querySelector(".elementSelect").value;
        const account = row.querySelector(".accountSelect").value;
        const isDebitCredit = row.querySelector(".isDebitCreditSelect").value;
        const amount = row.querySelector(".amountInput").value;
        return `Effect: ${element}, ${account}, ${isDebitCredit}, ${formatAmount(amount)}`;
      });

      const debits = [];
      const credits = [];

      rows.forEach(row => {
        const account = row.querySelector(".accountSelect").value;
        const isDebitCredit = row.querySelector(".isDebitCreditSelect").value;
        const amount = formatAmount(row.querySelector(".amountInput").value);

        if (isDebitCredit === "Debit") {
          debits.push({ account, amount });
        } else {
          credits.push({ account, amount });
        }
      });

      const debitLines = debits.map(entry => {
        const drIndent = " ".repeat(5);
        const spacing = " ".repeat(30);
        return `${drIndent}${entry.account}${spacing}${entry.amount}`;
      });

      const longestDebitLine = debitLines.reduce((max, line) => line.length > max.length ? line : max, "");
      const creditAmountColumn = longestDebitLine.length;

      const creditLines = credits.map(entry => {
        const crIndent = " ".repeat(10);
        const spaceToAmount = " ".repeat(Math.max(0, creditAmountColumn - (crIndent.length + entry.account.length)));
        return `${crIndent}${entry.account}${spaceToAmount}${entry.amount}`;
      });

      const memoIndent = " ".repeat(13);
      const memoText = shuffledQuestions[currentQuestionIndex]?.question || "Memo not available";
      const memoLine = `${memoIndent}${memoText}`;

      const journalBlock = [...debitLines, ...creditLines, memoLine].join("\n");

      return `Type: ${type}\n${effects.join("\n")}\n\nJournal Entry:\n${journalBlock}`;
    }

    function formatAmount(value) {
      const num = parseFloat(value.replace(/,/g, ""));
      if (isNaN(num)) return "0.00";
      return num.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function assembleStudentAnswer() {
      const type = document.getElementById("typeSelect").value;
      const rows = document.querySelectorAll(".effectRow");

      const effects = Array.from(rows).map(row => ({
        element: row.querySelector(".elementSelect").value,
        account: row.querySelector(".accountSelect").value,
        isDebitCredit: row.querySelector(".isDebitCreditSelect").value,
        amount: formatAmount(row.querySelector(".amountInput").value)
      }));

      return { type, effects };
    }

    function calculateScore() {
      const currentQuestion = shuffledQuestions[currentQuestionIndex];
      const correctAnswers = Array.isArray(currentQuestion?.answer) ? currentQuestion.answer : [currentQuestion.answer];
      const studentType = document.getElementById("typeSelect").value;
      const rows = document.querySelectorAll(".effectRow");

      let score = 0;

      if (correctAnswers.some(ans => ans.type === studentType)) {
        score += 1;
      }

      const rowScores = Array.from(rows).map(row => {
        const element = row.querySelector(".elementSelect").value;
        const account = row.querySelector(".accountSelect").value;
        const isDebitCredit = row.querySelector(".isDebitCreditSelect").value;
        const amount = formatAmount(row.querySelector(".amountInput").value);

        const matchingAnswers = correctAnswers.filter(ans => ans.isDebitCredit === isDebitCredit);
        let maxRowScore = 0;

        matchingAnswers.forEach(ans => {
          let rowScore = 0;
          if (ans.element === element) rowScore += 1;
          if (ans.account === account) rowScore += 1;
          if (ans.isDebitCredit === isDebitCredit) rowScore += 1;
          if (formatAmount(ans.amount) === amount) rowScore += 1;
          maxRowScore = Math.max(maxRowScore, rowScore);
        });

        return { isDebitCredit, score: maxRowScore };
      });

      const allDebit = rowScores.every(r => r.isDebitCredit === "Debit");
      const allCredit = rowScores.every(r => r.isDebitCredit === "Credit");

      if (allDebit || allCredit) {
        score += Math.max(...rowScores.map(r => r.score));
      } else {
        score += rowScores.reduce((sum, r) => sum + r.score, 0);
      }

      return score;
    }

    function getLetterGrade(score, totalItems) {
      const percentage = (score / totalItems) * 100;
      if (percentage >= 95) return "A";
      if (percentage >= 85) return "P";
      if (percentage >= 75) return "D";
      return "IR";
    }

    function updateSubmitButtonState() {
      const allAnswered = shuffledQuestions.every(q => q.studentAnswer);
      submitBtn.disabled = !allAnswered;
    }

    function setupAutoSubmit(endTimeMillis) {
      const now = Date.now();
      const delay = endTimeMillis - now;
      if (delay > 0) {
        setTimeout(() => {
          if (!submitBtn.disabled) {
            submitBtn.click();
          }
        }, delay);
      }
    }

    async function submitStudentAnswer() {
      const currentQuestion = shuffledQuestions[currentQuestionIndex];
const studentId = currentStudent.Idnumber;
const studentCN = currentStudent.CN;
const studentLastName = currentStudent.LastName;
const studentFirstName = currentStudent.firstName;

      const selectedAnswer = assembleStudentAnswer();
      const score = calculateScore();
      const totalItems = 1 + (Array.isArray(currentQuestion.answer) ? currentQuestion.answer.length * 4 : 4);
      const letterGrade = getLetterGrade(score, totalItems);

      const recordId = `${studentCN}-${studentId}-${studentLastName}-${studentFirstName}`;
      const resultsId = `${title}_${attendanceId}_results`;

      const studentAnswerRecord = {
        questionID: currentQuestion.questionID,
        question: currentQuestion.question,
        competency: currentQuestion.competency,
        topic: currentQuestion.topic,
        explanation: currentQuestion.explanation,
        testType: currentQuestion.testType,
        answerkey: currentQuestion.answer,
        studentAnswers: selectedAnswer,
        score,
        letterGrade,
        ReadablesubmittedAt: new Date().toISOString()
      };

      const resultRef = doc(db, "activityResults", resultsId);
      try {
        await setDoc(resultRef, {
          ...activityResultsData,
          students: {
            [recordId]: {
              ...activityResultsData.students?.[recordId],
              answers: {
                ...(activityResultsData.students?.[recordId]?.answers || {}),
                [currentQuestionIndex]: studentAnswerRecord
              }
            }
          }
        }, { merge: true });

        console.log("‚úÖ Submitted:", studentAnswerRecord);
        updateSubmitButtonState();
      } catch (err) {
        console.error("‚ùå Submission error:", err);
      }
    }
  });


</script>
</body>
</html>
