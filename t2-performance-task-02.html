<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">T2 Performance Task 02</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* REMOVE UP/DOWN ARROWS (SPINNERS) */
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }

        /* Style for inputs in tables */
        .table-input {
            width: 100%;
            padding: 4px;
            padding-right: 22px; /* Make space for the icon so it doesn't cover digits */
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right; /* Right-align amounts */
            font-size: 0.85rem; /* Base font size */
            background-color: #f0f9ff; /* light blue background for input areas */
        }
        .text-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: #f0f9ff;
        }
        .fs-input {
            border: 1px solid #9ca3af;
            background-color: #f9fafb;
            padding: 4px 8px;
            padding-right: 22px; /* Make space for the icon */
            text-align: right;
            border-radius: 6px;
            font-weight: 500;
            width: 100%; /* Adjusted to fill container */
            font-size: 0.85rem; /* Base font size */
        }
        .header-bg { background-color: #0f172a; color: white; }
        .footer-bg { background-color: #334155; color: white; }
        
        .validation-icon {
            font-weight: bold;
            font-size: 1rem;
            pointer-events: none; /* Allows clicks to go through to the input */
            background-color: rgba(255,255,255,0.7); /* Slight backing to ensure visibility */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Style the rubric for better visibility */
        .rubric-box p, .rubric-box table {
            line-height: 1.4;
        }

        /* Custom Print Footer Styling */
        #print-footer-content { display: none; }

        /* Print-specific styles */
        @media print {
            .no-print { display: none !important; }
            /* Set margin to 0.25in and center horizontally */
            .printable-area { 
                width: 100% !important; 
                max-width: 100% !important;
                margin: 0 !important; 
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            /* Layout for Task 2 Horizontal Alignment in Print */
            .task2-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr !important;
                gap: 10px !important;
            }

            body { background-color: white; color: black; margin-bottom: 2cm; } /* Margin bottom for fixed footer */
            .shadow-xl, .rounded-xl, .border { border: none !important; box-shadow: none !important; }
            .header-bg { background-color: #fff !important; color: #000 !important; border-bottom: 2px solid black !important; }
            .footer-bg { display: none !important; } /* Hide screen footer, show print footer */
            
            /* Force inputs to look like text */
            .table-input, .text-input, .fs-input {
                border: none !important;
                border-bottom: 1px solid #ccc !important; /* Keep underline for clarity */
                background-color: white !important;
                color: black !important;
                font-size: 7pt !important; 
                padding: 0 !important;
                padding-right: 15px !important;
            }
            
            /* Rubric specific print styles */
            .rubric-box {
                background-color: white !important;
                border: 1px solid black !important;
                page-break-inside: avoid;
            }
            .rubric-box table { border-color: black !important; }
            .rubric-box th, .rubric-box td { border-color: black !important; color: black !important; }

            /* Validation icons visible in print based on request */
            .validation-icon { display: block !important; position: absolute; right: 0; top: 2px; }

            /* Student info box */
            #student-print-info { display: block !important; border: 1px solid #000 !important; margin-bottom: 10px; }
            .print-text-sm { font-size: 9pt; }
            
            /* Instructions */
            #print-instructions { display: block !important; font-size: 8pt; margin-bottom: 10px; font-style: italic; }

            /* Score display above rubric */
            .score-display { display: block !important; text-align: right; font-weight: bold; margin-bottom: 5px; }

            /* Footer Logic */
            #print-footer-content {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 1.5cm;
                background: white;
                border-top: 1px solid #ccc;
                padding-top: 5px;
            }
            
            /* Ensure Task 1 and Task 2 are visible if we are in the final report mode */
            #final-report-container { display: block !important; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Timer Display -->
    <div id="timer-box" class="no-print bg-red-800 text-white p-3 rounded-lg shadow-xl mb-4 flex items-center justify-center font-mono text-lg font-bold">
        Task Time Remaining: <span id="countdown" class="ml-2 text-yellow-300">--:--:--</span>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="max-w-7xl mx-auto printable-area bg-white shadow-xl rounded-xl p-6 md:p-10 border border-gray-200">

        <header class="text-center mb-4 pb-4 border-b-4 border-indigo-600 header-bg rounded-t-lg p-4">
            <img src="./shs-adc-logo.png" alt="School Logo" class="mx-auto mb-2 h-20 w-auto" onerror="this.style.display='none'"/>
            <p class="text-sm mt-1">SY 2025-2026 | 2nd Semester</p>
            <h1 class="text-3xl md:text-4xl font-extrabold text-yellow-300 print:text-black">
                T2 Performance Task 02
            </h1>
            <h2 id="company-name" class="text-xl md:text-2xl font-semibold text-gray-200 mt-1 hidden print:block print:text-gray-800">[Company Name]</h2>
            <p class="text-sm font-light text-gray-400 mt-2 hidden print:block print:text-black">Sole Proprietorship Service Business | For the Year Ended December 31, 2024</p>
            <h3 id="task-header-title" class="text-xl font-bold text-white mt-4 hidden print:block print:text-black"></h3>
        </header>
        
        <!-- Student Info for Print -->
        <div id="student-print-info" class="no-print hidden mb-4 text-xs p-2 rounded w-full"></div>
        
        <!-- Instructions for Print -->
        <div id="print-instructions" class="hidden no-print text-gray-600">
             Instruction: Complete all required fields. Enter amounts with two decimal places but without commas. Round off centavos to the nearest peso.
        </div>

        <!-- Dynamic Content Area -->
        <div id="task-container">
            <!-- Javascript renders here -->
        </div>

        <!-- Feedback and Actions Area -->
        <div id="action-area" class="mt-8 pt-6 border-t border-gray-300 no-print flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <div id="message-box" class="text-lg font-medium text-gray-700 min-h-8"></div>
            <button id="next-step-btn" onclick="window.handleNextStep()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Login to Start Task
            </button>
        </div>

        <footer class="mt-8 pt-4 border-t-4 border-indigo-600 footer-bg rounded-b-lg p-4 text-center no-print">
            <p class="text-sm text-gray-400">
                Instruction: Complete all required fields. <br>
                Enter amounts with two decimal places but without commas. <br>
                Round off centavos to the nearest peso. <br>
                After validating each task, use the 'Print to PDF' option. <br>
                Version 2025.11.21 163650
            </p>
        </footer>

        <!-- PRINT FOOTER (Fixed on all pages in PDF) -->
        <div id="print-footer-content">
            <div class="flex justify-between items-end px-8 text-xs font-bold">
                <div class="text-left w-1/3">FABM 1</div>
                <div class="text-center w-1/3">
                    <div class="border border-black px-4 py-1 inline-block">
                        4Cs: Christ-centeredness, Competence, Character, Compassion
                    </div>
                </div>
                <div class="text-right w-1/3">Page <span class="page-number"></span></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Main Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // 1. Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
            authDomain: "jlvcpa-quizzes.firebaseapp.com",
            projectId: "jlvcpa-quizzes",
            storageBucket: "jlvcpa-quizzes.appspot.com",
            messagingSenderId: "629158256557",
            appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VALIDATION LOGIC FOR LOGIN ---
        async function validateStudentLogin(attendanceId, studentId) {
            if (!attendanceId || !studentId) return { success: false, message: "Missing Attendance ID or Student ID." };
            try {
                const docRef = doc(db, "attendance", attendanceId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) return { success: false, message: "Attendance Record not found." };
                const data = docSnap.data();
                const student = data.students.find(s => String(s.Idnumber) === String(studentId));
                if (!student) return { success: false, message: "ID Number not found." };
                
                const status = student.status || "";
                const isPresent = status.includes("✔") || status.includes("✓") || status.includes("✔️");
                if (isPresent) {
                    return {
                        success: true, message: "Student Verified",
                        data: { cn: student.CN || "", fullName: student.fullName || "", section: data.section || "", idNumber: studentId }
                    };
                } else {
                    return { success: false, message: "Student marked absent." };
                }
            } catch (error) {
                return { success: false, message: "Connection Error: " + error.message };
            }
        }

        async function saveExamResults(attendanceId, resultData) {
            const activityName = "T2 Performance Task 02";
            const collectionName = `results_${activityName}_${attendanceId}`;
            const info = resultData.studentInfo;
            const docName = `students.${info.classNumber}-students.${info.idNumber}-${info.fullName}`;
            const cleanData = JSON.parse(JSON.stringify(resultData, (k, v) => v === undefined ? null : v));
            try {
                await setDoc(doc(db, collectionName, docName), cleanData);
                await setDoc(doc(db, "results_list", collectionName), { created: new Date().toISOString() });
                return true;
            } catch (error) { throw error; }
        }

        // --- GRADING LOGIC ---
        const gradingCriteria = { A: {min:95}, P: {min:85}, D: {min:75}, IR: {min:0} };
        const calculateScoreAndGrade = (correct, total) => {
            if (total === 0) return { score: 0, total: 0, percentage: 0, grade: 'N/A' };
            const percentage = (correct / total) * 100;
            let grade = 'IR';
            if (percentage >= 95) grade = 'A';
            else if (percentage >= 85) grade = 'P';
            else if (percentage >= 75) grade = 'D';
            return { score: correct, total: total, percentage: Math.round(percentage * 10) / 10, grade: grade };
        };

        // --- STATE ---
        let state = {
            currentStep: 0, // 0: Login, 1: Task 1, 2: Task 2 (Full), 3: Complete
            attendanceId: "",
            studentInfo: null,
            initialTB: [],
            adjustments: [],
            worksheetInputs: {},
            fsInputs: { is: {}, sce: {}, bs: {} },
            validationAttempts: { 1: 0, 2: 0 }, // 1 for Task 1, 2 for Task 2 (Combined)
            task1Score: null,
            task2Score: null,
            newAccounts: []
        };

        // --- TIMER LOGIC ---
        window.examDurationMins = 0;
        let timerInterval = null;
        let timeRemainingSeconds = 0;

        window.disableAllInputs = () => {
            document.querySelectorAll('input, button, select').forEach(el => {
                if(el.id !== 'next-step-btn' && el.id !== 'login-btn') {
                    el.disabled = true;
                    el.classList.add('cursor-not-allowed', 'opacity-75');
                }
            });
        };

        function updateTimerDisplay() {
            const display = document.getElementById('countdown');
            const box = document.getElementById('timer-box');
            if (!display || timeRemainingSeconds === null) return;
            const h = Math.floor(timeRemainingSeconds / 3600);
            const m = Math.floor((timeRemainingSeconds % 3600) / 60);
            const s = timeRemainingSeconds % 60;
            display.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if (timeRemainingSeconds < 300) {
                box?.classList.remove('bg-red-800'); box?.classList.add('bg-red-600', 'animate-pulse');
            }
            if (timeRemainingSeconds <= 0) {
                stopTimer();
                display.textContent = "00:00:00";
                window.disableAllInputs();
                window.finishAndPreview(true);
            }
        }

        function stopTimer() { if (timerInterval) clearInterval(timerInterval); }
        function startTimer() {
            if (timerInterval) stopTimer();
            timeRemainingSeconds = window.examDurationMins * 60;
            updateTimerDisplay();
            timerInterval = setInterval(() => { timeRemainingSeconds--; updateTimerDisplay(); }, 1000);
        }

        const checkUrlParametersAndInit = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const attId = urlParams.get('att');
            const duration = urlParams.get('dur');
            if (!attId || !duration) {
                 document.getElementById('task-container').innerHTML = `<div class="text-center text-red-600 font-bold py-10">Missing Link Parameters.</div>`;
                 document.getElementById('next-step-btn').disabled = true;
                 return;
            }
            state.attendanceId = attId;
            window.examDurationMins = parseInt(duration);
            startTimer();
            renderStep();
        };

        window.finishAndPreview = async (isAutoSubmit = false) => {
            if (!state.studentInfo) return;
            
            // Calculate scores if not done
            if (!state.task1Score) state.task1Score = validateWorksheet(false).scoreData;
            if (!state.task2Score) state.task2Score = validateTask2Full(false).scoreData;

            renderMessageBox("Saving results...", false);
            stopTimer();

            try {
                await saveExamResults(state.attendanceId, {
                    studentInfo: state.studentInfo,
                    initialTB: state.initialTB,
                    adjustments: state.adjustments,
                    worksheetInputs: state.worksheetInputs,
                    fsInputs: state.fsInputs,
                    task1Score: state.task1Score,
                    task2Score: state.task2Score,
                    timestamp: new Date().toISOString()
                });
                state.currentStep = 3;
                renderStep();
            } catch (e) {
                renderMessageBox("Error saving: " + e.message, true);
                state.currentStep = 3; // Move anyway so they can print
                renderStep();
            }
        };

        // --- DATA GENERATION ---
        const rand = (min, max) => Math.round((Math.random() * (max - min) + min) / 1000) * 1000;
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        const generateDynamicData = () => {
            const name = getFamilyName();
            const cap = `${name}, Capital`;
            const withdr = `${name}, Withdrawals`;
            let tDr = 0, tCr = 0;
            
            const gen = [
                {name:'Cash',type:'asset',isFS:'BS',amount:rand(80000,150000)},
                {name:'Accounts Receivable',type:'asset',isFS:'BS',amount:rand(20000,50000)},
                {name:'Supplies',type:'asset',isFS:'BS',amount:rand(10000,30000)},
                {name:'Prepaid Rent',type:'asset',isFS:'BS',amount:rand(40000,80000)},
                {name:'Equipment',type:'asset',isFS:'BS',amount:rand(180000,250000)},
                {name:'Accumulated Depreciation-Equip.',type:'contra-asset',isFS:'BS',amount:rand(10000,40000)},
                {name:'Accounts Payable',type:'liability',isFS:'BS',amount:rand(10000,20000)},
                {name:'Unearned Service Revenue',type:'liability',isFS:'BS',amount:rand(5000,15000)},
                {name:withdr,type:'equity',isFS:'BS',amount:rand(40000,60000)},
                {name:'Service Revenue',type:'revenue',isFS:'IS',amount:rand(150000,250000)},
                {name:'Salaries Expense',type:'expense',isFS:'IS',amount:rand(25000,45000)},
                {name:'Utilities Expense',type:'expense',isFS:'IS',amount:rand(8000,12000)}
            ];

            gen.forEach(a => {
                if (['asset','expense'].includes(a.type) || a.name === withdr) tDr += a.amount;
                else tCr += a.amount;
            });
            
            let capAmt = tDr - tCr;
            if (capAmt < 100000) {
                gen.find(x=>x.name==='Service Revenue').amount += 150000;
                capAmt = tDr - (tCr + 150000);
            }

            const strict = ['Cash','Accounts Receivable','Supplies','Prepaid Rent','Equipment','Accumulated Depreciation-Equip.','Accounts Payable','Unearned Service Revenue',cap,withdr,'Service Revenue','Salaries Expense','Utilities Expense'];
            
            let final = [];
            strict.forEach(n => {
                let amt = 0;
                let type = ''; let isFS = '';
                if(n===cap) { amt = capAmt; type='equity'; isFS='BS'; }
                else {
                   let f = gen.find(x=>x.name===n);
                   amt = f.amount; type=f.type; isFS=f.isFS;
                }
                const isDr = ['asset','expense'].includes(type) || n===withdr;
                final.push({ name: n, type: type, isFS: isFS, TB_DR: isDr?amt:0, TB_CR: isDr?0:amt });
            });

            let drT=0, crT=0;
            final.forEach(x=>{drT+=x.TB_DR; crT+=x.TB_CR;});
            final.push({name:'Totals', TB_DR: drT, TB_CR: crT});
            state.initialTB = final;

            // Adjustments
            const sup = final.find(x=>x.name==='Supplies').TB_DR;
            const pre = final.find(x=>x.name==='Prepaid Rent').TB_DR;
            const un = final.find(x=>x.name==='Unearned Service Revenue').TB_CR;
            
            const aa = rand(Math.floor(sup*0.4), Math.floor(sup*0.7));
            const ab = Math.round(pre/randInt(6,12));
            const ac = rand(10000,20000);
            const ad = rand(5000,10000);
            const ae = rand(Math.floor(un*0.5), Math.floor(un*0.8));
            const af = rand(3000,7000);

            state.adjustments = [
                {desc:`A. Supplies on hand, Dec 31, ₱${formatPHP(sup-aa)}.`, dr:'Supplies Expense', cr:'Supplies', amount:aa},
                {desc:`B. One month rent expired.`, dr:'Rent Expense', cr:'Prepaid Rent', amount:ab},
                {desc:`C. Depreciation: ₱${formatPHP(ac)}.`, dr:'Depreciation Expense', cr:'Accumulated Depreciation-Equip.', amount:ac},
                {desc:`D. Accrued salaries: ₱${formatPHP(ad)}.`, dr:'Salaries Expense', cr:'Salaries Payable', amount:ad},
                {desc:`E. Unearned revenue earned: ₱${formatPHP(ae)}.`, dr:'Unearned Service Revenue', cr:'Service Revenue', amount:ae},
                {desc:`F. Accrued revenue: ₱${formatPHP(af)}.`, dr:'Accrued Service Revenue', cr:'Service Revenue', amount:af}
            ];

            state.newAccounts = [
                {name:'Accrued Service Revenue', type:'asset', isFS:'BS'},
                {name:'Salaries Payable', type:'liability', isFS:'BS'},
                {name:'Supplies Expense', type:'expense', isFS:'IS'},
                {name:'Rent Expense', type:'expense', isFS:'IS'},
                {name:'Depreciation Expense', type:'expense', isFS:'IS'}
            ];
        };

        const getFamilyName = () => state.studentInfo?.fullName?.split(',')[0]?.trim() || 'A';
        const formatPHP = (num) => (Math.round(num * 100) / 100).toLocaleString('en-US', {minimumFractionDigits: 2});
        const getAccountId = (name) => name.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
        
        // --- RENDERERS ---

        const renderMessageBox = (msg, isErr) => {
            const box = document.getElementById('message-box');
            box.className = `text-lg font-medium min-h-8 ${isErr ? 'text-red-600' : 'text-green-600'}`;
            box.innerHTML = msg;
        };

        const renderRubric = (taskNum) => {
            let competency = taskNum === 1 ? "Create 10-column worksheet." : "Create IS, SCE, and BS.";
            let scoreHtml = "";
            
            // Add score display above rubric if available
            let scoreData = taskNum === 1 ? state.task1Score : state.task2Score;
            if (scoreData) {
                scoreHtml = `
                    <div class="score-display text-indigo-800">
                        Score: ${scoreData.score}/${scoreData.total} | 
                        Percentage: ${scoreData.percentage}% | 
                        Grade: <span class="text-xl font-extrabold">${scoreData.grade}</span>
                    </div>
                `;
            }

            return `
                ${scoreHtml}
                <div class="rubric-box bg-white p-4 rounded-lg border-2 border-indigo-300 shadow-md mb-6">
                    <h4 class="font-extrabold text-indigo-700 text-lg mb-2 border-b-2 pb-1">
                        TASK ${taskNum} RUBRIC
                    </h4>
                    <table class="min-w-full text-xs border-collapse border border-gray-400">
                        <thead>
                            <tr class="header-bg text-center text-white">
                                <th class="p-2 border w-1/5">Competency</th>
                                <th class="p-2 border bg-green-600/90 w-1/5">Advanced (A)</th>
                                <th class="p-2 border bg-blue-600/90 w-1/5">Proficient (P)</th>
                                <th class="p-2 border bg-yellow-600/90 w-1/5">Developing (D)</th>
                                <th class="p-2 border bg-red-600/90 w-1/5">Intervention (IR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 border font-semibold italic">${competency}</td>
                                <td class="p-2 border bg-green-50/50">Excellent (95-100%)</td>
                                <td class="p-2 border bg-blue-50/50">Good (85-94.9%)</td>
                                <td class="p-2 border bg-yellow-50/50">Acceptable (75-84.9%)</td>
                                <td class="p-2 border bg-red-50/50">Unacceptable (<75%)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        };

        // Login Step
        const renderStudentInfo = () => {
             document.getElementById('task-container').innerHTML = `
                <h3 class="text-xl font-semibold text-indigo-700">Student Verification</h3>
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner space-y-4">
                    <input type="text" id="attendanceId" class="text-input" placeholder="Attendance ID" value="${state.attendanceId}">
                    <input type="text" id="studentId" class="text-input" placeholder="Student ID">
                    <button id="login-btn" onclick="window.handleLogin()" class="px-4 py-2 bg-green-600 text-white rounded">Verify</button>
                    
                    <div class="mt-4 border-t pt-2">
                        <label>Name</label> <input id="fullName" class="text-input bg-gray-200" disabled value="${state.studentInfo?.fullName||''}">
                    </div>
                </div>
             `;
             document.getElementById('next-step-btn').innerText = "Submit Info & Proceed to Task 1";
             document.getElementById('next-step-btn').disabled = true;
        };

        const calculateWorksheetAnswers = () => {
            const map = new Map();
            state.initialTB.filter(a=>a.name!=='Totals').forEach(a => map.set(a.name, {...a, ADJ_DR:0, ADJ_CR:0, ATB_DR:a.TB_DR, ATB_CR:a.TB_CR}));
            state.newAccounts.forEach(n => { if(!map.has(n.name)) map.set(n.name, {...n, TB_DR:0,TB_CR:0,ADJ_DR:0,ADJ_CR:0,ATB_DR:0,ATB_CR:0}); });

            // Specific overrides
            map.get('Accrued Service Revenue').type='asset'; map.get('Accrued Service Revenue').isFS='BS';
            map.get('Salaries Payable').type='liability'; map.get('Salaries Payable').isFS='BS';
            map.get('Supplies Expense').type='expense'; map.get('Supplies Expense').isFS='IS';
            map.get('Rent Expense').type='expense'; map.get('Rent Expense').isFS='IS';
            map.get('Depreciation Expense').type='expense'; map.get('Depreciation Expense').isFS='IS';

            state.adjustments.forEach(adj => {
                if(map.has(adj.dr)) map.get(adj.dr).ADJ_DR += adj.amount;
                if(map.has(adj.cr)) map.get(adj.cr).ADJ_CR += adj.amount;
            });

            let allAcc = [];
            const order = ['Cash','Accounts Receivable','Supplies','Prepaid Rent','Accrued Service Revenue','Equipment','Accumulated Depreciation-Equip.','Accounts Payable','Unearned Service Revenue','Salaries Payable', `${getFamilyName()}, Capital`, `${getFamilyName()}, Withdrawals`, 'Service Revenue','Salaries Expense','Utilities Expense','Supplies Expense','Rent Expense','Depreciation Expense'];
            
            order.forEach(name => {
                if(map.has(name)) {
                    let acc = map.get(name);
                    let bal = (acc.TB_DR + acc.ADJ_DR) - (acc.TB_CR + acc.ADJ_CR);
                    acc.ATB_DR = bal > 0 ? bal : 0; acc.ATB_CR = bal < 0 ? Math.abs(bal) : 0;
                    
                    acc.IS_DR=0; acc.IS_CR=0; acc.BS_DR=0; acc.BS_CR=0;
                    if(acc.isFS==='IS') { acc.IS_DR=acc.ATB_DR; acc.IS_CR=acc.ATB_CR; }
                    else { acc.BS_DR=acc.ATB_DR; acc.BS_CR=acc.ATB_CR; }
                    allAcc.push(acc);
                }
            });

            let sums = { TB_DR:0,TB_CR:0, ADJ_DR:0,ADJ_CR:0, ATB_DR:0,ATB_CR:0, IS_DR:0,IS_CR:0, BS_DR:0,BS_CR:0 };
            allAcc.forEach(a => {
                sums.TB_DR+=a.TB_DR; sums.TB_CR+=a.TB_CR;
                sums.ADJ_DR+=a.ADJ_DR; sums.ADJ_CR+=a.ADJ_CR;
                sums.ATB_DR+=a.ATB_DR; sums.ATB_CR+=a.ATB_CR;
                sums.IS_DR+=a.IS_DR; sums.IS_CR+=a.IS_CR;
                sums.BS_DR+=a.BS_DR; sums.BS_CR+=a.BS_CR;
            });

            const ni = sums.IS_CR - sums.IS_DR;
            const capName = `${getFamilyName()}, Capital`;
            const withName = `${getFamilyName()}, Withdrawals`;
            const startCap = map.get(capName)?.ATB_CR || 0;
            const withdr = map.get(withName)?.ATB_DR || 0;
            const endCap = startCap + ni - withdr;

            return {
                accounts: allAcc,
                sums: sums,
                netIncome: ni,
                endingCapital: endCap,
                totalRevenue: sums.IS_CR,
                totalExpenses: sums.IS_DR,
                assets: allAcc.filter(x=>x.isFS==='BS' && (x.type==='asset'||x.type==='contra-asset')),
                liabilities: allAcc.filter(x=>x.type==='liability'),
                isAccounts: allAcc.filter(x=>x.isFS==='IS'),
                startingCapital: startCap, withdrawals: withdr,
                correctBS_Total: sums.BS_CR + (ni > 0 ? ni : 0) // Simplification for check
            };
        };

        // Task 1 Renderer
        const renderWorksheet = (readOnly = false) => {
            const data = calculateWorksheetAnswers();
            const subAfter = 'Depreciation Expense';
            let rows = '';
            
            data.accounts.forEach((acc, i) => {
                const bid = `wks_${i}_`;
                const cols = ['ADJ_DR','ADJ_CR','ATB_DR','ATB_CR','IS_DR','IS_CR','BS_DR','BS_CR'];
                let inputs = cols.map(c => {
                    const disabled = (c.includes('IS') && acc.isFS!=='IS') || (c.includes('BS') && acc.isFS!=='BS') || readOnly;
                    return `<td class="p-0 border relative"><input type="number" id="${bid}${c}" oninput="window.saveWorksheetInput('${bid}${c}', this.value)" class="table-input" value="${state.worksheetInputs[bid+c]||''}" ${disabled?'disabled':''}><span id="${bid}${c}_val" class="validation-icon"></span></td>`;
                }).join('');
                rows += `<tr><td class="p-2 border text-left whitespace-nowrap">${acc.name}</td><td class="p-2 border text-right">${formatPHP(acc.TB_DR)}</td><td class="p-2 border text-right">${formatPHP(acc.TB_CR)}</td>${inputs}</tr>`;
            });

            // Totals Row (Simplified for brevity in renderer, full logic in validation)
            const totalsCols = ['TB_DR','TB_CR','ADJ_DR','ADJ_CR','ATB_DR','ATB_CR','IS_DR','IS_CR','BS_DR','BS_CR'];
            let totInputs = totalsCols.map((c, idx) => {
                const id = `wks_FINAL_${c}`;
                return `<td class="p-0 border relative"><input type="number" id="${id}" oninput="window.saveWorksheetInput('${id}', this.value)" class="table-input font-bold" value="${state.worksheetInputs[id]||''}" ${readOnly?'disabled':''}><span id="${id}_val" class="validation-icon"></span></td>`;
            }).join('');

            return `
                ${renderRubric(1)}
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-blue-700">Required Adjustments:</h4>
                    <ul class="list-disc list-inside text-sm">${state.adjustments.map(a=>`<li>${a.desc}</li>`).join('')}</ul>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border-collapse border border-gray-400">
                        <thead>
                             <tr class="header-bg text-center"><th rowspan="2" class="p-2 border">Account Titles</th><th colspan="2" class="p-2 border">Trial Balance</th><th colspan="2" class="p-2 border">Adjustments</th><th colspan="2" class="p-2 border">Adj. Trial Balance</th><th colspan="2" class="p-2 border">Income Statement</th><th colspan="2" class="p-2 border">Balance Sheet</th></tr>
                             <tr class="bg-indigo-100 text-center text-indigo-900"><th class="p-1 border">DR</th><th class="p-1 border">CR</th><th class="p-1 border">DR</th><th class="p-1 border">CR</th><th class="p-1 border">DR</th><th class="p-1 border">CR</th><th class="p-1 border">DR</th><th class="p-1 border">CR</th><th class="p-1 border">DR</th><th class="p-1 border">CR</th></tr>
                        </thead>
                        <tbody>${rows}<tr class="font-bold bg-indigo-50 border-t-2 border-indigo-700"><td class="p-2 border text-center">TOTALS</td>${totInputs}</tr></tbody>
                    </table>
                </div>
            `;
        };

        // Combined Task 2 Renderer
        const renderTask2Full = (readOnly = false) => {
            const data = calculateWorksheetAnswers();
            const isNI = data.netIncome > 0;
            const compName = document.getElementById('company-name').innerText.replace(' - Year End', '');

            // Helper for IS
            const renderISPart = () => {
                const rev = data.isAccounts.filter(a=>a.type==='revenue');
                const exp = data.isAccounts.filter(a=>a.type==='expense');
                const renderRow = (acc) => {
                     const id = getAccountId(acc.name)+'_is_li';
                     return `<div class="relative mb-1"><div class="flex justify-between text-sm"><span class="mr-2">${acc.name}</span><div class="relative w-1/2"><input type="number" id="${id}" oninput="saveFSInput('is','${id}',this.value)" class="fs-input" value="${state.fsInputs.is[id]||''}" ${readOnly?'disabled':''}><span id="${id}_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div></div>`;
                };
                return `
                    <div class="border p-2 rounded bg-white h-full">
                        <div class="text-center font-bold text-sm mb-2 border-b">${compName}<br>Income Statement</div>
                        <div class="text-xs font-bold text-green-700 mb-1">Revenues</div>
                        ${rev.map(renderRow).join('')}
                        <div class="flex justify-between font-bold text-sm mt-1 border-t pt-1"><span class="text-green-700">Total Rev:</span><div class="relative w-1/2"><input type="number" id="is_total_revenue" oninput="saveFSInput('is','is_total_revenue',this.value)" class="fs-input" value="${state.fsInputs.is.is_total_revenue||''}" ${readOnly?'disabled':''}><span id="is_total_revenue_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                        <div class="text-xs font-bold text-red-700 mt-2 mb-1">Expenses</div>
                        ${exp.map(renderRow).join('')}
                        <div class="flex justify-between font-bold text-sm mt-1 border-t pt-1"><span class="text-red-700">Total Exp:</span><div class="relative w-1/2"><input type="number" id="is_total_expense" oninput="saveFSInput('is','is_total_expense',this.value)" class="fs-input" value="${state.fsInputs.is.is_total_expense||''}" ${readOnly?'disabled':''}><span id="is_total_expense_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                        <div class="flex justify-between font-extrabold text-sm mt-2 border-t-2 pt-1 bg-indigo-50"><span class="text-indigo-800">${isNI?'Net Income':'Net Loss'}:</span><div class="relative w-1/2"><input type="number" id="is_net_income" oninput="saveFSInput('is','is_net_income',this.value)" class="fs-input" value="${state.fsInputs.is.is_net_income||''}" ${readOnly?'disabled':''}><span id="is_net_income_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                    </div>
                `;
            };

            // Helper for SCE
            const renderSCEPart = () => {
                const capName = `${getFamilyName()}, Capital`;
                const withName = `${getFamilyName()}, Withdrawals`;
                return `
                    <div class="border p-2 rounded bg-white h-full">
                        <div class="text-center font-bold text-sm mb-2 border-b">${compName}<br>Changes in Equity</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center"><span>${capName}, Jan 1</span><div class="relative w-1/2"><input type="number" id="sce_starting_capital" oninput="saveFSInput('sce','sce_starting_capital',this.value)" class="fs-input" value="${state.fsInputs.sce.sce_starting_capital||''}" ${readOnly?'disabled':''}><span id="sce_starting_capital_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                            <div class="flex justify-between items-center text-green-700"><span>Add: Net Income</span><div class="relative w-1/2"><input type="number" id="sce_net_income" oninput="saveFSInput('sce','sce_net_income',this.value)" class="fs-input" value="${state.fsInputs.sce.sce_net_income||''}" ${readOnly?'disabled':''}><span id="sce_net_income_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                            <div class="flex justify-between items-center text-red-700"><span>Less: Withdrawals</span><div class="relative w-1/2"><input type="number" id="sce_withdrawals" oninput="saveFSInput('sce','sce_withdrawals',this.value)" class="fs-input" value="${state.fsInputs.sce.sce_withdrawals||''}" ${readOnly?'disabled':''}><span id="sce_withdrawals_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                            <div class="flex justify-between items-center font-bold bg-indigo-50 border-t-2 pt-1"><span>${capName}, Dec 31</span><div class="relative w-1/2"><input type="number" id="sce_ending_capital" oninput="saveFSInput('sce','sce_ending_capital',this.value)" class="fs-input" value="${state.fsInputs.sce.sce_ending_capital||''}" ${readOnly?'disabled':''}><span id="sce_ending_capital_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                        </div>
                    </div>
                `;
            };

            // Helper for BS
            const renderBSPart = () => {
                 const renderRow = (acc, type) => {
                     const id = getAccountId(acc.name)+'_bs_li';
                     const lbl = acc.type==='contra-asset' ? `Less: ${acc.name}` : acc.name;
                     return `<div class="flex justify-between text-sm mb-1"><span class="w-1/2 truncate mr-1" title="${lbl}">${lbl}</span><div class="relative w-1/2"><input type="number" id="${id}" oninput="saveFSInput('bs','${id}',this.value)" class="fs-input" value="${state.fsInputs.bs[id]||''}" ${readOnly?'disabled':''}><span id="${id}_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>`;
                };
                return `
                    <div class="border p-2 rounded bg-white h-full">
                        <div class="text-center font-bold text-sm mb-2 border-b">${compName}<br>Balance Sheet</div>
                        <div class="text-xs font-bold text-blue-700">ASSETS</div>
                        ${data.assets.map(a=>renderRow(a)).join('')}
                        <div class="flex justify-between font-bold text-sm border-t pt-1 bg-blue-50 mb-2"><span>Total Assets:</span><div class="relative w-1/2"><input type="number" id="bs_total_assets" oninput="saveFSInput('bs','bs_total_assets',this.value)" class="fs-input" value="${state.fsInputs.bs.bs_total_assets||''}" ${readOnly?'disabled':''}><span id="bs_total_assets_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                        
                        <div class="text-xs font-bold text-red-700">LIABILITIES</div>
                        ${data.liabilities.map(a=>renderRow(a)).join('')}
                        
                        <div class="text-xs font-bold text-purple-700 mt-1">EQUITY</div>
                        <div class="flex justify-between text-sm mb-1"><span>Capital Dec 31</span><div class="relative w-1/2"><input type="number" id="bs_ending_capital_bs" oninput="saveFSInput('bs','bs_ending_capital_bs',this.value)" class="fs-input" value="${state.fsInputs.bs.bs_ending_capital_bs||''}" ${readOnly?'disabled':''}><span id="bs_ending_capital_bs_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                        
                        <div class="flex justify-between font-bold text-sm border-t-2 border-red-500 pt-1 bg-red-50"><span>Total L&E:</span><div class="relative w-1/2"><input type="number" id="bs_total_liab_equity" oninput="saveFSInput('bs','bs_total_liab_equity',this.value)" class="fs-input" value="${state.fsInputs.bs.bs_total_liab_equity||''}" ${readOnly?'disabled':''}><span id="bs_total_liab_equity_val" class="validation-icon absolute right-1 top-1/2 -translate-y-1/2"></span></div></div>
                    </div>
                `;
            };

            return `
                ${renderRubric(2)}
                <!-- Grid Container: Stack on Mobile, 3 Columns on Desktop AND Print -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 task2-grid">
                    <div class="w-full">${renderISPart()}</div>
                    <div class="w-full">${renderSCEPart()}</div>
                    <div class="w-full">${renderBSPart()}</div>
                </div>
            `;
        };

        // --- VALIDATION ---
        const renderValidationIcon = (id, isCorrect) => {
            const span = document.getElementById(id + '_val');
            if(span) span.innerHTML = isCorrect ? '<span class="text-green-600">✔</span>' : '<span class="text-red-600">❌</span>';
        };

        const validateWorksheet = (doIcons) => {
            const d = calculateWorksheetAnswers();
            let c=0, t=0;
            const check = (id, val) => { 
                t++; const ok = Math.abs((state.worksheetInputs[id]||0)-val)<0.01; 
                if(ok) c++; 
                if(doIcons) renderValidationIcon(id, ok); 
            };

            d.accounts.forEach((acc, i) => {
                const bid = `wks_${i}_`;
                check(bid+'ADJ_DR', acc.ADJ_DR); check(bid+'ADJ_CR', acc.ADJ_CR);
                check(bid+'ATB_DR', acc.ATB_DR); check(bid+'ATB_CR', acc.ATB_CR);
                if(acc.isFS==='IS'){ check(bid+'IS_DR', acc.IS_DR); check(bid+'IS_CR', acc.IS_CR); }
                if(acc.isFS==='BS'){ check(bid+'BS_DR', acc.BS_DR); check(bid+'BS_CR', acc.BS_CR); }
            });
            // Finals
            check('wks_FINAL_TB_DR', d.sums.TB_DR); check('wks_FINAL_TB_CR', d.sums.TB_CR);
            check('wks_FINAL_ADJ_DR', d.sums.ADJ_DR); check('wks_FINAL_ADJ_CR', d.sums.ADJ_CR);
            check('wks_FINAL_ATB_DR', d.sums.ATB_DR); check('wks_FINAL_ATB_CR', d.sums.ATB_CR);
            check('wks_FINAL_IS_DR', d.sums.IS_DR); check('wks_FINAL_IS_CR', d.sums.IS_CR);
            check('wks_FINAL_BS_DR', d.sums.BS_DR); check('wks_FINAL_BS_CR', d.sums.BS_CR);
            
            return { isPerfect: c===t, scoreData: calculateScoreAndGrade(c,t) };
        };

        const validateTask2Full = (doIcons) => {
            const d = calculateWorksheetAnswers();
            let c=0, t=0;
            const check = (valObj, id, correctVal) => {
                t++; const ok = Math.abs((valObj[id]||0)-correctVal)<0.01;
                if(ok) c++;
                if(doIcons) renderValidationIcon(id, ok);
            };

            // IS
            d.isAccounts.forEach(a => {
                 const val = a.type==='revenue'?a.ATB_CR:a.ATB_DR;
                 check(state.fsInputs.is, getAccountId(a.name)+'_is_li', val);
            });
            check(state.fsInputs.is, 'is_total_revenue', d.totalRevenue);
            check(state.fsInputs.is, 'is_total_expense', d.totalExpenses);
            check(state.fsInputs.is, 'is_net_income', Math.abs(d.netIncome));

            // SCE
            check(state.fsInputs.sce, 'sce_starting_capital', d.startingCapital);
            check(state.fsInputs.sce, 'sce_net_income', Math.abs(d.netIncome));
            check(state.fsInputs.sce, 'sce_withdrawals', d.withdrawals);
            check(state.fsInputs.sce, 'sce_ending_capital', d.endingCapital);

            // BS
            d.assets.forEach(a => check(state.fsInputs.bs, getAccountId(a.name)+'_bs_li', a.ATB_DR || a.ATB_CR)); // ATB_CR for contra
            d.liabilities.forEach(a => check(state.fsInputs.bs, getAccountId(a.name)+'_bs_li', a.ATB_CR));
            check(state.fsInputs.bs, 'bs_total_assets', d.sums.BS_DR - (d.netIncome<0?Math.abs(d.netIncome):0)); // Simplified asset total logic
            check(state.fsInputs.bs, 'bs_ending_capital_bs', d.endingCapital);
            check(state.fsInputs.bs, 'bs_total_liab_equity', d.correctBS_Total);

            return { isPerfect: c===t, scoreData: calculateScoreAndGrade(c,t) };
        };

        window.saveWorksheetInput = (id, v) => state.worksheetInputs[id] = Number(v)||0;
        window.saveFSInput = (type, id, v) => state.fsInputs[type][id] = Number(v)||0;

        window.handleLogin = async () => {
            const btn = document.getElementById('login-btn');
            btn.innerText = "Verifying..."; btn.disabled = true;
            const r = await validateStudentLogin(document.getElementById('attendanceId').value, document.getElementById('studentId').value);
            if(r.success) {
                state.studentInfo = { ...r.data, gradeSection: r.data.section, classNumber: r.data.cn };
                generateDynamicData();
                document.getElementById('company-name').innerText = `${getFamilyName()} Accounting Services - Year End`;
                renderMessageBox("Success!");
                document.getElementById('next-step-btn').disabled = false;
                btn.innerText = "Verified";
            } else {
                renderMessageBox(r.message, true);
                btn.innerText = "Verify"; btn.disabled = false;
            }
        };

        window.handleNextStep = async () => {
            const max = 3;
            let valid = false; let override = false; let msg = "";

            if(state.currentStep === 0) { // Login
                state.currentStep = 1;
                renderStep();
                return;
            }

            if(state.currentStep === 1) { // Task 1
                const r = validateWorksheet(true);
                state.task1Score = r.scoreData;
                if(!r.isPerfect) {
                    state.validationAttempts[1]++;
                    if(state.validationAttempts[1] >= max) { valid = true; override = true; msg = "Max attempts used. Printing & Proceeding."; }
                    else msg = `Errors found. Attempt ${state.validationAttempts[1]}/${max}.`;
                } else { valid = true; msg = "Task 1 Perfect!"; }
                
                if(valid) {
                    renderMessageBox(msg, override);
                    window.print();
                    state.currentStep = 2;
                    renderStep();
                } else renderMessageBox(msg, true);
            }
            else if(state.currentStep === 2) { // Task 2 Combined
                const r = validateTask2Full(true);
                state.task2Score = r.scoreData;
                if(!r.isPerfect) {
                    state.validationAttempts[2]++;
                    if(state.validationAttempts[2] >= max) { valid = true; override = true; msg = "Max attempts used. Submitting."; }
                    else msg = `Errors found. Attempt ${state.validationAttempts[2]}/${max}.`;
                } else { valid = true; msg = "Task 2 Perfect! Submitting."; }

                if(valid) {
                    renderMessageBox(msg, override);
                    await window.finishAndPreview(false);
                } else renderMessageBox(msg, true);
            }
        };

        // --- STEP RENDERING ---
        const renderCompletion = () => {
            document.getElementById('task-container').innerHTML = `
                <div id="final-report-container">
                    <div class="no-print text-center py-10">
                        <h3 class="text-3xl font-bold text-indigo-800">Task Complete!</h3>
                        <p class="mb-4">Data saved.</p>
                        <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-6">
                             <div class="border p-4 rounded bg-blue-50">
                                <strong>Task 1:</strong> ${state.task1Score.grade} (${state.task1Score.score}/${state.task1Score.total})
                             </div>
                             <div class="border p-4 rounded bg-green-50">
                                <strong>Task 2:</strong> ${state.task2Score.grade} (${state.task2Score.score}/${state.task2Score.total})
                             </div>
                        </div>
                    </div>

                    <!-- INJECTED TASK 1 & TASK 2 FOR PRINTING -->
                    <div class="print:block">
                        <h3 class="text-2xl font-bold border-b-2 border-black mb-4 print:mt-0">TASK 1: Worksheet</h3>
                        ${renderWorksheet(true)}
                        
                        <div class="page-break"></div>
                        
                        <h3 class="text-2xl font-bold border-b-2 border-black mb-4 mt-8">TASK 2: Financial Statements</h3>
                        ${renderTask2Full(true)}

                        <div class="text-center font-bold text-xl mt-12 border-t-2 border-black pt-4 w-1/2 mx-auto">
                            *** END OF TASK ***
                        </div>
                    </div>
                </div>
            `;
            const btn = document.getElementById('next-step-btn');
            btn.innerText = "Print Final Report to PDF";
            btn.onclick = () => window.print();
            
            // Update Student Print Info Header
            const info = state.studentInfo;
            document.getElementById('student-print-info').innerHTML = `
                <div class="flex justify-between border-b border-black pb-1 mb-1">
                    <span><strong>CN:</strong> ${info.classNumber}</span>
                    <span><strong>Section:</strong> ${info.gradeSection}</span>
                </div>
                <div class="flex justify-between">
                    <span><strong>Name:</strong> ${info.fullName}</span>
                    <span><strong>ID:</strong> ${info.idNumber}</span>
                </div>
            `;
        };

        const renderStep = () => {
            const steps = [renderStudentInfo, () => document.getElementById('task-container').innerHTML = renderWorksheet(), () => document.getElementById('task-container').innerHTML = renderTask2Full(), renderCompletion];
            steps[state.currentStep]();
            
            // Update Header Context
            const titles = ["Login", "Task 1: 10-Column Worksheet", "Task 2: Financial Statements", "Final Report"];
            document.getElementById('task-header-title').innerText = titles[state.currentStep];
            
            // Update Print Info Block if not in final step (final step handles it differently)
            if(state.currentStep > 0 && state.currentStep < 3 && state.studentInfo) {
                const info = state.studentInfo;
                document.getElementById('student-print-info').innerHTML = `
                    <div class="flex justify-between border-b border-black pb-1 mb-1">
                        <span><strong>CN:</strong> ${info.classNumber}</span>
                        <span><strong>Section:</strong> ${info.gradeSection}</span>
                    </div>
                    <div class="flex justify-between">
                        <span><strong>Name:</strong> ${info.fullName}</span>
                        <span><strong>ID:</strong> ${info.idNumber}</span>
                    </div>
                `;
            }
            
            // Button State
            const btn = document.getElementById('next-step-btn');
            if (state.currentStep === 1) btn.innerText = "Validate Worksheet & Print Task 1";
            else if (state.currentStep === 2) btn.innerText = "Validate Task 2 & Submit";
        };
        
        window.onload = () => { checkUrlParametersAndInit(); };
    </script>
</body>
</html>
