<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Accounting Activity: Service</title>    <script src="https://cdn.tailwindcss.com"></script>    <script>window.STUDENT_CONFIG = {"config":{"businessType":"Service","ownership":"Sole Proprietorship","inventorySystem":"Periodic","numTransactions":10,"selectedSteps":[1,2,3,4,5,6,7,8,9,10],"numPartners":2,"isSubsequentYear":false,"deferredExpenseMethod":"Asset","deferredIncomeMethod":"Liability","fsFormat":"Single","includeCashFlows":false,"enableAutoSave":true,"options":{"includeTradeDiscounts":false,"includeCashDiscounts":false,"includeFreight":false}},"transactions":[{"type":"Investment","description":"Initial capital investment of P800,000","debits":[{"account":"Cash","amount":800000}],"credits":[{"account":"Owner, Capital","amount":800000}],"amount":800000,"analysis":{"assets":"Increase","liabilities":"No Effect","equity":"Increase","cause":"Increase in Capital"},"id":1,"date":"2023-01-03"},{"type":"Rent Advance","description":"Paid 3 months office rent in advance, P12,000","debits":[{"account":"Prepaid Rent","amount":12000}],"credits":[{"account":"Cash","amount":12000}],"amount":12000,"analysis":{"assets":"No Effect","liabilities":"No Effect","equity":"No Effect","cause":""},"id":2,"date":"2023-01-05"},{"type":"Supplies Credit","description":"Purchased office supplies on account for P5,900","debits":[{"account":"Supplies","amount":5900}],"credits":[{"account":"Accounts Payable","amount":5900}],"amount":5900,"analysis":{"assets":"Increase","liabilities":"Increase","equity":"No Effect","cause":""},"id":3,"date":"2023-01-07"},{"type":"Revenue Cash","description":"Provided services for cash, P20,300","debits":[{"account":"Cash","amount":20300}],"credits":[{"account":"Service Revenue","amount":20300}],"amount":20300,"analysis":{"assets":"Increase","liabilities":"No Effect","equity":"Increase","cause":"Increase in Income"},"id":4,"date":"2023-01-08"},{"type":"Revenue Credit","description":"Provided services on account, P10,300","debits":[{"account":"Accounts Receivable","amount":10300}],"credits":[{"account":"Service Revenue","amount":10300}],"amount":10300,"analysis":{"assets":"Increase","liabilities":"No Effect","equity":"Increase","cause":"Increase in Income"},"id":5,"date":"2023-01-12"},{"type":"Salary Expense","description":"Paid monthly salaries: P9,300","debits":[{"account":"Salaries Expense","amount":9300}],"credits":[{"account":"Cash","amount":9300}],"amount":9300,"analysis":{"assets":"Decrease","liabilities":"No Effect","equity":"Decrease","cause":"Increase in Expense"},"id":6,"date":"2023-01-13"},{"type":"Utility Expense","description":"Paid electricity and water bills: P2,200","debits":[{"account":"Utilities Expense","amount":2200}],"credits":[{"account":"Cash","amount":2200}],"amount":2200,"analysis":{"assets":"Decrease","liabilities":"No Effect","equity":"Decrease","cause":"Increase in Expense"},"id":7,"date":"2023-01-21"},{"type":"Drawings","description":"Owner withdrew cash for personal use: P5,500","debits":[{"account":"Owner, Drawings","amount":5500}],"credits":[{"account":"Cash","amount":5500}],"amount":5500,"analysis":{"assets":"Decrease","liabilities":"No Effect","equity":"Decrease","cause":"Increase in Drawings"},"id":8,"date":"2023-01-23"},{"type":"Equip Cash","description":"Purchased new equipment for cash: P49,200","debits":[{"account":"Equipment","amount":49200}],"credits":[{"account":"Cash","amount":49200}],"amount":49200,"analysis":{"assets":"No Effect","liabilities":"No Effect","equity":"No Effect","cause":""},"id":9,"date":"2023-01-29"},{"type":"Unearned Revenue","description":"Received cash in advance for services to be performed next month: P12,400","debits":[{"account":"Cash","amount":12400}],"credits":[{"account":"Unearned Revenue","amount":12400}],"amount":12400,"analysis":{"assets":"Increase","liabilities":"Increase","equity":"No Effect","cause":""},"id":10,"date":"2023-01-30"}],"ledger":{"Cash":{"debit":832700,"credit":78200},"Owner, Capital":{"debit":0,"credit":800000},"Prepaid Rent":{"debit":12000,"credit":0},"Supplies":{"debit":5900,"credit":0},"Accounts Payable":{"debit":0,"credit":5900},"Service Revenue":{"debit":0,"credit":30600},"Accounts Receivable":{"debit":10300,"credit":0},"Salaries Expense":{"debit":9300,"credit":0},"Utilities Expense":{"debit":2200,"credit":0},"Owner, Drawings":{"debit":5500,"credit":0},"Equipment":{"debit":49200,"credit":0},"Unearned Revenue":{"debit":0,"credit":12400}},"validAccounts":["Cash","Accounts Receivable","Supplies","Prepaid Rent","Equipment","Accounts Payable","Unearned Revenue","Owner, Capital","Owner, Drawings","Service Revenue","Salaries Expense","Utilities Expense"],"beginningBalances":null,"adjustments":[{"id":"adj1","desc":"Supplies on hand at end of period are P1,770.","drAcc":"Supplies Expense","crAcc":"Supplies","amount":4130},{"id":"adj2","desc":"One month of prepaid rent has expired: P4,000.","drAcc":"Rent Expense","crAcc":"Prepaid Rent","amount":4000},{"id":"adj3","desc":"Services performed related to advance payments: P2,500.","drAcc":"Unearned Revenue","crAcc":"Service Revenue","amount":2500},{"id":"adj4","desc":"Accrued salaries: P2,000.","drAcc":"Salaries Expense","crAcc":"Salaries Payable","amount":2000},{"id":"adj5","desc":"Depreciation: P1,500.","drAcc":"Depreciation Expense","crAcc":"Accumulated Depreciation - Equipment","amount":1500}],"steps":[{"id":1,"title":"Transaction Analysis","description":"Identify impact on Assets, Liabilities, and Equity"},{"id":2,"title":"Journalizing","description":"Record transactions in the General Journal"},{"id":3,"title":"Posting to Ledger","description":"Post journal entries to T-Accounts/Ledger"},{"id":4,"title":"Trial Balance","description":"Prepare Unadjusted Trial Balance"},{"id":5,"title":"10-Column Worksheet","description":"Prepare Worksheet with Adjustments"},{"id":6,"title":"Financial Statements","description":"Prepare Income Statement and Balance Sheet"},{"id":7,"title":"Adjusting Entries","description":"Journalize and Post Adjusting Entries"},{"id":8,"title":"Closing Entries","description":"Journalize and Post Closing Entries"},{"id":9,"title":"Post-Closing Trial Balance","description":"Prepare Post-Closing Trial Balance"},{"id":10,"title":"Reversing Entries","description":"Setup new period and Reversing Entries"}],"initialStatus":{"1":{"completed":false,"attempts":3,"correct":false},"2":{"completed":false,"attempts":3,"correct":false},"3":{"completed":false,"attempts":3,"correct":false},"4":{"completed":false,"attempts":3,"correct":false},"5":{"completed":false,"attempts":3,"correct":false},"6":{"completed":false,"attempts":3,"correct":false},"7":{"completed":false,"attempts":3,"correct":false},"8":{"completed":false,"attempts":3,"correct":false},"9":{"completed":false,"attempts":3,"correct":false},"10":{"completed":false,"attempts":3,"correct":false}}};</script>    <style>        @page { size: 8.5in 13in; margin: 0.5in; margin-bottom: 0.8in; }        @media print {             body { -webkit-print-color-adjust: exact; }             .page-break { page-break-after: always; }            .break-inside-avoid { break-inside: avoid; }            .hidden { display: block !important; }            button, .no-print { display: none !important; }            .print-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 0.8in; }            .report-body { margin-bottom: 0.8in; }        }        ::-webkit-scrollbar { display: none; }        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }    </style></head><body class="bg-gray-50 text-gray-900">    <div id="root"></div>    <script type="module">        import React, { useState, useCallback, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';        import htm from 'https://esm.sh/htm';        import * as Lucide from 'https://esm.sh/lucide-react@0.263.1';                // Expose icons globally for merged code        const { Book, Check, RefreshCw, ArrowLeft, Save, Printer, FileText, Trash2, AlertCircle, Download, Loader, Lock, ChevronDown, ChevronRight, Table, Plus, X } = Lucide;// -------------------
// --- utils.js for Constants and Logic Helpers for Accounting Cycle ---
// ------------------


const APP_VERSION = "Version: 2025-12-10 17:11 PST";

const EQUITY_CAUSES = ['', 'Increase in Capital', 'Decrease in Capital', 'Increase in Drawings', 'Decrease in Drawings', 'Increase in Income', 'Decrease in Income', 'Increase in Expense', 'Decrease in Expense'];

const CANONICAL_ACCOUNT_ORDER = ["Cash", "Accounts Receivable", "Merchandise Inventory", "Supplies", "Prepaid Rent", "Equipment", "Accumulated Depreciation - Equipment", "Furniture", "Accumulated Depreciation - Furniture", "Building", "Accumulated Depreciation - Building", "Land", "Accounts Payable", "Notes Payable", "Salaries Payable", "Utilities Payable", "Interest Payable", "Unearned Revenue", "Owner, Capital", "Owner, Drawings", "Share Capital", "Retained Earnings", "Dividends", "Service Revenue", "Sales", "Sales Discounts", "Sales Returns and Allowances", "Interest Income", "Cost of Goods Sold", "Purchases", "Purchase Discounts", "Purchase Returns and Allowances", "Freight In", "Freight Out", "Rent Expense", "Salaries Expense", "Utilities Expense", "Supplies Expense", "Repairs and Maintenance Expense", "Dues and Subscriptions Expense", "Depreciation Expense", "Insurance Expense", "Advertising Expense", "Interest Expense"];

const STEPS = [
    { id: 1, title: 'Transaction Analysis', description: 'Identify impact on Assets, Liabilities, and Equity' },
    { id: 2, title: 'Journalizing', description: 'Record transactions in the General Journal' },
    { id: 3, title: 'Posting to Ledger', description: 'Post journal entries to T-Accounts/Ledger' },
    { id: 4, title: 'Trial Balance', description: 'Prepare Unadjusted Trial Balance' },
    { id: 5, title: '10-Column Worksheet', description: 'Prepare Worksheet with Adjustments' },
    { id: 6, title: 'Financial Statements', description: 'Prepare Income Statement and Balance Sheet' },
    { id: 7, title: 'Adjusting Entries', description: 'Journalize and Post Adjusting Entries' },
    { id: 8, title: 'Closing Entries', description: 'Journalize and Post Closing Entries' },
    { id: 9, title: 'Post-Closing Trial Balance', description: 'Prepare Post-Closing Trial Balance' },
    { id: 10, title: 'Reversing Entries', description: 'Setup new period and Reversing Entries' },
];

const ActivityHelper = {
    getRubricHTML: (taskNum, taskTitle) => {
        let competency;
        if (taskNum === 1) competency = 'To correctly analyze business transactions by determining the effect on the fundamental accounting equation (Assets = Liabilities + Equity).';
        else if (taskNum === 2) competency = 'To accurately record business transactions in the general journal following the double-entry system (Debits = Credits).';
        else if (taskNum === 3) competency = 'To accurately post journal entries to the appropriate General Ledger (T-Accounts) and calculate the correct running balance for each account.';
        else if (taskNum === 4) competency = 'To prepare an Unadjusted Trial Balance by extracting the final balances from all General Ledger accounts.';
        else if (taskNum === 5) competency = 'To prepare a 10-column worksheet, applying adjustments and correctly extending balances to Financial Statement columns.';
        else competency = `To correctly complete the process for: ${taskTitle}.`;

        return `<div class="rubric-box bg-white p-4 rounded-lg border-2 border-indigo-300 shadow-md mb-6"><div class="flex justify-between items-end mb-2 border-b-2 pb-1"><h4 class="font-extrabold text-indigo-700 print:text-black">TASK ${taskNum}: ${taskTitle.toUpperCase()} RUBRIC</h4></div><div class="overflow-x-auto"><table class="min-w-full text-xs border-collapse border border-gray-400"><thead><tr class="header-bg text-center text-white"><th class="p-2 border border-gray-300 w-1/5">Competency</th><th class="p-2 border border-gray-300 bg-green-600/90 print:bg-white">Advanced (A)</th><th class="p-2 border border-gray-300 bg-blue-600/90 print:bg-white">Proficient (P)</th><th class="p-2 border border-gray-300 bg-yellow-600/90 print:bg-white">Developing (D)</th><th class="p-2 border border-gray-300 bg-red-600/90 print:bg-white">Intervention Required (IR)</th></tr></thead><tbody><tr class="align-top"><td class="p-2 border border-gray-300 italic">${competency}</td><td class="p-2 border border-gray-300 text-green-800 print:text-black">Excellent performance. (95-100%)</td><td class="p-2 border border-gray-300 text-blue-800 print:text-black">Good performance. (85-94.9%)</td><td class="p-2 border border-gray-300 text-yellow-800 print:text-black">Acceptable performance. (75-84.9%)</td><td class="p-2 border border-gray-300 text-red-800 print:text-black">Unacceptable performance. (&lt;75%)</td></tr></tbody></table></div></div>`;
    },
    getPrintStudentInfoHTML: (stepTitle, stepDescription) => {
         return `<div id="student-print-info" class="hidden"><div class="w-full mb-2 text-sm text-black font-bold font-mono border-b-2 border-black pb-2"><div class="flex justify-between items-center"><span class="text-left">CN: ___</span><span class="text-right">Section: ___</span></div><div class="flex justify-between items-center"><span class="text-left">Name: ______________________</span><span class="text-right">Date: ________________</span></div></div><h1 id="task-header-title" class="font-extrabold text-2xl mb-1 text-black">${stepTitle}</h1><p class="text-sm text-gray-700">${stepDescription}</p></div>`;
    },
    getCustomPrintHeaderHTML: () => `<header class="text-center mb-8 pb-4 border-b-4 border-indigo-600 header-bg rounded-t-lg p-4 print:block hidden print-header-custom"><h1 class="text-3xl md:text-4xl font-extrabold text-yellow-300">Performance Task</h1></header>`,
    getCustomPrintFooterHTML: () => `<div id="print-footer" class="hidden print:block fixed bottom-0 left-0 right-0 z-50 bg-white border-t-8 border-indigo-600"></div>`,
    
    // --- UPDATED INSTRUCTIONS GENERATOR ---
    getInstructionsHTML: (stepId, taskTitle, validAccounts = [], isSubsequentYear = false, beginningBalances = null, deferredExpenseMethod = 'Asset', deferredIncomeMethod = 'Liability') => {
        let instructionsHTML = "";
        let accountsList = "";
        
        // Logic for the extra bullet point
        const showDeferredNote = (deferredExpenseMethod === 'Expense' || deferredIncomeMethod === 'Income');
        const deferredLine = showDeferredNote ? "<li>Expense or Income method is to be used in accounting for Deferred Items.</li>" : "";

        if (stepId === 2 || stepId === 3) {
            if (stepId === 3 && isSubsequentYear && beginningBalances) {
                 const accountsWithBalances = validAccounts.map(a => {
                     let balText = "";
                     if (beginningBalances.balances && beginningBalances.balances[a]) {
                         const b = beginningBalances.balances[a];
                         const net = b.dr - b.cr;
                         if (net !== 0) {
                             balText = ` (Beg: ${Math.abs(net).toLocaleString()} ${net > 0 ? 'Dr' : 'Cr'})`;
                         }
                     }
                     return `${a}${balText}`;
                 });
                 accountsList = `<span class="font-mono text-xs text-blue-700 font-bold">${accountsWithBalances.join(', ')}</span>`;
            } else {
                 accountsList = `<span class="font-mono text-xs text-blue-700 font-bold">${validAccounts.join(', ')}</span>`;
            }
        }

        if (stepId === 1) {
            instructionsHTML = `
                <li>Analyze the increase or decrease effects of each transactions on assets, liabilities, and equity. If it affects equity, determine the cause.</li>
                ${deferredLine}
                <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
            `;
        } else if (stepId === 2) {
            instructionsHTML = `
                <li>Journalize the transactions using the rules of debit and credit and the manual process of recording transactions.</li>
                ${deferredLine}
                <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
                <li>Use the following accounts in journalizing the transactions below: ${accountsList}</li>
            `;
        } else if (stepId === 3) {
            let firstBullet = `Setup the general ledger using the following accounts (chart of accounts): ${accountsList}`;
            
            if (isSubsequentYear) {
                instructionsHTML = `
                    <li>${firstBullet}</li>
                    ${deferredLine}
                    <li>Enter the beginning balances of the account general ledger created using the amounts provided together with the accounts in the first instruction - YYYY in the first row, date column. Date column second row shall be Mmm dd or Mmm, d. Second row particulars shall be BB that stands for beginning balance, 2nd row PR is blank, and then the debit or credit beginning balance amount.</li>
                    <li>Post the journal entries to the appropriate General Ledger accounts.</li>
                    <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
                `;
            } else {
                instructionsHTML = `
                    <li>${firstBullet}</li>
                    ${deferredLine}
                    <li>Post the journal entries to the appropriate General Ledger accounts.</li>
                    <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
                `;
            }
        } else if (stepId === 4) {
            instructionsHTML = `
                <li>Prepare the Unadjusted Trial Balance based on the balances in the General Ledger.</li>
                ${deferredLine}
                <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
            `;
        } else if (stepId === 5) {
            instructionsHTML = `
                <li>Complete the 10-column worksheet, applying adjustments and correctly extending balances.</li>
                ${deferredLine}
                <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
            `;
        } else {
             instructionsHTML = `
                <li>Perform the necessary procedures to complete the ${taskTitle}.</li>
                ${deferredLine}
                <li>Complete all required fields. Enter amounts without commas and decimal places. Round off centavos to the nearest peso. Validate each task to unlock the next one.</li>
            `;
        }

        return `
            <p class="font-bold">Instructions:</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                ${instructionsHTML}
            </ul>
        `;
    }
};

const getAccountType = (acc) => {
    if (['Cash', 'Accounts Receivable', 'Merchandise Inventory', 'Supplies', 'Prepaid Rent', 'Equipment', 'Furniture', 'Building', 'Land'].includes(acc)) return 'Asset';
    if (acc.includes('Accumulated Depreciation')) return 'Asset';
    if (['Accounts Payable', 'Notes Payable', 'Salaries Payable', 'Utilities Payable', 'Interest Payable', 'Unearned Revenue'].includes(acc)) return 'Liability';
    if (['Owner, Capital', 'Share Capital', 'Retained Earnings'].includes(acc)) return 'Equity'; 
    if (['Owner, Drawings', 'Dividends'].includes(acc)) return 'Equity';
    if (acc.includes('Revenue') || acc === 'Sales' || acc.includes('Income') || acc.includes('Sales Discounts') || acc.includes('Sales Returns')) return 'Revenue';
    if (acc.includes('Expense') || acc === 'Cost of Goods Sold' || acc === 'Purchases' || acc.includes('Purchase Discounts') || acc.includes('Purchase Returns') || acc === 'Freight In' || acc === 'Freight Out') return 'Expense';
    return 'Asset';
};

const sortAccounts = (accounts) => [...accounts].sort((a, b) => {
    const indexA = CANONICAL_ACCOUNT_ORDER.indexOf(a);
    const indexB = CANONICAL_ACCOUNT_ORDER.indexOf(b);
    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
    if (indexA === -1) return 1;
    if (indexB === -1) return -1;
    return indexA - indexB;
});

const generateBeginningBalances = (businessType, ownership) => {
    const balances = {};
    let totalDr = 0; let totalCr = 0;
    const assetsPool = ["Cash", "Accounts Receivable", "Supplies", "Prepaid Rent", "Equipment", "Furniture"];
    const liabilityPool = ["Accounts Payable", "Notes Payable", "Salaries Payable", "Utilities Payable", "Unearned Revenue"];
    if (businessType === 'Merchandising' || businessType === 'Manufacturing') { assetsPool.push("Merchandise Inventory"); }
    const selectedAccounts = new Set(["Cash"]);
    const numAssets = Math.floor(Math.random() * 3) + 3;
    for(let i=0; i<numAssets; i++) selectedAccounts.add(assetsPool[Math.floor(Math.random() * assetsPool.length)]);
    const numLiabs = Math.floor(Math.random() * 3) + 2;
    for(let i=0; i<numLiabs; i++) selectedAccounts.add(liabilityPool[Math.floor(Math.random() * liabilityPool.length)]);
    const equityAcc = ownership === 'Sole Proprietorship' ? 'Owner, Capital' : 'Retained Earnings';
    selectedAccounts.add(equityAcc);
    
    Array.from(selectedAccounts).forEach(acc => {
        if (acc === equityAcc) return; 
        let amount = 0;
        if (acc === 'Cash') amount = Math.floor(Math.random() * 500000) + 100000; 
        else amount = Math.floor(Math.random() * 50000) + 5000;
        amount = Math.round(amount / 100) * 100;
        const type = getAccountType(acc);
        if (type === 'Asset') { balances[acc] = { dr: amount, cr: 0 }; totalDr += amount; } 
        else { balances[acc] = { dr: 0, cr: amount }; totalCr += amount; }
    });
    const equityNeeded = totalDr - totalCr;
    if (equityNeeded < 0) { balances['Cash'].dr += Math.abs(equityNeeded) + 200000; totalDr += Math.abs(equityNeeded) + 200000; balances[equityAcc] = { dr: 0, cr: 200000 }; totalCr += 200000; } 
    else { balances[equityAcc] = { dr: 0, cr: equityNeeded }; totalCr += equityNeeded; }
    return { balances, total: totalDr };
};

const fmt = (n) => `P${n.toLocaleString()}`;

const generateTransactions = (count, type, ownership, inventorySystem, options, isSubsequentYear, deferredExpenseMethod, deferredIncomeMethod) => {
    const transactions = [];
    // Define business type check early
    const isMerch = type === 'Merchandising' || type === 'Manufacturing'; 
    
    const createAnalysis = (debits, credits, isInvest = false, isDraw = false) => {
        let a = { assets: 'No Effect', liabilities: 'No Effect', equity: 'No Effect', cause: '' };
        const dr = debits[0].account; const cr = credits[0].account;
        const drType = getAccountType(dr); const crType = getAccountType(cr);
        if (drType === 'Asset') a.assets = 'Increase';
        if (crType === 'Asset') a.assets = a.assets === 'Increase' ? 'No Effect' : 'Decrease'; 
        if (crType === 'Liability') a.liabilities = 'Increase';
        if (drType === 'Liability') a.liabilities = 'Decrease';
        if (isInvest) { a.equity = 'Increase'; a.cause = 'Increase in Capital'; }
        else if (isDraw) { a.equity = 'Decrease'; a.cause = ownership === 'Sole Proprietorship' ? 'Increase in Drawings' : 'Decrease in Capital'; } 
        else if (crType === 'Revenue' && cr !== 'Sales Returns and Allowances') { a.equity = 'Increase'; a.cause = 'Increase in Income'; }
        else if (drType === 'Expense' || dr === 'Sales Returns and Allowances') { a.equity = 'Decrease'; a.cause = 'Increase in Expense'; }
        if (debits.some(d => d.account === 'Cost of Goods Sold')) { a.assets = 'Increase'; a.equity = 'Increase'; a.cause = 'Increase in Income'; } 
        else if (dr === 'Sales Returns and Allowances') { a.equity = 'Decrease'; a.cause = 'Decrease in Income'; } 
        else if (cr === 'Purchase Returns and Allowances') { a.equity = 'Increase'; a.cause = 'Decrease in Expense'; }
        return a;
    };
    
    // --- Helper for Shipping Terms ---
    const getShippingTerms = () => {
        const term = Math.random() > 0.5 ? 'FOB Shipping Point' : 'FOB Destination';
        const pay = Math.random() > 0.5 ? 'Freight Collect' : 'Freight Prepaid';
        return `${term}, ${pay}`;
    };

    // --- Transaction Templates ---
    const transactionTemplates = [];
    const revenueAcc = type === 'Merchandising' ? 'Sales' : 'Service Revenue';
    const capitalAcc = ownership === 'Sole Proprietorship' ? 'Owner, Capital' : 'Share Capital';
    const drawAcc = ownership === 'Sole Proprietorship' ? 'Owner, Drawings' : 'Dividends';
    
    // Determine Account Names based on Method
    const suppliesAssetAcc = 'Supplies';
    const suppliesExpAcc = 'Supplies Expense';
    const suppliesDebit = deferredExpenseMethod === 'Asset' ? suppliesAssetAcc : suppliesExpAcc;

    const prepaidRentAssetAcc = 'Prepaid Rent';
    const rentExpAcc = 'Rent Expense';
    const rentDebit = deferredExpenseMethod === 'Asset' ? prepaidRentAssetAcc : rentExpAcc;

    const unearnedRevLiabAcc = 'Unearned Revenue';
    const unearnedRevIncAcc = revenueAcc; // Service Revenue or Sales
    const unearnedCredit = deferredIncomeMethod === 'Liability' ? unearnedRevLiabAcc : unearnedRevIncAcc;


    const revenueArAmt = Math.round((Math.random() * 10000 + 10000) / 100) * 100;
    const suppliesAmt = Math.round((Math.random() * 3000 + 4000) / 100) * 100;
    const rentAmt = 12000;
    const salaryAmt = Math.round((Math.random() * 5000 + 7000) / 100) * 100;
    const utilityAmt = Math.round((Math.random() * 1000 + 2000) / 100) * 100;
    const drawAmt = Math.round((Math.random() * 2000 + 4000) / 100) * 100;
    const equipAmt = Math.round((Math.random() * 20000 + 40000) / 100) * 100;
    const unearnedAmt = Math.round((Math.random() * 5000 + 8000) / 100) * 100;
    const merchAmt = Math.round((Math.random() * 10000 + 15000) / 100) * 100;

    // 1. Initial Investment (Only if first year)
    if (!isSubsequentYear) {
        const investAmount = 800000; 
        transactionTemplates.push({ type: 'Investment', description: `Initial capital investment of ${fmt(investAmount)}`, debits: [{ account: 'Cash', amount: investAmount }], credits: [{ account: capitalAcc, amount: investAmount }], amount: investAmount, analysis: createAnalysis([{account: 'Cash'}], [{account: capitalAcc}], true) });
    }
    
    // 2. Pay Rent in Advance (Deferred Expense)
    transactionTemplates.push({ type: 'Rent Advance', description: `Paid 3 months office rent in advance, ${fmt(rentAmt)}`, debits: [{ account: rentDebit, amount: rentAmt }], credits: [{ account: 'Cash', amount: rentAmt }], amount: rentAmt, analysis: createAnalysis([{account: rentDebit}], [{account: 'Cash'}]) });

    // 3. Purchase Supplies on Account (Deferred Expense)
    transactionTemplates.push({ type: 'Supplies Credit', description: `Purchased office supplies on account for ${fmt(suppliesAmt)}`, debits: [{ account: suppliesDebit, amount: suppliesAmt }], credits: [{ account: 'Accounts Payable', amount: suppliesAmt }], amount: suppliesAmt, analysis: createAnalysis([{account: suppliesDebit}], [{account: 'Accounts Payable'}]) });

    // 3b. Purchase Supplies on Cash (Deferred Expense)
    transactionTemplates.push({ type: 'Supplies Cash', description: `Purchased office supplies for cash, ${fmt(suppliesAmt)}`, debits: [{ account: suppliesDebit, amount: suppliesAmt }], credits: [{ account: 'Cash', amount: suppliesAmt }], amount: suppliesAmt, analysis: createAnalysis([{account: suppliesDebit}], [{account: 'Cash'}]) });

    // 4. Revenue for Cash (Service Only)
    if (!isMerch) {
        const revenueCashAmt = revenueArAmt + 10000;
        transactionTemplates.push({ type: 'Revenue Cash', description: `Provided services for cash, ${fmt(revenueCashAmt)}`, debits: [{ account: 'Cash', amount: revenueCashAmt }], credits: [{ account: revenueAcc, amount: revenueCashAmt }], amount: revenueCashAmt, analysis: createAnalysis([{account: 'Cash'}], [{account: revenueAcc}]) });

        // 5. Revenue on Account (Service Only)
        transactionTemplates.push({ type: 'Revenue Credit', description: `Provided services on account, ${fmt(revenueArAmt)}`, debits: [{ account: 'Accounts Receivable', amount: revenueArAmt }], credits: [{ account: revenueAcc, amount: revenueArAmt }], amount: revenueArAmt, analysis: createAnalysis([{account: 'Accounts Receivable'}], [{account: revenueAcc}]) });
    }

    // 6. Expense: Salaries Paid
    transactionTemplates.push({ type: 'Salary Expense', description: `Paid monthly salaries: ${fmt(salaryAmt)}`, debits: [{ account: 'Salaries Expense', amount: salaryAmt }], credits: [{ account: 'Cash', amount: salaryAmt }], amount: salaryAmt, analysis: createAnalysis([{account: 'Salaries Expense'}], [{account: 'Cash'}]) });

    // 7. Expense: Utilities Paid
    transactionTemplates.push({ type: 'Utility Expense', description: `Paid electricity and water bills: ${fmt(utilityAmt)}`, debits: [{ account: 'Utilities Expense', amount: utilityAmt }], credits: [{ account: 'Cash', amount: utilityAmt }], amount: utilityAmt, analysis: createAnalysis([{account: 'Utilities Expense'}], [{account: 'Cash'}]) });
    
    // 8. Owner's Withdrawal
    transactionTemplates.push({ type: 'Drawings', description: `Owner withdrew cash for personal use: ${fmt(drawAmt)}`, debits: [{ account: drawAcc, amount: drawAmt }], credits: [{ account: 'Cash', amount: drawAmt }], amount: drawAmt, analysis: createAnalysis([{account: drawAcc}], [{account: 'Cash'}], false, true) });

    // 9. Purchase Equipment for Cash
    transactionTemplates.push({ type: 'Equip Cash', description: `Purchased new equipment for cash: ${fmt(equipAmt)}`, debits: [{ account: 'Equipment', amount: equipAmt }], credits: [{ account: 'Cash', amount: equipAmt }], amount: equipAmt, analysis: createAnalysis([{account: 'Equipment'}], [{account: 'Cash'}]) });
    
    // 10. Revenue in Advance (Deferred Income)
    transactionTemplates.push({ type: 'Unearned Revenue', description: `Received cash in advance for services to be performed next month: ${fmt(unearnedAmt)}`, debits: [{ account: 'Cash', amount: unearnedAmt }], credits: [{ account: unearnedCredit, amount: unearnedAmt }], amount: unearnedAmt, analysis: createAnalysis([{account: 'Cash'}], [{account: unearnedCredit}]) });

    // --- OPTIONAL / REPEAT TRANSACTIONS ---
    // A. Collection (Standard)
    transactionTemplates.push({ type: 'Collection AR', description: `Received payment on account from customer, ${fmt(revenueArAmt)}`, debits: [{ account: 'Cash', amount: revenueArAmt }], credits: [{ account: 'Accounts Receivable', amount: revenueArAmt }], amount: revenueArAmt, analysis: createAnalysis([{account: 'Cash'}], [{account: 'Accounts Receivable'}]) });

    // B. Payment (Standard)
    transactionTemplates.push({ type: 'Payment AP', description: `Paid supplier for goods/supplies purchased earlier, ${fmt(suppliesAmt)}`, debits: [{ account: 'Accounts Payable', amount: suppliesAmt }], credits: [{ account: 'Cash', amount: suppliesAmt }], amount: suppliesAmt, analysis: createAnalysis([{account: 'Accounts Payable'}], [{account: 'Cash'}]) });
    
    // Merchandising specific
    if (isMerch) {
        const merchDrAcc = inventorySystem === 'Perpetual' ? 'Merchandise Inventory' : 'Purchases';
        const freightAccIn = inventorySystem === 'Perpetual' ? 'Merchandise Inventory' : 'Freight In';
        
        // Purchase Logic (Cash & Credit, with options)
        const basePurAmt = merchAmt;
        let purAmount = basePurAmt;
        let purDesc = `Purchased merchandise on account`;
        let purTerms = `Terms: ${getShippingTerms()}`;
        
        // Trade Discount Logic
        if (options.includeTradeDiscounts) {
            const tdRate = 0.20; 
            purAmount = basePurAmt * (1 - tdRate);
            purDesc += `, list price ${fmt(basePurAmt)} less 20% trade discount`;
        } else {
            purDesc += ` for ${fmt(purAmount)}`;
        }
        
        // Cash Discount Logic (Terms)
        if (options.includeCashDiscounts) {
            purDesc += `, terms 2/10, n/30`;
        }
        
        purDesc += `. ${purTerms}`;

        // Add Purchase Credit
        transactionTemplates.push({ 
            type: 'Merch Purchase Credit', 
            description: purDesc, 
            debits: [{ account: merchDrAcc, amount: purAmount }], 
            credits: [{ account: 'Accounts Payable', amount: purAmount }], 
            amount: purAmount, 
            analysis: createAnalysis([{account: merchDrAcc}], [{account: 'Accounts Payable'}]) 
        });

        // Add Purchase Cash
        let purCashDesc = `Purchased merchandise for cash`;
        if (options.includeTradeDiscounts) {
             purCashDesc += `, list price ${fmt(basePurAmt)} less 20% trade discount`;
        } else {
             purCashDesc += ` for ${fmt(purAmount)}`;
        }
        purCashDesc += `. ${purTerms}`;

        transactionTemplates.push({ 
            type: 'Merch Purchase Cash', 
            description: purCashDesc, 
            debits: [{ account: merchDrAcc, amount: purAmount }], 
            credits: [{ account: 'Cash', amount: purAmount }], 
            amount: purAmount, 
            analysis: createAnalysis([{account: merchDrAcc}], [{account: 'Cash'}]) 
        });

        // Freight In Logic
        if (options.includeFreight) {
            const freightAmt = 1200;
            transactionTemplates.push({ 
                type: 'Freight In', 
                description: `Paid freight on merchandise purchased: ${fmt(freightAmt)}`, 
                debits: [{ account: freightAccIn, amount: freightAmt }], 
                credits: [{ account: 'Cash', amount: freightAmt }], 
                amount: freightAmt, 
                analysis: createAnalysis([{account: freightAccIn}], [{account: 'Cash'}]) 
            });
        }
        
        // Sale Logic (Cash & Credit, with options)
        const baseSaleAmt = revenueArAmt + 5000;
        let saleAmount = baseSaleAmt;
        let saleDesc = `Sold merchandise on account`;
        let saleTerms = `Terms: ${getShippingTerms()}`;
        
        if (options.includeTradeDiscounts) {
            const tdRate = 0.10;
            saleAmount = baseSaleAmt * (1 - tdRate);
            saleDesc += `, list price ${fmt(baseSaleAmt)} less 10% trade discount`;
        } else {
            saleDesc += ` for ${fmt(saleAmount)}`;
        }
        
        if (options.includeCashDiscounts) {
            saleDesc += `, terms 2/10, n/30`;
        }
        
        saleDesc += `. ${saleTerms}`;

        // Add Sale Credit
        transactionTemplates.push({ 
            type: 'Merch Sale Credit', 
            description: saleDesc, 
            debits: [{ account: 'Accounts Receivable', amount: saleAmount }], 
            credits: [{ account: 'Sales', amount: saleAmount }], 
            amount: saleAmount, 
            analysis: createAnalysis([{account: 'Accounts Receivable'}], [{account: 'Sales'}]) 
        });
        
        // Add Sale Cash
        let saleCashDesc = `Sold merchandise for cash`;
        if (options.includeTradeDiscounts) {
            saleCashDesc += `, list price ${fmt(baseSaleAmt)} less 10% trade discount`;
        } else {
            saleCashDesc += ` for ${fmt(saleAmount)}`;
        }
        saleCashDesc += `. ${saleTerms}`;
        
        transactionTemplates.push({ 
            type: 'Merch Sale Cash', 
            description: saleCashDesc, 
            debits: [{ account: 'Cash', amount: saleAmount }], 
            credits: [{ account: 'Sales', amount: saleAmount }], 
            amount: saleAmount, 
            analysis: createAnalysis([{account: 'Cash'}], [{account: 'Sales'}]) 
        });
        
        // Freight Out Logic
        if (options.includeFreight) {
            const foAmt = 1500;
            transactionTemplates.push({
                type: 'Freight Out',
                description: `Paid freight on merchandise sold (FOB Destination): ${fmt(foAmt)}`,
                debits: [{ account: 'Freight Out', amount: foAmt }],
                credits: [{ account: 'Cash', amount: foAmt }],
                amount: foAmt,
                analysis: createAnalysis([{account: 'Freight Out'}], [{account: 'Cash'}])
            });
        }

        // --- NEW DISCOUNT TRANSACTIONS ---
        if (options.includeCashDiscounts) {
            // Collection with Discount
            const colGross = 8000;
            const colDisc = colGross * 0.02; // 2%
            const colNet = colGross - colDisc;
            transactionTemplates.push({
                type: 'Collection Discount',
                description: `Collected ${fmt(colGross)} accounts receivable within discount period (2/10, n/30)`,
                debits: [
                    { account: 'Cash', amount: colNet },
                    { account: 'Sales Discounts', amount: colDisc }
                ],
                credits: [{ account: 'Accounts Receivable', amount: colGross }],
                amount: colGross,
                // Manual analysis object because Sales Discounts (Revenue) behaves like Expense (Equity Decrease) in analysis
                analysis: { assets: 'Decrease', liabilities: 'No Effect', equity: 'Decrease', cause: 'Decrease in Income' }
            });

            // Payment with Discount
            const payGross = 6000;
            const payDisc = payGross * 0.02;
            const payNet = payGross - payDisc;
            const discountAccount = inventorySystem === 'Perpetual' ? 'Merchandise Inventory' : 'Purchase Discounts';
            
            let payAnalysis = { assets: 'Decrease', liabilities: 'Decrease', equity: 'Increase', cause: 'Decrease in Expense' };
            if (inventorySystem === 'Perpetual') {
                // Cr Inventory -> Assets Decrease. Net Asset change (-Cash -Inv) matches Liab change (-AP). No Equity effect.
                payAnalysis = { assets: 'Decrease', liabilities: 'Decrease', equity: 'No Effect', cause: '' };
            }

            transactionTemplates.push({
                type: 'Payment Discount',
                description: `Paid ${fmt(payGross)} accounts payable within discount period (2/10, n/30)`,
                debits: [{ account: 'Accounts Payable', amount: payGross }],
                credits: [
                    { account: 'Cash', amount: payNet },
                    { account: discountAccount, amount: payDisc }
                ],
                amount: payGross,
                analysis: payAnalysis
            });
        }
    }

    // --- Dynamic Selection and Ordering ---
    let coreTypes = ['Rent Advance', 'Supplies Credit', 'Revenue Cash', 'Revenue Credit', 'Salary Expense', 'Utility Expense', 'Drawings', 'Equip Cash', 'Unearned Revenue'];
    
    if (isMerch) {
        coreTypes = [];
        coreTypes.push('Merch Purchase Credit');
        coreTypes.push('Merch Sale Credit');
        if (options.includeCashDiscounts) coreTypes.push('Collection Discount');
        else coreTypes.push('Collection AR');
        if (options.includeCashDiscounts) coreTypes.push('Payment Discount');
        else coreTypes.push('Payment AP');
        if (options.includeFreight) {
            coreTypes.push('Freight In'); 
        }
        coreTypes.push('Rent Advance');
        coreTypes.push('Salary Expense');
        coreTypes.push('Utility Expense');
        coreTypes.push('Supplies Cash');
    }
    
    let selectedTemplates = [];
    
    // Handle Investment First
    if (!isSubsequentYear) {
        const invest = transactionTemplates.find(t => t.type === 'Investment');
        if (invest) selectedTemplates.push(invest);
    }

    // Select Core
    coreTypes.forEach(type => {
        const template = transactionTemplates.find(t => t.type === type);
        if (template) {
            selectedTemplates.push(template);
        }
    });

    // Fill the remaining spots
    const fillPool = transactionTemplates.filter(t => t.type !== 'Investment');

    while (selectedTemplates.length < count) {
        if (fillPool.length === 0) break;
        const randomIndex = Math.floor(Math.random() * fillPool.length);
        const template = fillPool[randomIndex];
        const transaction = JSON.parse(JSON.stringify(template)); 
        
        if (['Revenue Cash', 'Salary Expense', 'Collection AR', 'Utility Expense', 'Revenue Credit', 'Merch Purchase Cash', 'Merch Sale Cash', 'Collection Discount', 'Payment Discount'].includes(transaction.type)) {
            transaction.amount = transaction.amount + Math.floor(Math.random() * 2000) - 1000;
            if (transaction.amount < 1000) transaction.amount = 1000; 
            
            if (transaction.debits.length > 1 || transaction.credits.length > 1) {
                const ratio = transaction.amount / template.amount;
                transaction.debits.forEach(d => d.amount = Math.round(d.amount * ratio));
                transaction.credits.forEach(c => c.amount = Math.round(c.amount * ratio));
            } else {
                transaction.debits[0].amount = transaction.amount;
                transaction.credits[0].amount = transaction.amount;
            }
            transaction.description = transaction.description.replace(/P[\d,]+/, fmt(transaction.amount));
        }

        selectedTemplates.push(transaction);
    }
    
    const randomDays = Array.from({ length: count }, () => Math.floor(Math.random() * 30) + 1).sort((a, b) => a - b);
    
    const finalTransactions = selectedTemplates.slice(0, count).map((t, index) => {
        const day = randomDays[index];
        const dateStr = `2023-01-${day.toString().padStart(2, '0')}`;
        const transaction = { ...t, id: index + 1, date: dateStr };
        return transaction;
    });
    
    return finalTransactions.filter(t => t && t.analysis && t.debits && t.debits.length > 0 && t.credits && t.credits.length > 0);
};

const generateAdjustments = (ledgerData, businessType, deferredExpenseMethod, deferredIncomeMethod) => {
    const adjustments = [];
    const isMerch = businessType === 'Merchandising' || businessType === 'Manufacturing';
    
    // 1. Supplies
    const suppliesAssetAmt = ledgerData['Supplies'] ? ledgerData['Supplies'].debit : 0;
    const suppliesExpAmt = ledgerData['Supplies Expense'] ? ledgerData['Supplies Expense'].debit : 0;
    const totalSupplies = suppliesAssetAmt + suppliesExpAmt;
    if (totalSupplies > 0) {
        const endingSupplies = Math.round(totalSupplies * 0.3); 
        if (deferredExpenseMethod === 'Asset') {
            const used = totalSupplies - endingSupplies;
             adjustments.push({ id: 'adj1', desc: `Supplies on hand at end of period are P${endingSupplies.toLocaleString()}.`, drAcc: 'Supplies Expense', crAcc: 'Supplies', amount: used });
        } else { // Expense Method
            const unused = endingSupplies;
             adjustments.push({ id: 'adj1', desc: `Supplies on hand at end of period are P${endingSupplies.toLocaleString()}.`, drAcc: 'Supplies', crAcc: 'Supplies Expense', amount: unused });
        }
    }

    // 2. Prepaid Rent
    const rentAssetAmt = ledgerData['Prepaid Rent'] ? ledgerData['Prepaid Rent'].debit : 0;
    const rentExpAmt = ledgerData['Rent Expense'] ? ledgerData['Rent Expense'].debit : 0;
    const totalRent = rentAssetAmt + rentExpAmt;
    if (totalRent > 0) {
        if (deferredExpenseMethod === 'Asset') {
            const expired = Math.round(totalRent / 3);
            adjustments.push({ id: 'adj2', desc: `One month of prepaid rent has expired: P${expired.toLocaleString()}.`, drAcc: 'Rent Expense', crAcc: 'Prepaid Rent', amount: expired });
        } else { // Expense Method
            const unexpired = Math.round((totalRent / 3) * 2);
            adjustments.push({ id: 'adj2', desc: `Two months of rent are still unexpired: P${unexpired.toLocaleString()}.`, drAcc: 'Prepaid Rent', crAcc: 'Rent Expense', amount: unexpired });
        }
    }

    // 3. Unearned Revenue
    const revAccName = isMerch ? 'Sales' : 'Service Revenue';
    const unearnedLiabAmt = ledgerData['Unearned Revenue'] ? ledgerData['Unearned Revenue'].credit : 0;
    const revenueAmt = ledgerData[revAccName] ? ledgerData[revAccName].credit : 0;
    
    if (unearnedLiabAmt > 0 || (deferredIncomeMethod === 'Income' && revenueAmt > 20000)) { 
         if (deferredIncomeMethod === 'Liability') {
             const earned = 2500;
             adjustments.push({ id: 'adj3', desc: `Services performed related to advance payments: P${earned.toLocaleString()}.`, drAcc: 'Unearned Revenue', crAcc: revAccName, amount: earned });
         } else { // Income Method
             const unearned = 3500;
             adjustments.push({ id: 'adj3', desc: `Services paid in advance but not yet performed: P${unearned.toLocaleString()}.`, drAcc: revAccName, crAcc: 'Unearned Revenue', amount: unearned });
         }
    }

    // 4. Accrued Salaries
    adjustments.push({ id: 'adj4', desc: `Accrued salaries: P2,000.`, drAcc: 'Salaries Expense', crAcc: 'Salaries Payable', amount: 2000 });
    
    // 5. Depreciation
    adjustments.push({ id: 'adj5', desc: `Depreciation: P1,500.`, drAcc: 'Depreciation Expense', crAcc: 'Accumulated Depreciation - Equipment', amount: 1500 });

    // 6. Ending Inventory (Merch/Mfg only)
    if (isMerch) {
         const endingInv = 25000;
         adjustments.push({ id: 'adj6', desc: `Merchandise Inventory, End: P${endingInv.toLocaleString()}.`, drAcc: 'Merchandise Inventory', crAcc: 'Income Summary', amount: endingInv });
    }

    return adjustments;
};

// --- NEW HELPER ---
const getLetterGrade = (score, maxScore) => {
    if (maxScore === 0) return 'IR';
    const percentage = (score / maxScore) * 100;
    
    if (percentage >= 95) return 'A';    // Advanced
    if (percentage >= 85) return 'P';    // Proficient
    if (percentage >= 75) return 'D';    // Developing
    return 'IR';                         // Intervention Required
};


// -------------------
// --- steps.js ---
// ------------------





// Import all modular steps with their validation functions






 
 
 



const html = htm.bind(React.createElement);

const TaskSection = ({ step, activityData, answers, stepStatus, onValidate, updateAnswerFns, isCurrentActiveTask, isPrevStepCompleted }) => {
    const stepId = step.id;
    const status = stepStatus[stepId] || { attempts: 3, completed: false, correct: false };
    const isLocked = !isPrevStepCompleted;
    const isCompleted = status.completed;
    const isStickyActive = !isLocked && !isCompleted;
    const { deferredExpenseMethod, deferredIncomeMethod } = activityData.config; // Extract config

    const handlePrint = () => {
        const content = document.querySelector(`.task-content-${stepId}`);
        if (!content) return;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print</title><script src="https://cdn.tailwindcss.com"><\/script></head><body class="bg-white">');
        printWindow.document.write(ActivityHelper.getCustomPrintHeaderHTML());
        printWindow.document.write(ActivityHelper.getPrintStudentInfoHTML(`Task ${stepId}: ${step.title}`, step.description));
        printWindow.document.write(ActivityHelper.getRubricHTML(stepId, step.title));
        printWindow.document.write('<div class="printable-area">' + content.innerHTML + '</div>');
        printWindow.document.write(ActivityHelper.getCustomPrintFooterHTML());
        printWindow.document.close();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
    };

    const handleStep01Change = (id, key, val) => updateAnswerFns.updateNestedAnswer(1, id.toString(), key, val);
    const handleStep02Change = (id, newRows) => updateAnswerFns.updateNestedAnswer(2, id.toString(), 'rows', newRows);
    const handleStep03Change = (key, val) => updateAnswerFns.updateAnswer(3, { ...(answers[3] || {}), [key]: val });
    const handleStep03TogglePR = (key) => {
        const cur = answers[3]?.journalPRs || {};
        updateAnswerFns.updateAnswer(3, {...(answers[3] || {}), journalPRs: {...cur, [key]: !cur[key]}});
    };
    const handleStep04Change = (key, val) => updateAnswerFns.updateAnswer(4, { ...(answers[4] || {}), [key]: val });
    const handleStep05Change = (type, payload) => {
        const stepAnswer = answers[stepId] || {};
        const currentFooters = stepAnswer.footers || {};
        if (type === 'rows') {
             updateAnswerFns.updateAnswer(5, { ...stepAnswer, rows: payload });
        } else if (type === 'footers') {
             const { section, field, val } = payload;
             const newSection = { ...currentFooters[section], [field]: val };
             updateAnswerFns.updateAnswer(5, { ...stepAnswer, footers: { ...currentFooters, [section]: newSection } });
        }
    };
    const handleStep06Change = (section, data) => updateAnswerFns.updateAnswer(6, { ...(answers[6] || {}), [section]: data });
    const handleStep07Change = (section, data) => updateAnswerFns.updateAnswer(7, { ...(answers[7] || {}), [section]: data });
    const handleStep08Change = (section, data) => updateAnswerFns.updateAnswer(8, { ...(answers[8] || {}), [section]: data });
    const handleStep9Change = (key, val) => updateAnswerFns.updateAnswer(9, { ...(answers[9] || {}), [key]: val });
    const handleStep10Change = (adjId, val) => updateAnswerFns.updateAnswer(10, { ...(answers[10] || {}), [adjId]: val });

    const handleGenericChange = (k, v) => updateAnswerFns.updateAnswer(stepId, { ...(answers[stepId] || {}), [k]: v });

    // --- SCORE DISPLAY LOGIC ---
    let scoreDisplay = null;
    
    // Step 2
    if (stepId === 2 && answers[2] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep02 === 'function') {
            const res = validateStep02(activityData.transactions, answers[2]);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 3
    else if (stepId === 3 && answers[3] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep03 === 'function') {
            const res = validateStep03(activityData, answers[3]);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 4
    else if (stepId === 4 && answers[4] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep04 === 'function') {
            const res = validateStep04(activityData, answers[4]);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 5
    else if (stepId === 5 && answers[5] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep05 === 'function') {
            const res = validateStep05(activityData.ledger, activityData.adjustments, answers[5]);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 6
    else if (stepId === 6 && answers[6] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep06 === 'function') {
            const res = validateStep06(activityData.ledger, activityData.adjustments, activityData, answers[6]);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 7
    else if (stepId === 7 && answers[7] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep07 === 'function') {
            const res = validateStep07(activityData.adjustments, answers[7].journal || {}, answers[7].ledger || {}, activityData.transactions);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 8
    else if (stepId === 8 && answers[8] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep08 === 'function') {
            const res = validateStep08(answers[8], activityData);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    // Step 9
    else if (stepId === 9 && answers[9] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep09 === 'function') {
            const res = validateStep09(answers[9], activityData);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }

    else if (stepId === 10 && answers[10] && (status.completed || status.attempts < 3)) {
        if (typeof validateStep10 === 'function') {
            const res = validateStep10(answers[10], activityData);
            if (res.maxScore > 0) {
                scoreDisplay = html`<span className="ml-3 font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200">Score: ${res.score} of ${res.maxScore} - ([${res.letterGrade}])</span>`;
            }
        }
    }
    
    const renderStepContent = () => {
        if (isLocked) return html`<div className="p-8 text-center bg-gray-100 rounded text-gray-500"><${Lock} size=${32} className="mx-auto mb-2" /> Task Locked (Complete previous task to unlock)</div>`;
        // Show feedback if attempts are used OR if the task is marked completed (perfect score)
        const showFeedback = status.attempts < 3 || status.completed;
        
        if (stepId === 1) return html`<${Step01Analysis} transactions=${activityData.transactions} data=${answers[1] || {}} onChange=${handleStep01Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        if (stepId === 2) return html`<${Step02Journalizing} transactions=${activityData.transactions} data=${answers[2] || {}} onChange=${handleStep02Change} showFeedback=${showFeedback} validAccounts=${activityData.validAccounts} isReadOnly=${status.completed} />`;
        if (stepId === 3) return html`<${Step03Posting} activityData=${activityData} data=${answers[3] || {}} onChange=${handleStep03Change} showFeedback=${showFeedback} validAccounts=${activityData.validAccounts} ledgerKey=${activityData.ledger} transactions=${activityData.transactions} beginningBalances=${activityData.beginningBalances} isReadOnly=${status.completed} journalPRs=${answers[3]?.journalPRs || {}} onTogglePR=${handleStep03TogglePR} matchedJournalEntries=${status.completed || showFeedback ? (answers[3]?.matched || new Set()) : null} />`;
        if (stepId === 4) return html`<${Step04TrialBalance} activityData=${activityData} transactions=${activityData.transactions} validAccounts=${activityData.validAccounts} beginningBalances=${activityData.beginningBalances} isSubsequentYear=${activityData.config.isSubsequentYear} data=${answers[4] || {}} onChange=${handleStep04Change} showFeedback=${showFeedback} isReadOnly=${status.completed} expectedLedger=${activityData.ledger} />`;
        if (stepId === 5) return html`<${Step05Worksheet} ledgerData=${activityData.ledger} adjustments=${activityData.adjustments} data=${answers[stepId] || {}} onChange=${handleStep05Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        if (stepId === 6) return html`<${Step06FinancialStatements} ledgerData=${activityData.ledger} adjustments=${activityData.adjustments} activityData=${activityData} data=${answers[stepId] || {}} onChange=${handleStep06Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        if (stepId === 7) return html`<${Step07AdjustingEntries} activityData=${activityData} data=${answers[stepId] || {}} onChange=${handleStep07Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        if (stepId === 8) return html`<${Step08ClosingEntries} activityData=${activityData} data=${answers[stepId] || {}} onChange=${handleStep08Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        if (stepId === 9) {
            // We only need to inject the Closing Entries from Step 8 so the Ledger View can show them.
            // The component handles its own validation logic internally.
            const closingJournal = answers[8]?.journal; 
            const step9Data = { ...(answers[stepId] || {}), closingJournal };

            return html`<${Step09PostClosingTB} activityData=${activityData} data=${step9Data} onChange=${handleStep9Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        }
        if (stepId === 10) return html`<${Step10ReversingEntries} activityData=${activityData} data=${answers[stepId] || {}} onChange=${handleStep10Change} showFeedback=${showFeedback} isReadOnly=${status.completed} />`;
        
        return html`<${GenericStep} stepId=${stepId} title=${step.title} onChange=${handleGenericChange} data=${answers[stepId]} />`;
    };

    // Calculate conditional instruction for the hardcoded Step 8 block
    const showDeferredNote = (deferredExpenseMethod === 'Expense' || deferredIncomeMethod === 'Income');
    const deferredLine = showDeferredNote ? "<li>Expense or Income method is to be used in accounting for Deferred Items.</li>" : "";

    return html`
        <div id=${`task-${stepId}`} className="mb-8">
            <div className=${`bg-white p-4 shadow-md rounded-lg mb-4 border-b border-gray-200 no-print ${isStickyActive ? 'task-sticky-header border-b-4 border-blue-600' : ''} ${isCompleted ? 'border-b-4 border-green-600' : ''}`}>
                <div className="flex justify-between items-start gap-4">
                    <div className="flex-1"><h2 className="text-2xl font-bold text-gray-800">Task #${stepId}: ${step.title}</h2><p className="text-gray-600 text-sm">${step.description}</p></div>
                    <div className="flex items-center gap-3">
                        ${isCompleted 
                            ? html`<span className=${`text-sm font-bold flex items-center bg-green-50 px-3 py-1 rounded border ${status.correct ? 'text-green-600 border-green-200' : 'text-red-600 border-red-200'}`}><${Check} size=${16} className="mr-1"/> ${status.correct ? 'Completed' : 'Completed (3 Attempts Used)'}</span>`
                            : isLocked 
                                ? html`<span className="text-gray-500 font-bold flex items-center bg-gray-100 px-3 py-1 rounded border border-gray-300"><${Lock} size=${16} className="mr-1"/> Locked</span>`
                                : html`<div className="text-right flex items-center">
                                    <div className="mr-3 text-xs font-semibold text-gray-500">Attempts: <span className=${status.attempts <= 1 ? 'text-red-500' : 'text-gray-700'}>${status.attempts}</span></div>
                                    <button onClick=${() => onValidate(stepId)()} disabled=${status.attempts <= 0} className=${`px-4 py-2 rounded font-bold text-white flex items-center gap-2 ${status.attempts > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'}`}><${Check} size=${18} /> Validate</button>
                                    ${scoreDisplay}
                                </div>`
                        }
                        <button onClick=${handlePrint} className="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 hidden sm:block"><${Printer} size=${18} /></button>
                    </div>
                </div>
                ${(stepId === 2) && html`<div className="mt-2 pt-2 border-t text-sm"><div className="bg-yellow-50 p-2 rounded border border-yellow-200" dangerouslySetInnerHTML=${{ __html: ActivityHelper.getInstructionsHTML(stepId, step.title, activityData.validAccounts, false, null, deferredExpenseMethod, deferredIncomeMethod) }} /></div>`}
                ${(stepId === 3) && html`<div className="mt-2 pt-2 border-t text-sm"><div className="bg-yellow-50 p-2 rounded border border-yellow-200" dangerouslySetInnerHTML=${{ __html: ActivityHelper.getInstructionsHTML(stepId, step.title, activityData.validAccounts, activityData.config.isSubsequentYear, activityData.beginningBalances, deferredExpenseMethod, deferredIncomeMethod) }} /></div>`}
                ${(stepId === 8) && html`<div className="mt-2 pt-2 border-t text-sm"><div className="bg-yellow-50 p-2 rounded border border-yellow-200"><p class="font-bold">Instructions:</p><ul class="list-disc list-inside space-y-1 ml-2"><li>Journalize the closing entries using the REID method (Revenue, Expenses, Income Summary, Drawings).</li><li dangerouslySetInnerHTML=${{ __html: deferredLine.replace(/<\/?li>/g, '') }} style=${{ display: showDeferredNote ? 'list-item' : 'none' }}></li><li>Post the closing entries to the General Ledger.</li><li>Ensure all nominal accounts (Revenues, Expenses, Drawings) have a zero balance.</li></ul></div></div>`}
            </div>
            <div className="no-print space-y-3 mb-6">
                ${stepId !== 2 && stepId !== 3 && stepId !== 7 && stepId !== 8 && html`<div className="bg-gray-100 p-3 rounded-lg border text-sm" dangerouslySetInnerHTML=${{ __html: ActivityHelper.getInstructionsHTML(stepId, step.title, activityData.validAccounts, false, null, deferredExpenseMethod, deferredIncomeMethod) }} />`}
                <div dangerouslySetInnerHTML=${{ __html: ActivityHelper.getRubricHTML(stepId, step.title) }} />
            </div>
            <div className=${`printable-area task-content-${stepId}`}>${renderStepContent()}</div>
        </div>
    `;
};


// -----------------
// --- App.js ------
// -----------------






// Import all modular steps












const html = htm.bind(React.createElement);

// --- COMPONENT: Full Report View (Hidden, used for Printing) ---
const ReportView = ({ activityData, answers }) => {
    return html`
        <div id="full-report-container" className="hidden">
            <div id="print-footer-template">
                <div className="w-full px-8 pb-4 font-serif text-xs">
                    <div className="flex justify-between items-end border-t border-gray-400 pt-2 mb-1">
                        <span className="font-bold">FABM 2</span>
                        <span className="page-number-slot"></span> 
                    </div>
                    <div className="border border-gray-800 p-1 text-center font-bold">
                        [4Cs: Christ-centeredness, Competence, Character, Compassion]
                    </div>
                </div>
            </div>

            <div className="p-8 space-y-8 report-body font-serif text-sm">
                <div className="text-center border-b-2 border-gray-800 pb-4 mb-8">
                    <h1 className="text-2xl font-bold text-blue-900 uppercase">Fundamentals of Accountancy, Business and Management 2</h1>
                    <h2 className="text-xl font-bold text-gray-700 mt-2">Comprehensive Activity Report</h2>
                    <div className="mt-4 flex justify-center gap-8">
                        <p><strong>Company:</strong> ${activityData.config.businessType} - ${activityData.config.ownership}</p>
                        <p><strong>Period:</strong> ${activityData.config.isSubsequentYear ? 'Subsequent Year' : 'First Year'}</p>
                    </div>
                </div>

                ${activityData.steps.map(step => {
                    const stepId = step.id;
                    const stepAnswer = answers[stepId] || {};
                    const props = {
                        activityData, 
                        data: stepAnswer, 
                        isReadOnly: true, 
                        showFeedback: true,
                        onChange: () => {} 
                    };

                    let content = null;
                    if (stepId === 1) content = html`<${Step01Analysis} transactions=${activityData.transactions} ...${props} />`;
                    else if (stepId === 2) content = html`<${Step02Journalizing} transactions=${activityData.transactions} validAccounts=${activityData.validAccounts} ...${props} />`;
                    else if (stepId === 3) {
                         const journalPRs = stepAnswer.journalPRs || {};
                         content = html`<${Step03Posting} validAccounts=${activityData.validAccounts} ledgerKey=${activityData.ledger} transactions=${activityData.transactions} beginningBalances=${activityData.beginningBalances} ...${props} journalPRs=${journalPRs} />`;
                    }
                    else if (stepId === 4) content = html`<${Step04TrialBalance} transactions=${activityData.transactions} validAccounts=${activityData.validAccounts} beginningBalances=${activityData.beginningBalances} isSubsequentYear=${activityData.config.isSubsequentYear} expectedLedger=${activityData.ledger} ...${props} />`;
                    else if (stepId === 5) content = html`<${Step05Worksheet} ledgerData=${activityData.ledger} adjustments=${activityData.adjustments} ...${props} />`;
                    else if (stepId === 6) content = html`<${Step06FinancialStatements} ledgerData=${activityData.ledger} adjustments=${activityData.adjustments} ...${props} />`;
                    else if (stepId === 7) content = html`<${Step07AdjustingEntries} ...${props} />`;
                    else if (stepId === 8) {
                        let valRes = null;
                        if(typeof validateStep08 === 'function') valRes = validateStep08(stepAnswer, activityData);
                        content = html`<${Step08ClosingEntries} ...${props} validationResult=${valRes} />`;
                    }
                    else if (stepId === 9) {
                         const closingJournal = answers[8]?.journal;
                         const step9Data = { ...stepAnswer, closingJournal };
                         content = html`<${Step09PostClosingTB} ...${props} data=${step9Data} />`;
                    }
                    else if (stepId === 10) content = html`<${Step10ReversingEntries} ...${props} />`;
                    else content = html`<${GenericStep} stepId=${stepId} title=${step.title} ...${props} />`;

                    return html`
                        <div key=${stepId} className="report-section mb-10 break-inside-avoid">
                            <h3 className="text-lg font-bold text-gray-800 border-b border-gray-300 mb-4 pb-1 uppercase">
                                Task ${stepId}: ${step.title}
                            </h3>
                            ${content}
                        </div>
                        ${(stepId === 5 || stepId === 6 || stepId === 9) ? html`<div className="page-break"></div>` : ''}
                    `;
                })}
            </div>
        </div>
    `;
};


const TeacherDashboard = ({ onGenerate, onResume }) => {
    // PERSISTENCE
    const [businessType, setBusinessType] = useState(() => localStorage.getItem('ac_businessType') || 'Service');
    const [ownership, setOwnership] = useState(() => localStorage.getItem('ac_ownership') || 'Sole Proprietorship');
    const [inventorySystem, setInventorySystem] = useState(() => localStorage.getItem('ac_inventorySystem') || 'Periodic');
    const [numTransactions, setNumTransactions] = useState(() => Number(localStorage.getItem('ac_numTransactions')) || 10);
    const [selectedSteps, setSelectedSteps] = useState(() => localStorage.getItem('ac_selectedSteps') ? JSON.parse(localStorage.getItem('ac_selectedSteps')) : STEPS.map(s => s.id));
    const [fsFormat, setFsFormat] = useState(() => localStorage.getItem('ac_fsFormat') || 'Single');
    const [includeCashFlows, setIncludeCashFlows] = useState(() => localStorage.getItem('ac_includeCashFlows') === 'true');
    const [enableAutoSave, setEnableAutoSave] = useState(() => localStorage.getItem('ac_enableAutoSave') === 'true');
    const [isGenerating, setIsGenerating] = useState(false);

    // Standard Options
    const [includeTradeDiscounts, setIncludeTradeDiscounts] = useState(false);
    const [includeCashDiscounts, setIncludeCashDiscounts] = useState(false);
    const [includeFreight, setIncludeFreight] = useState(false);
    const [numPartners, setNumPartners] = useState(2);
    const [isSubsequentYear, setIsSubsequentYear] = useState(false);
    const [deferredExpenseMethod, setDeferredExpenseMethod] = useState('Asset');
    const [deferredIncomeMethod, setDeferredIncomeMethod] = useState('Liability');
    
    // Check for saved progress
    const [savedProgress, setSavedProgress] = useState(null);

    useEffect(() => { 
        const saved = localStorage.getItem('ac_student_progress');
        if (saved) {
            try {
                setSavedProgress(JSON.parse(saved));
            } catch (e) { console.error("Error loading progress", e); }
        }
    }, []);

    // PERSISTENCE EFFECTS
    useEffect(() => { localStorage.setItem('ac_businessType', businessType); }, [businessType]);
    useEffect(() => { localStorage.setItem('ac_ownership', ownership); }, [ownership]);
    useEffect(() => { localStorage.setItem('ac_inventorySystem', inventorySystem); }, [inventorySystem]);
    useEffect(() => { localStorage.setItem('ac_numTransactions', numTransactions); }, [numTransactions]);
    useEffect(() => { localStorage.setItem('ac_selectedSteps', JSON.stringify(selectedSteps)); }, [selectedSteps]);
    useEffect(() => { localStorage.setItem('ac_fsFormat', fsFormat); }, [fsFormat]);
    useEffect(() => { localStorage.setItem('ac_includeCashFlows', includeCashFlows); }, [includeCashFlows]);
    useEffect(() => { localStorage.setItem('ac_enableAutoSave', enableAutoSave); }, [enableAutoSave]);

    const toggleStep = (id) => setSelectedSteps(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    const handleSelectAll = (e) => e.target.checked ? setSelectedSteps(STEPS.map(s => s.id)) : setSelectedSteps([]);
    const isAllSelected = selectedSteps.length === STEPS.length;
    const isMerchOrMfg = businessType === 'Merchandising' || businessType === 'Manufacturing';

    const clearSave = () => {
        if(confirm("Are you sure you want to delete the saved progress?")) {
            localStorage.removeItem('ac_student_progress');
            setSavedProgress(null);
        }
    };

    const handleDownloadStandalone = async () => {
        // SECURITY CHECK
        if (window.location.protocol === 'file:') {
            alert("Security Restriction: Browsers block reading files directly from the hard drive (file:// protocol).\n\nPlease host this on GitHub Pages or use a local server.");
            return;
        }

        setIsGenerating(true);
        const config = { 
            businessType, ownership, inventorySystem, 
            numTransactions: Number(numTransactions) || 10, 
            selectedSteps, numPartners: Number(numPartners) || 2, 
            isSubsequentYear, deferredExpenseMethod, deferredIncomeMethod, 
            fsFormat, includeCashFlows, enableAutoSave, 
            options: { includeTradeDiscounts, includeCashDiscounts, includeFreight } 
        };
        // Trigger generic generation first to get the data
        await onGenerate(config, true); 
        setIsGenerating(false);
    };

    return html`
        <div className="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
            <div className="flex justify-between items-center mb-6 border-b pb-2">
                 <h2 className="text-2xl font-bold text-gray-800">Activity Configuration</h2>
                 ${savedProgress && html`
                    <div className="flex items-center gap-2">
                        <span className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">Resume Available</span>
                        <button onClick=${() => onResume(savedProgress)} className="bg-green-600 text-white text-xs px-3 py-1 rounded hover:bg-green-700 flex items-center gap-1"><${FileText} size=${14}/> Resume Activity</button>
                        <button onClick=${clearSave} className="text-red-500 hover:bg-red-50 p-1 rounded"><${Trash2} size=${14}/></button>
                    </div>
                 `}
            </div>
            
            <div className="mb-6 bg-yellow-50 p-3 rounded border border-yellow-200 flex items-center justify-between">
                <div>
                    <h3 className="font-bold text-yellow-900 text-sm">Student Session Settings</h3>
                    <p className="text-xs text-yellow-700">Enable this to allow students to close the browser and continue later on the same device.</p>
                </div>
                <label className="flex items-center gap-2 cursor-pointer">
                    <span className="text-sm font-bold text-gray-700">Enable Auto-Save to Device</span>
                    <input type="checkbox" checked=${enableAutoSave} onChange=${(e)=>setEnableAutoSave(e.target.checked)} className="rounded text-green-600 focus:ring-green-500 w-5 h-5"/>
                </label>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                <div className="text-left">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Business Organization</label>
                    <select value=${businessType} onChange=${(e) => setBusinessType(e.target.value)} className="w-full p-2 border rounded-md">
                        <option>Service</option>
                        <option>Merchandising</option>
                        <option>Manufacturing</option>
                        <option>Banking</option>
                    </select>
                </div>
                <div className="text-center">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Form of Ownership</label>
                    <select value=${ownership} onChange=${(e) => setOwnership(e.target.value)} className="w-full p-2 border rounded-md">
                        <option>Sole Proprietorship</option>
                        <option>Partnership</option>
                        <option>One Person Corporation</option><option>Cooperative</option>
                    </select>
                </div>
                <div className="text-right">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Number of Transactions</label>
                    <input type="number" min="5" max="30" value=${numTransactions} onChange=${(e) => setNumTransactions(e.target.value)} className="w-full p-2 border rounded-md text-right" />
                </div>
            </div>
            
            ${isMerchOrMfg && html`
                <div className="bg-blue-50 p-4 rounded border border-blue-200 mb-6">
                    <h3 className="font-bold text-blue-900 mb-3 text-sm uppercase">Merchandising & Manufacturing Options</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Inventory System</label>
                            <select value=${inventorySystem} onChange=${(e) => setInventorySystem(e.target.value)} className="w-full p-2 border rounded-md bg-white">
                                <option>Periodic</option>
                                <option>Perpetual</option>
                            </select>
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="font-medium text-sm text-gray-700">Include Transactions:</label>
                            <label className="flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded">
                                <input type="checkbox" checked=${includeTradeDiscounts} onChange=${(e) => setIncludeTradeDiscounts(e.target.checked)} className="rounded text-blue-600 focus:ring-blue-500" />
                                <span className="text-sm">Trade Discounts</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded">
                                <input type="checkbox" checked=${includeCashDiscounts} onChange=${(e) => setIncludeCashDiscounts(e.target.checked)} className="rounded text-blue-600 focus:ring-blue-500" />
                                <span className="text-sm">Cash Discounts (e.g. 2/10, n/30)</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded">
                                <input type="checkbox" checked=${includeFreight} onChange=${(e) => setIncludeFreight(e.target.checked)} className="rounded text-blue-600 focus:ring-blue-500" />
                                <span className="text-sm">Freight In/Out</span>
                            </label>
                        </div>
                    </div>
                </div>
            `}

            <div className="bg-green-50 p-4 rounded border border-green-200 mb-6">
                 <h3 className="font-bold text-green-900 mb-3 text-sm uppercase">Step 6: Financial Statement Options</h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Income Statement Format</label>
                        <select value=${fsFormat} onChange=${(e) => setFsFormat(e.target.value)} className="w-full p-2 border rounded-md">
                            <option value="Single">Single-Step</option>
                            <option value="Multi">Multi-Step</option>
                        </select>
                    </div>
                    <div className="flex items-end pb-2">
                        <label className="flex items-center gap-2 cursor-pointer hover:bg-green-100 p-2 rounded w-full border border-transparent hover:border-green-300">
                            <input type="checkbox" checked=${includeCashFlows} onChange=${(e) => setIncludeCashFlows(e.target.checked)} className="rounded text-green-600 focus:ring-green-500 w-5 h-5" />
                            <span className="font-medium text-gray-800">Include Statement of Cash Flows</span>
                        </label>
                    </div>
                 </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div className="bg-orange-50 p-3 rounded border border-orange-200">
                    <h3 className="font-bold text-orange-900 mb-3 text-sm text-left">Deferred Items Method</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="text-left">
                            <label className="block text-xs font-medium text-gray-700 mb-1">Deferred Expense</label>
                            <select value=${deferredExpenseMethod} onChange=${(e)=>setDeferredExpenseMethod(e.target.value)} className="w-full p-1 border rounded text-sm">
                                <option value="Asset">Asset Method (Default)</option>
                                <option value="Expense">Expense Method</option>
                            </select>
                        </div>
                        <div className="text-right">
                            <label className="block text-xs font-medium text-gray-700 mb-1">Deferred Income</label>
                            <select value=${deferredIncomeMethod} onChange=${(e)=>setDeferredIncomeMethod(e.target.value)} className="w-full p-1 border rounded text-sm text-right">
                                <option value="Liability">Liability Method (Default)</option>
                                <option value="Income">Income Method</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div className="bg-purple-50 p-3 rounded border border-purple-200">
                    <h3 className="font-bold text-purple-900 mb-2 text-sm text-right">Accounting Period</h3>
                    <div className="flex flex-col gap-2 items-end">
                        <label className="flex items-center gap-2 cursor-pointer justify-end w-full">
                            <span className="text-sm">First Year of Operations (Start from zero)</span>
                            <input type="radio" checked=${!isSubsequentYear} onChange=${() => setIsSubsequentYear(false)} />
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer justify-end w-full">
                            <span className="text-sm">Subsequent Year (Has Beginning Balances)</span>
                            <input type="radio" checked=${isSubsequentYear} onChange=${() => setIsSubsequentYear(true)} />
                        </label>
                    </div>
                </div>
            </div>

            <div className="mb-8">
                <div className="flex items-center justify-between mb-2">
                    <label className="block text-sm font-medium text-gray-700">Include Accounting Cycle Steps</label>
                    <label className="flex items-center space-x-2 text-sm text-blue-600 cursor-pointer bg-blue-50 px-3 py-1 rounded">
                        <input type="checkbox" checked=${isAllSelected} onChange=${handleSelectAll} />
                        <span className="font-semibold">${isAllSelected ? 'Deselect All' : 'Select All'}</span>
                    </label>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-72 overflow-y-auto border p-4 rounded-md bg-gray-50">
                    ${STEPS.map(step => html`
                        <div key=${step.id} className="flex items-start space-x-2">
                            <input type="checkbox" checked=${selectedSteps.includes(step.id)} onChange=${() => toggleStep(step.id)} className="mt-1" />
                            <div>
                                <span className="font-semibold block text-sm">Step ${step.id}: ${step.title}</span>
                                <span className="text-xs text-gray-500">${step.description}</span>
                            </div>
                        </div>
                    `)}
                </div>
            </div>

            <div className="flex gap-4">
                <button onClick=${() => onGenerate({ businessType, ownership, inventorySystem, numTransactions: Number(numTransactions) || 10, selectedSteps, numPartners: Number(numPartners) || 2, isSubsequentYear, deferredExpenseMethod, deferredIncomeMethod, fsFormat, includeCashFlows, enableAutoSave, options: { includeTradeDiscounts, includeCashDiscounts, includeFreight } })} className="flex-1 bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 font-bold flex items-center justify-center gap-2"><${RefreshCw} size=${20} /> Generate Activity</button>
                <button onClick=${handleDownloadStandalone} disabled=${isGenerating} className=${`bg-gray-800 text-white py-3 px-6 rounded-md hover:bg-black font-bold flex items-center justify-center gap-2 ${isGenerating ? 'opacity-70 cursor-wait' : ''}`}>
                    ${isGenerating ? html`<${Loader} size=${20} className="animate-spin"/>` : html`<${Download} size=${20} />`}
                    Download as HTML File
                </button>
            </div>
            <div className="mt-4 pt-4 border-t text-xs text-gray-400 text-center">${APP_VERSION}</div>
        </div>
    `;
};

const App = () => {
    // STUDENT MODE CHECK: If "window.STUDENT_CONFIG" exists, we use that data and skip the dashboard.
    const preloadedData = window.STUDENT_CONFIG || null;

    const [mode, setMode] = useState(preloadedData ? 'activity' : 'config');
    const [activityData, setActivityData] = useState(preloadedData);
    const [currentStepIndex, setCurrentStepIndex] = useState(0); 
    const [stepStatus, setStepStatus] = useState(preloadedData ? preloadedData.initialStatus : {});
    const [answers, setAnswers] = useState({});
    
    // Auto-Save Effect
    useEffect(() => {
        if (activityData?.config?.enableAutoSave && mode === 'activity') {
            const progress = {
                activityData,
                currentStepIndex,
                stepStatus,
                answers,
                timestamp: Date.now()
            };
            localStorage.setItem('ac_student_progress', JSON.stringify(progress));
        }
    }, [answers, stepStatus, currentStepIndex, activityData, mode]);

    const updateAnswer = useCallback((stepId, data) => setAnswers(p => ({ ...p, [stepId]: data })), []);
    const updateNestedAnswer = useCallback((stepId, key, subKey, value) => setAnswers(prev => { const stepData = prev[stepId] || {}; const keyData = stepData[key] || {}; return { ...prev, [stepId]: { ...stepData, [key]: { ...keyData, [subKey]: value } } }; }), []);
    
    const updateTrialBalanceAnswer = useCallback((stepId, acc, side, val) => {
        setAnswers(prev => {
            const stepData = prev[stepId] || {};
            const accData = stepData[acc] || {};
            return { ...prev, [stepId]: { ...stepData, [acc]: { ...accData, [side]: val } } };
        });
    }, []);

    const handleResume = (savedData) => {
        setActivityData(savedData.activityData);
        setStepStatus(savedData.stepStatus);
        setAnswers(savedData.answers);
        setCurrentStepIndex(savedData.currentStepIndex);
        setMode('activity');
        setTimeout(() => document.getElementById(`task-${savedData.activityData.steps[savedData.currentStepIndex].id}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
    };

    const generateData = (config) => {
        const transactions = generateTransactions(config.numTransactions, config.businessType, config.ownership, config.inventorySystem, config.options, config.isSubsequentYear, config.deferredExpenseMethod, config.deferredIncomeMethod);
        const usedAccounts = new Set();
        transactions.forEach(t => { t.debits.forEach(d => usedAccounts.add(d.account)); t.credits.forEach(c => usedAccounts.add(c.account)); });
        let beginningBalances = null;
        if (config.isSubsequentYear) {
            beginningBalances = generateBeginningBalances(config.businessType, config.ownership);
            Object.keys(beginningBalances.balances).forEach(acc => { if (!usedAccounts.has(acc)) usedAccounts.add(acc); });
        }
        const finalValidAccounts = sortAccounts(Array.from(usedAccounts));
        const ledgerAgg = {};
        if (beginningBalances) Object.keys(beginningBalances.balances).forEach(acc => ledgerAgg[acc] = { debit: beginningBalances.balances[acc].dr, credit: beginningBalances.balances[acc].cr });
        transactions.forEach(t => {
            t.debits.forEach(d => { if(!ledgerAgg[d.account]) ledgerAgg[d.account] = { debit: 0, credit: 0 }; ledgerAgg[d.account].debit += d.amount; });
            t.credits.forEach(c => { if(!ledgerAgg[c.account]) ledgerAgg[c.account] = { debit: 0, credit: 0 }; ledgerAgg[c.account].credit += c.amount; });
        });
        const adjustments = generateAdjustments(ledgerAgg, config.businessType, config.deferredExpenseMethod, config.deferredIncomeMethod);
        const initialStatus = {};
        const selectedSteps = STEPS.filter(s => config.selectedSteps.includes(s.id));
        selectedSteps.forEach((s) => { initialStatus[s.id] = { completed: false, attempts: 3, correct: false }; });
        
        return { config, transactions, ledger: ledgerAgg, validAccounts: finalValidAccounts, beginningBalances, adjustments, steps: selectedSteps, initialStatus };
    };

    // --- CLIENT-SIDE BUNDLER LOGIC ---
    const handleGenerate = async (config, isDownload = false) => {
        const data = generateData(config);
        
        if (isDownload) {
            try {
                // 1. Resolve Path Base using import.meta.url
                const baseUrl = new URL('.', import.meta.url).href;

                // 2. Fetch all source files (Relative to App.js location)
                const files = [
                    'utils.js', 'steps.js', 'App.js',
                    'steps/Step01Analysis.js', 'steps/Step02Journalizing.js',
                    'steps/Step03Posting.js', 'steps/Step04TrialBalance.js',
                    'steps/Step05Worksheet.js', 'steps/Step06FinancialStatements.js',
                    'steps/Step07AdjustingEntries.js', 'steps/Step08ClosingEntries.js',
                    'steps/Step09PostClosingTB.js', 'steps/Step10ReversingEntries.js',
                    'steps/GenericStep.js'
                ];
                
                const fetchedCodes = await Promise.all(files.map(async f => {
                    const url = new URL(f, baseUrl).href;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Failed to load ${f}`);
                    return await res.text();
                }));

                // 3. Process code: Strip imports/exports to make them work in one script scope
                const mergedCode = fetchedCodes.map(code => {
                     // Remove imports relative to local files (./...)
                     // Regex: match import lines that start with ./ or ../
                     let c = code.replace(/import\s+.*?;/g, ''); // Aggressive strip of ALL imports (even CDN ones)
                     
                     // Clean up exports (turn them into simple variable declarations)
                     c = c.replace(/function/g, 'function');
                     c = c.replace(/const/g, 'const');
                     c = c.replace(/const/g, 'const');
                     c = c.replace(/function/g, 'function');
                     c = c.replace(//g, '');
                     
                     // CRITICAL: Escape closing script tags in string literals (like in handlePrint)
                     c = c.replace(/<\/script>/g, '<\\/script>');
                     return c;
                }).join('\n\n');

                // 4. Construct HTML via ARRAY (NOT template literal) to avoid nesting issues
                const htmlParts = [
                    '<!DOCTYPE html>',
                    '<html lang="en">',
                    '<head>',
                    '    <meta charset="UTF-8">',
                    '    <meta name="viewport" content="width=device-width, initial-scale=1.0">',
                    '    <title>Accounting Activity: ' + config.businessType + '</title>',
                    '    <script src="https://cdn.tailwindcss.com"><\/script>',
                    '    <script>window.STUDENT_CONFIG = ' + JSON.stringify(data) + ';<\/script>',
                    '    <style>',
                    '        @page { size: 8.5in 13in; margin: 0.5in; margin-bottom: 0.8in; }',
                    '        @media print { ',
                    '            body { -webkit-print-color-adjust: exact; } ',
                    '            .page-break { page-break-after: always; }',
                    '            .break-inside-avoid { break-inside: avoid; }',
                    '            .hidden { display: block !important; }',
                    '            button, .no-print { display: none !important; }',
                    '            .print-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 0.8in; }',
                    '            .report-body { margin-bottom: 0.8in; }',
                    '        }',
                    '        ::-webkit-scrollbar { display: none; }',
                    '        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }',
                    '        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }',
                    '        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }',
                    '        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }',
                    '    </style>',
                    '</head>',
                    '<body class="bg-gray-50 text-gray-900">',
                    '    <div id="root"></div>',
                    '    <script type="module">',
                    '        ',
                    '        ',
                    '        ',
                    '        ',
                    '        ',
                    '        // Expose icons globally for merged code',
                    '        const { Book, Check, RefreshCw, ArrowLeft, Save, Printer, FileText, Trash2, AlertCircle, Download, Loader, Lock, ChevronDown, ChevronRight, Table, Plus, X } = Lucide;',
                    '',
                    mergedCode,
                    '',
                    '        const root = createRoot(document.getElementById(\'root\'));',
                    '        root.render(React.createElement(App));',
                    '    <\/script>',
                    '</body>',
                    '</html>'
                ];

                // 5. Download Blob
                const blob = new Blob(htmlParts, { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Activity_${config.businessType}_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error(err);
                alert("Failed to bundle standalone file. \nError: " + err.message);
            }
            return;
        }

        // Clear old save if starting new
        if(config.enableAutoSave) {
             localStorage.removeItem('ac_student_progress');
        }

        setActivityData({ 
            config: data.config, 
            transactions: data.transactions, 
            ledger: data.ledger, 
            validAccounts: data.validAccounts, 
            beginningBalances: data.beginningBalances, 
            adjustments: data.adjustments, 
            steps: data.steps 
        });
        setStepStatus(data.initialStatus);
        setAnswers({});
        setCurrentStepIndex(0);
        setTimeout(() => document.getElementById(`task-${data.steps[0].id}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50); 
        setMode('activity');
    };

    const handlePrint = () => {
        const content = document.getElementById('full-report-container');
        if (!content) return;
        const printWindow = window.open('', '', 'height=800,width=1000');
        
        printWindow.document.write('<html><head><title>Activity Report</title>');
        // Escaped script tag to prevent closing the string early
        printWindow.document.write('<script src="https://cdn.tailwindcss.com"></' + 'script>');
        printWindow.document.write(`
            <style>
                @page {
                    size: 8.5in 13in; /* Folio Size */
                    margin: 0.5in;
                    margin-bottom: 0.8in; /* Allowance for Footer */
                }
                @media print {
                    body { -webkit-print-color-adjust: exact; }
                    .page-break { page-break-after: always; }
                    .break-inside-avoid { break-inside: avoid; }
                    .hidden { display: block !important; } 
                    
                    button, .no-print { display: none !important; }

                    /* Custom Footer Logic */
                    .print-footer {
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        height: 0.8in;
                    }
                    .report-body { margin-bottom: 0.8in; }
                }
                ::-webkit-scrollbar { display: none; }
            </style>
        `);
        printWindow.document.write('</head><body class="bg-white">');
        
        // Wrap content
        printWindow.document.write('<div class="report-body">');
        printWindow.document.write(content.innerHTML);
        printWindow.document.write('</div>');

        // Extract Footer Template and inject as Fixed Footer
        const footerHTML = content.querySelector('#print-footer-template').innerHTML;
        printWindow.document.write(`<div class="print-footer">${footerHTML}</div>`);

        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        setTimeout(() => { 
            printWindow.focus(); 
            printWindow.print(); 
            printWindow.close(); 
        }, 1000);
    };

    const handleValidateStepById = (stepId) => () => {
        const status = stepStatus[stepId];
        if (status.attempts <= 0 && status.completed) return;
        const currentAns = answers[stepId] || {};
        let isCorrect = false;

        if (stepId === 1) {
            const result = validateStep01(activityData.transactions, currentAns);
            isCorrect = result.isCorrect;
        } else if (stepId === 2) {
            const result = validateStep02(activityData.transactions, currentAns);
            isCorrect = result.isCorrect;
        } else if (stepId === 3) {
            const result = validateStep03(activityData, currentAns);
            isCorrect = result.isCorrect;
        } else if (stepId === 4) {
            const result = validateStep04(activityData.transactions, currentAns, activityData.ledger);
            isCorrect = result.isCorrect;
        } else if (stepId === 5) {
             const result = validateStep05(activityData.ledger, activityData.adjustments, currentAns);
             isCorrect = result.isCorrect;
        } else if (stepId === 6) {
             const result = validateStep06(activityData.ledger, activityData.adjustments, activityData, currentAns);
             isCorrect = result.isCorrect;
        } else if (stepId === 7) {
             const journalData = currentAns.journal || {};
             const ledgerData = currentAns.ledger || {};
             const result = validateStep07(activityData.adjustments, journalData, ledgerData, activityData.transactions);
             isCorrect = result.score === result.maxScore && result.maxScore > 0;
        } else if (stepId === 8) {
            const result = validateStep08(currentAns, activityData);
            isCorrect = result.score === result.maxScore && result.maxScore > 0;
        } else if (stepId === 9) {
             const result = validateStep09(currentAns, activityData);
             isCorrect = result.isCorrect;
        } else if (stepId === 10) {
            const result = validateStep10(currentAns, activityData);
            isCorrect = result.isCorrect;
        } else {
             isCorrect = true;
        }

        setStepStatus(prev => {
            const newStatus = { ...prev };
            const currentStatus = prev[stepId];
            let nextStepShouldBeCompleted = false;
            if (isCorrect) {
                newStatus[stepId] = { ...currentStatus, completed: true, correct: true, attempts: currentStatus.attempts };
                nextStepShouldBeCompleted = true;
            } else {
                const remainingAttempts = currentStatus.attempts - 1;
                if (remainingAttempts <= 0) {
                    newStatus[stepId] = { ...currentStatus, completed: true, correct: false, attempts: 0 };
                    nextStepShouldBeCompleted = true;
                } else {
                    newStatus[stepId] = { ...currentStatus, attempts: remainingAttempts, completed: false, correct: false };
                }
            }
            if (nextStepShouldBeCompleted) {
                const nextActiveIndex = activityData.steps.findIndex((s, idx) => s.id === stepId) + 1;
                if (nextActiveIndex < activityData.steps.length) {
                    setCurrentStepIndex(nextActiveIndex); 
                    setTimeout(() => document.getElementById(`task-${activityData.steps[nextActiveIndex].id}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100); 
                } else { 
                    setCurrentStepIndex(activityData.steps.length); 
                }
            }
            return newStatus;
        });
    };
    
    const isAllComplete = activityData?.steps.every(s => stepStatus[s.id]?.completed);

    if (mode === 'config') return html`<div className="min-h-screen bg-gray-50 p-8"><div className="max-w-4xl mx-auto mb-8 text-center"><h1 className="text-4xl font-extrabold text-blue-900 flex justify-center items-center gap-3"><${Book} size=${40} /> Accounting Cycle Simulator</h1><p className="text-gray-600 mt-2">Generate unique accounting scenarios and practice every step of the cycle.</p></div><${TeacherDashboard} onGenerate=${handleGenerate} onResume=${handleResume} /></div>`;

    return html`
        <div className="min-h-screen flex flex-col bg-gray-50">
            <header id="main-header" className="bg-white border-b shadow-md p-4 flex justify-between items-center sticky top-0 z-50 no-print">
                <div className="flex items-center gap-4"><button onClick=${() => setMode('config')} className="p-2 hover:bg-gray-100 rounded-full text-gray-600"><${ArrowLeft} size=${20} /></button><div><h1 id="company-name" className="font-bold text-xl text-blue-900">${activityData.config.businessType} - ${activityData.config.ownership}</h1><p className="text-xs text-gray-500">Inventory: ${activityData.config.inventorySystem}  ${activityData.config.isSubsequentYear ? 'Subsequent Year' : 'New Business'}</p></div></div>
                <div className="text-right flex items-center gap-4">
                    ${isAllComplete && html`
                        <button onClick=${handlePrint} className="flex items-center gap-2 bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 transition-colors animate-pulse">
                            <${Printer} size=${18} /> Print / Save PDF
                        </button>
                    `}
                    <div>
                        <div className="text-xs font-bold text-gray-500 uppercase">First Uncompleted Task</div>
                        <div className="font-semibold text-blue-700">${activityData.steps[currentStepIndex] ? `Task #${activityData.steps[currentStepIndex].id}: ${activityData.steps[currentStepIndex].title}` : 'All Tasks Complete'}</div>
                    </div>
                </div>
            </header>
            <div className="bg-white border-b overflow-x-auto shadow-sm sticky top-[73px] z-40 no-print"><div className="flex min-w-max px-4">${activityData.steps.map((s, idx) => html`<div key=${s.id} className=${`p-3 flex items-center gap-2 text-sm border-b-2 transition-colors ${idx === currentStepIndex ? 'border-blue-600 text-blue-700 font-bold' : 'border-transparent text-gray-500'} ${stepStatus[s.id].completed ? 'text-green-600' : ''} cursor-pointer hover:bg-gray-50`} onClick=${() => setCurrentStepIndex(idx)}><div className=${`w-6 h-6 rounded-full flex items-center justify-center text-xs border ${stepStatus[s.id].completed ? 'bg-green-100 border-green-300 text-green-700' : idx === currentStepIndex ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-200'}`}><${stepStatus[s.id].completed ? Check : 'span'} size=${14}>${stepStatus[s.id].completed ? '' : s.id}</${stepStatus[s.id].completed ? Check : 'span'}></div><span>${s.title}</span></div>`)}</div></div>
            <main className="flex-1 p-6"><div className="max-w-7xl mx-auto">${activityData.steps.map((step, idx) => html`<${TaskSection} key=${step.id} step=${step} activityData=${activityData} answers=${answers} stepStatus=${stepStatus} onValidate=${handleValidateStepById} updateAnswerFns=${{ updateNestedAnswer, updateTrialBalanceAnswer, updateAnswer }} isCurrentActiveTask=${idx === currentStepIndex} isPrevStepCompleted=${idx === 0 || stepStatus[activityData.steps[idx - 1].id]?.completed} />`)}</div></main>
            <footer className="bg-gray-100 border-t p-2 text-center text-sm text-gray-500 no-print flex justify-between items-center px-6">
                <span className="text-xs text-gray-400">${APP_VERSION}</span>
                ${isAllComplete ? html`<span className="font-bold text-green-700">Accounting Cycle Activity Fully Completed! </span>` : html`<span>Scroll up to continue the exercise.</span>`}
                <span className="w-20"></span>
            </footer>
            
            <${ReportView} activityData=${activityData} answers=${answers} />
        </div>
    `;
};

 App;


// --- Step01Analysis.js ---



 // Added getLetterGrade 

// --- HELPER: DRY Validation Logic ---
const checkRow = (transaction, answer = {}) => {
    const isAssetCorrect = answer.A === transaction.analysis.assets;
    const isLiabCorrect = answer.L === transaction.analysis.liabilities;
    const isEquityCorrect = answer.E === transaction.analysis.equity;
    
    // Normalize Cause: treat undefined/null as empty string
    const targetCause = transaction.analysis.cause || '';
    const userCause = answer.Cause || '';
    const isCauseCorrect = targetCause === userCause;

    // Calculate Score for this row (4 points possible)
    let score = 0;
    if (isAssetCorrect) score++;
    if (isLiabCorrect) score++;
    if (isEquityCorrect) score++;
    if (isCauseCorrect) score++;

    return {
        isAssetCorrect,
        isLiabCorrect,
        isEquityCorrect,
        isCauseCorrect,
        isRowFullyCorrect: isAssetCorrect && isLiabCorrect && isEquityCorrect && isCauseCorrect,
        score,
        maxScore: 4
    };
};

// --- EXPORTED VALIDATION FUNCTION (For App.js) ---
const validateStep01 = (transactions, allAnswers) => {
    let totalScore = 0;
    let totalMax = 0;
    let perfectRows = 0;

    transactions.forEach(t => {
        const { score, maxScore, isRowFullyCorrect } = checkRow(t, allAnswers[t.id]);
        totalScore += score;
        totalMax += maxScore;
        if (isRowFullyCorrect) perfectRows++;
    });

    return {
        isCorrect: perfectRows === transactions.length, // Must be 100% perfect to auto-advance
        score: totalScore,
        maxScore: totalMax,
        letterGrade: getLetterGrade(totalScore, totalMax)
    };
};

// --- INTERNAL COMPONENTS ---
const StatusIcon = ({ correct, show }) => {
    if (!show) return null;
    return correct 
        ? html`<${Check} size=${14} className="text-green-600 inline ml-1" />` 
        : html`<${X} size=${14} className="text-red-600 inline ml-1" />`;
};

// --- MAIN COMPONENT ---
function Step01Analysis({ transactions = [], data, onChange, showFeedback, isReadOnly }) {
    if (!transactions || transactions.length === 0) return html`<div className="p-4 bg-red-50 text-red-600 rounded border border-red-200">No transactions generated. Please go back and regenerate the activity.</div>`;
    
    // Calculate result for display
    const result = validateStep01(transactions, data);

    return html`
        <div className="flex flex-col gap-4">
            ${showFeedback && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 flex justify-between items-center shadow-sm">
                    <span className="font-bold">Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${result.score} of ${result.maxScore} - (${result.letterGrade})</span>
                </div>
            `}

            <div className="overflow-x-auto min-h-[200px]">
                <table className="w-full text-sm border-collapse border min-w-[900px]">
                    <thead className="bg-gray-100">
                        <tr>
                            <th className="border p-2">Date</th>
                            <th className="border p-2 w-1/3">Transaction</th>
                            <th className="border p-2">Assets</th>
                            <th className="border p-2">Liabilities</th>
                            <th className="border p-2">Equity</th>
                            <th className="border p-2 w-1/5">Cause</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map((t) => {
                            const ans = data[t.id] || {};
                            const status = checkRow(t, ans);

                            return html`
                                <tr key=${t.id} className="hover:bg-gray-50">
                                    <td className="border p-2 text-center whitespace-nowrap">${t.date}</td>
                                    <td className="border p-2">${t.description}</td>
                                    
                                    ${/* Assets Column */''}
                                    <td className="border p-2">
                                        <div className="flex items-center">
                                            <select className=${`w-full bg-white border rounded p-1 ${showFeedback && !status.isAssetCorrect ? 'border-red-300 bg-red-50' : ''}`} 
                                                value=${ans.A || '-'} 
                                                onChange=${(e) => onChange(t.id, 'A', e.target.value)} 
                                                disabled=${isReadOnly}>
                                                <option>-</option><option>Increase</option><option>Decrease</option><option>No Effect</option>
                                            </select>
                                            <${StatusIcon} show=${showFeedback} correct=${status.isAssetCorrect} />
                                        </div>
                                    </td>

                                    ${/* Liabilities Column */''}
                                    <td className="border p-2">
                                        <div className="flex items-center">
                                            <select className=${`w-full bg-white border rounded p-1 ${showFeedback && !status.isLiabCorrect ? 'border-red-300 bg-red-50' : ''}`} 
                                                value=${ans.L || '-'} 
                                                onChange=${(e) => onChange(t.id, 'L', e.target.value)} 
                                                disabled=${isReadOnly}>
                                                <option>-</option><option>Increase</option><option>Decrease</option><option>No Effect</option>
                                            </select>
                                            <${StatusIcon} show=${showFeedback} correct=${status.isLiabCorrect} />
                                        </div>
                                    </td>

                                    ${/* Equity Column */''}
                                    <td className="border p-2">
                                        <div className="flex items-center">
                                            <select className=${`w-full bg-white border rounded p-1 ${showFeedback && !status.isEquityCorrect ? 'border-red-300 bg-red-50' : ''}`} 
                                                value=${ans.E || '-'} 
                                                onChange=${(e) => onChange(t.id, 'E', e.target.value)} 
                                                disabled=${isReadOnly}>
                                                <option>-</option><option>Increase</option><option>Decrease</option><option>No Effect</option>
                                            </select>
                                            <${StatusIcon} show=${showFeedback} correct=${status.isEquityCorrect} />
                                        </div>
                                    </td>

                                    ${/* Cause Column */''}
                                    <td className="border p-2">
                                        <div className="flex items-center">
                                            <select className=${`w-full bg-white border rounded p-1 ${showFeedback && !status.isCauseCorrect ? 'border-red-300 bg-red-50' : ''}`} 
                                                value=${ans.Cause || ''} 
                                                onChange=${(e) => onChange(t.id, 'Cause', e.target.value)} 
                                                disabled=${isReadOnly}>
                                                ${EQUITY_CAUSES.map(c => html`<option key=${c} value=${c}>${c || '-'}</option>`)}
                                            </select>
                                            <${StatusIcon} show=${showFeedback} correct=${status.isCauseCorrect} />
                                        </div>
                                    </td>
                                </tr>
                            `;
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}


// --- steps/Step02Journalizing.js ---





const html = htm.bind(React.createElement);

// --- HELPER: DETERMINE LOGICAL LINE INDEX ---
// Maps the Grid Row Index (idx) to the Transaction Line Index (0, 1, 2...)
const getLogicalIndex = (tIdx, idx) => {
    if (tIdx === 0) {
        if (idx === 0) return -1; // Year Row (Special)
        return idx - 1; // Grid Row 1 -> Line 0
    }
    return idx; // Grid Row 0 -> Line 0
};

// --- HELPER: GET EXPECTED CONFIGURATION ---
// Determines if a specific line SHOULD be a Debit or Credit based on the Answer Key
const getExpectedConfig = (t, logicalIdx) => {
    if (logicalIdx < 0) return null; // Year row
    
    const numDebits = t.debits.length;
    const totalLines = numDebits + t.credits.length;
    
    if (logicalIdx >= totalLines) return null; // Out of bounds (extra row)

    if (logicalIdx < numDebits) {
        return { type: 'debit', data: t.debits[logicalIdx] };
    } else {
        return { type: 'credit', data: t.credits[logicalIdx - numDebits] };
    }
};

// --- HELPER: ROW VALIDATION ---
const validateRow = (row, t, tIdx, idx) => {
    const result = { date: null, acc: null, drAmt: null, crAmt: null, score: 0, maxScore: 0 };
    const logicalIdx = getLogicalIndex(tIdx, idx);

    // 1. Date Validation
    if (tIdx === 0 && idx === 0) {
        // First row of first transaction: Needs Year
        const txnDate = new Date(t.date);
        const yyyy = txnDate.getFullYear().toString();
        const val = row.date?.trim() || ""; 
        const isEmptyOthers = !row.acc && !row.pr && !row.dr && !row.cr;
        
        result.maxScore += 1;
        if (val === yyyy && isEmptyOthers) {
            result.date = true;
            result.score += 1;
        } else {
            result.date = false;
        }
    } else if ((tIdx === 0 && idx === 1) || (tIdx > 0 && idx === 0)) {
        // Date row (Month/Day)
        const txnDate = new Date(t.date);
        const mm = txnDate.toLocaleString('default', { month: 'short' });
        const dd = txnDate.getDate().toString();
        const dd0 = dd.padStart(2, '0');
        const val = row.date?.trim() || "";
        
        result.maxScore += 1;
        let dateValid = false;
        if (tIdx === 0 && idx === 1) dateValid = val === `${mm} ${dd}` || val === `${mm} ${dd0}`;
        else dateValid = val === dd || val === dd0;
        
        if (dateValid) {
            result.date = true;
            result.score += 1;
        } else {
            result.date = false;
        }
    } else {
        // Rows that shouldn't have dates
        result.date = true; 
    }

    // 2. Account & Amount Validation
    if (!row.isDescription) {
        const expected = getExpectedConfig(t, logicalIdx);
        
        if (expected) {
            result.maxScore += 2; // 1 for Account, 1 for Amount

            const acc = row.acc || "";
            const dr = Number(row.dr) || 0;
            const cr = Number(row.cr) || 0;

            // --- DEBIT EXPECTATION ---
            if (expected.type === 'debit') {
                result.crAmt = null; // Should not be in credit column

                // Account Name Check (Must not start with space)
                const accValid = acc.length > 0 && !acc.startsWith(' ') && acc.trim() === expected.data.account;
                
                if (!accValid) result.acc = false;
                else { result.acc = true; result.score += 1; }

                // Amount Check
                // Must be in Debit column, matches amount, Credit column is empty
                const amtValid = Math.abs(dr - expected.data.amount) <= 1 && cr === 0;
                
                if (!amtValid) result.drAmt = false;
                else { result.drAmt = true; result.score += 1; }
            }
            
            // --- CREDIT EXPECTATION ---
            else if (expected.type === 'credit') {
                result.drAmt = null; // Should not be in debit column

                // Account Name Check (Must have 3 spaces)
                const threeSpaces = '   ';
                const startsWith3 = acc.startsWith(threeSpaces);
                const fourthCharNotSpace = acc.length > 3 && acc[3] !== ' '; 
                const cleanName = acc.substring(3);
                
                const accValid = startsWith3 && fourthCharNotSpace && cleanName === expected.data.account;

                if (!accValid) result.acc = false;
                else { result.acc = true; result.score += 1; }

                // Amount Check
                // Must be in Credit column, matches amount, Debit column is empty
                const amtValid = Math.abs(cr - expected.data.amount) <= 1 && dr === 0;

                if (!amtValid) result.crAmt = false;
                else { result.crAmt = true; result.score += 1; }
            }
        } else if (logicalIdx >= 0) {
            // Extra row that shouldn't exist (but isn't description/year)
            // If user filled it, mark wrong
            if (row.acc || row.dr || row.cr) {
                result.acc = false;
                result.drAmt = false;
                result.crAmt = false;
            }
        }
    }

    return result;
};

// --- GLOBAL VALIDATION FUNCTION (DRY) ---
const validateStep02 = (transactions, currentAns = {}) => {
    let totalScore = 0;
    let maxScore = 0;
    let correctTx = 0;
    
    // Safety check
    if (!transactions || transactions.length === 0) {
        return { isCorrect: false, score: 0, maxScore: 0, letterGrade: 'IR' };
    }
    
    transactions.forEach((t, tIdx) => {
        const entry = currentAns[t.id] || {};
        const rows = entry.rows || [];
        
        let txScore = 0;
        let txMax = 0;
        let isTxPerfect = true;

        // Calculate Max Score for this transaction structure
        // Date pts: 2 for first Tx, 1 for others
        if (tIdx === 0) txMax += 2; else txMax += 1;
        // Line pts: 2 per line (Account + Amount)
        const expectedCount = t.debits.length + t.credits.length;
        txMax += (expectedCount * 2);

        // Validate existing rows
        rows.forEach((row, rIdx) => {
            const res = validateRow(row, t, tIdx, rIdx);
            txScore += res.score;
            
            // Check for failure flags
            if (res.date === false || res.acc === false || res.drAmt === false || res.crAmt === false) {
                isTxPerfect = false;
            }
        });

        // Penalize for missing rows (User hasn't added enough rows yet)
        //  CORRECTED 
        const contentRows = rows.filter((r, rIdx) => !r.isDescription && !((r.id === 'year' || rIdx === 0) && tIdx === 0)); 
        // Note: Counting content rows accurately is tricky with the year row mixed in.
        // Simplified check: If score < max, it's not perfect.
        
        if (txScore < txMax) isTxPerfect = false;

        totalScore += txScore;
        maxScore += txMax;
        if (isTxPerfect) correctTx++;
    });

    return {
        isCorrect: correctTx === transactions.length,
        score: totalScore,
        maxScore: maxScore,
        letterGrade: getLetterGrade(totalScore, maxScore)
    };
};


// --- INTERNAL COMPONENTS ---

const StatusIcon = ({ status, show }) => {
    if (!show) return null;
    if (status === true) return html`<${Check} size=${14} className="text-green-600" />`;
    if (status === false) return html`<${X} size=${14} className="text-red-600" />`;
    return null; // status is null/undefined
};

const JournalRow = ({ row, idx, tIdx, updateRow, deleteRow, showFeedback, isReadOnly, t }) => {
    const isDesc = row.isDescription;
    const isYearRow = tIdx === 0 && idx === 0;
    
    // Run validation logic
    const valResult = validateRow(row, t, tIdx, idx);
    
    // Determine placeholders
    let datePlaceholder = "";
    if (tIdx === 0) { 
        if (idx === 0) datePlaceholder = "YYYY"; 
        else if (idx === 1) datePlaceholder = "Mmm dd"; 
    } else { 
        if (idx === 0) datePlaceholder = "dd"; 
    }

    // Input background helper
    const bgClass = (status) => showFeedback && status === false ? 'bg-red-50' : '';

    return html`
        <div className=${`flex h-8 items-center border-t border-gray-100 ${isDesc ? 'bg-white text-gray-600' : ''}`}>
            
            <div className="w-16 h-full border-r relative group">
                ${!isDesc && html`
                    <input type="text" 
                        className=${`w-full h-full px-1 text-xs outline-none bg-transparent text-right ${bgClass(valResult?.date)}`} 
                        value=${row.date || ''} 
                        onChange=${(e)=>updateRow(idx, 'date', e.target.value)} 
                        placeholder=${datePlaceholder} 
                        disabled=${isReadOnly}
                    />
                    ${(idx === 0 || (tIdx===0 && idx===1)) && html`
                        <div className="absolute left-1 top-1/2 -translate-y-1/2 pointer-events-none">
                            <${StatusIcon} show=${showFeedback} status=${valResult?.date} />
                        </div>
                    `}
                `}
            </div>

            <div className="flex-1 h-full border-r relative">
                ${isDesc 
                    ? html`<div className="px-2 w-full h-full flex items-center overflow-hidden whitespace-pre-wrap text-xs font-mono absolute top-0 left-0 z-10 bg-white border-r" style=${{width: 'calc(100% + 16rem)'}}>${row.acc}</div>`
                    : (!isYearRow && html`
                        <input type="text" 
                            className=${`w-full h-full px-2 pr-6 outline-none font-mono text-xs ${bgClass(valResult?.acc)}`} 
                            value=${row.acc || ''} 
                            onChange=${(e)=>updateRow(idx, 'acc', e.target.value)} 
                            placeholder="Account Title" 
                            disabled=${isReadOnly}
                        />
                        <div className="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none">
                            <${StatusIcon} show=${showFeedback} status=${valResult?.acc} />
                        </div>
                    `)
                }
            </div>

            <div className="w-16 h-full border-r">
                ${!isDesc && !isYearRow && html`<input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${row.pr || ''} onChange=${(e)=>updateRow(idx, 'pr', e.target.value)} disabled=${isReadOnly} />`}
            </div>

            <div className="w-24 h-full border-r relative">
                ${!isDesc && !isYearRow && html`
                    <input type="number" 
                        className=${`w-full h-full px-2 pr-6 text-right outline-none bg-transparent ${bgClass(valResult?.drAmt)}`} 
                        value=${row.dr||''} 
                        onChange=${(e)=>updateRow(idx,'dr',e.target.value)} 
                        disabled=${isReadOnly} 
                    />
                    <div className="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none">
                        <${StatusIcon} show=${showFeedback} status=${valResult?.drAmt} />
                    </div>
                `}
            </div>

            <div className="w-24 h-full border-r relative">
                ${!isDesc && !isYearRow && html`
                    <input type="number" 
                        className=${`w-full h-full px-2 pr-6 text-right outline-none bg-transparent ${bgClass(valResult?.crAmt)}`} 
                        value=${row.cr||''} 
                        onChange=${(e)=>updateRow(idx,'cr',e.target.value)} 
                        disabled=${isReadOnly} 
                    />
                    <div className="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none">
                        <${StatusIcon} show=${showFeedback} status=${valResult?.crAmt} />
                    </div>
                `}
            </div>

            <div className="w-8 flex justify-center items-center">
                ${!isDesc && !isYearRow && !isReadOnly && html`<button onClick=${() => deleteRow(idx)} className="text-red-400 hover:text-red-600"><${Trash2} size=${14}/></button>`}
            </div>
        </div>
    `;
};

// --- MAIN EXPORT ---

function Step02Journalizing({ transactions = [], data, onChange, showFeedback, validAccounts, isReadOnly }) {
    
    // --- AUTOMATIC ROW ADDITION EFFECT ---
    useEffect(() => {
        if (showFeedback && !isReadOnly) {
            transactions.forEach((t, tIdx) => {
                const entry = data[t.id] || {};
                const currentRows = entry.rows || [];
                
                // Calculate Required Rows
                // T1: 1 (Year) + Debits + Credits + 1 (Desc)
                // Tn: Debits + Credits + 1 (Desc)
                const lineItems = t.debits.length + t.credits.length;
                const requiredCount = (tIdx === 0 ? 1 : 0) + lineItems + 1;

                if (currentRows.length < requiredCount) {
                    const newRows = [...currentRows];
                    
                    // Temporarily remove desc row if exists
                    const descIndex = newRows.findIndex(r => r.isDescription);
                    const descRow = descIndex >= 0 ? newRows.splice(descIndex, 1)[0] : { id: 'desc', date: '', acc: `      ${t.description}`, dr: '', cr: '', pr: '', isDescription: true };
                    
                    // Fill lines
                    const needed = requiredCount - 1; // target count excluding desc
                    while (newRows.length < needed) {
                        newRows.push({ id: Date.now() + Math.random(), date: '', acc: '', dr: '', cr: '', pr: '' });
                    }
                    
                    // Put desc back
                    newRows.push(descRow);
                    onChange(t.id, newRows);
                }
            });
        }
    }, [showFeedback, isReadOnly, transactions, data, onChange]);

    if (!transactions || transactions.length === 0) return html`<div className="p-4 bg-red-50 text-red-600 rounded border border-red-200">No transactions generated.</div>`;
    
    // Calculate Score for Display (Read Only)
    const result = validateStep02(transactions, data);

    return html`
        <div>
            ${showFeedback && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm">
                    <span className="font-bold">Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${result.score} of ${result.maxScore} - (${result.letterGrade})</span>
                </div>
            `}
            <div className="border border-gray-400 shadow-sm min-h-[200px]">
                <div className="flex bg-gray-800 text-white border-b border-gray-400 font-bold text-sm text-center">
                    <div className="w-16 border-r p-2">Date</div>
                    <div className="flex-1 border-r p-2">Account Titles</div>
                    <div className="w-16 border-r p-2">PR</div>
                    <div className="w-24 border-r p-2">Debit</div>
                    <div className="w-24 p-2">Credit</div>
                    <div className="w-8"></div>
                </div>
                ${transactions.map((t, tIdx) => {
                    const entry = data[t.id] || {};
                    let initialRows = entry.rows;
                    if (!initialRows) {
                        if (tIdx === 0) { 
                            initialRows = [
                                { id: 'year', date: '', acc: '', dr: '', cr: '', pr: '' }, 
                                { id: 1, date: '', acc: '', dr: '', cr: '', pr: '' }, 
                                { id: 2, date: '', acc: '', dr: '', cr: '', pr: '' }, 
                                { id: 'desc', date: '', acc: `      ${t.description}`, dr: '', cr: '', pr: '', isDescription: true }
                            ]; 
                        } else { 
                            initialRows = [
                                { id: 1, date: '', acc: '', dr: '', cr: '', pr: '' }, 
                                { id: 2, date: '', acc: '', dr: '', cr: '', pr: '' }, 
                                { id: 'desc', date: '', acc: `      ${t.description}`, dr: '', cr: '', pr: '', isDescription: true }
                            ]; 
                        }
                    }
                    const rows = initialRows;
                    const updateRow = (idx, field, val) => { const newRows = [...rows]; if(!newRows[idx]) newRows[idx] = {}; newRows[idx] = { ...newRows[idx], [field]: val }; onChange(t.id, newRows); };
                    const addRow = () => { const newRows = [...rows]; const descRow = newRows.pop(); newRows.push({ id: Date.now(), date: '', acc: '', dr: '', cr: '', pr: '' }); newRows.push(descRow); onChange(t.id, newRows); };
                    const deleteRow = (idx) => { const minRows = tIdx === 0 ? 4 : 3; if (rows.length <= minRows) return; const newRows = rows.filter((_, i) => i !== idx); onChange(t.id, newRows); };
                    
                    return html`
                        <div key=${t.id} className="border-b border-gray-300 text-sm">
                            <div className="bg-gray-50 px-2 py-1 text-xs font-bold text-gray-700 border-b border-gray-200 block no-print">${t.date}. ${t.description}</div>
                            ${rows.map((row, idx) => html`<${JournalRow} key=${idx} row=${row} idx=${idx} tIdx=${tIdx} updateRow=${updateRow} deleteRow=${deleteRow} showFeedback=${showFeedback} isReadOnly=${isReadOnly} t=${t} />`)}
                            <div className="bg-gray-50 p-1 flex justify-center border-t no-print">${!isReadOnly && html`<button onClick=${addRow} className="text-xs border border-dashed border-gray-400 rounded px-2 py-1 text-gray-600 hover:bg-white hover:text-blue-600 flex items-center gap-1 transition-colors"><${Plus} size=${12}/> Add Row</button>`}</div>
                        </div>
                    `;
                })}
            </div>
        </div>
    `;
}


// --- Step03Posting.js ---





const html = htm.bind(React.createElement);

// --- HELPER: NORMALIZE STRING ---
const norm = (str) => (str || '').toString().toLowerCase().trim();

// --- HELPER: GENERATE EXPECTED DATA (THE ANSWER KEY) ---
const getExpectedLedgerData = (transactions, beginningBalances, validAccounts) => {
    const expected = {};

    // 1. Initialize all valid accounts
    validAccounts.forEach(acc => {
        expected[acc] = {
            rows: [], 
            begBalDr: 0,
            begBalCr: 0,
            totalDr: 0,
            totalCr: 0,
            hasDrEntries: false,
            hasCrEntries: false
        };
    });

    // 2. Process Beginning Balances
    if (beginningBalances && beginningBalances.balances) {
        Object.entries(beginningBalances.balances).forEach(([acc, bal]) => {
            if (!expected[acc]) return;
            const net = bal.dr - bal.cr;
            if (net !== 0) {
                const isDr = net > 0;
                const entry = {
                    date: 'Jan 1', 
                    part: 'BB',
                    pr: '', 
                    amount: Math.abs(net),
                    type: isDr ? 'dr' : 'cr',
                    isBegBal: true,
                    txnDateObj: new Date('2023-01-01'),
                    refKey: null // No checkbox for beginning balance
                };
                expected[acc].rows.push(entry);
                if (isDr) { expected[acc].begBalDr = Math.abs(net); expected[acc].hasDrEntries = true; }
                else { expected[acc].begBalCr = Math.abs(net); expected[acc].hasCrEntries = true; }
            }
        });
    }

    // 3. Process Transactions
    transactions.forEach((t) => {
        const dateObj = new Date(t.date);
        const mm = dateObj.toLocaleString('default', { month: 'short' });
        const dd = dateObj.getDate().toString();
        const fullDate = `${mm} ${dd}`;
        
        t.debits.forEach((d, i) => {
            if (expected[d.account]) {
                expected[d.account].rows.push({
                    date: fullDate,
                    day: dd,
                    part: 'GJ',
                    pr: '1',
                    amount: d.amount,
                    type: 'dr',
                    isBegBal: false,
                    txnDateObj: dateObj,
                    refKey: `dr-${t.id}-${i}` // LINK TO CHECKBOX
                });
                expected[d.account].totalDr += d.amount;
                expected[d.account].hasDrEntries = true;
            }
        });

        t.credits.forEach((c, i) => {
            if (expected[c.account]) {
                expected[c.account].rows.push({
                    date: fullDate,
                    day: dd,
                    part: 'GJ',
                    pr: '1',
                    amount: c.amount,
                    type: 'cr',
                    isBegBal: false,
                    txnDateObj: dateObj,
                    refKey: `cr-${t.id}-${i}` // LINK TO CHECKBOX
                });
                expected[c.account].totalCr += c.amount;
                expected[c.account].hasCrEntries = true;
            }
        });
    });

    return expected;
};

// --- VALIDATION FUNCTION ---
const validateStep03 = (activityData, studentAnswer) => {
    const { transactions, beginningBalances, validAccounts } = activityData;
    const studentLedgers = studentAnswer.ledgers || [];
    const journalPRs = studentAnswer.journalPRs || {};
    
    // 1. Generate Answer Key
    const expectedData = getExpectedLedgerData(transactions, beginningBalances, validAccounts);
    
    let totalScore = 0;
    let maxScore = 0;
    
    // Track correctly posted transaction keys (e.g. "dr-1-0") to award points for checkboxes
    const correctlyPostedKeys = new Set();
    const validationResults = { ledgers: {}, checkboxes: {} }; 

    // --- A. CALCULATE MAX SCORE ---
    
    // Ledger Points
    Object.keys(expectedData).forEach(accName => {
        const exp = expectedData[accName];
        maxScore += 1; // Account Title
        if (exp.hasDrEntries || exp.hasCrEntries) maxScore += 1; // Balance Line

        ['dr', 'cr'].forEach(type => {
            const hasEntries = type === 'dr' ? exp.hasDrEntries : exp.hasCrEntries;
            const expRows = exp.rows.filter(r => r.type === type);
            if (hasEntries) {
                maxScore += 1; // Year
                maxScore += 1; // Total
                expRows.forEach(row => {
                    if (row.isBegBal) maxScore += 3;
                    else maxScore += 4;
                });
            }
        });
    });

    // Checkbox Points (Max Score = Total Debits + Credits)
    transactions.forEach(t => {
        maxScore += (t.debits.length + t.credits.length);
    });

    // --- B. SCORE LEDGERS FIRST (To determine valid postings) ---

    studentLedgers.forEach(l => {
        const accName = l.account;
        const exp = expectedData[accName]; 
        const ledgerRes = { acc: false, balance: false, leftRows: [], rightRows: [], drTotal: null, crTotal: null };

        if (exp) {
            // Account Title
            if (norm(l.account) === norm(accName)) {
                totalScore += 1;
                ledgerRes.acc = true;
            }

            // --- DEBIT SIDE ---
            const uLeft = l.leftRows || [];
            const eDrRows = exp.rows.filter(r => r.type === 'dr');
            
            // Year
            const uYearL = uLeft[0] || {};
            if (exp.hasDrEntries) {
                const yValid = norm(uYearL.date) === '(2023)' || norm(uYearL.date) === '2023';
                if (yValid) { totalScore += 1; ledgerRes.leftRows[0] = { date: true }; }
                else { ledgerRes.leftRows[0] = { date: false }; }
            } else if (uYearL.date) {
                totalScore -= 1; 
                ledgerRes.leftRows[0] = { date: false };
            }
            if (uYearL.part) { totalScore -= 1; ledgerRes.leftRows[0] = { ...ledgerRes.leftRows[0], part: false }; }
            if (uYearL.pr) { totalScore -= 1; ledgerRes.leftRows[0] = { ...ledgerRes.leftRows[0], pr: false }; }
            if (uYearL.amount) { totalScore -= 1; ledgerRes.leftRows[0] = { ...ledgerRes.leftRows[0], amount: false }; }

            // Rows
            eDrRows.forEach((row, i) => {
                const uRow = uLeft[i + 1] || {};
                const res = {};
                
                const expDate = i === 0 ? row.date : row.day; 
                const dValid = norm(uRow.date) === norm(expDate) || norm(uRow.date) === norm(row.date) || norm(uRow.date) === norm(row.day.padStart(2,'0'));
                if (dValid) { totalScore += 1; res.date = true; } else res.date = false;

                const pValid = norm(uRow.part) === norm(row.part);
                if (pValid) { totalScore += 1; res.part = true; } else res.part = false;

                let prValid = false;
                if (!row.isBegBal) {
                    prValid = norm(uRow.pr) === norm(row.pr);
                    if (prValid) { totalScore += 1; res.pr = true; } else res.pr = false;
                } else if (uRow.pr) {
                    totalScore -= 1; res.pr = false; 
                } else {
                    prValid = true; // technically correct empty PR for BB
                }

                const aValid = Math.abs((Number(uRow.amount) || 0) - row.amount) < 1;
                if (aValid) { totalScore += 1; res.amount = true; } else res.amount = false;

                ledgerRes.leftRows[i + 1] = res;

                // **CRITICAL**: If row is FULLY correct (excluding PR for BB), mark reference key as posted
                // For BB, prValid is effectively true if empty. For GJ, needs match.
                // We check Date, Part, PR, Amount.
                if (dValid && pValid && prValid && aValid && row.refKey) {
                    correctlyPostedKeys.add(row.refKey);
                }
            });

            // Total
            if (exp.hasDrEntries) {
                const expTot = exp.begBalDr + exp.totalDr;
                if (Math.abs((Number(l.drTotal) || 0) - expTot) < 1) { totalScore += 1; ledgerRes.drTotal = true; }
                else ledgerRes.drTotal = false;
            } else if (l.drTotal) {
                totalScore -= 1; ledgerRes.drTotal = false;
            }

            // Deductions
            for(let i = eDrRows.length + 1; i < uLeft.length; i++) {
                const r = uLeft[i];
                const res = {};
                if(r.date){ totalScore-=1; res.date=false; }
                if(r.part){ totalScore-=1; res.part=false; }
                if(r.pr){ totalScore-=1; res.pr=false; }
                if(r.amount){ totalScore-=1; res.amount=false; }
                ledgerRes.leftRows[i] = res;
            }

            // --- CREDIT SIDE ---
            const uRight = l.rightRows || [];
            const eCrRows = exp.rows.filter(r => r.type === 'cr');

            // Year
            const uYearR = uRight[0] || {};
            if (exp.hasCrEntries) {
                const yValid = norm(uYearR.date) === '(2023)' || norm(uYearR.date) === '2023';
                if (yValid) { totalScore += 1; ledgerRes.rightRows[0] = { date: true }; }
                else { ledgerRes.rightRows[0] = { date: false }; }
            } else if (uYearR.date) {
                totalScore -= 1; 
                ledgerRes.rightRows[0] = { date: false };
            }
            if (uYearR.part) { totalScore -= 1; ledgerRes.rightRows[0] = { ...ledgerRes.rightRows[0], part: false }; }
            if (uYearR.pr) { totalScore -= 1; ledgerRes.rightRows[0] = { ...ledgerRes.rightRows[0], pr: false }; }
            if (uYearR.amount) { totalScore -= 1; ledgerRes.rightRows[0] = { ...ledgerRes.rightRows[0], amount: false }; }

            // Rows
            eCrRows.forEach((row, i) => {
                const uRow = uRight[i + 1] || {};
                const res = {};
                
                const expDate = i === 0 ? row.date : row.day; 
                const dValid = norm(uRow.date) === norm(expDate) || norm(uRow.date) === norm(row.date) || norm(uRow.date) === norm(row.day.padStart(2,'0'));
                if (dValid) { totalScore += 1; res.date = true; } else res.date = false;

                const pValid = norm(uRow.part) === norm(row.part);
                if (pValid) { totalScore += 1; res.part = true; } else res.part = false;

                let prValid = false;
                if (!row.isBegBal) {
                    prValid = norm(uRow.pr) === norm(row.pr);
                    if (prValid) { totalScore += 1; res.pr = true; } else res.pr = false;
                } else if (uRow.pr) {
                    totalScore -= 1; res.pr = false; 
                } else { prValid = true; }

                const aValid = Math.abs((Number(uRow.amount) || 0) - row.amount) < 1;
                if (aValid) { totalScore += 1; res.amount = true; } else res.amount = false;

                ledgerRes.rightRows[i + 1] = res;

                if (dValid && pValid && prValid && aValid && row.refKey) {
                    correctlyPostedKeys.add(row.refKey);
                }
            });

            // Total
            if (exp.hasCrEntries) {
                const expTot = exp.begBalCr + exp.totalCr;
                if (Math.abs((Number(l.crTotal) || 0) - expTot) < 1) { totalScore += 1; ledgerRes.crTotal = true; }
                else ledgerRes.crTotal = false;
            } else if (l.crTotal) {
                totalScore -= 1; ledgerRes.crTotal = false;
            }

            // Deductions
            for(let i = eCrRows.length + 1; i < uRight.length; i++) {
                const r = uRight[i];
                const res = {};
                if(r.date){ totalScore-=1; res.date=false; }
                if(r.part){ totalScore-=1; res.part=false; }
                if(r.pr){ totalScore-=1; res.pr=false; }
                if(r.amount){ totalScore-=1; res.amount=false; }
                ledgerRes.rightRows[i] = res;
            }

            // --- BALANCE ---
            const hasActivity = exp.hasDrEntries || exp.hasCrEntries;
            if (hasActivity) {
                const totalDr = exp.begBalDr + exp.totalDr;
                const totalCr = exp.begBalCr + exp.totalCr;
                const net = totalDr - totalCr;
                const expBal = Math.abs(net);
                const expType = net >= 0 ? 'Dr' : 'Cr';
                
                const uBal = Number(l.balance) || 0;
                const uType = l.balanceType;
                
                if (Math.abs(uBal - expBal) <= 1 && uType === expType) {
                    totalScore += 1;
                    ledgerRes.balance = true;
                } else {
                    ledgerRes.balance = false;
                }
            } else if (l.balance || l.balanceType) {
                totalScore -= 1;
                ledgerRes.balance = false;
            }

        } else {
            // Wrong Account Title used -> assume deductions or just zero points for content
            // Assuming strict: deductions for all filled content in a wrong account?
            // To keep it simple based on previous steps, just 0 for account match. 
            // Deductions for filled fields in wrong account is harsh but consistent. 
            // For now, let's just NOT add points.
            ledgerRes.acc = false;
        }

        validationResults.ledgers[l.id] = ledgerRes;
    });

    // --- C. SCORE CHECKBOXES (Dependent on Ledger Posting) ---
    transactions.forEach(t => {
        t.debits.forEach((d, i) => {
            const key = `dr-${t.id}-${i}`;
            const isChecked = !!journalPRs[key];
            const isPosted = correctlyPostedKeys.has(key);
            
            // SCORE RULE: 1 point if Checked AND Posted
            if (isChecked) {
                if (isPosted) {
                    totalScore += 1;
                    validationResults.checkboxes[key] = true; // Green Check
                } else {
                    // Checked but NOT posted/wrong posting -> 0 Points (no deduction, but marked wrong visually)
                    validationResults.checkboxes[key] = false; // Red X
                }
            } else {
                // Not Checked.
                // Was it supposed to be checked? Yes, if posted.
                // But generally students lose the point simply by not checking.
                // Visuals: If it SHOULD have been checked (and posted), show nothing or show missing?
                // Let's just leave it blank if unchecked.
                validationResults.checkboxes[key] = null;
            }
        });
        t.credits.forEach((c, i) => {
            const key = `cr-${t.id}-${i}`;
            const isChecked = !!journalPRs[key];
            const isPosted = correctlyPostedKeys.has(key);
            
            if (isChecked) {
                if (isPosted) {
                    totalScore += 1;
                    validationResults.checkboxes[key] = true;
                } else {
                    validationResults.checkboxes[key] = false;
                }
            } else {
                validationResults.checkboxes[key] = null;
            }
        });
    });

    if (totalScore < 0) totalScore = 0;

    return {
        isCorrect: totalScore === maxScore && maxScore > 0,
        score: totalScore,
        maxScore: maxScore,
        letterGrade: getLetterGrade(totalScore, maxScore),
        validationDetails: validationResults
    };
};


// --- INTERNAL COMPONENTS ---

const ValidationIcon = ({ status, show }) => {
    if (!show || status === undefined || status === null) return null;
    return html`
        <div className="absolute top-1 right-1 pointer-events-none z-10">
            ${status === true 
                ? html`<${Check} size=${12} className="text-green-600 bg-white rounded-full opacity-80 shadow-sm" />` 
                : html`<${X} size=${12} className="text-red-600 bg-white rounded-full opacity-80 shadow-sm" />`
            }
        </div>
    `;
};

// Simplified Icon for Checkboxes (Static position)
const CheckboxStatus = ({ status, show }) => {
    if (!show || status === null) return null;
    return status === true 
        ? html`<${Check} size=${14} className="text-green-600 ml-1" />` 
        : html`<${X} size=${14} className="text-red-600 ml-1" />`;
};

const JournalSourceView = ({ transactions, journalPRs, onTogglePR, showFeedback, isReadOnly, validationDetails }) => {
    const [expanded, setExpanded] = useState(true);
    const cbResults = validationDetails?.checkboxes || {};
    
    return html`
        <div className="mb-4 border rounded bg-white overflow-hidden shadow-sm h-[36rem] flex flex-col">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 cursor-pointer flex justify-between items-center flex-shrink-0" onClick=${()=>setExpanded(!expanded)}>
                <span><${Book} size=${16} className="inline mr-2"/>Source: General Journal</span>
                <div className="flex items-center gap-4">
                    <span className="text-xs font-normal">Page 1</span>
                    ${expanded ? html`<${ChevronDown} size=${16}/>` : html`<${ChevronRight} size=${16}/>`}
                </div>
            </div>
            ${expanded && html`
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="flex bg-gray-50 text-gray-700 border-b border-gray-300 font-bold text-xs text-center flex-shrink-0">
                        <div className="w-16 border-r p-2 flex-shrink-0">Date</div>
                        <div className="flex-1 border-r p-2 text-left">Account Titles and Explanation</div>
                        <div className="w-16 border-r p-2 flex-shrink-0">P.R.</div>
                        <div className="w-24 border-r p-2 text-right flex-shrink-0">Debit</div>
                        <div className="w-24 p-2 text-right flex-shrink-0">Credit</div>
                    </div>
                    <div className="overflow-y-auto flex-1">
                        ${transactions.map((t, tIdx) => {
                            const txnDate = new Date(t.date);
                            const yyyy = txnDate.getFullYear();
                            const mm = txnDate.toLocaleString('default', { month: 'short' });
                            const dd = txnDate.getDate().toString().padStart(2, '0');
                            const isFirst = tIdx === 0;
                            const dateDisplay = isFirst ? `${mm} ${dd}` : dd;

                            return html`
                                <React.Fragment key=${t.id}>
                                    ${isFirst && html`
                                        <div className="flex border-b border-gray-100 text-xs h-8 items-center">
                                            <div className="w-16 border-r text-right pr-1 font-bold text-gray-500 flex-shrink-0">${yyyy}</div>
                                            <div className="flex-1 border-r"></div>
                                            <div className="w-16 border-r flex-shrink-0"></div>
                                            <div className="w-24 border-r flex-shrink-0"></div>
                                            <div className="w-24 flex-shrink-0"></div>
                                        </div>
                                    `}
                                    
                                    ${t.debits.map((d, i) => {
                                        const key = `dr-${t.id}-${i}`;
                                        const isChecked = !!journalPRs[key];
                                        return html`
                                            <div key=${key} className="flex border-b border-gray-100 text-xs h-8 items-center hover:bg-gray-50">
                                                <div className="w-16 border-r text-right pr-1 flex-shrink-0">${i === 0 ? dateDisplay : ''}</div>
                                                <div className="flex-1 border-r pl-1 font-medium text-gray-800 truncate" title=${d.account}>${d.account}</div>
                                                <div className="w-16 border-r text-center flex justify-center items-center flex-shrink-0">
                                                    <input type="checkbox" checked=${isChecked} onChange=${() => onTogglePR(key)} disabled=${isReadOnly} className="cursor-pointer accent-blue-600" /> 
                                                    <${CheckboxStatus} show=${showFeedback} status=${cbResults[key]} />
                                                </div>
                                                <div className="w-24 border-r text-right pr-1 flex-shrink-0">${d.amount.toLocaleString()}</div>
                                                <div className="w-24 text-right pr-1 flex-shrink-0"></div>
                                            </div>
                                        `;
                                    })}
                                    ${t.credits.map((c, i) => {
                                        const key = `cr-${t.id}-${i}`;
                                        const isChecked = !!journalPRs[key];
                                        return html`
                                            <div key=${key} className="flex border-b border-gray-100 text-xs h-8 items-center hover:bg-gray-50">
                                                <div className="w-16 border-r flex-shrink-0"></div>
                                                <div className="flex-1 border-r pl-6 text-gray-800 truncate" title=${c.account}>${c.account}</div>
                                                <div className="w-16 border-r text-center flex justify-center items-center flex-shrink-0">
                                                     <input type="checkbox" checked=${isChecked} onChange=${() => onTogglePR(key)} disabled=${isReadOnly} className="cursor-pointer accent-blue-600" />
                                                     <${CheckboxStatus} show=${showFeedback} status=${cbResults[key]} />
                                                </div>
                                                <div className="w-24 border-r flex-shrink-0"></div>
                                                <div className="w-24 text-right pr-1 flex-shrink-0">${c.amount.toLocaleString()}</div>
                                            </div>
                                        `;
                                    })}
                                    <div key=${'desc' + t.id} className="flex border-b border-gray-200 text-xs h-8 items-center text-gray-500 italic">
                                        <div className="w-16 border-r flex-shrink-0"></div>
                                        <div className="flex-1 border-r pl-8 truncate" title=${t.description}>(${t.description})</div>
                                        <div className="w-16 border-r flex-shrink-0"></div>
                                        <div className="w-24 border-r flex-shrink-0"></div>
                                        <div className="w-24 flex-shrink-0"></div>
                                    </div>
                                </React.Fragment>
                            `;
                        })}
                        <div className="h-12"></div>
                    </div>
                </div>
            `}
        </div>
    `;
};

const LedgerAccount = ({ l, idx, updateLedger, updateSideRow, addRow, deleteLedger, isReadOnly, showFeedback, validationDetails }) => {
    const leftRows = l.leftRows && l.leftRows.length > 0 ? l.leftRows : [{}, {}, {}, {}]; 
    const rightRows = l.rightRows && l.rightRows.length > 0 ? l.rightRows : [{}, {}, {}, {}];
    const maxRows = Math.max(leftRows.length, rightRows.length);
    const displayRows = Array.from({length: maxRows}).map((_, i) => i);
    
    // Safety check for validation details
    const vResult = (validationDetails && validationDetails.ledgers && validationDetails.ledgers[l.id]) 
        ? validationDetails.ledgers[l.id] 
        : null;

    return html`
        <div className="border-2 border-gray-800 bg-white shadow-md">
            <div className="border-b-2 border-gray-800 p-2 flex justify-between bg-gray-100 relative">
                <div className="absolute left-2 top-2">
                    ${showFeedback && (vResult?.acc === true 
                        ? html`<${Check} size=${16} className="text-green-600"/>` 
                        : vResult?.acc === false ? html`<${X} size=${16} className="text-red-600"/>` : null)}
                </div>
                <div className="w-full text-center mx-8 relative">
                    <input list="step3-accs" className="w-full border-b border-gray-400 text-center bg-transparent font-bold text-lg outline-none" placeholder="Account Title" value=${l.account} onChange=${(e)=>updateLedger(idx,'account',e.target.value)} disabled=${isReadOnly} />
                </div>
                ${!isReadOnly && html`<button onClick=${() => deleteLedger(idx)} className="absolute right-2 top-2 text-red-500 hover:text-red-700"><${Trash2} size=${16}/></button>`}
            </div>
            <div className="flex">
                ${/* DEBIT SIDE */''}
                <div className="flex-1 border-r-2 border-gray-800">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">DEBIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400"><div className="w-16 border-r p-1 text-center">Date</div><div className="flex-1 border-r p-1 text-center">Particulars</div><div className="w-10 border-r p-1 text-center">PR</div><div className="w-20 p-1 text-center">Amount</div></div>
                    ${displayRows.map(rowIdx => {
                        const row = leftRows[rowIdx] || {};
                        const rVal = vResult && vResult.leftRows[rowIdx] ? vResult.leftRows[rowIdx] : {};
                        return html`
                            <div key=${`l-${rowIdx}`} className="flex text-xs border-b border-gray-200 h-8 relative">
                                <div className="w-16 border-r relative group">
                                    <input type="text" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${row.date||''} onChange=${(e)=>updateSideRow(idx,'left',rowIdx,'date',e.target.value)} disabled=${isReadOnly} placeholder=${rowIdx===0 ? "(YYYY)" : ""}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.date} />
                                </div>
                                <div className="flex-1 border-r relative group">
                                    <input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${row.part||''} onChange=${(e)=>updateSideRow(idx,'left',rowIdx,'part',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.part} />
                                </div>
                                <div className="w-10 border-r relative group">
                                    <input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${row.pr||''} onChange=${(e)=>updateSideRow(idx,'left',rowIdx,'pr',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.pr} />
                                </div>
                                <div className="w-20 relative group">
                                    <input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${row.amount||''} onChange=${(e)=>updateSideRow(idx,'left',rowIdx,'amount',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.amount} />
                                </div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50 relative">
                        <span className="text-xs font-bold">Total Debit</span>
                        <div className="relative">
                            <input type="number" className="w-24 text-right border border-gray-300" value=${l.drTotal||''} onChange=${(e)=>updateLedger(idx,'drTotal',e.target.value)} disabled=${isReadOnly} />
                            <${ValidationIcon} show=${showFeedback} status=${vResult?.drTotal} />
                        </div>
                    </div>
                </div>
                
                ${/* CREDIT SIDE */''}
                <div className="flex-1">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">CREDIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400 bg-white"><div className="w-16 border-r p-1 text-center">Date</div><div className="flex-1 border-r p-1 text-center">Particulars</div><div className="w-10 border-r p-1 text-center">PR</div><div className="w-20 p-1 text-center border-r">Amount</div><div className="w-6"></div></div>
                    ${displayRows.map(rowIdx => {
                        const row = rightRows[rowIdx] || {};
                        const rVal = vResult && vResult.rightRows[rowIdx] ? vResult.rightRows[rowIdx] : {};
                        return html`
                            <div key=${`r-${rowIdx}`} className="flex text-xs border-b border-gray-200 h-8 relative">
                                <div className="w-16 border-r relative group">
                                    <input type="text" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${row.date||''} onChange=${(e)=>updateSideRow(idx,'right',rowIdx,'date',e.target.value)} disabled=${isReadOnly} placeholder=${rowIdx===0 ? "(YYYY)" : ""}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.date} />
                                </div>
                                <div className="flex-1 border-r relative group">
                                    <input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${row.part||''} onChange=${(e)=>updateSideRow(idx,'right',rowIdx,'part',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.part} />
                                </div>
                                <div className="w-10 border-r relative group">
                                    <input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${row.pr||''} onChange=${(e)=>updateSideRow(idx,'right',rowIdx,'pr',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.pr} />
                                </div>
                                <div className="w-20 border-r relative group">
                                    <input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${row.amount||''} onChange=${(e)=>updateSideRow(idx,'right',rowIdx,'amount',e.target.value)} disabled=${isReadOnly}/>
                                    <${ValidationIcon} show=${showFeedback} status=${rVal.amount} />
                                </div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50 relative">
                        <span className="text-xs font-bold">Total Credit</span>
                        <div className="relative">
                            <input type="number" className="w-24 text-right border border-gray-300" value=${l.crTotal||''} onChange=${(e)=>updateLedger(idx,'crTotal',e.target.value)} disabled=${isReadOnly} />
                            <${ValidationIcon} show=${showFeedback} status=${vResult?.crTotal} />
                        </div>
                    </div>
                </div>
            </div>
            <div className="border-t border-gray-300 p-2 flex justify-center items-center gap-2 relative">
                <span className="text-xs font-bold uppercase text-gray-600">Balance:</span>
                <select className="border border-gray-300 rounded text-xs p-1 outline-none bg-white" value=${l.balanceType || ''} onChange=${(e)=>updateLedger(idx, 'balanceType', e.target.value)} disabled=${isReadOnly}><option value="" disabled>Debit or Credit?</option><option value="Dr">Debit</option><option value="Cr">Credit</option></select>
                <div className="relative">
                    <input type="number" className="w-32 text-center border-b-2 border-double border-black bg-white font-bold text-sm outline-none" placeholder="0" value=${l.balance||''} onChange=${(e)=>updateLedger(idx,'balance',e.target.value)} disabled=${isReadOnly} />
                    <${ValidationIcon} show=${showFeedback} status=${vResult?.balance} />
                </div>
            </div>
            ${!isReadOnly && html`<div className="p-2 text-center bg-gray-50 border-t border-gray-300"><button onClick=${()=>addRow(idx)} className="text-xs border border-dashed border-gray-400 rounded px-3 py-1 text-gray-600 hover:bg-white hover:text-blue-600 flex items-center gap-1 mx-auto"><${Plus} size=${12}/> Add Row</button></div>`}
        </div>
    `;
};

// --- MAIN COMPONENT ---

function Step03Posting({ activityData, data, onChange, showFeedback, validAccounts, ledgerKey, transactions, beginningBalances, isReadOnly, journalPRs, onTogglePR, matchedJournalEntries }) {
    const ledgers = data.ledgers || [{ id: 1, account: '', leftRows: [{}], rightRows: [{}] }];
    
    // --- RUN VALIDATION FOR FEEDBACK ---
    let validationDetails = {};
    let scoreInfo = { score: 0, maxScore: 0, letterGrade: 'IR' };
    
    if (showFeedback && activityData) {
        // Need to pass full activityData to the validator
        const result = validateStep03(activityData, data);
        validationDetails = result.validationDetails;
        scoreInfo = { score: result.score, maxScore: result.maxScore, letterGrade: result.letterGrade };
    }

    const updateLedger = (idx, field, val) => { const n = [...ledgers]; n[idx] = { ...n[idx], [field]: val }; onChange('ledgers', n); };
    const updateSideRow = (idx, side, rowIdx, field, val) => {
         const n = [...ledgers];
         const sideKey = side === 'left' ? 'leftRows' : 'rightRows';
         const rows = [...(n[idx][sideKey] || [{}])];
         if (!rows[rowIdx]) rows[rowIdx] = {};
         rows[rowIdx][field] = val;
         n[idx][sideKey] = rows;
         onChange('ledgers', n);
    };
    const addRow = (idx) => { const n = [...ledgers]; const left = n[idx].leftRows || [{}]; const right = n[idx].rightRows || [{}]; left.push({}); right.push({}); n[idx].leftRows = left; n[idx].rightRows = right; onChange('ledgers', n); };
    const deleteLedger = (idx) => { if (!window.confirm("Delete this entire ledger?")) return; const n = ledgers.filter((_, i) => i !== idx); onChange('ledgers', n); };
    
    return html`
        <div className="flex flex-col gap-4 h-full">
            ${showFeedback && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 flex justify-between items-center shadow-sm">
                    <span className="font-bold">Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${scoreInfo.score} of ${scoreInfo.maxScore} - (${scoreInfo.letterGrade})</span>
                </div>
            `}
            <div className="flex flex-col lg:flex-row gap-4 h-full">
                <div className="lg:w-5/12 h-full"><${JournalSourceView} transactions=${transactions} journalPRs=${journalPRs} onTogglePR=${onTogglePR} showFeedback=${showFeedback} isReadOnly=${isReadOnly} validationDetails=${validationDetails} /></div>
                <div className="lg:w-7/12 border rounded bg-white h-[36rem] flex flex-col">
                    <div className="bg-blue-100 p-2 font-bold text-blue-900">General Ledger</div>
                    <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                        <div className="flex flex-col gap-8 pb-4">
                            ${ledgers.map((l, idx) => html`<${LedgerAccount} key=${l.id} l=${l} idx=${idx} ledgerKey=${ledgerKey} updateLedger=${updateLedger} updateSideRow=${updateSideRow} addRow=${addRow} deleteLedger=${deleteLedger} isReadOnly=${isReadOnly} showFeedback=${showFeedback} validationDetails=${validationDetails} />`)}
                        </div>
                        ${!isReadOnly && html`<button onClick=${()=>onChange('ledgers', [...ledgers, { id: Date.now(), account: '', leftRows:[{},{},{},{}], rightRows:[{},{},{},{}] }])} className="mt-8 w-full py-3 border-2 border-dashed border-gray-400 text-gray-500 hover:border-blue-400 flex justify-center items-center gap-2 font-bold bg-gray-50"><${Plus} size=${20}/> Add New Account Ledger</button>`}
                    </div>
                </div>
            </div>
        </div>
    `;
                  }


// --- Step04TrialBalance.js ---





const html = htm.bind(React.createElement);

// --- HELPER FUNCTIONS ---

const getLastDayOfMonth = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = date.getMonth();
    const lastDay = new Date(year, month + 1, 0);
    return lastDay.toLocaleString('default', { month: 'long', day: 'numeric', year: 'numeric' });
};

// --- VALIDATION LOGIC ---
const validateStep04 = (transactions, data, expectedLedger) => {
    // Safety guard
    if (!expectedLedger || !data) {
        return { 
            score: 0, maxScore: 0, isCorrect: false, letterGrade: 'IR', 
            feedback: { header: {}, rows: [], totals: {} } 
        };
    }

    let score = 0;
    let maxScore = 0;
    const feedback = { header: {}, rows: [], totals: {} };
    
    // 1. HEADER VALIDATION (3 Points)
    maxScore += 3;
    const header = data.header || {};
    
    // A. Company Name
    const companyName = (header.company || '').trim();
    const isCompanyValid = companyName.length > 3; 
    if (isCompanyValid) score += 1;
    feedback.header.company = isCompanyValid;

    // B. Document Name
    const docName = (header.doc || '').trim().toLowerCase();
    const isDocValid = docName === 'trial balance';
    if (isDocValid) score += 1;
    feedback.header.doc = isDocValid;

    // C. Date
    const targetDate = getLastDayOfMonth(transactions ? transactions[0]?.date : '');
    const inputDate = (header.date || '').trim();
    const isDateValid = targetDate && inputDate.toLowerCase() === targetDate.toLowerCase();
    if (isDateValid) score += 1;
    feedback.header.date = isDateValid;

    // 2. BODY VALIDATION
    const rows = data.rows || [];
    const totals = data.totals || { dr: '', cr: '' };
    const expectedAccounts = Object.keys(expectedLedger);
    
    // Calculate Expected Totals & Map for Lookup
    let expTotalDr = 0;
    let expTotalCr = 0;
    const expBalances = {};

    expectedAccounts.forEach(acc => {
        const net = expectedLedger[acc].debit - expectedLedger[acc].credit;
        const absNet = Math.abs(net);
        if (absNet > 0) { 
            expBalances[acc] = { amount: absNet, side: net >= 0 ? 'dr' : 'cr' };
            if (net >= 0) expTotalDr += net;
            else expTotalCr += Math.abs(net);
            maxScore += 2; // 1 for Acc Name, 1 for Amount
        }
    });

    // Max Score for Totals
    maxScore += 2;

    const processedAccounts = new Set();

    rows.forEach((row, idx) => {
        const userAcc = (row.account || '').trim();
        const userDr = Number(row.dr) || 0;
        const userCr = Number(row.cr) || 0;
        
        const rowFeedback = { acc: false, amt: false };
        
        if (userAcc) {
            const matchedKey = Object.keys(expBalances).find(k => k.toLowerCase() === userAcc.toLowerCase());
            
            if (matchedKey && !processedAccounts.has(matchedKey)) {
                // Point 1: Account Name Match
                score += 1;
                rowFeedback.acc = true;
                processedAccounts.add(matchedKey);

                // Point 2: Correct Amount AND Side
                const exp = expBalances[matchedKey];
                const isDrCorrect = exp.side === 'dr' && Math.abs(userDr - exp.amount) <= 1 && userCr === 0;
                const isCrCorrect = exp.side === 'cr' && Math.abs(userCr - exp.amount) <= 1 && userDr === 0;

                if (isDrCorrect || isCrCorrect) {
                    score += 1;
                    rowFeedback.amt = true;
                }
            }
        }
        feedback.rows[idx] = rowFeedback;
    });

    // 3. TOTALS VALIDATION (Compare USER INPUT to EXPECTED SUMS)
    const userTotalDrInput = Number(totals.dr) || 0;
    const userTotalCrInput = Number(totals.cr) || 0;

    const isTotalDrCorrect = Math.abs(userTotalDrInput - expTotalDr) <= 1;
    const isTotalCrCorrect = Math.abs(userTotalCrInput - expTotalCr) <= 1;

    if (isTotalDrCorrect) score += 1;
    if (isTotalCrCorrect) score += 1;
    
    feedback.totals = { dr: isTotalDrCorrect, cr: isTotalCrCorrect };

    // Grade Calculation using Utility
    const letterGrade = getLetterGrade(score, maxScore);

    return { score, maxScore, isCorrect: score === maxScore, letterGrade, feedback };
};

// --- INTERNAL COMPONENTS ---

const StatusIcon = ({ correct, show }) => {
    if (!show) return null;
    return correct 
        ? html`<${Check} size=${16} className="text-green-600 inline ml-1 flex-shrink-0" strokeWidth=${3} />` 
        : html`<${X} size=${16} className="text-red-600 inline ml-1 flex-shrink-0" strokeWidth=${3} />`;
};

const LedgerSourceView = ({ transactions, validAccounts, beginningBalances, isSubsequentYear }) => {
    const [expanded, setExpanded] = useState(true);
    const sortedAccounts = sortAccounts(validAccounts || []);

    return html`
        <div className="mb-4 border rounded-lg shadow-sm bg-blue-50 overflow-hidden no-print h-full flex flex-col">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 cursor-pointer flex justify-between items-center flex-shrink-0" onClick=${()=>setExpanded(!expanded)}>
                <span><${Book} size=${16} className="inline mr-2"/>Source: General Ledger</span>
            </div>
            ${expanded && html`
                <div className="p-4 overflow-y-auto custom-scrollbar flex-1 flex flex-col gap-6 bg-gray-50">
                    ${sortedAccounts.map(acc => {
                        const rowsL = [];
                        const rowsR = [];
                        rowsL.push({ date: '2023', part: '', pr: '', amount: null, isYear: true });
                        rowsR.push({ date: '2023', part: '', pr: '', amount: null, isYear: true });
                        
                        let bbDr = 0, bbCr = 0;
                        if (isSubsequentYear && beginningBalances && beginningBalances.balances[acc]) {
                            const b = beginningBalances.balances[acc];
                            if (b.dr > 0) { rowsL.push({ date: 'Jan 01', part: 'BB', pr: '', amount: b.dr }); bbDr = b.dr; }
                            if (b.cr > 0) { rowsR.push({ date: 'Jan 01', part: 'BB', pr: '', amount: b.cr }); bbCr = b.cr; }
                        }
                        
                        let lastMonthL = bbDr > 0 ? 'Jan' : '';
                        let lastMonthR = bbCr > 0 ? 'Jan' : '';

                        if (transactions) {
                            transactions.forEach(t => {
                                const dateObj = new Date(t.date);
                                const mmm = dateObj.toLocaleString('default', { month: 'short' });
                                const dd = dateObj.getDate().toString().padStart(2, '0');
                                const dateStrFull = `${mmm} ${dd}`;

                                t.debits.forEach(d => {
                                    if (d.account === acc) {
                                        let displayDate = dd;
                                        if (rowsL.length === 1 || lastMonthL !== mmm) displayDate = dateStrFull;
                                        rowsL.push({ date: displayDate, part: 'GJ', pr: '1', amount: d.amount });
                                        lastMonthL = mmm;
                                    }
                                });
                                t.credits.forEach(c => {
                                    if (c.account === acc) {
                                        let displayDate = dd;
                                        if (rowsR.length === 1 || lastMonthR !== mmm) displayDate = dateStrFull;
                                        rowsR.push({ date: displayDate, part: 'GJ', pr: '1', amount: c.amount });
                                        lastMonthR = mmm;
                                    }
                                });
                            });
                        }

                        const totalDr = rowsL.reduce((sum, r) => sum + (r.amount || 0), 0);
                        const totalCr = rowsR.reduce((sum, r) => sum + (r.amount || 0), 0);
                        const net = totalDr - totalCr;
                        const balance = Math.abs(net);
                        const maxCount = Math.max(rowsL.length, rowsR.length, 4);
                        const displayRows = Array.from({ length: maxCount }).map((_, i) => i);

                        return html`
                            <div key=${acc} className="border-y-2 border-gray-800 bg-white shadow-md">
                                <div className="border-b-2 border-gray-800 p-2 bg-gray-100 font-bold text-center text-lg text-gray-800">${acc}</div>
                                <div className="flex">
                                    <div className="flex-1 border-r-2 border-gray-800">
                                        <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">DEBIT</div>
                                        ${displayRows.map(i => {
                                            const r = rowsL[i] || {};
                                            return html`<div key=${i} className="flex text-xs border-b border-gray-200 h-6 items-center px-1"><div className="w-12 text-right text-gray-500 mr-2">${r.date||''}</div><div className="flex-1">${r.part||''}</div><div className="text-right">${r.amount ? r.amount.toLocaleString() : ''}</div></div>`;
                                        })}
                                        <div className="border-t border-gray-800 p-1 text-right text-xs font-bold">${totalDr.toLocaleString()}</div>
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">CREDIT</div>
                                        ${displayRows.map(i => {
                                            const r = rowsR[i] || {};
                                            return html`<div key=${i} className="flex text-xs border-b border-gray-200 h-6 items-center px-1"><div className="w-12 text-right text-gray-500 mr-2">${r.date||''}</div><div className="flex-1">${r.part||''}</div><div className="text-right">${r.amount ? r.amount.toLocaleString() : ''}</div></div>`;
                                        })}
                                        <div className="border-t border-gray-800 p-1 text-right text-xs font-bold">${totalCr.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div className="bg-yellow-50 p-2 text-center border-t border-gray-300 text-sm font-bold text-gray-700">
                                    Balance: <span className="text-blue-700 ml-2 text-base">${balance.toLocaleString()}</span>
                                </div>
                            </div>
                        `;
                    })}
                </div>
            `}
        </div>
    `;
};

const TrialBalanceForm = ({ data, onChange, showFeedback, isReadOnly, validationResult }) => {
    const rows = data.rows || Array(15).fill({ account: '', dr: '', cr: '' });
    const header = data.header || { company: '', doc: '', date: '' };
    const totals = data.totals || { dr: '', cr: '' };
    const fb = validationResult?.feedback || { header: {}, rows: [], totals: {} };

    const updateHeader = (field, val) => {
        onChange('header', { ...header, [field]: val });
    };

    const updateRow = (idx, field, val) => {
        const newRows = [...rows];
        newRows[idx] = { ...newRows[idx], [field]: val };
        onChange('rows', newRows);
    };
    
    const updateTotals = (field, val) => {
        onChange('totals', { ...totals, [field]: val });
    };

    const addRow = () => {
        onChange('rows', [...rows, { account: '', dr: '', cr: '' }]);
    };

    const deleteRow = (idx) => {
        if (rows.length <= 1) return;
        const newRows = rows.filter((_, i) => i !== idx);
        onChange('rows', newRows);
    };

    const getHeaderStyle = (isValid) => {
        if (!showFeedback) return 'border-black';
        return isValid ? 'border-green-600 bg-green-50 text-green-700' : 'border-red-600 bg-red-50';
    };

    return html`
        <div className="flex flex-col h-full">
            
            <div className="flex flex-col gap-2 mb-6 items-center px-8 mt-2">
                <div className="w-3/4 flex items-center justify-center relative">
                    <input type="text" placeholder="[StudentLastName] Accounting Services" className=${`text-center font-bold text-lg border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.company)}`} value=${header.company} onChange=${(e) => updateHeader('company', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.company} /></div>
                </div>
                <div className="w-1/2 flex items-center justify-center relative">
                    <input type="text" placeholder="Trial Balance" className=${`text-center font-bold text-md border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.doc)}`} value=${header.doc} onChange=${(e) => updateHeader('doc', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.doc} /></div>
                </div>
                <div className="w-1/3 flex items-center justify-center relative">
                    <input type="text" placeholder="Month DD, YYYY" className=${`text-center text-sm border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.date)}`} value=${header.date} onChange=${(e) => updateHeader('date', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.date} /></div>
                </div>
            </div>

            <div className="flex-1 overflow-auto px-2">
                <table className="w-full text-sm border-collapse">
                    <thead className="bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th className="p-2 border text-left">Account Title</th>
                            <th className="p-2 border w-28 text-right">Debit</th>
                            <th className="p-2 border w-28 text-right">Credit</th>
                            <th className="p-2 border w-8"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map((row, idx) => {
                            const rowFB = fb.rows[idx] || {};
                            const hasAccInput = row.account && row.account.trim().length > 0;
                            const hasAmtInput = Number(row.dr) > 0 || Number(row.cr) > 0;

                            return html`
                            <tr key=${idx} className="border-b hover:bg-gray-50">
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="text" className="w-full outline-none bg-transparent" value=${row.account} onChange=${(e)=>updateRow(idx, 'account', e.target.value)} disabled=${isReadOnly} />
                                        ${hasAccInput && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.acc} />`}
                                    </div>
                                </td>
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="number" className="w-full text-right outline-none bg-transparent" value=${row.dr} onChange=${(e)=>updateRow(idx, 'dr', e.target.value)} disabled=${isReadOnly} />
                                        ${Number(row.dr) > 0 && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.amt} />`}
                                    </div>
                                </td>
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="number" className="w-full text-right outline-none bg-transparent" value=${row.cr} onChange=${(e)=>updateRow(idx, 'cr', e.target.value)} disabled=${isReadOnly} />
                                        ${Number(row.cr) > 0 && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.amt} />`}
                                    </div>
                                </td>
                                <td className="p-1 border text-center">
                                    ${!isReadOnly && html`<button onClick=${() => deleteRow(idx)} className="text-gray-400 hover:text-red-600"><${Trash2} size=${14}/></button>`}
                                </td>
                            </tr>
                        `})} 
                    </tbody>
                    <tfoot className="bg-gray-100 font-bold sticky bottom-0 border-t-2 border-gray-300">
                        <tr>
                            <td className="p-2 text-right uppercase text-xs text-gray-600">Total</td>
                            <td className="p-1 border-double border-gray-400 relative">
                                <div className="flex items-center justify-end">
                                    <input 
                                        type="number" 
                                        className=${`w-full text-right outline-none bg-transparent font-bold ${showFeedback ? (fb.totals.dr ? 'text-green-700' : 'text-red-600') : ''}`} 
                                        value=${totals.dr} 
                                        onChange=${(e) => updateTotals('dr', e.target.value)}
                                        disabled=${isReadOnly}
                                        placeholder="0"
                                    />
                                    ${(totals.dr !== '' && Number(totals.dr) > 0) && html`<${StatusIcon} show=${showFeedback} correct=${fb.totals.dr} />`}
                                </div>
                            </td>
                            <td className="p-1 border-double border-gray-400 relative">
                                <div className="flex items-center justify-end">
                                    <input 
                                        type="number" 
                                        className=${`w-full text-right outline-none bg-transparent font-bold ${showFeedback ? (fb.totals.cr ? 'text-green-700' : 'text-red-600') : ''}`} 
                                        value=${totals.cr} 
                                        onChange=${(e) => updateTotals('cr', e.target.value)}
                                        disabled=${isReadOnly}
                                        placeholder="0"
                                    />
                                    ${(totals.cr !== '' && Number(totals.cr) > 0) && html`<${StatusIcon} show=${showFeedback} correct=${fb.totals.cr} />`}
                                </div>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
             ${!isReadOnly && html`<button onClick=${addRow} className="mt-2 text-xs flex items-center gap-1 text-blue-600 hover:underline p-2"><${Plus} size=${12}/> Add Account Row</button>`}
        </div>
    `;
};

function Step04TrialBalance({ transactions, validAccounts, beginningBalances, isSubsequentYear, data, onChange, showFeedback, isReadOnly, expectedLedger }) {
    const validationResult = showFeedback 
        ? validateStep04(transactions, data, expectedLedger) 
        : null;

    const result = validationResult || {};

    const handleChange = (key, val) => {
        onChange(key, val);
    };

    return html`
        <div className="flex flex-col h-[calc(100vh-140px)] min-h-[600px]">
            ${showFeedback && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${result.score || 0} of ${result.maxScore || 0} - (${result.letterGrade || 'IR'})</span>
                </div>
            `}

            <div className="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                <div className="flex-1 lg:w-1/2 h-full min-h-0">
                     <${LedgerSourceView} transactions=${transactions} validAccounts=${validAccounts} beginningBalances=${beginningBalances} isSubsequentYear=${isSubsequentYear} /> 
                </div>
                <div className="flex-1 lg:w-1/2 border rounded bg-white flex flex-col shadow-sm overflow-hidden min-h-0">
                    <div className="bg-green-100 p-2 font-bold text-green-900 flex justify-between items-center">
                        <span><${Table} size=${16} className="inline mr-2"/>Trial Balance</span>
                    </div>
                    <div className="p-0 overflow-y-auto custom-scrollbar flex-1 bg-white">
                         <${TrialBalanceForm} 
                            data=${data} 
                            onChange=${handleChange} 
                            showFeedback=${showFeedback} 
                            isReadOnly=${isReadOnly} 
                            validationResult=${validationResult}
                        />
                    </div>
                </div>
            </div>
        </div>
    `;
}







const html = htm.bind(React.createElement);

// --- DRY VALIDATION LOGIC ---

const validateStep05 = (ledgerData, adjustments, userAnswers) => {
    const rows = userAnswers.rows || [];
    const footers = userAnswers.footers || { totals: {}, net: {}, final: {} };
    
    // 1. Calculate Expected Data
    const mergedAccounts = new Set(Object.keys(ledgerData));
    adjustments.forEach(adj => { mergedAccounts.add(adj.drAcc); mergedAccounts.add(adj.crAcc); });
    const sortedAccounts = sortAccounts(Array.from(mergedAccounts));

    const expectedMap = {};
    const columnTotals = { tbDr:0, tbCr:0, adjDr:0, adjCr:0, atbDr:0, atbCr:0, isDr:0, isCr:0, bsDr:0, bsCr:0 };

    sortedAccounts.forEach(acc => {
        // TB
        const lBal = (ledgerData[acc]?.debit || 0) - (ledgerData[acc]?.credit || 0);
        const tbDr = lBal > 0 ? lBal : 0;
        const tbCr = lBal < 0 ? Math.abs(lBal) : 0;
        
        // Adj
        let aDr = 0; let aCr = 0;
        adjustments.forEach(a => { if(a.drAcc === acc) aDr += a.amount; if(a.crAcc === acc) aCr += a.amount; });
        
        // ATB
        const net = (tbDr - tbCr) + (aDr - aCr);
        const atbDr = net > 0 ? net : 0;
        const atbCr = net < 0 ? Math.abs(net) : 0;

        // IS / BS
        const type = getAccountType(acc);
        const isIS = ['Revenue', 'Expense'].includes(type); 
        
        const isDr = isIS ? atbDr : 0;
        const isCr = isIS ? atbCr : 0;
        const bsDr = !isIS ? atbDr : 0;
        const bsCr = !isIS ? atbCr : 0;

        expectedMap[acc] = { tbDr, tbCr, adjDr: aDr, adjCr: aCr, atbDr, atbCr, isDr, isCr, bsDr, bsCr };

        // Add to totals
        columnTotals.tbDr += tbDr; columnTotals.tbCr += tbCr;
        columnTotals.adjDr += aDr; columnTotals.adjCr += aCr;
        columnTotals.atbDr += atbDr; columnTotals.atbCr += atbCr;
        columnTotals.isDr += isDr; columnTotals.isCr += isCr;
        columnTotals.bsDr += bsDr; columnTotals.bsCr += bsCr;
    });

    // Calculate Net Income
    const netIncome = columnTotals.isCr - columnTotals.isDr;
    const netRow = {
        isDr: netIncome > 0 ? netIncome : 0, 
        isCr: netIncome < 0 ? Math.abs(netIncome) : 0,
        bsDr: netIncome < 0 ? Math.abs(netIncome) : 0,
        bsCr: netIncome > 0 ? netIncome : 0
    };

    // Calculate Final Totals
    const finalRow = {
        tbDr: columnTotals.tbDr, tbCr: columnTotals.tbCr,
        adjDr: columnTotals.adjDr, adjCr: columnTotals.adjCr,
        atbDr: columnTotals.atbDr, atbCr: columnTotals.atbCr,
        isDr: columnTotals.isDr + netRow.isDr,
        isCr: columnTotals.isCr + netRow.isCr,
        bsDr: columnTotals.bsDr + netRow.bsDr,
        bsCr: columnTotals.bsCr + netRow.bsCr
    };

    // 2. Score Calculation
    let score = 0;
    let maxScore = 0;
    const validationResults = { rows: {}, footers: { totals: {}, net: {}, final: {} } };

    // Helper to compare
    const checkVal = (userVal, expectedVal) => {
        maxScore++;
        const u = Number(userVal || 0);
        const e = Math.round(Number(expectedVal || 0));
        const isCorrect = Math.abs(u - e) <= 1;
        if (isCorrect) score++;
        return isCorrect;
    };

    // Score Rows
    rows.forEach(row => {
        const acc = row.account?.trim();
        const rowRes = {};
        if (acc && expectedMap[acc]) {
            ['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].forEach(col => {
                rowRes[col] = checkVal(row[col], expectedMap[acc][col]);
            });
        } else if (acc) {
            ['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].forEach(col => {
                checkVal(row[col], 0);
                rowRes[col] = false;
            });
        }
        validationResults.rows[row.id] = rowRes;
    });
    
    // Add max score for missing rows if any
    const missingCount = sortedAccounts.length - rows.filter(r => r.account && expectedMap[r.account]).length;
    if (missingCount > 0) maxScore += (missingCount * 10);

    // Score Footers
    ['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].forEach(col => {
        validationResults.footers.totals[col] = checkVal(footers.totals[col], columnTotals[col]);
        validationResults.footers.final[col] = checkVal(footers.final[col], finalRow[col]);
    });

    ['isDr', 'isCr', 'bsDr', 'bsCr'].forEach(col => {
        validationResults.footers.net[col] = checkVal(footers.net[col], netRow[col]);
    });

    const isCorrect = score === maxScore && maxScore > 0;
    const letterGrade = getLetterGrade(score, maxScore);

    return { isCorrect, score, maxScore, letterGrade, validationResults, expectedMap };
};


// --- INTERNAL COMPONENTS ---

const SimpleLedgerView = ({ ledgerData, adjustments }) => {
    const [expanded, setExpanded] = useState(true);
    
    const allAccounts = useMemo(() => {
        const accounts = new Set(Object.keys(ledgerData));
        if (adjustments) {
            adjustments.forEach(adj => {
                if(adj.drAcc) accounts.add(adj.drAcc);
                if(adj.crAcc) accounts.add(adj.crAcc);
            });
        }
        return sortAccounts(Array.from(accounts));
    }, [ledgerData, adjustments]);
    
    return html`
        <div className="mb-4 border rounded-lg shadow-sm bg-blue-50 overflow-hidden no-print">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 cursor-pointer flex justify-between" onClick=${()=>setExpanded(!expanded)}>
                <span><${Table} size=${16} className="inline mr-2"/>Source: General Ledger Balances</span>
                ${expanded ? html`<${ChevronDown} size=${16}/>` : html`<${ChevronRight} size=${16}/>`}
            </div>
            ${expanded && html`
                <div className="p-2 max-h-40 overflow-y-auto flex flex-wrap gap-2">
                    ${allAccounts.map(acc => { 
                        const accData = ledgerData[acc] || { debit: 0, credit: 0 };
                        const bal = accData.debit - accData.credit; 
                        return html`
                            <div key=${acc} className="bg-white border px-2 py-1 text-xs rounded shadow-sm">
                                <span className="font-semibold">${acc}:</span> 
                                <span className="text-gray-800 ml-1 font-mono font-medium">
                                    ${Math.abs(bal).toLocaleString()}
                                </span>
                            </div>
                        `; 
                    })}
                </div>
            `}
        </div>
    `;
};

// --- MAIN COMPONENT ---

function Step05Worksheet({ ledgerData, adjustments, data, onChange, showFeedback, isReadOnly }) {
    
    const initialRows = useMemo(() => Array.from({ length: 10 }).map((_, i) => ({ id: i, account: '', tbDr: '', tbCr: '', adjDr: '', adjCr: '', atbDr: '', atbCr: '', isDr: '', isCr: '', bsDr: '', bsCr: '' })), []);
    const rows = data.rows || initialRows;

    const [localFooters, setLocalFooters] = useState({ totals: {}, net: {}, final: {} });

    useEffect(() => {
        if (data.footers) {
            setLocalFooters(prev => ({
                totals: { ...prev.totals, ...data.footers.totals },
                net: { ...prev.net, ...data.footers.net },
                final: { ...prev.final, ...data.footers.final }
            }));
        }
    }, [data.footers]);

    const validation = useMemo(() => {
        return validateStep05(ledgerData, adjustments, { rows, footers: localFooters });
    }, [ledgerData, adjustments, rows, localFooters]);

    const updateRow = (idx, field, val) => {
        const newRows = [...rows];
        newRows[idx] = { ...newRows[idx], [field]: val };
        onChange('rows', newRows);
    };

    const addRow = () => {
        const newId = rows.length > 0 ? Math.max(...rows.map(r => r.id)) + 1 : 0;
        onChange('rows', [...rows, { id: newId, account: '', tbDr: '', tbCr: '', adjDr: '', adjCr: '', atbDr: '', atbCr: '', isDr: '', isCr: '', bsDr: '', bsCr: '' }]);
    };

    const deleteRow = (idx) => {
        const newRows = rows.filter((_, i) => i !== idx);
        onChange('rows', newRows);
    };

    const updateFooter = (section, field, val) => {
        const newSection = { ...localFooters[section], [field]: val };
        const newFooters = { ...localFooters, [section]: newSection };
        setLocalFooters(newFooters);
        onChange('footers', newFooters);
    };

    const renderInput = (val, handler, validResult, disabled = false, placeholder = "") => {
        let bgClass = "bg-transparent hover:bg-gray-50 focus:bg-white";
        let icon = null;

        if (showFeedback && validResult !== undefined) {
            if (validResult) {
                bgClass = "bg-green-50 text-green-900 font-medium";
                icon = html`<span className="absolute left-1 top-1/2 transform -translate-y-1/2 text-green-600 pointer-events-none"><${Check} size=${12}/></span>`;
            } else {
                bgClass = "bg-red-50 text-red-900 font-medium";
                icon = html`<span className="absolute left-1 top-1/2 transform -translate-y-1/2 text-red-500 pointer-events-none"><${X} size=${12}/></span>`;
            }
        }

        return html`
            <div className="relative w-full h-full">
                ${icon}
                <input type="number" 
                    className=${`w-full h-full text-right p-1 pl-4 text-xs outline-none border border-transparent focus:border-blue-500 ${bgClass}`} 
                    value=${val || ''} 
                    onChange=${handler} 
                    disabled=${disabled || isReadOnly}
                    placeholder=${placeholder}
                />
            </div>
        `;
    };

    const renderAccountInput = (row, idx) => {
        const isValid = validation.expectedMap[row.account];
        let bgClass = "bg-white";
        if (showFeedback) {
            bgClass = isValid ? "text-green-700 font-bold" : (row.account ? "text-red-600 bg-red-50" : "");
        }
        return html`
            <input type="text" 
                className=${`w-full h-full p-1 text-xs outline-none ${bgClass}`} 
                value=${row.account} 
                onChange=${(e) => updateRow(idx, 'account', e.target.value)} 
                disabled=${isReadOnly} 
                placeholder="Account Title"
            />
        `;
    };

    const renderBanner = () => {
        if (!showFeedback && !isReadOnly) return null;
        const result = validation;

        return html`
            <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                <span className="font-mono font-bold text-lg">Score: ${result.score || 0} of ${result.maxScore || 0} - (${result.letterGrade || 'IR'})</span>
            </div>
        `;
    };

    return html`
        <div className="w-full">
            
            ${renderBanner()}

            <div className="flex flex-col lg:flex-row gap-4 mb-4">
                <div className="flex-1"><${SimpleLedgerView} ledgerData=${ledgerData} adjustments=${adjustments} /></div>
                <div className="flex-1 border rounded-lg shadow-sm bg-yellow-50 overflow-hidden">
                    <div className="bg-yellow-100 p-2 font-bold text-yellow-900 flex items-center gap-2"><${List} size=${16}/> Adjustments Data</div>
                    <div className="p-2 max-h-40 overflow-y-auto"><ul className="list-decimal list-inside text-xs space-y-1">${adjustments.map(adj => html`<li key=${adj.id}>${adj.desc}</li>`)}</ul></div>
                </div>
            </div>

            <div className="border rounded-lg shadow-md bg-white overflow-x-auto custom-scrollbar">
                <table className="w-full text-xs min-w-[1200px] border-collapse table-fixed">
                    <thead>
                        <tr className="bg-gray-800 text-white text-center">
                            <th rowSpan="2" className="p-2 border-r border-gray-600 text-left w-48 sticky left-0 bg-gray-800 z-10">Account Title</th>
                            <th colSpan="2" className="p-1 border-r border-gray-600 bg-blue-900">Unadjusted TB</th>
                            <th colSpan="2" className="p-1 border-r border-gray-600 bg-yellow-900">Adjustments</th>
                            <th colSpan="2" className="p-1 border-r border-gray-600 bg-purple-900">Adjusted TB</th>
                            <th colSpan="2" className="p-1 border-r border-gray-600 bg-green-900">Income Statement</th>
                            <th colSpan="2" className="p-1 bg-indigo-900">Balance Sheet</th>
                            <th rowSpan="2" className="w-8 bg-gray-800"></th>
                        </tr>
                        <tr className="bg-gray-700 text-white text-center">
                             ${['Dr', 'Cr', 'Dr', 'Cr', 'Dr', 'Cr', 'Dr', 'Cr', 'Dr', 'Cr'].map(h => html`<th className="p-1 border-r border-gray-600">${h}</th>`)}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map((row, idx) => {
                            const rowRes = validation.validationResults.rows[row.id] || {};
                            return html`
                                <tr key=${row.id} className="border-b hover:bg-blue-50">
                                    <td className="p-0 border-r text-left relative sticky left-0 z-0 bg-white border-b">
                                        ${renderAccountInput(row, idx)}
                                    </td>
                                    ${['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].map(col => html`
                                        <td key=${col} className="border-r border-b p-0 relative h-8">
                                            ${renderInput(row[col], (e) => updateRow(idx, col, e.target.value), rowRes[col])}
                                        </td>
                                    `)}
                                    <td className="p-0 text-center border-b">
                                        ${!isReadOnly && html`<button onClick=${() => deleteRow(idx)} className="text-gray-400 hover:text-red-600 p-1"><${Trash2} size=${14}/></button>`}
                                    </td>
                                </tr>
                            `;
                        })}
                        
                        <tr className="bg-gray-100 font-bold border-t-2 border-gray-400">
                            <td className="p-1 border-r text-right sticky left-0 bg-gray-100 border-b">Column Totals</td>
                            ${['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].map(col => html`
                                <td key=${col} className="border-r border-b p-0 relative h-8">
                                    ${renderInput(localFooters.totals?.[col], (e) => updateFooter('totals', col, e.target.value), validation.validationResults.footers.totals[col])}
                                </td>
                            `)}
                            <td className="bg-gray-100 border-b"></td>
                        </tr>

                        <tr className="bg-white border-t border-gray-200">
                            <td className="p-1 border-r text-right sticky left-0 bg-white font-medium border-b">Net Income (Loss)</td>
                            <td colSpan="6" className="border-r bg-gray-50 text-center text-xs text-gray-400 italic border-b"></td>
                            ${['isDr', 'isCr', 'bsDr', 'bsCr'].map(col => html`
                                <td key=${col} className="border-r border-b p-0 relative h-8">
                                    ${renderInput(localFooters.net?.[col], (e) => updateFooter('net', col, e.target.value), validation.validationResults.footers.net[col], false, '')}
                                </td>
                            `)}
                            <td className="border-b"></td>
                        </tr>

                        <tr className="bg-gray-200 font-extrabold border-t-2 border-black border-b-2">
                            <td className="p-1 border-r text-right sticky left-0 bg-gray-200">Final Total</td>
                            ${['tbDr', 'tbCr', 'adjDr', 'adjCr', 'atbDr', 'atbCr', 'isDr', 'isCr', 'bsDr', 'bsCr'].map(col => html`
                                <td key=${col} className="border-r p-0 relative h-8">
                                     ${renderInput(localFooters.final?.[col], (e) => updateFooter('final', col, e.target.value), validation.validationResults.footers.final[col])}
                                </td>`
                            )}
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            ${!isReadOnly && html`
                <div className="mt-2">
                    <button onClick=${addRow} className="text-xs bg-blue-50 border border-blue-200 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 flex items-center gap-1 font-bold">
                        <${Plus} size=${14}/> Add Row
                    </button>
                </div>
            `}
        </div>
    `;
}







const html = htm.bind(React.createElement);

// --- HELPER: Value Parser & Validator ---
const parseUserValue = (val) => {
    if (!val) return 0;
    let str = val.toString().trim();
    let isNegative = false;
    if (str.startsWith('(') && str.endsWith(')')) {
        isNegative = true;
        str = str.slice(1, -1);
    } else if (str.startsWith('-')) {
        isNegative = true;
        str = str.substring(1);
    }
    const num = Number(str.replace(/,/g, ''));
    return isNegative ? -num : num;
};

const checkField = (userVal, expectedVal, isDeduction = false) => {
    // Round expected value to nearest integer for comparison
    const expRounded = Math.round(expectedVal);
    
    // Case 1: Expected is 0 (e.g. Income Tax, Beg Cap for new business)
    // Allowed to be blank or '0'
    if (Math.abs(expRounded) < 0.01) {
        return !userVal || parseUserValue(userVal) === 0;
    }

    // Case 2: Expected is NON-ZERO
    // Must NOT be blank. If blank, return FALSE (X mark).
    // This fixes the "Confusing Checkmarks" issue on empty total boxes.
    if (!userVal && userVal !== 0) return false;

    const parsedUser = parseUserValue(userVal);
    const matchesNumber = Math.abs(parsedUser - expRounded) <= 1 || Math.abs(parsedUser - (-expRounded)) <= 1;
    
    if (!matchesNumber) return false;
    
    // Sign check for deductions
    if (expRounded < 0 || isDeduction) {
        // Enforce explicit sign if needed, though mostly we just check magnitude above
        if (!userVal.toString().includes('(') && !userVal.toString().includes('-') && parsedUser > 0) return false;
    }
    return true;
};

// Modified input class to allow space for the icon on the right (pr-6)
const inputClass = (isError) => `w-full text-right p-1 text-xs outline-none border-b border-gray-300 bg-transparent focus:border-blue-500 font-mono pr-6 ${isError ? 'bg-red-50 text-red-600 font-bold' : ''}`;
const btnStyle = "mt-2 text-xs text-blue-900 font-medium hover:underline flex items-center gap-1 cursor-pointer";

// --- NEW INTERNAL COMPONENT: Input with Feedback Icon ---
const FeedbackInput = ({ value, onChange, expected, isDeduction, showFeedback, isReadOnly, placeholder, required }) => {
    // Determine validation status
    let isCorrect = checkField(value, expected, isDeduction);
    
    // ENHANCEMENT: If required is true, treat empty values as incorrect even if expected is 0
    if (required && (!value || value.toString().trim() === '')) {
        isCorrect = false;
    }
    
    // We show styling if feedback is enabled.
    const isError = showFeedback && !isCorrect;
    const isValid = showFeedback && isCorrect;

    return html`
        <div className="relative w-full">
            <input 
                type="text" 
                className=${inputClass(isError)} 
                value=${value || ''} 
                onChange=${onChange} 
                disabled=${isReadOnly} 
                placeholder=${placeholder}
            />
            ${showFeedback && html`
                <span className="absolute right-0 top-1/2 transform -translate-y-1/2 pointer-events-none pr-1">
                    ${isValid 
                        ? html`<${Check} size=${14} className="text-green-600"/>` 
                        : html`<${X} size=${14} className="text-red-500"/>`
                    }
                </span>
            `}
        </div>
    `;
};

// --- DRY VALIDATION LOGIC ---
const validateStep06 = (ledgerData, adjustments, activityData, userAnswers) => {
    let score = 0;
    let maxScore = 0;
    
    // 1. Calculate Expected Data (The Truth)
    const s = new Set(Object.keys(ledgerData));
    adjustments.forEach(adj => { s.add(adj.drAcc); s.add(adj.crAcc); });
    
    // Buckets for expected accounts
    const expected = {
        revenues: [],
        expenses: [],
        currentAssets: [],
        nonCurrentAssets: [], // For PPE Cost
        contraAssets: [],     // For Accumulated Depreciation
        otherAssets: [],      // Land, etc.
        liabilities: [],
        currentLiabilities: [],
        nonCurrentLiabilities: [],
        equity: {}, // BegCap, Investments, Drawings
        totals: { 
            ni: 0, 
            rev: 0,
            exp: 0,
            curAssets: 0, 
            nonCurAssets: 0,
            assets: 0, 
            curLiabs: 0,
            nonCurLiabs: 0,
            liabs: 0, 
            endCap: 0,
            liabEquity: 0
        }
    };

    // Process Ledger + Adjustments to get Final Adjusted Balances
    Array.from(s).forEach(acc => {
        const lBal = (ledgerData[acc]?.debit || 0) - (ledgerData[acc]?.credit || 0);
        let aDr = 0; let aCr = 0;
        adjustments.forEach(a => { if(a.drAcc === acc) aDr += a.amount; if(a.crAcc === acc) aCr += a.amount; });
        const atbNet = lBal + (aDr - aCr); // Positive = Dr, Negative = Cr
        
        if (Math.abs(atbNet) < 0.01) return; // Skip zero balance accounts

        const type = getAccountType(acc);
        const val = Math.abs(atbNet);

        if (type === 'Revenue') {
            expected.revenues.push({ name: acc, amount: val });
            expected.totals.ni += val; 
            expected.totals.rev += val;
        } else if (type === 'Expense') {
            expected.expenses.push({ name: acc, amount: val });
            expected.totals.ni -= val; 
            expected.totals.exp += val;
        } else if (type === 'Asset') {
            const lowerAcc = acc.toLowerCase();
            const isCurrent = ['cash', 'receivable', 'inventory', 'supplies', 'prepaid'].some(k => lowerAcc.includes(k));
            const isContra = lowerAcc.includes('accumulated');
            
            if (isCurrent) {
                expected.currentAssets.push({ name: acc, amount: val });
                expected.totals.curAssets += val;
            } else if (isContra) {
                expected.contraAssets.push({ name: acc, amount: val }); 
                expected.totals.nonCurAssets -= val; // Contra reduces assets
            } else {
                // Non-current (PPE, Land)
                expected.nonCurrentAssets.push({ name: acc, amount: val });
                expected.totals.nonCurAssets += val;
            }
            expected.totals.assets += (isContra ? -val : val); // Net Asset Total
            
        } else if (type === 'Liability') {
            const isNonCurrent = acc.toLowerCase().includes('mortgage') || acc.toLowerCase().includes('bond') || acc.toLowerCase().includes('loan');
            
            if (isNonCurrent) {
                expected.nonCurrentLiabilities.push({ name: acc, amount: val });
                expected.totals.nonCurLiabs += val;
            } else {
                expected.currentLiabilities.push({ name: acc, amount: val });
                expected.totals.curLiabs += val;
            }
            expected.totals.liabs += val;
            
        } else if (acc.includes('Drawings') || acc.includes('Dividends')) {
            expected.equity.drawings = (expected.equity.drawings || 0) + val;
        } else if (type === 'Equity' && !acc.includes('Income Summary')) {
            expected.equity.capitalAccount = acc;
            expected.equity.begBal = Math.abs(activityData.beginningBalances?.balances?.[acc]?.cr || 0); 
            expected.equity.atbCapital = val; 
        }
    });

    // Special handling for Investments
    let investments = 0;
    activityData.transactions.forEach(t => {
        t.credits.forEach(c => {
             if (getAccountType(c.account) === 'Equity' && !c.account.includes('Drawings') && !c.account.includes('Retained')) {
                 investments += c.amount;
             }
        });
    });
    expected.equity.investments = investments;

    // Recalculate End Cap strictly (Assets - Liabilities = Equity)
    expected.totals.endCap = expected.totals.assets - expected.totals.liabs;
    expected.totals.liabEquity = expected.totals.liabs + expected.totals.endCap;


    // --- SCORING HELPER ---
    const scoreSection = (userRows, expectedItems) => {
        expectedItems.forEach(exp => {
            maxScore += 2; // 1 for Name, 1 for Amount
            const match = userRows.find(r => r.label && r.label.toLowerCase().trim() === exp.name.toLowerCase().trim());
            if (match) {
                score += 1; // Found the account
                if (checkField(match.amount, exp.amount)) {
                    score += 1; // Amount is correct
                }
            }
        });
    };

    const scoreField = (userVal, expectedVal) => {
        maxScore += 1;
        if (checkField(userVal, expectedVal)) score += 1;
    };


    // 2. Score Income Statement
    const isData = userAnswers.is || {};
    const allUserISRows = [
        ...(isData.revenues || []), 
        ...(isData.opRevenues || []), 
        ...(isData.otherIncome || []),
        ...(isData.expenses || []),
        ...(isData.opExpenses || []),
        ...(isData.nonOpItems || [])
    ];

    scoreSection(allUserISRows, expected.revenues);
    scoreSection(allUserISRows, expected.expenses);
    
    // Score Totals in IS
    scoreField(isData.totalRevenues || isData.totalOpRevenues, expected.totals.rev);
    scoreField(isData.totalExpenses || isData.totalOpExpenses, expected.totals.exp);
    scoreField(isData.netIncomeBeforeTax, expected.totals.ni);
    scoreField(isData.incomeTax, 0); // Income Tax is 0
    scoreField(isData.netIncomeAfterTax, expected.totals.ni); 

    // 3. Score SCE
    const sceData = userAnswers.sce || {};
    const begCapVal = activityData.config.isSubsequentYear ? expected.equity.begBal : 0; 
    scoreField(sceData.begCapital, begCapVal);
    
    const sceAdditions = sceData.additions || [];
    let additionsTotal = 0;
    if (expected.equity.investments > 0) {
        maxScore += 2;
        const invMatch = sceAdditions.find(r => r.label.toLowerCase().includes('investment') || r.label.toLowerCase().includes('capital'));
        if (invMatch) {
            score += 1;
            if (checkField(invMatch.amount, expected.equity.investments)) score += 1;
        }
        additionsTotal += expected.equity.investments;
    }
    if (expected.totals.ni > 0) {
        maxScore += 2;
        const niMatch = sceAdditions.find(r => r.label.toLowerCase().includes('income'));
        if (niMatch) {
            score += 1;
            if (checkField(niMatch.amount, expected.totals.ni)) score += 1;
        }
        additionsTotal += expected.totals.ni;
    }
    scoreField(sceData.totalAdditions, additionsTotal);

    // Capital During
    scoreField(sceData.totalCapDuring, begCapVal + additionsTotal);

    const sceDeductions = sceData.deductions || [];
    let deductionsTotal = 0;
    if (expected.equity.drawings > 0) {
        maxScore += 2;
        const drwMatch = sceDeductions.find(r => r.label.toLowerCase().includes('drawing'));
        if (drwMatch) {
            score += 1;
            if (checkField(drwMatch.amount, expected.equity.drawings)) score += 1;
        }
        deductionsTotal += expected.equity.drawings;
    }
    if (expected.totals.ni < 0) {
        maxScore += 2;
        const lossMatch = sceDeductions.find(r => r.label.toLowerCase().includes('loss'));
        if (lossMatch) {
            score += 1;
            if (checkField(lossMatch.amount, Math.abs(expected.totals.ni))) score += 1;
        }
        deductionsTotal += Math.abs(expected.totals.ni);
    }
    scoreField(sceData.totalDeductions, deductionsTotal);

    scoreField(sceData.endCapital, expected.totals.endCap);

    // 4. Score Balance Sheet
    const bsData = userAnswers.bs || {};
    
    // Score Current Assets
    scoreSection(bsData.curAssets || [], expected.currentAssets);
    scoreField(bsData.totalCurAssets, expected.totals.curAssets);

    // Score Depreciable Assets (Cost, Accum, Net)
    const userDepAssets = bsData.depAssets || [];
    const ppeAssets = expected.nonCurrentAssets.filter(a => !a.name.toLowerCase().includes('land')); 
    const landAssets = expected.nonCurrentAssets.filter(a => a.name.toLowerCase().includes('land'));

    ppeAssets.forEach(ppe => {
        // ENHANCEMENT: Increase max score to 5 per asset to include Names and all Amounts
        // 1. Asset Name (1)
        // 2. Cost Amount (1)
        // 3. Contra Name (1)
        // 4. Accum Amount (1)
        // 5. Net Amount (1)
        maxScore += 5; 

        // Matching logic: Check if user asset name contains key word from expected (e.g. "Equipment" from "Office Equipment")
        const keyword = ppe.name.toLowerCase().split(' ')[0];
        const userRow = userDepAssets.find(r => r.asset && r.asset.toLowerCase().includes(keyword));
        
        if (userRow) {
            // 1. Asset Name found
            score += 1;

            // 2. Check Cost Amount
            if (checkField(userRow.cost, ppe.amount)) score += 1;
            
            // 3. Check Contra Name (Should imply it's an Accumulated Depreciation account)
            // We check if it exists and reasonably looks like a contra account
            if (userRow.contra && userRow.contra.toLowerCase().includes('accumulated')) {
                score += 1;
            }

            // 4. Check Accum Amount (Contra)
            const contra = expected.contraAssets.find(c => c.name.toLowerCase().includes(keyword)); 
            const contraAmt = contra ? contra.amount : 0;
            if (checkField(userRow.accum, contraAmt, true)) score += 1; 

            // 5. Check Net
            const netAmt = ppe.amount - contraAmt;
            if (checkField(userRow.net, netAmt)) score += 1;
        }
    });

    // Score Other Assets (Land, etc)
    scoreSection(bsData.otherAssets || [], landAssets);
    
    scoreField(bsData.totalNonCurAssets, expected.totals.nonCurAssets);
    scoreField(bsData.totalAssets, expected.totals.assets);

    // Score Liabilities
    scoreSection(bsData.curLiabs || [], expected.currentLiabilities);
    scoreField(bsData.totalCurLiabs, expected.totals.curLiabs);
    
    scoreSection(bsData.nonCurLiabs || [], expected.nonCurrentLiabilities);
    scoreField(bsData.totalNonCurLiabs, expected.totals.nonCurLiabs);

    scoreField(bsData.totalLiabs, expected.totals.liabs);
    
    // Score Equity Section in BS
    scoreField(bsData.endCapital, expected.totals.endCap);
    scoreField(bsData.totalLiabEquity, expected.totals.liabEquity);

    const isCorrect = score === maxScore && maxScore > 0;
    const letterGrade = getLetterGrade(score, maxScore);
    
    return { score, maxScore, letterGrade, isCorrect, expected }; 
};


// --- INTERNAL COMPONENT: Worksheet Source View (Read-Only) ---
const WorksheetSourceView = ({ ledgerData, adjustments }) => {
    const mergedAccounts = useMemo(() => { 
        const s = new Set(Object.keys(ledgerData)); 
        adjustments.forEach(adj => { s.add(adj.drAcc); s.add(adj.crAcc); }); 
        return sortAccounts(Array.from(s)); 
    }, [ledgerData, adjustments]);

    const data = useMemo(() => {
        return mergedAccounts.map(acc => {
            const ledgerBal = (ledgerData[acc]?.debit || 0) - (ledgerData[acc]?.credit || 0);
            const tbDr = ledgerBal > 0 ? ledgerBal : 0; const tbCr = ledgerBal < 0 ? Math.abs(ledgerBal) : 0;
            let aDr = 0; let aCr = 0;
            adjustments.forEach(a => { if(a.drAcc === acc) aDr += a.amount; if(a.crAcc === acc) aCr += a.amount; });
            const atbNet = (tbDr - tbCr) + (aDr - aCr);
            const atbDr = atbNet > 0 ? atbNet : 0; const atbCr = atbNet < 0 ? Math.abs(atbNet) : 0;
            const type = getAccountType(acc); const isIS = type === 'Revenue' || type === 'Expense';
            const isDr = isIS ? atbDr : 0; const isCr = isIS ? atbCr : 0; 
            const bsDr = !isIS ? atbDr : 0; const bsCr = !isIS ? atbCr : 0;
            return { acc, tbDr, tbCr, adjDr: aDr, adjCr: aCr, atbDr, atbCr, isDr, isCr, bsDr, bsCr };
        });
    }, [mergedAccounts, ledgerData, adjustments]);

    return html`
        <div className="h-full flex flex-col">
            <div className="bg-purple-100 p-2 font-bold text-purple-900 border-b border-purple-200"><${Table} size=${16} className="inline mr-2"/>Source: Worksheet (Correct Answers)</div>
            <div className="overflow-auto custom-scrollbar flex-1 bg-white">
                <table className="w-full text-xs min-w-[1000px] border-collapse">
                    <thead className="sticky top-0 z-10">
                        <tr className="bg-purple-900 text-white text-center"><th className="p-1 sticky left-0 bg-purple-900 z-20">Account</th><th colSpan="2">Adjusted TB</th><th colSpan="2">Income Statement</th><th colSpan="2">Balance Sheet</th></tr>
                        <tr className="bg-purple-800 text-white text-center"><th className="p-1 sticky left-0 bg-purple-800 z-20"></th><th>Dr</th><th>Cr</th><th>Dr</th><th>Cr</th><th>Dr</th><th>Cr</th></tr>
                    </thead>
                    <tbody>
                        ${data.map((row, idx) => html`
                            <tr key=${idx} className="border-b border-purple-100 hover:bg-purple-50">
                                <td className="p-1 border-r sticky left-0 bg-white z-0 truncate font-medium w-40">${row.acc}</td>
                                <td className="p-1 border-r text-right w-20">${row.atbDr || ''}</td>
                                <td className="p-1 border-r text-right w-20">${row.atbCr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-green-50">${row.isDr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-green-50">${row.isCr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-indigo-50">${row.bsDr || ''}</td>
                                <td className="p-1 text-right w-20 bg-indigo-50">${row.bsCr || ''}</td>
                            </tr>
                        `)}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

// Generic Form for Cash Flows (and others if needed)
const FinancialStatementForm = ({ title, data, onChange, isReadOnly, headerColor = "bg-gray-100" }) => {
    const rows = data?.rows || [{ label: '', amount: '' }, { label: '', amount: '' }];
    const updateRow = (idx, field, val) => { const newRows = [...rows]; newRows[idx] = { ...newRows[idx], [field]: val }; onChange('rows', newRows); };
    const addRow = () => onChange('rows', [...rows, { label: '', amount: '' }]);
    const deleteRow = (idx) => { if (rows.length <= 1) return; onChange('rows', rows.filter((_, i) => i !== idx)); };

    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className=${`${headerColor} p-2 font-bold text-gray-800 border-b text-center text-sm`}>${title}</div>
            <div className="p-2 overflow-y-auto flex-1">
                <table className="w-full text-xs">
                    <thead><tr><th className="text-left p-1">Particulars</th><th className="text-right p-1 w-24">Amount</th><th className="w-6"></th></tr></thead>
                    <tbody>${rows.map((r, i) => html`<tr key=${i} className="border-b border-gray-100"><td className="p-1"><input type="text" className="w-full outline-none bg-transparent font-medium" placeholder="..." value=${r.label} onChange=${(e)=>updateRow(i, 'label', e.target.value)} disabled=${isReadOnly}/></td><td className="p-1"><input type="number" className="w-full text-right outline-none bg-transparent" placeholder="0" value=${r.amount} onChange=${(e)=>updateRow(i, 'amount', e.target.value)} disabled=${isReadOnly}/></td><td className="p-1 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow(i)} className="text-gray-400 hover:text-red-500"><${Trash2} size=${12}/></button>`}</td></tr>`)}</tbody>
                </table>
                ${!isReadOnly && html`<button onClick=${addRow} className=${btnStyle}><${Plus} size=${12}/> Add Line</button>`}
            </div>
        </div>
    `;
};

// --- BALANCE SHEET COMPONENT ---

const BalanceSheet = ({ data, onChange, isReadOnly, showFeedback, sceEndingCapital, expectedTotals, expectedData }) => {
    const [showNonCurrentAssets, setShowNonCurrentAssets] = useState(false);
    const [showNonCurrentLiabs, setShowNonCurrentLiabs] = useState(false);

    // Initial load check for Depreciable Assets row
    useEffect(() => {
        if (!data?.depAssets || data.depAssets.length === 0) {
            if (!isReadOnly && onChange) {
                // Initialize with one empty block if missing
                onChange({ ...data, depAssets: [{ asset: '', cost: '', contra: '', accum: '', net: '' }] });
            }
        }
    }, []); 

    const updateData = (updates) => onChange({ ...data, ...updates });

    // --- Asset Lists ---
    const curAssets = data?.curAssets || [{ label: '', amount: '' }];
    const otherAssets = data?.otherAssets || [{ label: '', amount: '' }];
    const depAssets = data?.depAssets || []; 

    // --- Liability Lists ---
    const curLiabs = data?.curLiabs || [{ label: '', amount: '' }];
    const nonCurLiabs = data?.nonCurLiabs || [{ label: '', amount: '' }];

    // --- Helpers ---
    const handleArrChange = (arrKey, idx, field, val) => {
        const arr = [...(data?.[arrKey] || [])];
        if (!arr[idx]) arr[idx] = {}; // Safety check
        arr[idx] = { ...arr[idx], [field]: val };
        updateData({ [arrKey]: arr });
    };
    const addRow = (arrKey, defaultObj) => updateData({ [arrKey]: [...(data?.[arrKey]||[]), defaultObj] });
    const deleteRow = (arrKey, idx) => updateData({ [arrKey]: (data?.[arrKey]||[]).filter((_, i) => i !== idx) });

    // EXPECTED TOTALS (From Truth, passed via props)
    // Fallback to 0 if not provided
    const expTotals = expectedTotals || { curAssets:0, nonCurAssets:0, assets:0, curLiabs:0, nonCurLiabs:0, liabs:0, liabEquity:0 };

    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-blue-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Balance Sheet (Sole Proprietorship)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                
                <div className="text-center font-bold text-sm mb-2">Assets</div>
                
                <div className="font-bold text-gray-700 mb-1">Current Assets</div>
                ${curAssets.map((r, i) => html`
                    <div key=${i} className="flex justify-between items-center border-b border-gray-100 py-1">
                        <div className="flex-1 pl-4"><input type="text" className="w-full bg-transparent outline-none" placeholder="[Current asset account]" value=${r.label} onChange=${(e)=>handleArrChange('curAssets', i, 'label', e.target.value)} disabled=${isReadOnly}/></div>
                        <div className="w-24"><input type="text" className="w-full text-right bg-transparent outline-none" placeholder="0" value=${r.amount} onChange=${(e)=>handleArrChange('curAssets', i, 'amount', e.target.value)} disabled=${isReadOnly}/></div>
                        <div className="w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('curAssets', i)}><${Trash2} size=${12} class="text-gray-400 hover:text-red-500"/></button>`}</div>
                    </div>
                `)}
                ${!isReadOnly && html`<button onClick=${()=>addRow('curAssets', {label:'', amount:''})} className=${btnStyle}><${Plus} size=${12}/> Add Current Asset Row</button>`}
                <div className="flex justify-between items-center py-1 font-semibold border-t border-black mt-1">
                    <span className="pl-8">Total Current Assets</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalCurAssets} onChange=${(e)=>updateData({ totalCurAssets: e.target.value })} expected=${expTotals.curAssets} showFeedback=${showFeedback} isReadOnly=${isReadOnly} /></div>
                </div>

                <div className="mt-4 mb-2 flex items-center gap-2 cursor-pointer text-blue-800 font-bold text-xs" onClick=${()=>setShowNonCurrentAssets(!showNonCurrentAssets)}>
                    ${showNonCurrentAssets ? html`<${ChevronDown} size=${14}/>` : html`<${ChevronRight} size=${14}/>`} Non-current Assets Section
                </div>
                
                ${showNonCurrentAssets && html`
                    <div className="pl-2 border-l-2 border-blue-100 mb-4">
                        ${depAssets.map((block, i) => {
                            // Enhancement: Find "True" expected values based on asset name entered by user
                            // This ensures that if the User has the correct name, we validate amounts against the ANSWER KEY, not just math.
                            let expCost = 0, expAccum = 0, expNet = 0;
                            if (expectedData && block.asset) {
                                const keyword = block.asset.toLowerCase().split(' ')[0];
                                const matchAsset = expectedData.nonCurrentAssets.find(a => a.name.toLowerCase().includes(keyword));
                                if (matchAsset) {
                                    expCost = matchAsset.amount;
                                    const matchContra = expectedData.contraAssets.find(c => c.name.toLowerCase().includes(keyword));
                                    expAccum = matchContra ? matchContra.amount : 0;
                                    expNet = expCost - expAccum;
                                } else {
                                    // Fallback to internal consistency check if no match found yet
                                    expNet = parseUserValue(block.cost) - Math.abs(parseUserValue(block.accum));
                                }
                            } else {
                                expNet = parseUserValue(block.cost) - Math.abs(parseUserValue(block.accum));
                            }

                            return html`
                            <div key=${i} className="mb-2 bg-gray-50 p-2 rounded relative group">
                                <div className="flex justify-between mb-1">
                                    <input type="text" className="bg-transparent w-full outline-none font-bold text-gray-800" placeholder="[Property/Equipment Account]" value=${block.asset} onChange=${(e)=>handleArrChange('depAssets', i, 'asset', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="w-24 relative">
                                        <${FeedbackInput} value=${block.cost} onChange=${(e)=>handleArrChange('depAssets', i, 'cost', e.target.value)} expected=${expCost} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="Cost" required=${true} />
                                    </div>
                                </div>
                                <div className="flex justify-between mb-1 text-gray-600">
                                    <span className="pl-4 flex-1">Less: <input type="text" className="inline-block bg-transparent outline-none w-3/4 italic" placeholder="[Accum. Depr.]" value=${block.contra} onChange=${(e)=>handleArrChange('depAssets', i, 'contra', e.target.value)} disabled=${isReadOnly}/></span>
                                    <div className="w-24 relative">
                                         <${FeedbackInput} value=${block.accum} onChange=${(e)=>handleArrChange('depAssets', i, 'accum', e.target.value)} expected=${expAccum} isDeduction=${false} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="0" required=${true} />
                                    </div>
                                </div>
                                <div className="flex justify-between font-bold">
                                    <span className="pl-8">Net Book Value</span>
                                    <div className="w-full"><${FeedbackInput} value=${block.net} onChange=${(e)=>handleArrChange('depAssets', i, 'net', e.target.value)} expected=${expNet} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="0" required=${true} /></div>
                                </div>
                                ${!isReadOnly && html`<button onClick=${()=>deleteRow('depAssets', i)} className="absolute top-1 right-[-20px] text-red-400 opacity-0 group-hover:opacity-100"><${Trash2} size=${12}/></button>`}
                            </div>
                        `})}
                        ${!isReadOnly && html`<button onClick=${()=>addRow('depAssets', {asset:'', cost:'', contra:'', accum:'', net:''})} className=${btnStyle}><${Plus} size=${12}/> Add Depreciable Asset Row</button>`}
                        
                        ${otherAssets.map((r, i) => html`
                            <div key=${i} className="flex justify-between items-center border-b border-gray-100 py-1 mt-2">
                                <div className="flex-1 pl-4"><input type="text" className="w-full bg-transparent outline-none" placeholder="[Land / Other asset account]" value=${r.label} onChange=${(e)=>handleArrChange('otherAssets', i, 'label', e.target.value)} disabled=${isReadOnly}/></div>
                                <div className="w-24"><input type="text" className="w-full text-right bg-transparent outline-none" placeholder="0" value=${r.amount} onChange=${(e)=>handleArrChange('otherAssets', i, 'amount', e.target.value)} disabled=${isReadOnly}/></div>
                                <div className="w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('otherAssets', i)}><${Trash2} size=${12} class="text-gray-400 hover:text-red-500"/></button>`}</div>
                            </div>
                        `)}
                        ${!isReadOnly && html`<button onClick=${()=>addRow('otherAssets', {label:'', amount:''})} className=${btnStyle}><${Plus} size=${12}/> Add Other Asset Row</button>`}
                        
                        <div className="flex justify-between items-center py-1 font-semibold border-t border-black mt-2">
                            <span className="pl-8">Total Non-current Assets</span>
                            <div className="w-full"><${FeedbackInput} value=${data?.totalNonCurAssets} onChange=${(e)=>updateData({ totalNonCurAssets: e.target.value })} expected=${expTotals.nonCurAssets} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                        </div>
                    </div>
                `}

                <div className="flex justify-between items-center py-2 font-bold border-t-2 border-black border-double border-b-4 mt-2 mb-6">
                    <span className="">Total Assets</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalAssets} onChange=${(e)=>updateData({ totalAssets: e.target.value })} expected=${expTotals.assets} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                <div className="text-center font-bold text-sm mb-2">Liabilities and Owner's Equity</div>

                <div className="font-bold text-gray-700 mb-1">Liabilities</div>
                <div className="pl-2 mb-2 font-medium text-gray-600">Current Liabilities</div>
                ${curLiabs.map((r, i) => html`
                    <div key=${i} className="flex justify-between items-center border-b border-gray-100 py-1">
                        <div className="flex-1 pl-4"><input type="text" className="w-full bg-transparent outline-none" placeholder="[Current liability account]" value=${r.label} onChange=${(e)=>handleArrChange('curLiabs', i, 'label', e.target.value)} disabled=${isReadOnly}/></div>
                        <div className="w-24"><input type="text" className="w-full text-right bg-transparent outline-none" placeholder="0" value=${r.amount} onChange=${(e)=>handleArrChange('curLiabs', i, 'amount', e.target.value)} disabled=${isReadOnly}/></div>
                        <div className="w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('curLiabs', i)}><${Trash2} size=${12} class="text-gray-400 hover:text-red-500"/></button>`}</div>
                    </div>
                `)}
                ${!isReadOnly && html`<button onClick=${()=>addRow('curLiabs', {label:'', amount:''})} className=${btnStyle}><${Plus} size=${12}/> Add Current Liability Row</button>`}
                
                <div className="flex justify-between items-center py-1 font-semibold border-t border-black mt-1">
                    <span className="pl-8">Total Current Liabilities</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalCurLiabs} onChange=${(e)=>updateData({ totalCurLiabs: e.target.value })} expected=${expTotals.curLiabs} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                 <div className="mt-4 mb-2 flex items-center gap-2 cursor-pointer text-blue-800 font-bold text-xs" onClick=${()=>setShowNonCurrentLiabs(!showNonCurrentLiabs)}>
                    ${showNonCurrentLiabs ? html`<${ChevronDown} size=${14}/>` : html`<${ChevronRight} size=${14}/>`} Non-current Liabilities Section
                </div>
                ${showNonCurrentLiabs && html`
                    <div className="pl-2 border-l-2 border-blue-100 mb-4">
                         ${nonCurLiabs.map((r, i) => html`
                            <div key=${i} className="flex justify-between items-center border-b border-gray-100 py-1">
                                <div className="flex-1 pl-4"><input type="text" className="w-full bg-transparent outline-none" placeholder="[Non-current liability account]" value=${r.label} onChange=${(e)=>handleArrChange('nonCurLiabs', i, 'label', e.target.value)} disabled=${isReadOnly}/></div>
                                <div className="w-24"><input type="text" className="w-full text-right bg-transparent outline-none" placeholder="0" value=${r.amount} onChange=${(e)=>handleArrChange('nonCurLiabs', i, 'amount', e.target.value)} disabled=${isReadOnly}/></div>
                                <div className="w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('nonCurLiabs', i)}><${Trash2} size=${12} class="text-gray-400 hover:text-red-500"/></button>`}</div>
                            </div>
                        `)}
                        ${!isReadOnly && html`<button onClick=${()=>addRow('nonCurLiabs', {label:'', amount:''})} className=${btnStyle}><${Plus} size=${12}/> Add Non-current Liability Row</button>`}
                         <div className="flex justify-between items-center py-1 font-semibold border-t border-black mt-1">
                            <span className="pl-8">Total Non-current Liabilities</span>
                            <div className="w-full"><${FeedbackInput} value=${data?.totalNonCurLiabs} onChange=${(e)=>updateData({ totalNonCurLiabs: e.target.value })} expected=${expTotals.nonCurLiabs} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                        </div>
                    </div>
                `}

                <div className="flex justify-between items-center py-1 font-bold mt-2">
                    <span className="pl-0">Total Liabilities</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalLiabs} onChange=${(e)=>updateData({ totalLiabs: e.target.value })} expected=${expTotals.liabs} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                <div className="font-bold text-gray-700 mt-4 mb-1">Owner's Equity</div>
                <div className="flex justify-between items-center py-1">
                    <span className="pl-4 text-gray-500 italic">[Owner, Capital Ending]</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.endCapital} onChange=${(e)=>updateData({ endCapital: e.target.value })} expected=${sceEndingCapital} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="From SCE..."/></div>
                </div>

                <div className="flex justify-between items-center py-2 font-bold mt-4 border-t-2 border-black border-double border-b-4">
                    <span className="">Total Liabilities and Owner's Equity</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalLiabEquity} onChange=${(e)=>updateData({ totalLiabEquity: e.target.value })} expected=${expTotals.liabEquity} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

            </div>
        </div>
    `;
};


// --------------------------------------------------------
// SCE
// --------------------------------------------------------
const StatementOfChangesInEquity = ({ data, onChange, isReadOnly, showFeedback, calculatedTotals, activityData, expectedTotals }) => {
    const { isSubsequentYear } = activityData.config;
    const { beginningBalances, transactions, ledger } = activityData;

    let expBegCap = 0;
    if (isSubsequentYear && beginningBalances) {
        expBegCap = beginningBalances.balances['Owner, Capital']?.cr || 0;
    }

    let expInvestment = 0;
    transactions.forEach(t => {
        t.credits.forEach(c => {
            if (c.account === 'Owner, Capital') {
                expInvestment += c.amount;
            }
        });
    });
    
    const expNetInc = calculatedTotals.isCr - calculatedTotals.isDr; 
    const expDrawings = (ledger['Owner, Drawings']?.debit || 0) - (ledger['Owner, Drawings']?.credit || 0);

    const expTotalAdditions = expInvestment + (expNetInc > 0 ? expNetInc : 0);
    const expTotalCapDuring = expBegCap + expTotalAdditions;
    const expTotalDeductions = expDrawings + (expNetInc < 0 ? Math.abs(expNetInc) : 0);
    const expEndCap = expTotalCapDuring - expTotalDeductions;

    const additions = data?.additions || [{ label: '', amount: '' }];
    const deductions = data?.deductions || [{ label: '', amount: '' }];
    const updateData = (updates) => onChange({ ...data, ...updates });

    const handleArrChange = (key, idx, field, val) => {
        const arr = [...(key === 'additions' ? additions : deductions)];
        arr[idx] = { ...arr[idx], [field]: val };
        updateData({ [key]: arr });
    };
    const addRow = (key) => updateData({ [key]: [...(key==='additions'?additions:deductions), { label: '', amount: '' }] });
    const deleteRow = (key, idx) => {
        const arr = [...(key === 'additions' ? additions : deductions)];
        if (arr.length <= 1) return;
        updateData({ [key]: arr.filter((_, i) => i !== idx) });
    };

    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-yellow-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Statement of Changes in Equity (Sole Proprietorship)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                
                <div className="flex justify-between items-center py-1">
                    <span className="text-gray-500 italic pl-0">[Owner, Capital - beginning]</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.begCapital} onChange=${(e)=>updateData({ begCapital: e.target.value })} expected=${expBegCap} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="0"/></div>
                </div>

                <div className="mt-2 font-bold text-gray-800">Add: <span className="text-gray-400 font-normal italic">[Additions to Capital]</span></div>
                <table className="w-full mb-1"><tbody>${additions.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="Investment / Net Income..." value=${r.label} onChange=${(e)=>handleArrChange('additions',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrChange('additions',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('additions',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table>
                ${!isReadOnly && html`<button onClick=${()=>addRow('additions')} className=${btnStyle}><${Plus} size=${12}/> Add Addition Row</button>`}
                
                <div className="flex justify-between items-center py-1 font-semibold border-t border-black">
                    <span className="pl-8">Total Additions to Capital</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalAdditions} onChange=${(e)=>updateData({ totalAdditions: e.target.value })} expected=${expTotalAdditions} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                <div className="flex justify-between items-center py-2 font-semibold">
                    <span className="">Total Owner, Capital during the period</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalCapDuring} onChange=${(e)=>updateData({ totalCapDuring: e.target.value })} expected=${expTotalCapDuring} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                <div className="mt-2 font-bold text-gray-800">Less: <span className="text-gray-400 font-normal italic">[Deductions from Capital]</span></div>
                <table className="w-full mb-1"><tbody>${deductions.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="Drawings / Net Loss..." value=${r.label} onChange=${(e)=>handleArrChange('deductions',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrChange('deductions',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('deductions',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table>
                ${!isReadOnly && html`<button onClick=${()=>addRow('deductions')} className=${btnStyle}><${Plus} size=${12}/> Add Deduction Row</button>`}

                <div className="flex justify-between items-center py-1 font-semibold border-t border-black">
                    <span className="pl-8">Total Deductions from Capital</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.totalDeductions} onChange=${(e)=>updateData({ totalDeductions: e.target.value })} expected=${expTotalDeductions} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div>
                </div>

                <div className="flex justify-between items-center py-2 font-bold mt-2 border-t border-black border-b-4 border-double">
                    <span className="text-gray-500 italic">[Owner, Capital - ending]</span>
                    <div className="w-full"><${FeedbackInput} value=${data?.endCapital} onChange=${(e)=>updateData({ endCapital: e.target.value })} expected=${expEndCap} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder="0"/></div>
                </div>
            </div>
        </div>
    `;
};


// --- RESTORED INCOME STATEMENT COMPONENTS (FROM DEC 8) ---

const ServiceSingleStepIS = ({ data, onChange, isReadOnly, showFeedback, calculatedTotals, expectedTotals }) => {
    const revenues = data?.revenues || [{ label: '', amount: '' }];
    const expenses = data?.expenses || [{ label: '', amount: '' }];
    const updateData = (updates) => onChange({ ...data, ...updates });
    const handleArrChange = (key, idx, field, val) => { const arr = [...(key==='revenues'?revenues:expenses)]; arr[idx] = {...arr[idx], [field]:val}; updateData({[key]: arr}); };
    const addRow = (key) => updateData({ [key]: [...(key==='revenues'?revenues:expenses), { label: '', amount: '' }] });
    const deleteRow = (key, idx) => { const arr = [...(key==='revenues'?revenues:expenses)]; if(arr.length<=1)return; updateData({[key]: arr.filter((_, i)=>i!==idx)}); };
    const expRev = calculatedTotals.isCr; const expExp = calculatedTotals.isDr; const expNI = expRev - expExp;
    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-green-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Income Statement (Single-Step Service)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                <div className="mb-4"><div className="font-bold mb-1 text-gray-800">Revenues</div><table className="w-full mb-1"><tbody>${revenues.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full outline-none bg-transparent" placeholder="[Revenue Account]" value=${r.label} onChange=${(e)=>handleArrChange('revenues',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="p-1 w-24"><input type="text" className="w-full text-right outline-none bg-transparent border-b border-gray-200" value=${r.amount} onChange=${(e)=>handleArrChange('revenues',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td className="p-1 w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('revenues',i)}><${Trash2} size=${12}/></button>`}</td></tr>`)}</tbody></table>${!isReadOnly && html`<button onClick=${()=>addRow('revenues')} className=${btnStyle}><${Plus} size=${12}/> Add Revenue Row</button>`}<div className="flex justify-between items-center py-1 font-bold mt-1"><span className="pl-0">Total Revenues</span><div className="w-full"><${FeedbackInput} value=${data?.totalRevenues} onChange=${(e)=>updateData({ totalRevenues: e.target.value })} expected=${expectedTotals?.rev || expRev} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div></div>
                <div className="mb-4"><div className="font-bold mb-1 text-gray-800">Less: Expenses</div><table className="w-full mb-1"><tbody>${expenses.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full outline-none bg-transparent" placeholder="[Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('expenses',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="p-1 w-24"><input type="text" className="w-full text-right outline-none bg-transparent border-b border-gray-200" value=${r.amount} onChange=${(e)=>handleArrChange('expenses',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td className="p-1 w-6 text-center">${!isReadOnly && html`<button onClick=${()=>deleteRow('expenses',i)}><${Trash2} size=${12}/></button>`}</td></tr>`)}</tbody></table>${!isReadOnly && html`<button onClick=${()=>addRow('expenses')} className=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button>`}<div className="flex justify-between items-center py-1 font-bold mt-1"><span className="pl-0">Total Expenses</span><div className="w-full"><${FeedbackInput} value=${data?.totalExpenses} onChange=${(e)=>updateData({ totalExpenses: e.target.value })} expected=${expectedTotals?.exp || expExp} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div></div>
                <div className="space-y-1 mt-4 border-t-2 border-gray-400 pt-2"><div className="flex justify-between items-center py-1 font-semibold"><span className="">Net Income (Loss) before taxes</span><div className="w-full"><${FeedbackInput} value=${data?.netIncomeBeforeTax} onChange=${(e)=>updateData({ netIncomeBeforeTax: e.target.value })} expected=${expNI} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div><div className="flex justify-between items-center py-1"><span className="pl-4">Less: Income Tax</span><div className="w-full"><${FeedbackInput} value=${data?.incomeTax} onChange=${(e)=>updateData({ incomeTax: e.target.value })} expected=${0} showFeedback=${showFeedback} isReadOnly=${isReadOnly} /></div></div><div className="flex justify-between items-center py-2 font-bold text-blue-900 bg-gray-50 border-t-2 border-black border-double border-b-4"><span className="">Net Income (Loss) after taxes</span><div className="w-full"><${FeedbackInput} value=${data?.netIncomeAfterTax} onChange=${(e)=>updateData({ netIncomeAfterTax: e.target.value })} expected=${expNI} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div></div>
            </div>
        </div>
    `;
};

const ServiceMultiStepIS = ({ data, onChange, isReadOnly, showFeedback, calculatedTotals, expectedTotals }) => {
    const opRevenues = data?.opRevenues || [{ label: '', amount: '' }];
    const opExpenses = data?.opExpenses || [{ label: '', amount: '' }];
    const nonOpItems = data?.nonOpItems || [{ label: '', amount: '' }];
    const updateData = (updates) => onChange({ ...data, ...updates });
    const handleArrChange = (key, idx, field, val) => { const arr = [...(key==='opRevenues'?opRevenues:key==='opExpenses'?opExpenses:nonOpItems)]; arr[idx] = {...arr[idx], [field]:val}; updateData({[key]: arr}); };
    const addRow = (key) => updateData({ [key]: [...(key==='opRevenues'?opRevenues:key==='opExpenses'?opExpenses:nonOpItems), { label: '', amount: '' }] });
    const deleteRow = (key, idx) => { const arr = [...(key==='opRevenues'?opRevenues:key==='opExpenses'?opExpenses:nonOpItems)]; if(arr.length<=1)return; updateData({[key]: arr.filter((_, i)=>i!==idx)}); };
    const expRev = calculatedTotals.isCr; const expExp = calculatedTotals.isDr; const expNI = expRev - expExp;
    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-green-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Income Statement (Multi-Step Service)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                <div className="mb-4"><div className="font-bold mb-1">Operating Revenues</div><table className="w-full"><tbody>${opRevenues.map((r,i)=>html`<tr key=${i}><td className="pl-4"><input type="text" className="w-full bg-transparent" value=${r.label} onChange=${(e)=>handleArrChange('opRevenues',i,'label',e.target.value)} disabled=${isReadOnly} placeholder="[Revenue Account]"/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrChange('opRevenues',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('opRevenues',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('opRevenues')} class=${btnStyle}><${Plus} size=${12}/> Add Revenue Row</button><div class="flex justify-between font-bold"><span>Total Operating Revenues</span><input type="text" class="w-24 text-right" value=${data?.totalOpRevenues} onChange=${(e)=>updateData({totalOpRevenues:e.target.value})} disabled=${isReadOnly}/></div></div>
                <div className="mb-4"><div className="font-bold mb-1">Operating Expenses</div><table className="w-full"><tbody>${opExpenses.map((r,i)=>html`<tr key=${i}><td className="pl-4"><input type="text" className="w-full bg-transparent" value=${r.label} onChange=${(e)=>handleArrChange('opExpenses',i,'label',e.target.value)} disabled=${isReadOnly} placeholder="[Operating Expense Account]"/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrChange('opExpenses',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('opExpenses',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('opExpenses')} class=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button><div class="flex justify-between font-bold"><span>Total Operating Expenses</span><input type="text" class="w-24 text-right" value=${data?.totalOpExpenses} onChange=${(e)=>updateData({totalOpExpenses:e.target.value})} disabled=${isReadOnly}/></div></div>
                <div className="flex justify-between items-center border-t border-b border-gray-300 py-1 font-bold bg-gray-50 mb-4"><span className="">Net Operating Income (Loss)</span><input type="text" className="w-24 text-right outline-none bg-transparent pr-7" value=${data?.netOpIncome || ''} onChange=${(e)=>updateData({ netOpIncome: e.target.value })} disabled=${isReadOnly}/></div>
                <div className="mb-4"><div className="font-bold mb-1">Non-Operating Income and Expenses</div><table className="w-full"><tbody>${nonOpItems.map((r,i)=>html`<tr key=${i}><td className="pl-4"><input type="text" className="w-full bg-transparent" value=${r.label} onChange=${(e)=>handleArrChange('nonOpItems',i,'label',e.target.value)} disabled=${isReadOnly} placeholder="[Non-Operating Account]"/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrChange('nonOpItems',i,'amount',e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('nonOpItems',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('nonOpItems')} class=${btnStyle}><${Plus} size=${12}/> Add Non-Operating Row</button><div class="flex justify-between font-bold"><span>Net Non-operating Income (Loss)</span><input type="text" class="w-24 text-right" value=${data?.netNonOpIncome} onChange=${(e)=>updateData({netNonOpIncome:e.target.value})} disabled=${isReadOnly}/></div></div>
                <div className="space-y-1 mt-4 border-t-2 border-gray-400 pt-2"><div className="flex justify-between items-center py-1 font-semibold"><span className="">Net Income (Loss) before taxes</span><div className="w-full"><${FeedbackInput} value=${data?.netIncomeBeforeTax} onChange=${(e)=>updateData({ netIncomeBeforeTax: e.target.value })} expected=${expNI} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div><div className="flex justify-between items-center py-2 font-bold text-blue-900 bg-gray-50 border-t-2 border-black border-double border-b-4"><span className="">Net Income (Loss) after taxes</span><div className="w-full"><${FeedbackInput} value=${data?.netIncomeAfterTax} onChange=${(e)=>updateData({ netIncomeAfterTax: e.target.value })} expected=${expNI} showFeedback=${showFeedback} isReadOnly=${isReadOnly}/></div></div></div>
            </div>
        </div>
    `;
};

// --- RESTORED MERCH COMPONENTS ---

const MerchPeriodicIS = ({ data, onChange, isReadOnly, showFeedback, calculatedTotals, type = "Single", expectedTotals }) => {
    const { ledger, adjustments } = calculatedTotals;
    const getBal = (accName) => { const acc = Object.keys(ledger).find(k => k.toLowerCase() === accName.toLowerCase()); if (!acc) return 0; return (ledger[acc].debit || 0) - (ledger[acc].credit || 0); };
    
    // Values for Validation
    const expSales = Math.abs(getBal('Sales')); 
    const expSalesDisc = getBal('Sales Discounts'); 
    const expSalesRet = getBal('Sales Returns and Allowances'); 
    const expNetSales = expSales - expSalesDisc - expSalesRet;
    const expPurch = getBal('Purchases'); 
    const expPurchDisc = Math.abs(getBal('Purchase Discounts')); 
    const expPurchRet = Math.abs(getBal('Purchase Returns and Allowances')); 
    const expNetPurch = expPurch - expPurchDisc - expPurchRet;
    const expFreightIn = getBal('Freight In'); 
    const expCostPurch = expNetPurch + expFreightIn;
    const expBegInv = getBal('Merchandise Inventory'); 
    const expTGAS = expBegInv + expCostPurch;
    let expEndInv = 0; adjustments.forEach(a => { if (a.drAcc === 'Merchandise Inventory' || a.crAcc === 'Merchandise Inventory') { expEndInv = a.amount; } });
    const expCOGS = expTGAS - expEndInv; 
    const expGross = expNetSales - expCOGS;
    
    // Expenses
    const totalExpenses = calculatedTotals.isDr; 
    const expOpExp = totalExpenses - (expBegInv + expPurch + expFreightIn + expSalesDisc + expSalesRet);
    const expOpIncome = expGross - expOpExp; 
    const expNonOp = 0; 
    const expNI = expOpIncome + expNonOp;
    
    const updateData = (updates) => onChange({ ...data, ...updates });
    const handleAmountChange = (key, val) => {
        if (/^[0-9.,\-() ]*$/.test(val)) updateData({ [key]: val });
    };

    const renderRow = (label, valueKey, expected, isDeduction=false, indent='pl-4', placeholder='0.00', showInput=true, labelKey=null) => html`<div className="flex justify-between items-center py-1">
        ${labelKey 
            ? html`<span className=${indent}><input type="text" className="w-64 outline-none bg-transparent border-b border-gray-300 focus:border-blue-500 placeholder-gray-400 italic" placeholder=${label} value=${data?.[labelKey] || ''} onChange=${(e)=>updateData({ [labelKey]: e.target.value })} disabled=${isReadOnly}/></span>`
            : html`<span className=${indent}>${label}</span>`
        }
        ${showInput ? html`<div className="w-full"><${FeedbackInput} value=${data?.[valueKey]} onChange=${(e)=>handleAmountChange(valueKey, e.target.value)} expected=${expected} isDeduction=${isDeduction} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder=${placeholder}/></div>` : ''}
    </div>`;

    // Dynamic Expense Rows
    const expenseRows = data?.expenses || [{label:'', amount:''}];
    const opExpenseRows = data?.opExpenses || [{label:'', amount:''}];
    const nonOpRows = data?.nonOpItems || [{label:'', amount:''}];
    const otherIncomeRows = data?.otherIncome || [{label:'', amount:''}];
    
    const handleArrChange = (key, idx, field, val) => { const arr = [...(data[key] || [{label:'', amount:''} ])]; arr[idx] = {...arr[idx], [field]:val}; updateData({[key]: arr}); };
    const handleArrAmountChange = (key, idx, val) => {
        if (/^[0-9.,\-() ]*$/.test(val)) handleArrChange(key, idx, 'amount', val);
    };
    const addRow = (key) => updateData({ [key]: [...(data[key]||[{label:'',amount:''}]), { label: '', amount: '' }] });
    const deleteRow = (key, idx) => { const arr = [...(data[key] || [])]; if(arr.length<=1)return; updateData({[key]: arr.filter((_, i)=>i!==idx)}); };
    
    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-blue-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Income Statement (${type}-Step Periodic)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                ${type === 'Single' ? html`<div className="mb-2 font-bold text-gray-800">Revenues</div>` : html`<div className="mb-2 font-bold text-gray-800">Operating Revenues</div>`}
                ${renderRow('[Sales Account]', 'sales', expSales, false, 'pl-4', '0.00', true, 'salesLabel')}
                <div className="flex items-center gap-2 pl-8 text-blue-600 mb-1 cursor-pointer hover:underline text-xs" onClick=${()=>updateData({showSalesDetails: !data.showSalesDetails})}>${data.showSalesDetails ? '- Hide' : '+ Show'} Sales Discounts / Allowances Row</div>
                ${data.showSalesDetails && html`
                    ${renderRow('Less: Sales Discounts', 'salesDisc', -expSalesDisc, true, 'pl-8')}
                    ${renderRow('Less: Sales Returns and Allowances', 'salesRet', -expSalesRet, true, 'pl-8')}
                `}
                <div className="border-t border-black mt-1 mb-2"></div>
                ${renderRow('Net Sales', 'netSales', expNetSales, false, 'pl-4 font-bold')}

                <div className="mt-4 mb-2 font-bold text-gray-800">Cost of Goods Sold</div>
                ${renderRow('[Inventory Account - beginning]', 'begInv', expBegInv, false, 'pl-4', '[Beg Inv]', true, 'begInvLabel')}
                ${renderRow('[Purchases Account]', 'purchases', expPurch, false, 'pl-4', '[Purchases]', true, 'purchasesLabel')}
                <div className="flex items-center gap-2 pl-8 text-blue-600 mb-1 cursor-pointer hover:underline text-xs" onClick=${()=>updateData({showPurchDetails: !data.showPurchDetails})}>${data.showPurchDetails ? '- Hide' : '+ Show'} Purchase Discounts / Allowances Row</div>
                ${data.showPurchDetails && html`
                     ${renderRow('Less: Purchase Discounts', 'purchDisc', -expPurchDisc, true, 'pl-12')}
                     ${renderRow('Less: Purchase Returns', 'purchRet', -expPurchRet, true, 'pl-12')}
                `}
                ${renderRow('Net Purchases', 'netPurch', expNetPurch, false, 'pl-8 font-semibold')}
                ${renderRow('[Freight-in / Transportation In]', 'freightIn', expFreightIn, false, 'pl-8', '[Freight In]', true, 'freightInLabel')}
                <div className="border-t border-gray-300 mt-1 mb-1"></div>
                ${renderRow('Total Cost of Goods Purchased', 'costPurch', expCostPurch, false, 'pl-4 font-semibold')}
                <div className="border-t border-black mt-1 mb-1"></div>
                ${renderRow('Total Goods Available for Sale', 'tgas', expTGAS, false, 'pl-4 font-bold')}
                ${renderRow('[Inventory Account - ending]', 'endInv', -expEndInv, true, 'pl-4', '[End Inv]', true, 'endInvLabel')}
                <div className="border-b border-black mb-2"></div>
                ${renderRow('Cost of Goods Sold', 'cogs', -expCOGS, true, 'pl-0 font-bold text-red-700')}
                
                <div className="border-b-2 border-black mb-4"></div>
                ${renderRow('GROSS INCOME', 'grossIncome', expGross, false, 'pl-0 font-bold')}

                ${type === 'Single' ? html`
                    <div className="mt-4 font-bold text-gray-800">Other Operating & Non-Operating Income</div>
                    <table className="w-full mb-1"><tbody>${(data.otherIncome||[{label:'',amount:''}]).map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Other operating / non-operating income]" value=${r.label} onChange=${(e)=>handleArrChange('otherIncome',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('otherIncome',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('otherIncome',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('otherIncome')} class=${btnStyle}><${Plus} size=${12}/> Add Revenue Row</button>
                    ${renderRow('Total Revenues', 'totalRevenues', expGross, false, 'pl-0 font-bold')}

                    <div className="mt-4 font-bold text-gray-800">Expenses</div>
                    <table className="w-full mb-1"><tbody>${expenseRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Operating / Non-operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('expenses',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('expenses',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('expenses',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('expenses')} class=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button>
                    ${renderRow('Total Expenses', 'totalExpenses', expOpExp, false, 'pl-0 font-bold')}
                ` : html`
                    <div className="mt-4 font-bold text-gray-800">Less: Operating Expenses</div>
                    <table className="w-full mb-1"><tbody>${opExpenseRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('opExpenses',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('opExpenses',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('opExpenses',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('opExpenses')} class=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button>
                    ${renderRow('Total Operating Expenses', 'totalOpExpenses', expOpExp, false, 'pl-4 font-semibold')}
                    ${renderRow('Net Operating Income (Loss)', 'netOpInc', expOpIncome, false, 'pl-0 font-bold')}
                    
                    <div className="mt-4 font-bold text-gray-800">Non-Operating Income and Expenses</div>
                    <table className="w-full mb-1"><tbody>${nonOpRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Non-Operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('nonOpItems',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('nonOpItems',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('nonOpItems',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('nonOpItems')} class=${btnStyle}><${Plus} size=${12}/> Add Non-Operating Row</button>
                    ${renderRow('Net Non-Operating Income (Loss)', 'netNonOp', expNonOp, false, 'pl-4')}
                `}

                <div className="mt-6 border-t-2 border-black pt-2">
                     ${renderRow('Net Income (Loss) before taxes', 'niBefore', expNI, false, 'pl-0 font-bold')}
                     ${renderRow('Income Tax', 'tax', 0, true, 'pl-4')}
                     <div className="border-b-4 border-double border-black mb-1"></div>
                     ${renderRow('Net Income (Loss) after taxes', 'niAfter', expNI, false, 'pl-0 font-bold')}
                </div>
            </div>
        </div>
    `;
};

const MerchPerpetualIS = ({ data, onChange, isReadOnly, showFeedback, calculatedTotals, type = "Single", expectedTotals }) => {
    const { ledger } = calculatedTotals;
    const getBal = (accName) => { const acc = Object.keys(ledger).find(k => k.toLowerCase() === accName.toLowerCase()); if (!acc) return 0; return (ledger[acc].debit || 0) - (ledger[acc].credit || 0); };

    // Perpetual Values
    const expSales = Math.abs(getBal('Sales')); 
    const expSalesDisc = getBal('Sales Discounts'); 
    const expSalesRet = getBal('Sales Returns and Allowances'); 
    const expNetSales = expSales - expSalesDisc - expSalesRet;
    const expCOGS = getBal('Cost of Goods Sold'); 
    const expGross = expNetSales - expCOGS;
    const totalISDebits = calculatedTotals.isDr; 
    const expOpExp = totalISDebits - (expSalesDisc + expSalesRet + expCOGS);
    const expOpIncome = expGross - expOpExp;
    const expNonOp = 0; 
    const expNI = expOpIncome + expNonOp;

    const updateData = (updates) => onChange({ ...data, ...updates });
    const handleAmountChange = (key, val) => {
        if (/^[0-9.,\-() ]*$/.test(val)) updateData({ [key]: val });
    };

    const renderRow = (label, valueKey, expected, isDeduction=false, indent='pl-4', placeholder='0.00', showInput=true, labelKey=null) => html`<div className="flex justify-between items-center py-1">
        ${labelKey 
            ? html`<span className=${indent}><input type="text" className="w-64 outline-none bg-transparent border-b border-gray-300 focus:border-blue-500 placeholder-gray-400 italic" placeholder=${label} value=${data?.[labelKey] || ''} onChange=${(e)=>updateData({ [labelKey]: e.target.value })} disabled=${isReadOnly}/></span>`
            : html`<span className=${indent}>${label}</span>`
        }
        ${showInput ? html`<div className="w-full"><${FeedbackInput} value=${data?.[valueKey]} onChange=${(e)=>handleAmountChange(valueKey, e.target.value)} expected=${expected} isDeduction=${isDeduction} showFeedback=${showFeedback} isReadOnly=${isReadOnly} placeholder=${placeholder}/></div>` : ''}
    </div>`;
    
    // Dynamic Row Helpers
    const expenseRows = data?.expenses || [{label:'', amount:''}];
    const opExpenseRows = data?.opExpenses || [{label:'', amount:''}];
    const nonOpRows = data?.nonOpItems || [{label:'', amount:''}];
    const otherIncomeRows = data?.otherIncome || [{label:'', amount:''}];

    const handleArrChange = (key, idx, field, val) => { const arr = [...(data[key] || [{label:'', amount:''} ])]; arr[idx] = {...arr[idx], [field]:val}; updateData({[key]: arr}); };
    const handleArrAmountChange = (key, idx, val) => {
        if (/^[0-9.,\-() ]*$/.test(val)) handleArrChange(key, idx, 'amount', val);
    };
    const addRow = (key) => updateData({ [key]: [...(data[key]||[{label:'',amount:''}]), { label: '', amount: '' }] });
    const deleteRow = (key, idx) => { const arr = [...(data[key]||[])]; if(arr.length<=1)return; updateData({[key]: arr.filter((_, i)=>i!==idx)}); };

    return html`
        <div className="border rounded bg-white flex flex-col h-full shadow-sm">
            <div className="bg-blue-100 p-2 font-bold text-gray-800 border-b text-center text-sm">Income Statement (${type}-Step Perpetual)</div>
            <div className="p-4 overflow-y-auto flex-1 text-xs">
                ${type === 'Single' ? html`<div className="mb-2 font-bold text-gray-800">Revenues</div>` : html`<div className="mb-2 font-bold text-gray-800">Operating Revenues</div>`}
                ${renderRow('[Sales Account]', 'sales', expSales, false, 'pl-4', '0.00', true, 'salesLabel')}
                <div className="flex items-center gap-2 pl-8 text-blue-600 mb-1 cursor-pointer hover:underline text-xs" onClick=${()=>updateData({showSalesDetails: !data.showSalesDetails})}>${data.showSalesDetails ? '- Hide' : '+ Show'} Sales Discounts / Allowances Row</div>
                ${data.showSalesDetails && html`
                    ${renderRow('Less: Sales Discounts', 'salesDisc', -expSalesDisc, true, 'pl-8')}
                    ${renderRow('Less: Sales Returns and Allowances', 'salesRet', -expSalesRet, true, 'pl-8')}
                `}
                <div className="border-t border-black mt-1 mb-2"></div>
                ${renderRow('Net Sales', 'netSales', expNetSales, false, 'pl-4 font-bold')}

                ${renderRow('Cost of Goods Sold', 'cogs', -expCOGS, true, 'pl-4', '0.00', true, 'cogsLabel')}
                
                <div className="border-b-2 border-black mb-4"></div>
                ${renderRow('GROSS INCOME', 'grossIncome', expGross, false, 'pl-0 font-bold')}

                ${type === 'Single' ? html`
                    <div className="mt-4 font-bold text-gray-800">Other Operating & Non-Operating Income</div>
                    <table className="w-full mb-1"><tbody>${(otherIncomeRows).map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Other operating / non-operating income]" value=${r.label} onChange=${(e)=>handleArrChange('otherIncome',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('otherIncome',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('otherIncome',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('otherIncome')} class=${btnStyle}><${Plus} size=${12}/> Add Revenue Row</button>
                    ${renderRow('Total Revenues', 'totalRevenues', expGross, false, 'pl-0 font-bold')}

                    <div className="mt-4 font-bold text-gray-800">Expenses</div>
                    <table className="w-full mb-1"><tbody>${expenseRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Operating / Non-operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('expenses',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('expenses',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('expenses',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('expenses')} class=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button>
                    ${renderRow('Total Expenses', 'totalExpenses', expOpExp, false, 'pl-0 font-bold')}
                ` : html`
                    <div className="mt-4 font-bold text-gray-800">Operating Expenses</div>
                    <table className="w-full mb-1"><tbody>${opExpenseRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('opExpenses',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('opExpenses',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('opExpenses',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('opExpenses')} class=${btnStyle}><${Plus} size=${12}/> Add Expense Row</button>
                    ${renderRow('Total Operating Expenses', 'totalOpExpenses', expOpExp, false, 'pl-4 font-semibold')}
                    ${renderRow('Net Operating Income (Loss)', 'netOpInc', expOpIncome, false, 'pl-0 font-bold')}
                    
                    <div className="mt-4 font-bold text-gray-800">Non-Operating Income and Expenses</div>
                    <table className="w-full mb-1"><tbody>${nonOpRows.map((r,i)=>html`<tr key=${i}><td className="p-1 pl-4"><input type="text" className="w-full bg-transparent" placeholder="[Non-Operating Expense Account]" value=${r.label} onChange=${(e)=>handleArrChange('nonOpItems',i,'label',e.target.value)} disabled=${isReadOnly}/></td><td className="w-24"><input type="text" className="w-full text-right bg-transparent border-b" value=${r.amount} onChange=${(e)=>handleArrAmountChange('nonOpItems',i,e.target.value)} disabled=${isReadOnly}/></td><td><button onClick=${()=>deleteRow('nonOpItems',i)}><${Trash2} size=${12}/></button></td></tr>`)}</tbody></table><button onClick=${()=>addRow('nonOpItems')} class=${btnStyle}><${Plus} size=${12}/> Add Non-Operating Row</button>
                    ${renderRow('Net Non-Operating Income (Loss)', 'netNonOp', expNonOp, false, 'pl-4')}
                `}

                <div className="mt-6 border-t-2 border-black pt-2">
                     ${renderRow('Net Income (Loss) before taxes', 'niBefore', expNI, false, 'pl-0 font-bold')}
                     ${renderRow('Income Tax', 'tax', 0, true, 'pl-4')}
                     <div className="border-b-4 border-double border-black mb-1"></div>
                     ${renderRow('Net Income (Loss) after taxes', 'niAfter', expNI, false, 'pl-0 font-bold')}
                </div>
            </div>
        </div>
    `;
};

// --- MAIN EXPORT ---

function Step06FinancialStatements({ ledgerData, adjustments, activityData, data, onChange, showFeedback, isReadOnly }) {
    const { fsFormat, includeCashFlows, businessType, inventorySystem } = activityData.config;
    const isMerch = businessType === 'Merchandising' || businessType === 'Manufacturing';
    const isPerpetual = inventorySystem === 'Perpetual';

    // Calculated totals for validation logic (if needed in main)
    const calculatedTotals = { 
        ...useMemo(() => {
            const s = new Set(Object.keys(ledgerData)); 
            adjustments.forEach(adj => { s.add(adj.drAcc); s.add(adj.crAcc); }); 
            let isDr = 0; let isCr = 0;
            Array.from(s).forEach(acc => {
                const lBal = (ledgerData[acc]?.debit || 0) - (ledgerData[acc]?.credit || 0);
                let aDr = 0; let aCr = 0;
                adjustments.forEach(a => { if(a.drAcc === acc) aDr += a.amount; if(a.crAcc === acc) aCr += a.amount; });
                const atbNet = lBal + (aDr - aCr);
                const atbDr = atbNet > 0 ? atbNet : 0; const atbCr = atbNet < 0 ? Math.abs(atbNet) : 0;
                const type = getAccountType(acc);
                if (type === 'Revenue' || type === 'Expense') { isDr += atbDr; isCr += atbCr; }
            });
            return { isDr, isCr, ledger: ledgerData, adjustments };
        }, [ledgerData, adjustments])
    };

    const handleSCEChange = (newData) => onChange('sce', newData);
    const handleBSChange = (key, val) => onChange('bs', { ...data.bs, [key]: val });
    const handleSCFChange = (key, val) => onChange('scf', { ...data.scf, [key]: val });

    // Derive ending capital from SCE data to pass to Balance Sheet for validation
    const sceEndingCapital = parseUserValue(data.sce?.endCapital);

    // Calculate Banner Results and Get Expected Totals
    const validationResult = useMemo(() => {
        if (!showFeedback && !isReadOnly) return null;
        return validateStep06(ledgerData, adjustments, activityData, data);
    }, [ledgerData, adjustments, activityData, data, showFeedback, isReadOnly]);

    const expectedTotals = validationResult?.expected?.totals;
    // Pass detailed expected data for advanced validation in child components (e.g. Balance Sheet)
    const expectedData = validationResult?.expected; 

    const renderIncomeStatement = () => {
        const currentData = data.is || {};
        const props = {
            data: currentData,
            onChange: (d) => onChange('is', d),
            isReadOnly,
            showFeedback,
            calculatedTotals,
            expectedTotals // Pass expected totals for scoring IS
        };
        
        if (!isMerch) {
            return fsFormat === 'Single' 
                ? html`<${ServiceSingleStepIS} ...${props} />`
                : html`<${ServiceMultiStepIS} ...${props} />`;
        } else {
            return isPerpetual 
                ? html`<${MerchPerpetualIS} type=${fsFormat} ...${props} />`
                : html`<${MerchPeriodicIS} type=${fsFormat} ...${props} />`;
        }
    };

    return html`
        <div className="flex flex-col h-[calc(100vh-140px)]">
            ${(showFeedback || isReadOnly) && validationResult && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${validationResult.score || 0} of ${validationResult.maxScore || 0} - (${validationResult.letterGrade || 'IR'})</span>
                </div>
            `}
            <div className="h-1/2 overflow-hidden border-b-4 border-gray-300 pb-2 bg-white relative">
                <${WorksheetSourceView} ledgerData=${ledgerData} adjustments=${adjustments} />
            </div>
            <div className="h-1/2 overflow-hidden bg-gray-100 p-2">
                <div className="h-full w-full overflow-y-auto">
                    ${includeCashFlows 
                        ? html`
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full min-h-[500px]">
                                <div className="flex flex-col gap-4 h-full">
                                    <div className="flex-1 flex flex-col h-1/2">${renderIncomeStatement()}</div>
                                    <div className="flex-1 flex flex-col h-1/2">
                                        <${StatementOfChangesInEquity} data=${data.sce} onChange=${handleSCEChange} isReadOnly=${isReadOnly} showFeedback=${showFeedback} calculatedTotals=${calculatedTotals} activityData=${activityData} expectedTotals=${expectedTotals}/>
                                    </div>
                                </div>
                                <div className="h-full">
                                    <${BalanceSheet} data=${data.bs} onChange=${(d)=>onChange('bs', d)} isReadOnly=${isReadOnly} showFeedback=${showFeedback} sceEndingCapital=${sceEndingCapital} expectedTotals=${expectedTotals} expectedData=${expectedData}/>
                                </div>
                                <div className="h-full">
                                    <${FinancialStatementForm} title="Statement of Cash Flows" headerColor="bg-indigo-100" data=${data.scf} onChange=${(k, v) => handleSCFChange(k, v)} isReadOnly=${isReadOnly} />
                                </div>
                            </div>
                        ` 
                        : html`
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full min-h-[400px]">
                                <div className="h-full">${renderIncomeStatement()}</div>
                                <div className="h-full">
                                    <${StatementOfChangesInEquity} data=${data.sce} onChange=${handleSCEChange} isReadOnly=${isReadOnly} showFeedback=${showFeedback} calculatedTotals=${calculatedTotals} activityData=${activityData} expectedTotals=${expectedTotals}/>
                                </div>
                                <div className="h-full">
                                    <${BalanceSheet} data=${data.bs} onChange=${(d)=>onChange('bs', d)} isReadOnly=${isReadOnly} showFeedback=${showFeedback} sceEndingCapital=${sceEndingCapital} expectedTotals=${expectedTotals} expectedData=${expectedData}/>
                                </div>
                            </div>
                        `
                    }
                </div>
            </div>
        </div>
    `;
}


// --- Step07AdjustingEntries.js ---





const html = htm.bind(React.createElement);

// --- HELPER: DRY VALIDATION LOGIC ---
const validateStep07 = (arg1, arg2, arg3, arg4) => {
    // 1. Adapter for arguments to handle different calling signatures from App.js vs Internal
    let activityData, journalData, ledgerData;

    // Check if arg1 is activityData object (contains 'transactions' or 'adjustments' as full array)
    if (arg1 && (arg1.transactions || (arg1.adjustments && !Array.isArray(arg1)))) {
        activityData = arg1;
        journalData = arg2;
        ledgerData = arg3;
    } else {
        // Legacy/App.js signature: (adjustments, journalData, ledgerData, transactions)
        // We construct a fallback activityData
        const transactions = arg4 || [];
        const adjustments = arg1 || [];
        
        // Derive validAccounts for scoring iteration
        const accs = new Set();
        transactions.forEach(t => {
            t.debits.forEach(d => accs.add(d.account));
            t.credits.forEach(c => accs.add(c.account));
        });
        adjustments.forEach(a => {
            accs.add(a.drAcc);
            accs.add(a.crAcc);
        });

        activityData = {
            adjustments,
            transactions,
            beginningBalances: null, // Fallback
            config: {}, // Fallback
            validAccounts: Array.from(accs)
        };
        journalData = arg2;
        ledgerData = arg3;
    }

    const { adjustments, transactions, beginningBalances, config, validAccounts } = activityData;
    
    // 2. Determine Correct Date
    const baseDate = transactions.length > 0 ? new Date(transactions[0].date) : new Date();
    const year = baseDate.getFullYear().toString();
    const month = baseDate.getMonth();
    const lastDayOfMonth = new Date(year, month + 1, 0).getDate().toString();

    let score = 0;
    let maxScore = 0;
    const fieldStatus = {}; 

    // Helper: Check if matching row exists in ledger
    const findMatchingRow = (accName, side, date, amt) => {
        if (!accName || !ledgerData[accName]) return false;
        const rows = side === 'dr' ? (ledgerData[accName].leftRows || []) : (ledgerData[accName].rightRows || []);
        
        return rows.some(r => {
            const rAmt = Number(r.amount);
            const matchAmt = Math.abs(rAmt - amt) <= 1;
            const matchDate = (r.date || '').trim() === date;
            return matchAmt && matchDate;
        });
    };

    // A. Journal & Posting Validation
    adjustments.forEach(adj => {
        const entry = journalData[adj.id] || {};

        // 1. Journal Debit (4 pts)
        const drDateCorrect = (entry.drDate || '').trim() === lastDayOfMonth;
        const drAccCorrect = (entry.drAcc || '').toLowerCase() === adj.drAcc.toLowerCase();
        const drAmtCorrect = Math.abs(Number(entry.drAmt) - adj.amount) <= 1;
        
        const drPostedRowFound = findMatchingRow(adj.drAcc, 'dr', lastDayOfMonth, adj.amount);
        const drPrCorrect = entry.drPR === true && drPostedRowFound;

        if (drDateCorrect) score++;
        if (drAccCorrect) score++;
        if (drAmtCorrect) score++;
        if (drPrCorrect) score++;
        maxScore += 4;

        // 2. Journal Credit (3 pts - No Date)
        const crAccCorrect = (entry.crAcc || '').toLowerCase() === adj.crAcc.toLowerCase();
        const crAmtCorrect = Math.abs(Number(entry.crAmt) - adj.amount) <= 1;
        const crPostedRowFound = findMatchingRow(adj.crAcc, 'cr', lastDayOfMonth, adj.amount);
        const crPrCorrect = entry.crPR === true && crPostedRowFound;

        if (crAccCorrect) score++;
        if (crAmtCorrect) score++;
        if (crPrCorrect) score++;
        maxScore += 3;

        // 3. Ledger Posting Score (Double counting logic as requested)
        if (drPostedRowFound) score += 4;
        maxScore += 4;

        if (crPostedRowFound) score += 3;
        maxScore += 3;
        
        fieldStatus[`${adj.id}-dr-date`] = drDateCorrect;
        fieldStatus[`${adj.id}-dr-acc`] = drAccCorrect;
        fieldStatus[`${adj.id}-dr-amt`] = drAmtCorrect;
        fieldStatus[`${adj.id}-dr-pr`] = drPrCorrect;
        fieldStatus[`${adj.id}-cr-acc`] = crAccCorrect;
        fieldStatus[`${adj.id}-cr-amt`] = crAmtCorrect;
        fieldStatus[`${adj.id}-cr-pr`] = crPrCorrect;
    });

    // Determine New vs Historical Accounts
    const adjAccounts = new Set();
    adjustments.forEach(a => { adjAccounts.add(a.drAcc); adjAccounts.add(a.crAcc); });
    const historicalAccounts = new Set(validAccounts);
    // Accounts in adjustments that are NOT in original transactions/balances are "New"
    // Note: validAccounts usually includes all involved accounts. We check against the original set if possible.
    // If constructed from fallback, this distinction might be weak, but functional.
    const newLedgerAccounts = [...adjAccounts].filter(acc => !historicalAccounts.has(acc));
    
    // B. New Ledger Year Entry (1 pt each)
    // Note: In fallback mode, validAccounts derived from adj includes adj accounts, so newLedgerAccounts might be empty.
    // We rely on 'ledgerData.addedAccounts' list if available or check manually added props.
    // Enhanced check: Check if user added yearInput for any account
    const allRelevantAccounts = new Set([...validAccounts, ...adjAccounts]);
    
    allRelevantAccounts.forEach(acc => {
        const u = ledgerData[acc] || {};
        // If this account has a 'yearInput' field (meaning it was treated as new by UI), validate it
        if (u.yearInput !== undefined) {
             if ((u.yearInput || '').trim() === year) score++;
             maxScore += 1;
        }
    });

    // C. Ledger Totals & Balance (3 pts each)
    allRelevantAccounts.forEach(acc => {
        // Calculate Expected
        let bbDr = 0, bbCr = 0;
        if (config.isSubsequentYear && beginningBalances?.balances[acc]) {
            bbDr = beginningBalances.balances[acc].dr;
            bbCr = beginningBalances.balances[acc].cr;
        }
        let transDr = 0, transCr = 0;
        transactions.forEach(t => {
            t.debits.forEach(d => { if(d.account === acc) transDr += d.amount; });
            t.credits.forEach(c => { if(c.account === acc) transCr += c.amount; });
        });
        let adjDr = 0, adjCr = 0;
        adjustments.forEach(a => {
            if (a.drAcc === acc) adjDr += a.amount;
            if (a.crAcc === acc) adjCr += a.amount;
        });
        const expTotalDr = bbDr + transDr + adjDr;
        const expTotalCr = bbCr + transCr + adjCr;
        const net = expTotalDr - expTotalCr;
        const expBal = Math.abs(net);
        const expType = net >= 0 ? 'Dr' : 'Cr';

        // Check User Inputs
        const u = ledgerData[acc] || {};
        const uDrTotal = Number(u.drTotal || 0);
        const uCrTotal = Number(u.crTotal || 0);
        const uBal = Number(u.balance || 0);
        const uType = u.balanceType;

        if (Math.abs(uDrTotal - expTotalDr) <= 1) score++;
        if (Math.abs(uCrTotal - expTotalCr) <= 1) score++;
        if (Math.abs(uBal - expBal) <= 1 && (uType === expType || expBal === 0)) score++;
        
        maxScore += 3;
    });

    const letterGrade = getLetterGrade(score, maxScore);

    return { score, maxScore, letterGrade, fieldStatus, lastDayOfMonth, year };
};


const StatusIcon = ({ isCorrect, show }) => {
    if (!show) return null;
    return isCorrect 
        ? html`<${Check} size=${14} className="text-green-600 inline ml-1" />` 
        : html`<${X} size=${14} className="text-red-600 inline ml-1" />`;
};

// --- LEFT PANEL: JOURNAL COMPONENTS ---

const HistoricalJournalView = ({ transactions }) => {
    const [expanded, setExpanded] = useState(false);
    
    return html`
        <div className="mb-4 border rounded bg-white overflow-hidden shadow-sm flex flex-col">
            <div className="bg-gray-100 p-2 font-bold text-gray-700 cursor-pointer flex justify-between items-center flex-shrink-0" onClick=${()=>setExpanded(!expanded)}>
                <div className="flex items-center">
                    <${Book} size=${16} className="inline mr-2 w-4 h-4"/>
                    <span>Historical Journal Entries (Read-Only)</span>
                </div>
                <div className="flex items-center gap-2 text-xs font-normal">
                    ${expanded ? 'Click to Collapse' : 'Click to View'}
                    ${expanded ? html`<${ChevronDown} size=${16} className="w-4 h-4"/>` : html`<${ChevronRight} size=${16} className="w-4 h-4"/>`}
                </div>
            </div>
            ${expanded && html`
                <div className="h-64 flex flex-col overflow-hidden border-t border-gray-200">
                    <div className="flex bg-gray-50 text-gray-700 border-b border-gray-300 font-bold text-xs text-center flex-shrink-0">
                        <div className="w-16 border-r p-2 flex-shrink-0">Date</div>
                        <div className="flex-1 border-r p-2 text-left">Account Titles and Explanation</div>
                        <div className="w-16 border-r p-2 flex-shrink-0">P.R.</div>
                        <div className="w-24 border-r p-2 text-right flex-shrink-0">Debit</div>
                        <div className="w-24 p-2 text-right flex-shrink-0">Credit</div>
                    </div>
                    <div className="overflow-y-auto flex-1 bg-white">
                        ${transactions.map((t, tIdx) => {
                            const txnDate = new Date(t.date);
                            const yyyy = txnDate.getFullYear();
                            const mm = txnDate.toLocaleString('default', { month: 'short' });
                            const dd = txnDate.getDate().toString().padStart(2, '0');
                            const isFirst = tIdx === 0;
                            const dateDisplay = isFirst ? `${mm} ${dd}` : dd;

                            return html`
                                <React.Fragment key=${t.id}>
                                    ${isFirst && html`
                                        <div className="flex border-b border-gray-100 text-xs h-8 items-center text-gray-500">
                                            <div className="w-16 border-r text-right pr-1 font-bold flex-shrink-0">${yyyy}</div>
                                            <div className="flex-1 border-r"></div>
                                            <div className="w-16 border-r flex-shrink-0"></div>
                                            <div className="w-24 border-r flex-shrink-0"></div>
                                            <div className="w-24 flex-shrink-0"></div>
                                        </div>
                                    `}
                                    
                                    ${t.debits.map((d, i) => html`
                                        <div key=${`dr-${t.id}-${i}`} className="flex border-b border-gray-100 text-xs h-8 items-center hover:bg-gray-50">
                                            <div className="w-16 border-r text-right pr-1 flex-shrink-0 text-gray-500">${i === 0 ? dateDisplay : ''}</div>
                                            <div className="flex-1 border-r pl-1 font-medium text-gray-800 truncate" title=${d.account}>${d.account}</div>
                                            <div className="w-16 border-r text-center flex justify-center items-center flex-shrink-0 text-gray-400">1</div>
                                            <div className="w-24 border-r text-right pr-1 flex-shrink-0 text-gray-800">${d.amount.toLocaleString()}</div>
                                            <div className="w-24 text-right pr-1 flex-shrink-0"></div>
                                        </div>
                                    `)}
                                    
                                    ${t.credits.map((c, i) => html`
                                        <div key=${`cr-${t.id}-${i}`} className="flex border-b border-gray-100 text-xs h-8 items-center hover:bg-gray-50">
                                            <div className="w-16 border-r flex-shrink-0"></div>
                                            <div className="flex-1 border-r pl-6 text-gray-800 truncate" title=${c.account}>${c.account}</div>
                                            <div className="w-16 border-r text-center flex justify-center items-center flex-shrink-0 text-gray-400">1</div>
                                            <div className="w-24 border-r flex-shrink-0"></div>
                                            <div className="w-24 text-right pr-1 flex-shrink-0 text-gray-800">${c.amount.toLocaleString()}</div>
                                        </div>
                                    `)}
                                    
                                    <div key=${'desc' + t.id} className="flex border-b border-gray-200 text-xs h-8 items-center text-gray-500 italic bg-gray-50/50">
                                        <div className="w-16 border-r flex-shrink-0"></div>
                                        <div className="flex-1 border-r pl-8 truncate" title=${t.description}>(${t.description})</div>
                                        <div className="w-16 border-r flex-shrink-0"></div>
                                        <div className="w-24 border-r flex-shrink-0"></div>
                                        <div className="w-24 flex-shrink-0"></div>
                                    </div>
                                </React.Fragment>
                            `;
                        })}
                        <div className="h-8"></div>
                    </div>
                </div>
            `}
        </div>
    `;
};

const AdjustmentEntryForm = ({ adjustments, data, onChange, isReadOnly, showFeedback, validationResult }) => {
    const handleChange = (adjId, field, val) => {
        const current = data[adjId] || {};
        onChange(adjId, { ...current, [field]: val });
    };

    const { fieldStatus, year } = validationResult || {};

    return html`
        <div className="border rounded bg-white shadow-sm flex flex-col flex-1 min-h-0">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 border-b flex items-center">
                <${Book} size=${16} className="inline mr-2 w-4 h-4"/>
                Journalize Adjusting Entries (${year})
            </div>
            <div className="overflow-y-auto p-2 flex-1">
                ${adjustments.map((adj, idx) => {
                    const entry = data[adj.id] || {};
                    
                    const drDateOk = fieldStatus?.[`${adj.id}-dr-date`];
                    const drAccOk = fieldStatus?.[`${adj.id}-dr-acc`];
                    const drAmtOk = fieldStatus?.[`${adj.id}-dr-amt`];
                    const drPrOk = fieldStatus?.[`${adj.id}-dr-pr`];

                    const crAccOk = fieldStatus?.[`${adj.id}-cr-acc`];
                    const crAmtOk = fieldStatus?.[`${adj.id}-cr-amt`];
                    const crPrOk = fieldStatus?.[`${adj.id}-cr-pr`];

                    const inputClass = (isOk) => `w-full h-full p-1 outline-none text-sm ${showFeedback && !isOk ? 'bg-red-50' : ''}`;

                    return html`
                        <div key=${adj.id} className="mb-4 border border-blue-200 rounded overflow-hidden">
                            <div className="bg-blue-50 px-2 py-1 text-xs font-bold text-blue-800 border-b border-blue-200">AJE #${idx + 1}</div>
                            
                            <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-600 text-center">
                                <div className="w-14 border-r p-1">Date</div>
                                <div className="flex-1 border-r p-1">Account Title</div>
                                <div className="w-8 border-r p-1">PR</div>
                                <div className="w-24 border-r p-1">Debit</div>
                                <div className="w-24 p-1">Credit</div>
                            </div>

                            <div className="flex border-b border-gray-100 h-8">
                                <div className="w-14 border-r relative">
                                    <input type="text" className=${inputClass(drDateOk) + " text-center"} placeholder="dd" value=${entry.drDate || ''} onChange=${(e) => handleChange(adj.id, 'drDate', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute top-0 right-0"><${StatusIcon} show=${showFeedback} isCorrect=${drDateOk}/></div>
                                </div>
                                <div className="flex-1 border-r relative">
                                    <input type="text" className=${inputClass(drAccOk)} placeholder="Debit Account" value=${entry.drAcc || ''} onChange=${(e) => handleChange(adj.id, 'drAcc', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute top-1 right-1"><${StatusIcon} show=${showFeedback} isCorrect=${drAccOk}/></div>
                                </div>
                                <div className="w-8 border-r flex justify-center items-center bg-white relative">
                                    <input type="checkbox" className="w-4 h-4 cursor-pointer" checked=${entry.drPR || false} onChange=${(e) => handleChange(adj.id, 'drPR', e.target.checked)} disabled=${isReadOnly}/>
                                    <div className="absolute top-0 right-0 pointer-events-none"><${StatusIcon} show=${showFeedback} isCorrect=${drPrOk}/></div>
                                </div>
                                <div className="w-24 border-r relative">
                                    <input type="number" className=${inputClass(drAmtOk) + " text-right"} placeholder="Debit" value=${entry.drAmt || ''} onChange=${(e) => handleChange(adj.id, 'drAmt', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute top-0 right-0"><${StatusIcon} show=${showFeedback} isCorrect=${drAmtOk}/></div>
                                </div>
                                <div className="w-24 bg-gray-50"></div>
                            </div>

                            <div className="flex border-b border-gray-100 h-8">
                                <div className="w-14 border-r relative bg-gray-50">
                                    <input type="text" className="w-full h-full bg-gray-50 outline-none" disabled value="" />
                                </div>
                                <div className="flex-1 border-r relative pl-6">
                                    <input type="text" className=${inputClass(crAccOk)} placeholder="Credit Account" value=${entry.crAcc || ''} onChange=${(e) => handleChange(adj.id, 'crAcc', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute top-1 right-1"><${StatusIcon} show=${showFeedback} isCorrect=${crAccOk}/></div>
                                </div>
                                <div className="w-8 border-r flex justify-center items-center bg-white relative">
                                    <input type="checkbox" className="w-4 h-4 cursor-pointer" checked=${entry.crPR || false} onChange=${(e) => handleChange(adj.id, 'crPR', e.target.checked)} disabled=${isReadOnly}/>
                                    <div className="absolute top-0 right-0 pointer-events-none"><${StatusIcon} show=${showFeedback} isCorrect=${crPrOk}/></div>
                                </div>
                                <div className="w-24 border-r bg-gray-50"></div>
                                <div className="w-24 relative">
                                    <input type="number" className=${inputClass(crAmtOk) + " text-right"} placeholder="Credit" value=${entry.crAmt || ''} onChange=${(e) => handleChange(adj.id, 'crAmt', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute top-0 right-0"><${StatusIcon} show=${showFeedback} isCorrect=${crAmtOk}/></div>
                                </div>
                            </div>

                            <div className="flex bg-gray-50 text-gray-500 italic text-xs">
                                <div className="w-14 border-r"></div>
                                <div className="flex-1 p-1 pl-8">(${adj.desc})</div>
                            </div>
                        </div>
                    `;
                })}
            </div>
        </div>
    `;
};

// --- RIGHT PANEL: LEDGER COMPONENTS ---

const LedgerAccountAdj = ({ accName, transactions, startingBalance, userLedger, onUpdate, isReadOnly, showFeedback, correctEndingValues, contextYear, isNewAccount }) => {
    // 1. Prepare Data Rows
    const leftRows = [];
    const rightRows = [];

    // Beg Bal (Only for historical accounts)
    if (startingBalance) {
        if (startingBalance.dr > 0) leftRows.push({ date: 'Jan 01', item: 'Bal', pr: '', amount: startingBalance.dr, isLocked: true });
        if (startingBalance.cr > 0) rightRows.push({ date: 'Jan 01', item: 'Bal', pr: '', amount: startingBalance.cr, isLocked: true });
    }

    // Historical Transactions
    transactions.forEach(t => {
        const dateObj = new Date(t.date);
        const mm = dateObj.toLocaleString('default', { month: 'short' });
        const dd = dateObj.getDate().toString().padStart(2, '0');
        const dateStr = `${mm} ${dd}`;

        t.debits.forEach(d => { if(d.account === accName) leftRows.push({ date: dateStr, item: 'GJ', pr: '1', amount: d.amount, isLocked: true }); });
        t.credits.forEach(c => { if(c.account === accName) rightRows.push({ date: dateStr, item: 'GJ', pr: '1', amount: c.amount, isLocked: true }); });
    });

    const userLeft = userLedger?.leftRows || [];
    const userRight = userLedger?.rightRows || [];

    const finalLeft = [...leftRows, ...userLeft];
    const finalRight = [...rightRows, ...userRight];
    
    // VISUAL ROWS MAPPING
    const maxDataRows = Math.max(finalLeft.length, finalRight.length, 4);
    const displayRowsCount = maxDataRows + 1; // +1 for Year Row
    const displayRows = Array.from({length: displayRowsCount}).map((_, i) => i);

    const updateSide = (side, visualIdx, field, val) => {
        // Visual Index 0 is Year Row
        if (visualIdx === 0) {
            if (isNewAccount && side === 'left') { // Store year in userLedger root or special field
                onUpdate({ ...userLedger, yearInput: val });
            }
            return;
        }

        const dataIdx = visualIdx - 1; 
        const histLen = side === 'left' ? leftRows.length : rightRows.length;
        if (dataIdx < histLen) return; 

        const userIdx = dataIdx - histLen;
        const currentArr = side === 'left' ? userLeft : userRight;
        const newArr = [...currentArr];
        if (!newArr[userIdx]) newArr[userIdx] = {}; 
        newArr[userIdx] = { ...newArr[userIdx], [field]: val };
        
        onUpdate({ 
            ...userLedger, 
            [side === 'left' ? 'leftRows' : 'rightRows']: newArr 
        });
    };

    const addCombinedRow = () => {
        onUpdate({ 
            ...userLedger, 
            leftRows: [...userLeft, { date: '', item: 'Adj', pr: '', amount: '' }],
            rightRows: [...userRight, { date: '', item: 'Adj', pr: '', amount: '' }]
        });
    };

    const deleteCombinedRow = (visualIdx) => {
         if (visualIdx === 0) return;
         const dataIdx = visualIdx - 1;
         
         const histLenLeft = leftRows.length;
         const histLenRight = rightRows.length;
         
         // Adjusting entries step usually appends to existing. Historical rows are at top.
         // So if dataIdx >= max(histLenLeft, histLenRight), it is safe.
         if (dataIdx < Math.max(histLenLeft, histLenRight)) return;

         const userIdxLeft = dataIdx - histLenLeft;
         const userIdxRight = dataIdx - histLenRight;

         const newLeft = [...userLeft];
         const newRight = [...userRight];

         // Remove if index exists in user array
         if (userIdxLeft >= 0 && userIdxLeft < newLeft.length) newLeft.splice(userIdxLeft, 1);
         if (userIdxRight >= 0 && userIdxRight < newRight.length) newRight.splice(userIdxRight, 1);

         onUpdate({
             ...userLedger,
             leftRows: newLeft,
             rightRows: newRight
         });
    };
    
    const getCellProps = (side, visualIdx) => {
        if (visualIdx === 0) {
            // Year Row
            return {
                isYearRow: true,
                date: isNewAccount ? (userLedger.yearInput || '') : contextYear, // Editable if new
                item: '', pr: '', amount: '',
                isUser: isNewAccount, 
                isLocked: !isNewAccount
            };
        }

        const dataIdx = visualIdx - 1;
        const dataArr = side === 'left' ? finalLeft : finalRight;
        const row = dataArr[dataIdx];
        const isUser = side === 'left' ? dataIdx >= leftRows.length : dataIdx >= rightRows.length;

        if (!row) {
            return { isYearRow: false, date: '', item: '', pr: '', amount: '', isUser: isUser, isLocked: !isUser };
        }

        let displayDate = row.date || '';
        if (visualIdx === 1) {
            // First Data Row: "Mmm dd"
        } else {
            // Subsequent: "dd"
            if (row.isLocked && displayDate.includes(' ')) {
                displayDate = displayDate.split(' ')[1];
            }
        }

        return {
            isYearRow: false,
            date: displayDate,
            item: row.item,
            pr: row.pr,
            amount: row.amount,
            isUser: isUser,
            isLocked: row.isLocked
        };
    };

    return html`
        <div className="border-2 border-gray-800 bg-white shadow-md mb-6">
            <div className="border-b-2 border-gray-800 p-2 flex justify-between bg-gray-100 relative">
                <div className="absolute left-2 top-2"><${StatusIcon} show=${showFeedback} isCorrect=${
                    Math.abs(Number(userLedger?.balance || 0) - correctEndingValues.endBal) <= 1 &&
                    (userLedger?.balanceType === correctEndingValues.balType || correctEndingValues.endBal === 0)
                } /></div>
                <div className="w-full text-center mx-8 font-bold text-lg">${accName}</div>
            </div>
            
            <div className="flex">
                <!-- DEBIT SIDE -->
                <div className="flex-1 border-r-2 border-gray-800">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">DEBIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400">
                        <div className="w-14 border-r p-1 text-center">Date</div>
                        <div className="flex-1 border-r p-1 text-center">Particulars</div>
                        <div className="w-8 border-r p-1 text-center">PR</div>
                        <div className="w-16 p-1 text-center">Amount</div>
                    </div>
                    ${displayRows.map(i => {
                        const props = getCellProps('left', i);
                        const isRowDisabled = props.isLocked; // Year row is editable if isNewAccount
                        const datePlaceholder = i === 0 ? "YYYY" : (i === 1 ? "Mmm dd" : "dd");

                        return html`
                            <div key=${`l-${i}`} className="flex text-xs border-b border-gray-200 h-6 relative ${!props.isUser && !props.isYearRow && props.date ? 'bg-gray-50/50 text-gray-600' : ''}">
                                <div className="w-14 border-r relative"><input type="text" className="w-full h-full text-center px-1 outline-none bg-transparent" placeholder=${datePlaceholder} value=${props.date} onChange=${(e)=>updateSide('left', i, 'date', e.target.value)} disabled=${isRowDisabled}/></div>
                                <div className="flex-1 border-r relative"><input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${props.item||''} onChange=${(e)=>updateSide('left', i, 'item', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-8 border-r relative"><input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${props.pr||''} onChange=${(e)=>updateSide('left', i, 'pr', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-16 relative"><input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${props.amount||''} onChange=${(e)=>updateSide('left', i, 'amount', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50"><span className="text-xs font-bold">Total Debit</span><input type="number" className="w-20 text-right border border-gray-300 bg-white" value=${userLedger?.drTotal||''} onChange=${(e)=>onUpdate({...userLedger, drTotal: e.target.value})} disabled=${isReadOnly} /></div>
                </div>

                <!-- CREDIT SIDE -->
                <div className="flex-1">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">CREDIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400">
                        <div className="w-14 border-r p-1 text-center">Date</div>
                        <div className="flex-1 border-r p-1 text-center">Particulars</div>
                        <div className="w-8 border-r p-1 text-center">PR</div>
                        <div className="w-16 p-1 text-center">Amount</div>
                        <div className="w-6"></div>
                    </div>
                    ${displayRows.map(i => {
                        const props = getCellProps('right', i);
                        const isRowDisabled = props.isLocked;
                        const datePlaceholder = i === 0 ? "YYYY" : (i === 1 ? "Mmm dd" : "dd");
                        
                        // Check if row is deletable (user row and not year row)
                        const isDeletable = props.isUser && !isReadOnly && !props.isYearRow;

                        return html`
                            <div key=${`r-${i}`} className="flex text-xs border-b border-gray-200 h-6 relative ${!props.isUser && !props.isYearRow && props.date ? 'bg-gray-50/50 text-gray-600' : ''}">
                                <div className="w-14 border-r relative"><input type="text" className="w-full h-full text-center px-1 outline-none bg-transparent" placeholder=${datePlaceholder} value=${props.date} onChange=${(e)=>updateSide('right', i, 'date', e.target.value)} disabled=${isRowDisabled}/></div>
                                <div className="flex-1 border-r relative"><input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${props.item||''} onChange=${(e)=>updateSide('right', i, 'item', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-8 border-r relative"><input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${props.pr||''} onChange=${(e)=>updateSide('right', i, 'pr', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-16 relative"><input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${props.amount||''} onChange=${(e)=>updateSide('right', i, 'amount', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-6 flex justify-center items-center">
                                    ${isDeletable && html`<button onClick=${()=>deleteCombinedRow(i)} class="text-red-400 hover:text-red-600"><${Trash2} size=${10}/></button>`}
                                </div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50"><span className="text-xs font-bold">Total Credit</span><input type="number" className="w-20 text-right border border-gray-300 bg-white" value=${userLedger?.crTotal||''} onChange=${(e)=>onUpdate({...userLedger, crTotal: e.target.value})} disabled=${isReadOnly} /></div>
                </div>
            </div>
            
            ${!isReadOnly && html`<button onClick=${addCombinedRow} className="w-full text-center text-[10px] text-blue-600 hover:bg-blue-50 py-1 border-b border-gray-200 bg-gray-50"><${Plus} size=${10} className="inline"/> Add Row (Dr/Cr)</button>`}

            <div className="border-t border-gray-300 p-2 bg-gray-100 flex justify-center items-center gap-2">
                <span className="text-xs font-bold uppercase text-gray-600">Balance:</span>
                <select className="border border-gray-300 rounded text-xs p-1 outline-none bg-white" value=${userLedger?.balanceType || ''} onChange=${(e)=>onUpdate({...userLedger, balanceType: e.target.value})} disabled=${isReadOnly}><option value="" disabled>Type</option><option value="Dr">Debit</option><option value="Cr">Credit</option></select>
                <input type="number" className="w-32 text-center border-b-2 border-double border-black bg-white font-bold text-sm outline-none" placeholder="0" value=${userLedger?.balance||''} onChange=${(e)=>onUpdate({...userLedger, balance: e.target.value})} disabled=${isReadOnly} />
            </div>
        </div>
    `;
};

const LedgerPanel = ({ activityData, ledgerData, onChange, isReadOnly, showFeedback, validationResult }) => {
    const { validAccounts, transactions, beginningBalances, config } = activityData;
    const sortedAccounts = sortAccounts(validAccounts);
    const { year } = validationResult || {};
    
    const [isAdding, setIsAdding] = useState(false);
    const [newAccName, setNewAccName] = useState('');

    // Ensure addedAccounts is always an array
    const addedAccounts = useMemo(() => {
        return (ledgerData.addedAccounts || []);
    }, [ledgerData.addedAccounts]);

    const handleAddAccount = () => {
        if (!newAccName.trim()) return;
        const name = newAccName.trim();
        if (validAccounts.includes(name) || addedAccounts.includes(name)) {
            alert('Account already exists.');
            return;
        }
        
        const newAdded = [...addedAccounts, name];
        // Initialize with 2 empty rows per side as requested
        const initialLedger = {
            leftRows: [{}, {}], 
            rightRows: [{}, {}]
        };
        
        onChange(name, initialLedger); 
        onChange('addedAccounts', newAdded);
        
        setNewAccName('');
        setIsAdding(false);
    };

    const allAccountsToRender = [...sortedAccounts, ...addedAccounts];

    return html`
        <div className="h-full flex flex-col">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 border-b border-blue-200 flex items-center justify-between">
                <div className="flex items-center"><${Table} size=${16} className="inline mr-2 w-4 h-4"/> General Ledger (Adjusted)</div>
                ${!isReadOnly && html`
                    <button onClick=${() => setIsAdding(true)} className="bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700 flex items-center"><${Plus} size=${12} className="mr-1"/> Add Ledger</button>
                `}
            </div>

            ${isAdding && html`
                <div className="p-2 bg-blue-50 border-b border-blue-200 flex gap-2">
                    <input type="text" className="flex-1 border rounded px-2 py-1 text-sm" placeholder="Enter Account Name" value=${newAccName} onChange=${(e)=>setNewAccName(e.target.value)} />
                    <button onClick=${handleAddAccount} className="bg-green-600 text-white text-xs px-3 py-1 rounded hover:bg-green-700">Add</button>
                    <button onClick=${() => setIsAdding(false)} className="bg-gray-400 text-white text-xs px-3 py-1 rounded hover:bg-gray-500">Cancel</button>
                </div>
            `}

            <div className="overflow-y-auto p-4 flex-1 bg-gray-50 custom-scrollbar">
                ${allAccountsToRender.map(acc => {
                    const isNew = !validAccounts.includes(acc);
                    
                    // Calculate Correct Ending Values
                    let bbDr = 0, bbCr = 0;
                    if (!isNew && config.isSubsequentYear && beginningBalances?.balances[acc]) {
                        bbDr = beginningBalances.balances[acc].dr;
                        bbCr = beginningBalances.balances[acc].cr;
                    }
                    let transDr = 0, transCr = 0;
                    transactions.forEach(t => {
                        t.debits.forEach(d => { if(d.account === acc) transDr += d.amount; });
                        t.credits.forEach(c => { if(c.account === acc) transCr += c.amount; });
                    });
                    let adjDr = 0, adjCr = 0;
                    activityData.adjustments.forEach(a => {
                        if (a.drAcc === acc) adjDr += a.amount;
                        if (a.crAcc === acc) adjCr += a.amount;
                    });
                    const totalDr = bbDr + transDr + adjDr;
                    const totalCr = bbCr + transCr + adjCr;
                    const endBal = totalDr - totalCr;
                    
                    const correctEndingValues = {
                        adjDr, adjCr,
                        endBal: Math.abs(endBal),
                        balType: endBal >= 0 ? 'Dr' : 'Cr'
                    };

                    return html`
                        <${LedgerAccountAdj} 
                            key=${acc} 
                            accName=${acc} 
                            transactions=${transactions}
                            startingBalance={config.isSubsequentYear && beginningBalances ? beginningBalances.balances[acc] : null}
                            userLedger=${ledgerData[acc] || {}}
                            onUpdate=${(val) => onChange(acc, val)}
                            isReadOnly=${isReadOnly}
                            showFeedback=${showFeedback}
                            correctEndingValues=${correctEndingValues}
                            contextYear=${year}
                            isNewAccount=${isNew}
                        />
                    `;
                })}
            </div>
        </div>
    `;
};


// --- MAIN EXPORT ---

function Step07AdjustingEntries({ activityData, data, onChange, showFeedback, isReadOnly }) {
    const journalData = data.journal || {};
    const ledgerData = data.ledger || {};

    const validationResult = useMemo(() => {
        return validateStep07(activityData, journalData, ledgerData);
    }, [activityData, journalData, ledgerData]);

    const handleJournalChange = (id, val) => {
        onChange('journal', { ...journalData, [id]: val });
    };

    const handleLedgerChange = (acc, val) => {
        // If acc is 'addedAccounts', we update that specific key in the ledger object
        onChange('ledger', { ...ledgerData, [acc]: val });
    };

    return html`
        <div className="flex flex-col h-[calc(100vh-140px)]">
            <!-- VALIDATION BANNER -->
            ${(showFeedback || isReadOnly) && validationResult && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${validationResult.score || 0} of ${validationResult.maxScore || 0} - (${validationResult.letterGrade || 'IR'})</span>
                </div>
            `}

            <div className="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                <div className="flex-1 lg:w-5/12 flex flex-col gap-4 min-h-0">
                    <${HistoricalJournalView} transactions=${activityData.transactions} />
                    <${AdjustmentEntryForm} 
                        adjustments=${activityData.adjustments} 
                        data=${journalData} 
                        onChange=${handleJournalChange} 
                        isReadOnly=${isReadOnly} 
                        showFeedback=${showFeedback}
                        validationResult=${validationResult}
                    />
                </div>
                <div className="flex-1 lg:w-7/12 min-h-0 border rounded bg-white shadow-sm flex flex-col overflow-hidden">
                    <${LedgerPanel} 
                        activityData=${activityData} 
                        ledgerData=${ledgerData} 
                        onChange=${handleLedgerChange} 
                        isReadOnly=${isReadOnly} 
                        showFeedback=${showFeedback}
                        validationResult=${validationResult}
                    />
                </div>
            </div>
        </div>
    `;
}


// --- Step08ClosingEntries.js ---





const html = htm.bind(React.createElement);

// --- HELPER: Status Icon ---
const StatusIcon = ({ isCorrect, show }) => {
    if (!show || isCorrect === undefined) return null;
    return isCorrect 
        ? html`<${Check} size=${14} className="text-green-600 inline ml-1" />` 
        : html`<${X} size=${14} className="text-red-600 inline ml-1" />`;
};

// --- COMPONENT: Worksheet Source View (Read-Only) ---
const WorksheetSourceView = ({ ledgerData, adjustments }) => {
    const mergedAccounts = useMemo(() => { 
        const s = new Set(Object.keys(ledgerData)); 
        adjustments.forEach(adj => { s.add(adj.drAcc); s.add(adj.crAcc); }); 
        return sortAccounts(Array.from(s)); 
    }, [ledgerData, adjustments]);

    const data = useMemo(() => {
        return mergedAccounts.map(acc => {
            const ledgerBal = (ledgerData[acc]?.debit || 0) - (ledgerData[acc]?.credit || 0);
            const tbDr = ledgerBal > 0 ? ledgerBal : 0; const tbCr = ledgerBal < 0 ? Math.abs(ledgerBal) : 0;
            let aDr = 0; let aCr = 0;
            adjustments.forEach(a => { if(a.drAcc === acc) aDr += a.amount; if(a.crAcc === acc) aCr += a.amount; });
            const atbNet = (tbDr - tbCr) + (aDr - aCr);
            const atbDr = atbNet > 0 ? atbNet : 0; const atbCr = atbNet < 0 ? Math.abs(atbNet) : 0;
            const type = getAccountType(acc); const isIS = type === 'Revenue' || type === 'Expense';
            const isDr = isIS ? atbDr : 0; const isCr = isIS ? atbCr : 0; 
            const bsDr = !isIS ? atbDr : 0; const bsCr = !isIS ? atbCr : 0;
            return { acc, tbDr, tbCr, adjDr: aDr, adjCr: aCr, atbDr, atbCr, isDr, isCr, bsDr, bsCr };
        });
    }, [mergedAccounts, ledgerData, adjustments]);

    return html`
        <div className="h-full flex flex-col">
            <div className="bg-purple-100 p-2 font-bold text-purple-900 border-b border-purple-200"><${Table} size=${16} className="inline mr-2"/>Source: Worksheet (Correct Answers)</div>
            <div className="overflow-auto custom-scrollbar flex-1 bg-white">
                <table className="w-full text-xs min-w-[1000px] border-collapse">
                    <thead className="sticky top-0 z-10">
                        <tr className="bg-purple-900 text-white text-center"><th className="p-1 sticky left-0 bg-purple-900 z-20">Account</th><th colSpan="2">Adjusted TB</th><th colSpan="2">Income Statement</th><th colSpan="2">Balance Sheet</th></tr>
                        <tr className="bg-purple-800 text-white text-center"><th className="p-1 sticky left-0 bg-purple-800 z-20"></th><th>Dr</th><th>Cr</th><th>Dr</th><th>Cr</th><th>Dr</th><th>Cr</th></tr>
                    </thead>
                    <tbody>
                        ${data.map((row, idx) => html`
                            <tr key=${idx} className="border-b border-purple-100 hover:bg-purple-50">
                                <td className="p-1 border-r sticky left-0 bg-white z-0 truncate font-medium w-40">${row.acc}</td>
                                <td className="p-1 border-r text-right w-20">${row.atbDr || ''}</td>
                                <td className="p-1 border-r text-right w-20">${row.atbCr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-green-50">${row.isDr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-green-50">${row.isCr || ''}</td>
                                <td className="p-1 border-r text-right w-20 bg-indigo-50">${row.bsDr || ''}</td>
                                <td className="p-1 text-right w-20 bg-indigo-50">${row.bsCr || ''}</td>
                            </tr>
                        `)}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

// --- COMPONENT: Closing Entry Form (REID) ---
const ClosingEntryForm = ({ entries, onChange, isReadOnly, showFeedback, validationResult }) => {
    const { fieldStatus } = validationResult || {};

    const defaultStructure = [
        { id: 'closeRev', title: '1. Close Revenue', desc: 'To close the revenue accounts.' },
        { id: 'closeExp', title: '2. Close Expense', desc: 'To close the expense accounts.' },
        { id: 'closeInc', title: '3. Close Income Summary', desc: 'To close the income summary account.' },
        { id: 'closeDrw', title: '4. Close Drawings', desc: 'To close the drawing accounts.' }
    ];

    const currentEntries = entries || defaultStructure.map(s => ({ ...s, rows: [{}, {}] }));

    const updateBlock = (blockIdx, newRows) => {
        const newEntries = [...currentEntries];
        newEntries[blockIdx] = { ...newEntries[blockIdx], rows: newRows };
        onChange(newEntries);
    };

    const handleRowChange = (blockIdx, rowIdx, field, val) => {
        const rows = [...currentEntries[blockIdx].rows];
        if (!rows[rowIdx]) rows[rowIdx] = {};

        // 1. Debit Entry Check: Prevent Debit if a Credit exists in previous rows
        if (field === 'dr' && val > 0) {
            const hasPriorCredit = rows.some((r, idx) => idx < rowIdx && (Number(r.cr) || 0) > 0);
            if (hasPriorCredit) {
                alert("Please enter all Debit entries first before entering any Credit entries.");
                return; // Block change
            }
            // If entering Debit, ensure account is NOT indented
            if (rows[rowIdx].acc && rows[rowIdx].acc.startsWith("   ")) {
                rows[rowIdx].acc = rows[rowIdx].acc.trim();
            }
        }

        // 2. Credit Entry Logic: Auto-indent Account
        if (field === 'cr' && val > 0) {
            // Automatically indent account title if not already
            const currentAcc = rows[rowIdx].acc || '';
            if (!currentAcc.startsWith("   ")) {
                rows[rowIdx].acc = "   " + currentAcc;
            }
        }

        // 3. Date Logic: Only allowed on rowIdx 0 (Enforced in Render, but filtered here just in case)
        if (field === 'date' && rowIdx !== 0) return;

        rows[rowIdx][field] = val;
        updateBlock(blockIdx, rows);
    };

    const addRow = (blockIdx) => {
        const rows = [...currentEntries[blockIdx].rows, {}];
        updateBlock(blockIdx, rows);
    };

    const removeRow = (blockIdx, rowIdx) => {
        const rows = currentEntries[blockIdx].rows.filter((_, i) => i !== rowIdx);
        updateBlock(blockIdx, rows);
    };

    const getInputClass = (isOk) => 
        `w-full h-full p-1 outline-none text-sm ${showFeedback && isOk === false ? 'bg-red-50' : ''}`;

    return html`
        <div className="border rounded bg-white shadow-sm flex flex-col flex-1 min-h-0">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 border-b flex items-center">
                <${Book} size=${16} className="inline mr-2 w-4 h-4"/>
                Journalize Closing Entries (REID)
            </div>
            
            

            <div className="overflow-y-auto p-2 flex-1">
                ${currentEntries.map((block, bIdx) => {
                    const rows = block.rows || [{}, {}];
                    return html`
                        <div key=${block.id} className="mb-4 border border-blue-200 rounded overflow-hidden">
                            <div className="bg-blue-50 px-2 py-1 text-xs font-bold text-blue-800 border-b border-blue-200">${block.title}</div>
                            
                            <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-600 text-center">
                                <div className="w-14 border-r p-1">Date</div>
                                <div className="flex-1 border-r p-1">Account Title</div>
                                <div className="w-8 border-r p-1">PR</div>
                                <div className="w-24 border-r p-1">Debit</div>
                                <div className="w-24 p-1">Credit</div>
                                <div className="w-8"></div>
                            </div>

                            ${rows.map((row, rIdx) => {
                                // Validation Keys
                                const baseKey = `journal-${bIdx}-${rIdx}`;
                                const accOk = fieldStatus?.[`${baseKey}-acc`];
                                const drOk = fieldStatus?.[`${baseKey}-dr`];
                                const crOk = fieldStatus?.[`${baseKey}-cr`];
                                const prOk = fieldStatus?.[`${baseKey}-pr`];
                                const dateOk = fieldStatus?.[`${baseKey}-date`]; 

                                return html`
                                <div key=${rIdx} className="flex border-b border-gray-100 h-8">
                                    <div className="w-14 border-r relative">
                                        ${rIdx === 0 
                                            ? html`
                                                <input type="text" className=${getInputClass(dateOk) + " text-center"} placeholder="dd" value=${row.date || ''} onChange=${(e) => handleRowChange(bIdx, rIdx, 'date', e.target.value)} disabled=${isReadOnly}/>
                                                <div className="absolute top-0 right-0 pointer-events-none"><${StatusIcon} show=${showFeedback} isCorrect=${dateOk}/></div>
                                              `
                                            : html`<div className="w-full h-full bg-gray-50"></div>`
                                        }
                                    </div>
                                    <div className="flex-1 border-r relative">
                                        <input type="text" className=${getInputClass(accOk)} placeholder="Account Title" value=${row.acc || ''} onChange=${(e) => handleRowChange(bIdx, rIdx, 'acc', e.target.value)} disabled=${isReadOnly}/>
                                        <div className="absolute top-1 right-1"><${StatusIcon} show=${showFeedback} isCorrect=${accOk}/></div>
                                    </div>
                                    <div className="w-8 border-r relative flex items-center justify-center">
                                        <input type="checkbox" className="w-4 h-4 cursor-pointer" checked=${row.pr || false} onChange=${(e) => handleRowChange(bIdx, rIdx, 'pr', e.target.checked)} disabled=${isReadOnly}/>
                                        <div className="absolute top-0 right-0 pointer-events-none"><${StatusIcon} show=${showFeedback} isCorrect=${prOk}/></div>
                                    </div>
                                    <div className="w-24 border-r relative">
                                        <input type="number" className=${getInputClass(drOk) + " text-right"} placeholder="Debit" value=${row.dr || ''} onChange=${(e) => handleRowChange(bIdx, rIdx, 'dr', e.target.value)} disabled=${isReadOnly}/>
                                        <div className="absolute top-0 right-0"><${StatusIcon} show=${showFeedback} isCorrect=${drOk}/></div>
                                    </div>
                                    <div className="w-24 border-r relative">
                                        <input type="number" className=${getInputClass(crOk) + " text-right"} placeholder="Credit" value=${row.cr || ''} onChange=${(e) => handleRowChange(bIdx, rIdx, 'cr', e.target.value)} disabled=${isReadOnly}/>
                                        <div className="absolute top-0 right-0"><${StatusIcon} show=${showFeedback} isCorrect=${crOk}/></div>
                                    </div>
                                    <div className="w-8 flex justify-center items-center bg-gray-50">
                                        ${!isReadOnly && html`<button onClick=${() => removeRow(bIdx, rIdx)} className="text-gray-400 hover:text-red-500"><${Trash2} size=${12}/></button>`}
                                    </div>
                                </div>
                            `})}

                            <div className="flex bg-gray-50 text-gray-500 italic text-xs border-b border-gray-100">
                                <div className="w-14 border-r"></div>
                                <div className="flex-1 p-1 pl-8">(${block.desc})</div>
                            </div>

                            ${!isReadOnly && html`
                                <div className="bg-gray-50 p-1 text-center">
                                    <button onClick=${() => addRow(bIdx)} className="text-[10px] text-blue-600 hover:underline flex items-center justify-center w-full">
                                        <${Plus} size=${10} className="mr-1"/> Add Row
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                })}
            </div>
        </div>
    `;
};

// --- COMPONENT: Enhanced Ledger Account ---
const LedgerAccount = ({ accName, transactions, startingBalance, adjustments, userLedger, onUpdate, isReadOnly, showFeedback, validationResult, contextYear, isNewAccount }) => {
    // Validation
    const { fieldStatus } = validationResult || {};
    const ledgerKeyBase = `ledger-${accName}`;
    const overallOk = fieldStatus?.[`${ledgerKeyBase}-overall`];
    const drTotalOk = fieldStatus?.[`${ledgerKeyBase}-drTotal`];
    const crTotalOk = fieldStatus?.[`${ledgerKeyBase}-crTotal`];
    const balAmtOk = fieldStatus?.[`${ledgerKeyBase}-bal`];
    const balTypeOk = fieldStatus?.[`${ledgerKeyBase}-balType`];

    // 1. Prepare Data Rows
    const leftRows = [];
    const rightRows = [];

    // Beg Bal
    if (startingBalance) {
        if (startingBalance.dr > 0) leftRows.push({ date: 'Jan 01', item: 'Bal', pr: '', amount: startingBalance.dr, isLocked: true });
        if (startingBalance.cr > 0) rightRows.push({ date: 'Jan 01', item: 'Bal', pr: '', amount: startingBalance.cr, isLocked: true });
    }

    // Historical Transactions
    transactions.forEach(t => {
        const dateObj = new Date(t.date);
        const mm = dateObj.toLocaleString('default', { month: 'short' });
        const dd = dateObj.getDate().toString().padStart(2, '0');
        const dateStr = `${mm} ${dd}`;

        t.debits.forEach(d => { if(d.account === accName) leftRows.push({ date: dateStr, item: 'GJ', pr: '1', amount: d.amount, isLocked: true }); });
        t.credits.forEach(c => { if(c.account === accName) rightRows.push({ date: dateStr, item: 'GJ', pr: '1', amount: c.amount, isLocked: true }); });
    });

    // Adjusting Entries
    if (adjustments) {
        adjustments.forEach(adj => {
            if (adj.drAcc === accName) leftRows.push({ date: 'Dec 31', item: 'Adj', pr: 'J2', amount: adj.amount, isLocked: true });
            if (adj.crAcc === accName) rightRows.push({ date: 'Dec 31', item: 'Adj', pr: 'J2', amount: adj.amount, isLocked: true });
        });
    }

    const userLeft = userLedger?.leftRows || [];
    const userRight = userLedger?.rightRows || [];

    const finalLeft = [...leftRows, ...userLeft];
    const finalRight = [...rightRows, ...userRight];
     
    // VISUAL ROWS MAPPING
    const maxDataRows = Math.max(finalLeft.length, finalRight.length, 4);
    const displayRowsCount = maxDataRows + 1; // +1 for Year Row
    const displayRows = Array.from({length: displayRowsCount}).map((_, i) => i);

    const updateSide = (side, visualIdx, field, val) => {
        // Visual Index 0 is Year Row
        if (visualIdx === 0) {
            if (isNewAccount && side === 'left') { 
                onUpdate({ ...userLedger, yearInput: val });
            }
            return;
        }

        const dataIdx = visualIdx - 1; 
        const histLen = side === 'left' ? leftRows.length : rightRows.length;
        if (dataIdx < histLen) return; 

        const userIdx = dataIdx - histLen;
        const currentArr = side === 'left' ? userLeft : userRight;
        const newArr = [...currentArr];
        if (!newArr[userIdx]) newArr[userIdx] = {}; 
        newArr[userIdx] = { ...newArr[userIdx], [field]: val };
        
        onUpdate({ 
            ...userLedger, 
            [side === 'left' ? 'leftRows' : 'rightRows']: newArr 
        });
    };

    const addCombinedRow = () => {
        onUpdate({ 
            ...userLedger, 
            leftRows: [...userLeft, { date: '', item: 'Clos', pr: '', amount: '' }],
            rightRows: [...userRight, { date: '', item: 'Clos', pr: '', amount: '' }]
        });
    };

    const deleteCombinedRow = (visualIdx) => {
         if (visualIdx === 0) return;
         const dataIdx = visualIdx - 1;
         
         const histLenLeft = leftRows.length;
         const histLenRight = rightRows.length;
         
         if (dataIdx < Math.max(histLenLeft, histLenRight)) return;

         const userIdxLeft = dataIdx - histLenLeft;
         const userIdxRight = dataIdx - histLenRight;

         const newLeft = [...userLeft];
         const newRight = [...userRight];

         if (userIdxLeft >= 0 && userIdxLeft < newLeft.length) newLeft.splice(userIdxLeft, 1);
         if (userIdxRight >= 0 && userIdxRight < newRight.length) newRight.splice(userIdxRight, 1);

         onUpdate({
             ...userLedger,
             leftRows: newLeft,
             rightRows: newRight
         });
    };
    
    const getCellProps = (side, visualIdx) => {
        if (visualIdx === 0) {
            return {
                isYearRow: true,
                date: isNewAccount ? (userLedger.yearInput || '') : contextYear, 
                item: '', pr: '', amount: '',
                isUser: isNewAccount, 
                isLocked: !isNewAccount
            };
        }

        const dataIdx = visualIdx - 1;
        const dataArr = side === 'left' ? finalLeft : finalRight;
        const row = dataArr[dataIdx];
        const isUser = side === 'left' ? dataIdx >= leftRows.length : dataIdx >= rightRows.length;

        if (!row) {
            return { isYearRow: false, date: '', item: '', pr: '', amount: '', isUser: isUser, isLocked: !isUser };
        }

        let displayDate = row.date || '';
        if (visualIdx === 1) {
            // First Data Row: "Mmm dd"
        } else {
            // Subsequent: "dd"
            if (row.isLocked && displayDate.includes(' ')) {
                displayDate = displayDate.split(' ')[1];
            }
        }

        return {
            isYearRow: false,
            date: displayDate,
            item: row.item,
            pr: row.pr,
            amount: row.amount,
            isUser: isUser,
            isLocked: row.isLocked
        };
    };

    return html`
        <div className="border-2 border-gray-800 bg-white shadow-md mb-6">
            <div className="border-b-2 border-gray-800 p-2 flex justify-between bg-gray-100 relative">
                <div className="absolute left-2 top-2"><${StatusIcon} show=${showFeedback} isCorrect=${overallOk} /></div>
                <div className="w-full text-center mx-8 font-bold text-lg">${accName}</div>
            </div>
            
            <div className="flex">
                <div className="flex-1 border-r-2 border-gray-800">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">DEBIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400">
                        <div className="w-14 border-r p-1 text-center">Date</div>
                        <div className="flex-1 border-r p-1 text-center">Particulars</div>
                        <div className="w-8 border-r p-1 text-center">PR</div>
                        <div className="w-16 p-1 text-center">Amount</div>
                    </div>
                    ${displayRows.map(i => {
                        const props = getCellProps('left', i);
                        const isRowDisabled = props.isLocked; 
                        const datePlaceholder = i === 0 ? "YYYY" : (i === 1 ? "Mmm dd" : "dd");

                        return html`
                            <div key=${`l-${i}`} className="flex text-xs border-b border-gray-200 h-6 relative ${!props.isUser && !props.isYearRow && props.date ? 'bg-gray-50/50 text-gray-600' : ''}">
                                <div className="w-14 border-r relative"><input type="text" className="w-full h-full text-center px-1 outline-none bg-transparent" placeholder=${datePlaceholder} value=${props.date} onChange=${(e)=>updateSide('left', i, 'date', e.target.value)} disabled=${isRowDisabled}/></div>
                                <div className="flex-1 border-r relative"><input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${props.item||''} onChange=${(e)=>updateSide('left', i, 'item', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-8 border-r relative"><input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${props.pr||''} onChange=${(e)=>updateSide('left', i, 'pr', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-16 relative"><input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${props.amount||''} onChange=${(e)=>updateSide('left', i, 'amount', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50 relative">
                        <span className="text-xs font-bold">Total Debit</span>
                        <input type="number" className=${`w-20 text-right border border-gray-300 bg-white ${showFeedback && drTotalOk === false ? 'bg-red-50' : ''}`} value=${userLedger?.drTotal||''} onChange=${(e)=>onUpdate({...userLedger, drTotal: e.target.value})} disabled=${isReadOnly} />
                        <div className="absolute right-0 top-1"><${StatusIcon} show=${showFeedback} isCorrect=${drTotalOk}/></div>
                    </div>
                </div>

                <div className="flex-1">
                    <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">CREDIT</div>
                    <div className="flex text-xs font-bold border-b border-gray-400">
                        <div className="w-14 border-r p-1 text-center">Date</div>
                        <div className="flex-1 border-r p-1 text-center">Particulars</div>
                        <div className="w-8 border-r p-1 text-center">PR</div>
                        <div className="w-16 p-1 text-center">Amount</div>
                        <div className="w-6"></div>
                    </div>
                    ${displayRows.map(i => {
                        const props = getCellProps('right', i);
                        const isRowDisabled = props.isLocked;
                        const datePlaceholder = i === 0 ? "YYYY" : (i === 1 ? "Mmm dd" : "dd");
                        const isDeletable = props.isUser && !isReadOnly && !props.isYearRow;

                        return html`
                            <div key=${`r-${i}`} className="flex text-xs border-b border-gray-200 h-6 relative ${!props.isUser && !props.isYearRow && props.date ? 'bg-gray-50/50 text-gray-600' : ''}">
                                <div className="w-14 border-r relative"><input type="text" className="w-full h-full text-center px-1 outline-none bg-transparent" placeholder=${datePlaceholder} value=${props.date} onChange=${(e)=>updateSide('right', i, 'date', e.target.value)} disabled=${isRowDisabled}/></div>
                                <div className="flex-1 border-r relative"><input type="text" className="w-full h-full text-left px-1 outline-none bg-transparent" value=${props.item||''} onChange=${(e)=>updateSide('right', i, 'item', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-8 border-r relative"><input type="text" className="w-full h-full text-center outline-none bg-transparent" value=${props.pr||''} onChange=${(e)=>updateSide('right', i, 'pr', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-16 relative"><input type="number" className="w-full h-full text-right px-1 outline-none bg-transparent" value=${props.amount||''} onChange=${(e)=>updateSide('right', i, 'amount', e.target.value)} disabled=${props.isYearRow || isRowDisabled}/></div>
                                <div className="w-6 flex justify-center items-center">
                                    ${isDeletable && html`<button onClick=${()=>deleteCombinedRow(i)} class="text-red-400 hover:text-red-600"><${Trash2} size=${10}/></button>`}
                                </div>
                            </div>
                        `;
                    })}
                    <div className="border-t-2 border-gray-800 p-1 flex justify-between items-center bg-gray-50 relative">
                        <span className="text-xs font-bold">Total Credit</span>
                        <input type="number" className=${`w-20 text-right border border-gray-300 bg-white ${showFeedback && crTotalOk === false ? 'bg-red-50' : ''}`} value=${userLedger?.crTotal||''} onChange=${(e)=>onUpdate({...userLedger, crTotal: e.target.value})} disabled=${isReadOnly} />
                        <div className="absolute right-0 top-1"><${StatusIcon} show=${showFeedback} isCorrect=${crTotalOk}/></div>
                    </div>
                </div>
            </div>
            
            ${!isReadOnly && html`<button onClick=${addCombinedRow} className="w-full text-center text-[10px] text-blue-600 hover:bg-blue-50 py-1 border-b border-gray-200 bg-gray-50"><${Plus} size=${10} className="inline"/> Add Row (Dr/Cr)</button>`}

            <div className="border-t border-gray-300 p-2 bg-gray-100 flex justify-center items-center gap-2 relative">
                <span className="text-xs font-bold uppercase text-gray-600">Balance:</span>
                <div className="relative">
                    <select className=${`border border-gray-300 rounded text-xs p-1 outline-none bg-white ${showFeedback && balTypeOk === false ? 'bg-red-50' : ''}`} value=${userLedger?.balanceType || ''} onChange=${(e)=>onUpdate({...userLedger, balanceType: e.target.value})} disabled=${isReadOnly}><option value="" disabled>Type</option><option value="Dr">Debit</option><option value="Cr">Credit</option></select>
                </div>
                <div className="relative">
                    <input type="number" className=${`w-32 text-center border-b-2 border-double border-black bg-white font-bold text-sm outline-none ${showFeedback && balAmtOk === false ? 'bg-red-50' : ''}`} placeholder="0" value=${userLedger?.balance||''} onChange=${(e)=>onUpdate({...userLedger, balance: e.target.value})} disabled=${isReadOnly} />
                    <div className="absolute -right-5 top-1"><${StatusIcon} show=${showFeedback} isCorrect=${balAmtOk}/></div>
                </div>
            </div>
        </div>
    `;
};

// --- MAIN COMPONENT ---
function Step08ClosingEntries({ activityData, data, onChange, showFeedback, isReadOnly }) {
    
    // Internal Validation Calculation (DRY)
    const validationResult = useMemo(() => {
        if (!showFeedback && !isReadOnly) return null;
        return validateStep08(data, activityData);
    }, [data, activityData, showFeedback, isReadOnly]);

    // Ensure data structures exist
    const ledgers = data.ledgers || {}; 
    
    // Define Handlers BEFORE use
    const handleJournalChange = (entries) => onChange('journal', entries);
    
    const updateLedgerData = (accName, val) => {
        const newLedgers = { ...ledgers, [accName]: val };
        onChange('ledgers', newLedgers);
    };

    const { validAccounts, transactions, beginningBalances, config } = activityData;
    const sortedAccounts = sortAccounts(validAccounts);

    const contextYear = useMemo(() => {
        if (transactions && transactions.length > 0) {
            return new Date(transactions[0].date).getFullYear();
        }
        return new Date().getFullYear();
    }, [transactions]);

    return html`
        <div className="h-full flex flex-col">
            ${(showFeedback || isReadOnly) && validationResult && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${validationResult.score || 0} of ${validationResult.maxScore || 0} - (${validationResult.letterGrade || 'IR'})</span>
                </div>
            `}

            <div className="flex flex-col lg:flex-row gap-4 h-[calc(100vh-180px)]">
                <div className="flex-1 lg:w-5/12 flex flex-col gap-4 min-h-0">
                    <div className="h-1/2 min-h-0 flex flex-col border rounded overflow-hidden shadow-sm">
                         <${WorksheetSourceView} ledgerData=${activityData.ledger} adjustments=${activityData.adjustments} />
                    </div>
                    <div className="h-1/2 min-h-0 flex flex-col">
                        <${ClosingEntryForm} entries=${data.journal} onChange=${handleJournalChange} isReadOnly=${isReadOnly} showFeedback=${showFeedback} validationResult=${validationResult} />
                    </div>
                </div>
                
                <div className="flex-1 lg:w-7/12 border rounded bg-white h-full flex flex-col shadow-sm">
                    <div className="bg-blue-100 p-2 font-bold text-blue-900 border-b border-blue-200 flex items-center">
                        <${Table} size=${16} className="inline mr-2 w-4 h-4"/> General Ledger (Post-Closing)
                    </div>
                    <div className="p-4 overflow-y-auto custom-scrollbar flex-1 bg-gray-50">
                        <div className="flex flex-col gap-4 pb-4">
                            ${sortedAccounts.map(acc => {
                                const isNew = !validAccounts.includes(acc);
                                return html`
                                    <${LedgerAccount} 
                                        key=${acc} 
                                        accName=${acc} 
                                        transactions=${transactions}
                                        startingBalance=${config.isSubsequentYear && beginningBalances ? beginningBalances.balances[acc] : null}
                                        adjustments=${activityData.adjustments}
                                        userLedger=${ledgers[acc] || {}}
                                        onUpdate=${(val) => updateLedgerData(acc, val)}
                                        isReadOnly=${isReadOnly}
                                        showFeedback=${showFeedback}
                                        validationResult=${validationResult}
                                        contextYear=${contextYear}
                                        isNewAccount=${isNew}
                                    />
                                `;
                            })}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// --- VALIDATION HELPER ---
const validateStep08 = (data, activityData) => {
    const { validAccounts, ledger, adjustments, transactions } = activityData;
    const userJournal = data.journal || [];
    const userLedgers = data.ledgers || {};

    // Determine correct date (End of Month of last transaction)
    let expectedDate = 31;
    if (transactions && transactions.length > 0) {
        const d = new Date(transactions[transactions.length - 1].date);
        const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        expectedDate = lastDay;
    }

    let score = 0;
    const fieldStatus = {};

    // 1. Calculate Correct Closing Amounts
    let totalRev = 0, totalExp = 0, drawingAmt = 0;
    const revAccounts = [];
    const expAccounts = [];
    let drawingAccName = '';
    let capitalAccName = '';

    validAccounts.forEach(acc => {
        const type = getAccountType(acc);
        const rawDr = ledger[acc]?.debit || 0;
        const rawCr = ledger[acc]?.credit || 0;
        let adjDr = 0, adjCr = 0;
        adjustments.forEach(a => { if (a.drAcc === acc) adjDr += a.amount; if (a.crAcc === acc) adjCr += a.amount; });
        
        const net = (rawDr + adjDr) - (rawCr + adjCr); // +Dr, -Cr

        if (type === 'Revenue') {
            totalRev += Math.abs(net); // Normal Balance Cr
            revAccounts.push({ acc, amt: Math.abs(net) });
        } else if (type === 'Expense') {
            totalExp += Math.abs(net); // Normal Balance Dr
            expAccounts.push({ acc, amt: Math.abs(net) });
        } else if (acc.includes('Drawing') || acc.includes('Dividends')) {
            drawingAmt = Math.abs(net);
            drawingAccName = acc;
        } else if (acc.includes('Capital') || acc.includes('Retained Earnings')) {
            capitalAccName = acc;
        }
    });

    const netIncome = totalRev - totalExp;

    // 2. Validate Journal Entries (REID)
    // Calculate Max Score first (Points for every required input)
    // Structure: 
    // Rev: 1 line per revenue + 1 line inc sum. Each line has (Acc + Dr/Cr + Date if first).
    // Exp: 1 line inc sum + 1 line per expense.
    // NI: 2 lines.
    // Draw: 2 lines.
    
    // Each row worth 1 point? Request says "1 point for each input boxes... but amount should not receive point if not proper..."
    // Simplified: 1 point if the entire row is "valid" (Acc + Amount + Side Correct).
    
    // Calculate expected rows count
    const revRowsCount = revAccounts.length + 1; 
    const expRowsCount = expAccounts.length + 1; 
    const niRowsCount = 2; 
    const drawRowsCount = 2;
    
    const maxScore = revRowsCount + expRowsCount + niRowsCount + drawRowsCount + (validAccounts.length * 2); // Journal Rows + (Ledger Bal + Type)

    // --- Block 0: Close Revenues ---
    const b0 = userJournal[0]?.rows || [];
    const expectedB0 = [
        ...revAccounts.map(r => ({ acc: r.acc, dr: r.amt, cr: 0 })),
        { acc: 'Income Summary', dr: 0, cr: totalRev }
    ];
    
    // Iterate expected to score found items
    expectedB0.forEach(expected => {
        // Try to find matching user row
        // User row match criteria: Account Name matches
        const userRowIndex = b0.findIndex(r => r.acc && r.acc.trim() === expected.acc);
        
        if (userRowIndex !== -1) {
            const row = b0[userRowIndex];
            const rIdx = userRowIndex;
            const keyBase = `journal-0-${rIdx}`;

            const accOk = true; // Found by account name
            // Strict check on side and amount
            const drOk = Math.abs((Number(row.dr)||0) - expected.dr) < 1 && (expected.dr > 0 ? (Number(row.dr)||0) > 0 : true);
            const crOk = Math.abs((Number(row.cr)||0) - expected.cr) < 1 && (expected.cr > 0 ? (Number(row.cr)||0) > 0 : true);
            
            // Date only matters on first visual row of the block (index 0), but we are iterating expected.
            // Let's assume if the user put the correct date on the first row they typed, they get credit.
            const dateVal = b0[0]?.date;
            const dateOk = (Number(dateVal) === expectedDate); 

            fieldStatus[`${keyBase}-acc`] = accOk;
            fieldStatus[`${keyBase}-dr`] = drOk;
            fieldStatus[`${keyBase}-cr`] = crOk;
            fieldStatus[`${keyBase}-pr`] = row.pr === true;
            if (rIdx === 0) fieldStatus[`${keyBase}-date`] = dateOk;

            // Grant Point: If Account, Amount, Side, and Date (if applicable) are correct
            // Note: If expected.dr is 0, user row.dr should be empty or 0.
            if (accOk && drOk && crOk && (rIdx !== 0 || dateOk)) score++;
        }
    });

    // --- Block 1: Close Expenses ---
    const b1 = userJournal[1]?.rows || [];
    const expectedB1 = [
        { acc: 'Income Summary', dr: totalExp, cr: 0 },
        ...expAccounts.map(e => ({ acc: e.acc, dr: 0, cr: e.amt }))
    ];
    expectedB1.forEach(expected => {
        const userRowIndex = b1.findIndex(r => r.acc && r.acc.trim() === expected.acc);
        if (userRowIndex !== -1) {
            const row = b1[userRowIndex];
            const rIdx = userRowIndex;
            const keyBase = `journal-1-${rIdx}`;

            const accOk = true;
            const drOk = Math.abs((Number(row.dr)||0) - expected.dr) < 1 && (expected.dr > 0 ? (Number(row.dr)||0) > 0 : true);
            const crOk = Math.abs((Number(row.cr)||0) - expected.cr) < 1 && (expected.cr > 0 ? (Number(row.cr)||0) > 0 : true);
            const dateVal = b1[0]?.date;
            const dateOk = (Number(dateVal) === expectedDate); 

            fieldStatus[`${keyBase}-acc`] = accOk;
            fieldStatus[`${keyBase}-dr`] = drOk;
            fieldStatus[`${keyBase}-cr`] = crOk;
            fieldStatus[`${keyBase}-pr`] = row.pr === true;
            if (rIdx === 0) fieldStatus[`${keyBase}-date`] = dateOk;

            if (accOk && drOk && crOk && (rIdx !== 0 || dateOk)) score++;
        }
    });

    // --- Block 2: Close Income Summary (Net Income) ---
    const b2 = userJournal[2]?.rows || [];
    const expectedB2 = netIncome >= 0 
        ? [ { acc: 'Income Summary', dr: netIncome, cr: 0 }, { acc: capitalAccName, dr: 0, cr: netIncome } ]
        : [ { acc: capitalAccName, dr: Math.abs(netIncome), cr: 0 }, { acc: 'Income Summary', dr: 0, cr: Math.abs(netIncome) } ];
    
    expectedB2.forEach(expected => {
        const userRowIndex = b2.findIndex(r => r.acc && r.acc.trim() === expected.acc);
        if (userRowIndex !== -1) {
            const row = b2[userRowIndex];
            const rIdx = userRowIndex;
            const keyBase = `journal-2-${rIdx}`;
            
            const accOk = true;
            const drOk = Math.abs((Number(row.dr)||0) - expected.dr) < 1 && (expected.dr > 0 ? (Number(row.dr)||0) > 0 : true);
            const crOk = Math.abs((Number(row.cr)||0) - expected.cr) < 1 && (expected.cr > 0 ? (Number(row.cr)||0) > 0 : true);
            const dateVal = b2[0]?.date;
            const dateOk = (Number(dateVal) === expectedDate);

            fieldStatus[`${keyBase}-acc`] = accOk;
            fieldStatus[`${keyBase}-dr`] = drOk;
            fieldStatus[`${keyBase}-cr`] = crOk;
            fieldStatus[`${keyBase}-pr`] = row.pr === true;
            if (rIdx === 0) fieldStatus[`${keyBase}-date`] = dateOk;

            if (accOk && drOk && crOk && (rIdx !== 0 || dateOk)) score++;
        }
    });

    // --- Block 3: Close Drawings ---
    const b3 = userJournal[3]?.rows || [];
    const expectedB3 = [
        { acc: capitalAccName, dr: drawingAmt, cr: 0 },
        { acc: drawingAccName, dr: 0, cr: drawingAmt }
    ];
    expectedB3.forEach(expected => {
        const userRowIndex = b3.findIndex(r => r.acc && r.acc.trim() === expected.acc);
        if (userRowIndex !== -1) {
            const row = b3[userRowIndex];
            const rIdx = userRowIndex;
            const keyBase = `journal-3-${rIdx}`;
            
            const accOk = true;
            const drOk = Math.abs((Number(row.dr)||0) - expected.dr) < 1 && (expected.dr > 0 ? (Number(row.dr)||0) > 0 : true);
            const crOk = Math.abs((Number(row.cr)||0) - expected.cr) < 1 && (expected.cr > 0 ? (Number(row.cr)||0) > 0 : true);
            const dateVal = b3[0]?.date;
            const dateOk = (Number(dateVal) === expectedDate);

            fieldStatus[`${keyBase}-acc`] = accOk;
            fieldStatus[`${keyBase}-dr`] = drOk;
            fieldStatus[`${keyBase}-cr`] = crOk;
            fieldStatus[`${keyBase}-pr`] = row.pr === true;
            if (rIdx === 0) fieldStatus[`${keyBase}-date`] = dateOk;

            if (accOk && drOk && crOk && (rIdx !== 0 || dateOk)) score++;
        }
    });

    // 3. Validate Ledger Post-Closing Balances
    const postClosingVals = {};
    validAccounts.forEach(acc => {
        const type = getAccountType(acc);
        let rawDr = ledger[acc]?.debit || 0;
        let rawCr = ledger[acc]?.credit || 0;
        adjustments.forEach(a => { if (a.drAcc === acc) rawDr += a.amount; if (a.crAcc === acc) rawCr += a.amount; });
        let net = rawDr - rawCr;

        // Apply Closing Effects
        if (type === 'Revenue') net -= net; 
        else if (type === 'Expense') net += Math.abs(net);
        
        if (['Revenue', 'Expense'].includes(type) || acc === drawingAccName || acc === 'Income Summary') {
            postClosingVals[acc] = 0;
        } else if (acc === capitalAccName) {
            let capBal = (ledger[acc]?.credit || 0) - (ledger[acc]?.debit || 0); // Cr Balance
            capBal += netIncome;
            capBal -= drawingAmt;
            postClosingVals[acc] = capBal; // Expected Credit Balance
        } else {
            postClosingVals[acc] = Math.abs(net);
        }
    });

    validAccounts.forEach(acc => {
        const userL = userLedgers[acc] || {};
        const keyBase = `ledger-${acc}`;
        
        const expectedBal = postClosingVals[acc];
        const userBal = Number(userL.balance) || 0;
        const userType = userL.balanceType;

        const isZero = Math.abs(expectedBal) < 1;
        const matchesAmt = Math.abs(userBal - Math.abs(expectedBal)) < 1;
        
        let expectedType = '';
        if (!isZero) {
            const type = getAccountType(acc);
            if (acc === capitalAccName) expectedType = 'Cr'; 
            else if (type === 'Asset') expectedType = 'Dr';
            else if (type === 'Liability') expectedType = 'Cr';
        }

        const matchesType = isZero ? true : (userType === expectedType);

        fieldStatus[`${keyBase}-bal`] = matchesAmt;
        fieldStatus[`${keyBase}-balType`] = matchesType;
        fieldStatus[`${keyBase}-overall`] = matchesAmt && matchesType;
        
        fieldStatus[`${keyBase}-drTotal`] = true; 
        fieldStatus[`${keyBase}-crTotal`] = true;

        if (matchesAmt) score++;
        if (matchesType) score++;
    });

    return {
        score,
        maxScore,
        letterGrade: getLetterGrade(score, maxScore),
        fieldStatus,
        year: '20XX' 
    };
};


// --- Step09PostClosingTB.js ---





const html = htm.bind(React.createElement);

// --- HELPER FUNCTIONS ---

const getLastDayOfMonth = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = date.getMonth();
    const lastDay = new Date(year, month + 1, 0);
    return lastDay.toLocaleString('default', { month: 'long', day: 'numeric', year: 'numeric' });
};

// --- VALIDATION LOGIC ---
const validateStep09 = (data, activityData) => {
    // 1. Calculate Expected Post-Closing Balances
    const { validAccounts, ledger, adjustments, transactions } = activityData;
    
    // BUILD COMPREHENSIVE ACCOUNT LIST
    // Accounts might be in validAccounts OR introduced in adjustments
    const allUniqueAccounts = new Set([...validAccounts]);
    adjustments.forEach(a => {
        if (a.drAcc) allUniqueAccounts.add(a.drAcc);
        if (a.crAcc) allUniqueAccounts.add(a.crAcc);
    });
    const completeAccountList = Array.from(allUniqueAccounts);

    let totalRev = 0, totalExp = 0, totalDraw = 0;
    let capitalAccName = '';
    const adjustedBalances = {};

    // A. Calculate Adjusted Balances & Identify Nominal Totals
    completeAccountList.forEach(acc => {
        const rawDr = ledger[acc]?.debit || 0;
        const rawCr = ledger[acc]?.credit || 0;
        let adjDr = 0, adjCr = 0;
        adjustments.forEach(a => { if (a.drAcc === acc) adjDr += a.amount; if (a.crAcc === acc) adjCr += a.amount; });
        
        // Net Balance (+Dr, -Cr)
        const net = (rawDr + adjDr) - (rawCr + adjCr);
        adjustedBalances[acc] = net;

        const type = getAccountType(acc);
        if (type === 'Revenue') totalRev += Math.abs(net); // Normal Cr
        else if (type === 'Expense') totalExp += Math.abs(net); // Normal Dr
        else if (acc.includes('Drawing') || acc.includes('Dividends')) totalDraw += Math.abs(net); // Normal Dr
        else if (acc.includes('Capital') || acc.includes('Retained Earnings')) capitalAccName = acc;
    });

    const netIncome = totalRev - totalExp;

    // B. Build Expected Post-Closing Ledger
    const expBalances = {}; 
    let expTotalDr = 0;
    let expTotalCr = 0;
    let expectedMaxScore = 3; // Start with Header points

    completeAccountList.forEach(acc => {
        const type = getAccountType(acc);
        let finalBal = 0;

        if (['Revenue', 'Expense'].includes(type) || acc.includes('Drawing') || acc === 'Income Summary') {
            finalBal = 0; // Closed
        } else if (acc === capitalAccName) {
            // Capital = Old + NetIncome - Drawings
            const oldCap = Math.abs(adjustedBalances[acc] || 0); 
            const newCap = oldCap + netIncome - totalDraw;
            finalBal = -newCap; // Represent as Credit (negative)
        } else {
            finalBal = adjustedBalances[acc] || 0; // Assets/Liabilities unchanged
        }

        const absNet = Math.abs(finalBal);
        
        // Only include in Expected TB if balance > 0
        if (absNet > 0) { 
            expBalances[acc] = { amount: absNet, side: finalBal >= 0 ? 'dr' : 'cr' };
            if (finalBal >= 0) expTotalDr += absNet;
            else expTotalCr += absNet;
            expectedMaxScore += 2; // 1 for Acc Name, 1 for Amount
        }
    });

    expectedMaxScore += 2; // Totals

    // --- SCORING ---
    let score = 0;
    const feedback = { header: {}, rows: [], totals: {} };
    const header = data.header || {};

    // A. Company Name
    const companyName = (header.company || '').trim();
    const isCompanyValid = companyName.length > 3; 
    if (isCompanyValid) score += 1;
    feedback.header.company = isCompanyValid;

    // B. Document Name
    const docName = (header.doc || '').trim().toLowerCase();
    const isDocValid = docName.includes('post-closing trial balance') || docName === 'post closing trial balance';
    if (isDocValid) score += 1;
    feedback.header.doc = isDocValid;

    // C. Date
    const targetDate = getLastDayOfMonth(transactions ? transactions[0]?.date : '');
    const inputDate = (header.date || '').trim();
    const isDateValid = targetDate && inputDate.toLowerCase() === targetDate.toLowerCase();
    if (isDateValid) score += 1;
    feedback.header.date = isDateValid;

    // 2. BODY VALIDATION
    const rows = data.rows || [];
    const totals = data.totals || { dr: '', cr: '' };
    const processedAccounts = new Set();

    rows.forEach((row, idx) => {
        const userAcc = (row.account || '').trim();
        const userDr = Number(row.dr) || 0;
        const userCr = Number(row.cr) || 0;
        
        const rowFeedback = { acc: false, amt: false };
        
        if (userAcc) {
            const matchedKey = Object.keys(expBalances).find(k => k.toLowerCase() === userAcc.toLowerCase());
            
            if (matchedKey && !processedAccounts.has(matchedKey)) {
                // Found a valid real account
                score += 1;
                rowFeedback.acc = true;
                processedAccounts.add(matchedKey);

                const exp = expBalances[matchedKey];
                const isDrCorrect = exp.side === 'dr' && Math.abs(userDr - exp.amount) <= 1 && userCr === 0;
                const isCrCorrect = exp.side === 'cr' && Math.abs(userCr - exp.amount) <= 1 && userDr === 0;

                if (isDrCorrect || isCrCorrect) {
                    score += 1;
                    rowFeedback.amt = true;
                }
            }
        }
        feedback.rows[idx] = rowFeedback;
    });

    // 3. TOTALS VALIDATION
    const userTotalDrInput = Number(totals.dr) || 0;
    const userTotalCrInput = Number(totals.cr) || 0;

    const isTotalDrCorrect = Math.abs(userTotalDrInput - expTotalDr) <= 1;
    const isTotalCrCorrect = Math.abs(userTotalCrInput - expTotalCr) <= 1;

    if (isTotalDrCorrect) score += 1;
    if (isTotalCrCorrect) score += 1;
    
    feedback.totals = { dr: isTotalDrCorrect, cr: isTotalCrCorrect };

    return { 
        score, 
        maxScore: expectedMaxScore, 
        isCorrect: score === expectedMaxScore, 
        letterGrade: getLetterGrade(score, expectedMaxScore), 
        feedback,
        year: '20XX'
    };
};

// --- INTERNAL COMPONENTS ---

const StatusIcon = ({ correct, show }) => {
    if (!show) return null;
    return correct 
        ? html`<${Check} size=${16} className="text-green-600 inline ml-1 flex-shrink-0" strokeWidth=${3} />` 
        : html`<${X} size=${16} className="text-red-600 inline ml-1 flex-shrink-0" strokeWidth=${3} />`;
};

// --- UPDATED LEDGER VIEW FOR STEP 9 ---
const LedgerSourceView = ({ transactions, validAccounts, beginningBalances, isSubsequentYear, adjustments, closingEntries }) => {
    const [expanded, setExpanded] = useState(true);
    
    // CRITICAL FIX: Ensure all accounts, including those appearing ONLY in adjustments (e.g. Supplies Expense), are included.
    const allAccounts = useMemo(() => {
        const set = new Set();
        
        // 1. Base Accounts
        if (validAccounts) validAccounts.forEach(a => set.add(a));
        
        // 2. Transactions
        if (transactions) {
            transactions.forEach(t => {
                t.debits.forEach(d => set.add(d.account));
                t.credits.forEach(c => set.add(c.account));
            });
        }

        // 3. Adjustments (Catches Supplies Expense, Depr. Expense, etc.)
        if (adjustments) {
            adjustments.forEach(adj => {
                if (adj.drAcc) set.add(adj.drAcc);
                if (adj.crAcc) set.add(adj.crAcc);
            });
        }
        
        // 4. Closing Entries (In case user created distinct accounts, rare but possible)
        if (closingEntries) {
             closingEntries.forEach(block => {
                if (block.rows) {
                    block.rows.forEach(r => {
                        if (r.acc) set.add(r.acc.trim());
                    });
                }
             });
        }
        
        // 5. Ensure Income Summary is present
        set.add('Income Summary');

        return sortAccounts(Array.from(set));
    }, [validAccounts, transactions, adjustments, closingEntries]);


    // Construct "Correct" Closing Entries if user input is missing OR to visualize flow
    // We use 'allAccounts' here to ensure we close everything found.
    const computedClosingEntries = useMemo(() => {
        if (closingEntries && closingEntries.length > 0 && closingEntries[0]?.rows) return closingEntries;
        
        // --- AUTO-GENERATE CLOSING ENTRIES (FALLBACK) ---
        let totalRev = 0, totalExp = 0, totalDraw = 0;
        let capitalAccName = '';
        const tempLedger = {};

        // Calculate balances including Adj
        allAccounts.forEach(acc => {
            let bal = 0;
            // Beg Bal
            if (isSubsequentYear && beginningBalances?.balances[acc]) {
                bal += (beginningBalances.balances[acc].dr - beginningBalances.balances[acc].cr);
            }
            // Trans
            transactions.forEach(t => {
                t.debits.forEach(d => { if(d.account===acc) bal += d.amount; });
                t.credits.forEach(c => { if(c.account===acc) bal -= c.amount; });
            });
            // Adj
            adjustments.forEach(a => {
                if(a.drAcc===acc) bal += a.amount;
                if(a.crAcc===acc) bal -= a.amount;
            });
            tempLedger[acc] = bal;

            const type = getAccountType(acc);
            if(type==='Revenue') totalRev += Math.abs(bal);
            else if(type==='Expense') totalExp += Math.abs(bal); 
            else if(acc.includes('Drawing') || acc.includes('Dividends')) { totalDraw += Math.abs(bal); }
            else if(acc.includes('Capital') || acc.includes('Retained Earnings')) { capitalAccName = acc; }
        });

        const ni = totalRev - totalExp;
        const entries = [];

        // 1. Close Rev
        allAccounts.forEach(acc => {
            if (getAccountType(acc) === 'Revenue' && Math.abs(tempLedger[acc]) > 0) {
                entries.push({ rows: [{acc: acc, dr: Math.abs(tempLedger[acc])}, {acc: 'Income Summary', cr: Math.abs(tempLedger[acc])}] });
            }
        });
        
        // 2. Close Exp
        allAccounts.forEach(acc => {
            if (getAccountType(acc) === 'Expense' && tempLedger[acc] > 0) {
                entries.push({ rows: [{acc: 'Income Summary', dr: tempLedger[acc]}, {acc: acc, cr: tempLedger[acc]}] });
            }
        });

        // 3. Close NI
        if (ni !== 0) {
             if (ni > 0) entries.push({ rows: [{acc: 'Income Summary', dr: ni}, {acc: capitalAccName, cr: ni}] });
             else entries.push({ rows: [{acc: capitalAccName, dr: Math.abs(ni)}, {acc: 'Income Summary', cr: Math.abs(ni)}] });
        }

        // 4. Close Draw
        allAccounts.forEach(acc => {
            if ((acc.includes('Drawing') || acc.includes('Dividends')) && tempLedger[acc] > 0) {
                 entries.push({ rows: [{acc: capitalAccName, dr: tempLedger[acc]}, {acc: acc, cr: tempLedger[acc]}] });
            }
        });

        return entries;
    }, [closingEntries, allAccounts, transactions, adjustments, beginningBalances, isSubsequentYear]);


    // Helper to format date
    const formatDate = (dateStr, isFirst) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr; 
        
        if (isFirst) {
            return d.toLocaleString('default', { month: 'short', day: 'numeric' });
        } else {
            return d.getDate().toString();
        }
    };

    return html`
        <div className="mb-4 border rounded-lg shadow-sm bg-blue-50 overflow-hidden no-print h-full flex flex-col">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 cursor-pointer flex justify-between items-center flex-shrink-0" onClick=${()=>setExpanded(!expanded)}>
                <span><${Book} size=${16} className="inline mr-2"/>Source: General Ledger (Post-Closing)</span>
            </div>
            ${expanded && html`
                <div className="p-4 overflow-y-auto custom-scrollbar flex-1 flex flex-col gap-6 bg-gray-50">
                    ${allAccounts.map(acc => {
                        const rowsL = [];
                        const rowsR = [];
                        
                        // Determine Year
                        const contextYear = transactions && transactions.length > 0 
                            ? new Date(transactions[0].date).getFullYear() 
                            : new Date().getFullYear();

                        // Add Year Row (First Row)
                        rowsL.push({ isYear: true, displayDate: contextYear, part: '', pr: '', amount: null });
                        rowsR.push({ isYear: true, displayDate: contextYear, part: '', pr: '', amount: null });

                        // 1. Beginning Balances
                        if (isSubsequentYear && beginningBalances && beginningBalances.balances[acc]) {
                            const b = beginningBalances.balances[acc];
                            const bbDate = `${contextYear}-01-01`;
                            if (b.dr > 0) rowsL.push({ rawDate: bbDate, part: 'BB', pr: '', amount: b.dr });
                            if (b.cr > 0) rowsR.push({ rawDate: bbDate, part: 'BB', pr: '', amount: b.cr });
                        }
                        
                        // 2. Transactions
                        if (transactions) {
                            transactions.forEach(t => {
                                t.debits.forEach(d => { if(d.account === acc) rowsL.push({ rawDate: t.date, part: 'GJ', pr: '1', amount: d.amount }); });
                                t.credits.forEach(c => { if(c.account === acc) rowsR.push({ rawDate: t.date, part: 'GJ', pr: '1', amount: c.amount }); });
                            });
                        }

                        // 3. Adjusting Entries (Step 7)
                        if (adjustments) {
                            adjustments.forEach(adj => {
                                const adjDate = `${contextYear}-12-31`;
                                if (adj.drAcc === acc) rowsL.push({ rawDate: adjDate, part: 'Adj', pr: 'J2', amount: adj.amount });
                                if (adj.crAcc === acc) rowsR.push({ rawDate: adjDate, part: 'Adj', pr: 'J2', amount: adj.amount });
                            });
                        }

                        // 4. Closing Entries (Step 8 / Computed)
                        if (computedClosingEntries) {
                            computedClosingEntries.forEach(block => {
                                if (block.rows) {
                                    block.rows.forEach(row => {
                                        if (row.acc && row.acc.trim() === acc) {
                                            const dr = Number(row.dr) || 0;
                                            const cr = Number(row.cr) || 0;
                                            const closDate = `${contextYear}-12-31`;
                                            if (dr > 0) rowsL.push({ rawDate: closDate, part: 'Clos', pr: 'J3', amount: dr });
                                            if (cr > 0) rowsR.push({ rawDate: closDate, part: 'Clos', pr: 'J3', amount: cr });
                                        }
                                    });
                                }
                            });
                        }

                        // Filter out accounts with NO activity in rows (except Year row)
                        // If an account has activity (even if it closes to zero), we show it.
                        // rowsL/rowsR always have at least 1 row (Year). If length > 1, there is data.
                        if (rowsL.length <= 1 && rowsR.length <= 1) return null;

                        const totalDr = rowsL.reduce((sum, r) => sum + (r.amount || 0), 0);
                        const totalCr = rowsR.reduce((sum, r) => sum + (r.amount || 0), 0);
                        const net = totalDr - totalCr;
                        const balance = Math.abs(net);
                        const maxCount = Math.max(rowsL.length, rowsR.length, 4);
                        const displayRows = Array.from({ length: maxCount }).map((_, i) => i);

                        return html`
                            <div key=${acc} className="border-y-2 border-gray-800 bg-white shadow-md">
                                <div className="border-b-2 border-gray-800 p-2 bg-gray-100 font-bold text-center text-lg text-gray-800">${acc}</div>
                                <div className="flex">
                                    <div className="flex-1 border-r-2 border-gray-800">
                                        <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">DEBIT</div>
                                        <div className="flex text-xs font-bold border-b border-gray-400">
                                            <div className="w-14 border-r p-1 text-center">Date</div>
                                            <div className="flex-1 border-r p-1 text-center">Particulars</div>
                                            <div className="w-8 border-r p-1 text-center">PR</div>
                                            <div className="w-16 p-1 text-center">Amount</div>
                                        </div>
                                        ${displayRows.map(i => {
                                            const r = rowsL[i] || {};
                                            let dateText = '';
                                            if (r.isYear) {
                                                dateText = r.displayDate;
                                            } else if (r.rawDate) {
                                                const isFirstDataRow = i === 1;
                                                const prevRow = rowsL[i-1];
                                                let isMonthChange = false;
                                                if (i > 1 && prevRow && prevRow.rawDate && r.rawDate) {
                                                    const d1 = new Date(prevRow.rawDate);
                                                    const d2 = new Date(r.rawDate);
                                                    if (d1.getMonth() !== d2.getMonth()) isMonthChange = true;
                                                }
                                                dateText = formatDate(r.rawDate, isFirstDataRow || isMonthChange);
                                            }

                                            return html`<div key=${i} className="flex text-xs border-b border-gray-200 h-6 items-center px-1">
                                                <div className="w-14 text-center text-gray-500 border-r mr-1 font-medium ${r.isYear ? 'font-bold text-black' : ''}">${dateText}</div>
                                                <div className="flex-1 border-r mr-1">${r.part||''}</div>
                                                <div className="w-8 border-r text-center mr-1">${r.pr||''}</div>
                                                <div className="w-16 text-right">${r.amount ? r.amount.toLocaleString() : ''}</div>
                                            </div>`;
                                        })}
                                        <div className="border-t border-gray-800 p-1 text-right text-xs font-bold">${totalDr.toLocaleString()}</div>
                                    </div>
                                    
                                    <div className="flex-1">
                                        <div className="text-center font-bold border-b border-gray-400 bg-gray-50 text-xs py-1">CREDIT</div>
                                        <div className="flex text-xs font-bold border-b border-gray-400">
                                            <div className="w-14 border-r p-1 text-center">Date</div>
                                            <div className="flex-1 border-r p-1 text-center">Particulars</div>
                                            <div className="w-8 border-r p-1 text-center">PR</div>
                                            <div className="w-16 p-1 text-center">Amount</div>
                                        </div>
                                        ${displayRows.map(i => {
                                            const r = rowsR[i] || {};
                                            let dateText = '';
                                            if (r.isYear) {
                                                dateText = r.displayDate;
                                            } else if (r.rawDate) {
                                                const isFirstDataRow = i === 1;
                                                const prevRow = rowsR[i-1];
                                                let isMonthChange = false;
                                                if (i > 1 && prevRow && prevRow.rawDate && r.rawDate) {
                                                    const d1 = new Date(prevRow.rawDate);
                                                    const d2 = new Date(r.rawDate);
                                                    if (d1.getMonth() !== d2.getMonth()) isMonthChange = true;
                                                }
                                                dateText = formatDate(r.rawDate, isFirstDataRow || isMonthChange);
                                            }

                                            return html`<div key=${i} className="flex text-xs border-b border-gray-200 h-6 items-center px-1">
                                                <div className="w-14 text-center text-gray-500 border-r mr-1 font-medium ${r.isYear ? 'font-bold text-black' : ''}">${dateText}</div>
                                                <div className="flex-1 border-r mr-1">${r.part||''}</div>
                                                <div className="w-8 border-r text-center mr-1">${r.pr||''}</div>
                                                <div className="w-16 text-right">${r.amount ? r.amount.toLocaleString() : ''}</div>
                                            </div>`;
                                        })}
                                        <div className="border-t border-gray-800 p-1 text-right text-xs font-bold">${totalCr.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div className="bg-yellow-50 p-2 text-center border-t border-gray-300 text-sm font-bold text-gray-700">
                                    Balance: <span className="text-blue-700 ml-2 text-base">${balance === 0 ? '-' : balance.toLocaleString()}</span>
                                </div>
                            </div>
                        `;
                    })}
                </div>
            `}
        </div>
    `;
};

const TrialBalanceForm = ({ data, onChange, showFeedback, isReadOnly, validationResult }) => {
    const rows = data.rows || Array(15).fill({ account: '', dr: '', cr: '' });
    const header = data.header || { company: '', doc: '', date: '' };
    const totals = data.totals || { dr: '', cr: '' };
    const fb = validationResult?.feedback || { header: {}, rows: [], totals: {} };

    const updateHeader = (field, val) => {
        onChange('header', { ...header, [field]: val });
    };

    const updateRow = (idx, field, val) => {
        const newRows = [...rows];
        newRows[idx] = { ...newRows[idx], [field]: val };
        onChange('rows', newRows);
    };
    
    const updateTotals = (field, val) => {
        onChange('totals', { ...totals, [field]: val });
    };

    const addRow = () => {
        onChange('rows', [...rows, { account: '', dr: '', cr: '' }]);
    };

    const deleteRow = (idx) => {
        if (rows.length <= 1) return;
        const newRows = rows.filter((_, i) => i !== idx);
        onChange('rows', newRows);
    };

    const getHeaderStyle = (isValid) => {
        if (!showFeedback) return 'border-black';
        return isValid ? 'border-green-600 bg-green-50 text-green-700' : 'border-red-600 bg-red-50';
    };

    return html`
        <div className="flex flex-col h-full">
            
            <div className="flex flex-col gap-2 mb-6 items-center px-8 mt-2">
                <div className="w-3/4 flex items-center justify-center relative">
                    <input type="text" placeholder="[StudentLastName] Accounting Services" className=${`text-center font-bold text-lg border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.company)}`} value=${header.company} onChange=${(e) => updateHeader('company', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.company} /></div>
                </div>
                <div className="w-1/2 flex items-center justify-center relative">
                    <input type="text" placeholder="Post-Closing Trial Balance" className=${`text-center font-bold text-md border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.doc)}`} value=${header.doc} onChange=${(e) => updateHeader('doc', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.doc} /></div>
                </div>
                <div className="w-1/3 flex items-center justify-center relative">
                    <input type="text" placeholder="Month DD, YYYY" className=${`text-center text-sm border-b-2 outline-none w-full transition-colors ${getHeaderStyle(fb.header.date)}`} value=${header.date} onChange=${(e) => updateHeader('date', e.target.value)} disabled=${isReadOnly}/>
                    <div className="absolute -right-6"><${StatusIcon} show=${showFeedback} correct=${fb.header.date} /></div>
                </div>
            </div>

            <div className="flex-1 overflow-auto px-2">
                <table className="w-full text-sm border-collapse">
                    <thead className="bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th className="p-2 border text-left">Account Title</th>
                            <th className="p-2 border w-28 text-right">Debit</th>
                            <th className="p-2 border w-28 text-right">Credit</th>
                            <th className="p-2 border w-8"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map((row, idx) => {
                            const rowFB = fb.rows[idx] || {};
                            const hasAccInput = row.account && row.account.trim().length > 0;
                            
                            return html`
                            <tr key=${idx} className="border-b hover:bg-gray-50">
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="text" className="w-full outline-none bg-transparent" value=${row.account} onChange=${(e)=>updateRow(idx, 'account', e.target.value)} disabled=${isReadOnly} />
                                        ${hasAccInput && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.acc} />`}
                                    </div>
                                </td>
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="number" className="w-full text-right outline-none bg-transparent" value=${row.dr} onChange=${(e)=>updateRow(idx, 'dr', e.target.value)} disabled=${isReadOnly} />
                                        ${Number(row.dr) > 0 && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.amt} />`}
                                    </div>
                                </td>
                                <td className="p-1 border relative">
                                    <div className="flex items-center">
                                        <input type="number" className="w-full text-right outline-none bg-transparent" value=${row.cr} onChange=${(e)=>updateRow(idx, 'cr', e.target.value)} disabled=${isReadOnly} />
                                        ${Number(row.cr) > 0 && html`<${StatusIcon} show=${showFeedback} correct=${rowFB.amt} />`}
                                    </div>
                                </td>
                                <td className="p-1 border text-center">
                                    ${!isReadOnly && html`<button onClick=${() => deleteRow(idx)} className="text-gray-400 hover:text-red-600"><${Trash2} size=${14}/></button>`}
                                </td>
                            </tr>
                        `})} 
                    </tbody>
                    <tfoot className="bg-gray-100 font-bold sticky bottom-0 border-t-2 border-gray-300">
                        <tr>
                            <td className="p-2 text-right uppercase text-xs text-gray-600">Total</td>
                            <td className="p-1 border-double border-gray-400 relative">
                                <div className="flex items-center justify-end">
                                    <input 
                                        type="number" 
                                        className=${`w-full text-right outline-none bg-transparent font-bold ${showFeedback ? (fb.totals.dr ? 'text-green-700' : 'text-red-600') : ''}`} 
                                        value=${totals.dr} 
                                        onChange=${(e) => updateTotals('dr', e.target.value)}
                                        disabled=${isReadOnly}
                                        placeholder="0"
                                    />
                                    ${(totals.dr !== '' && Number(totals.dr) > 0) && html`<${StatusIcon} show=${showFeedback} correct=${fb.totals.dr} />`}
                                </div>
                            </td>
                            <td className="p-1 border-double border-gray-400 relative">
                                <div className="flex items-center justify-end">
                                    <input 
                                        type="number" 
                                        className=${`w-full text-right outline-none bg-transparent font-bold ${showFeedback ? (fb.totals.cr ? 'text-green-700' : 'text-red-600') : ''}`} 
                                        value=${totals.cr} 
                                        onChange=${(e) => updateTotals('cr', e.target.value)}
                                        disabled=${isReadOnly}
                                        placeholder="0"
                                    />
                                    ${(totals.cr !== '' && Number(totals.cr) > 0) && html`<${StatusIcon} show=${showFeedback} correct=${fb.totals.cr} />`}
                                </div>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
             ${!isReadOnly && html`<button onClick=${addRow} className="mt-2 text-xs flex items-center gap-1 text-blue-600 hover:underline p-2"><${Plus} size=${12}/> Add Account Row</button>`}
        </div>
    `;
};

// --- MAIN COMPONENT ---
function Step09PostClosingTB({ activityData, data, onChange, showFeedback, isReadOnly }) {
    
    // DRY Validation Calculation
    const validationResult = useMemo(() => {
        if (!showFeedback && !isReadOnly) return null;
        return validateStep09(data, activityData);
    }, [data, activityData, showFeedback, isReadOnly]);

    const result = validationResult || {};

    const handleChange = (key, val) => {
        onChange(key, val);
    };

    return html`
        <div className="flex flex-col h-[calc(100vh-140px)] min-h-[600px]">
            ${(showFeedback || isReadOnly) && validationResult && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${result.score || 0} of ${result.maxScore || 0} - (${result.letterGrade || 'IR'})</span>
                </div>
            `}

            <div className="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                <div className="flex-1 lg:w-1/2 h-full min-h-0">
                     <${LedgerSourceView} 
                        transactions=${activityData.transactions} 
                        validAccounts=${activityData.validAccounts} 
                        beginningBalances=${activityData.beginningBalances} 
                        isSubsequentYear=${activityData.config.isSubsequentYear} 
                        adjustments=${activityData.adjustments}
                        closingEntries=${data.closingJournal /* Passed from parent or undefined */} 
                     /> 
                </div>
                <div className="flex-1 lg:w-1/2 border rounded bg-white flex flex-col shadow-sm overflow-hidden min-h-0">
                    <div className="bg-green-100 p-2 font-bold text-green-900 flex justify-between items-center">
                        <span><${Table} size=${16} className="inline mr-2"/>Post-Closing Trial Balance</span>
                    </div>
                    <div className="p-0 overflow-y-auto custom-scrollbar flex-1 bg-white">
                         <${TrialBalanceForm} 
                            data=${data} 
                            onChange=${handleChange} 
                            showFeedback=${showFeedback} 
                            isReadOnly=${isReadOnly} 
                            validationResult=${validationResult}
                        />
                    </div>
                </div>
            </div>
        </div>
    `;
}


// --- Step10ReversingEntries.js ---





const html = htm.bind(React.createElement);

// --- INTERNAL COMPONENTS ---

const StatusIcon = ({ correct, show }) => {
    if (!show) return null;
    return correct 
        ? html`<${Check} size=${14} className="text-green-600 inline ml-1" />` 
        : html`<${X} size=${14} className="text-red-600 inline ml-1" />`;
};

// --- VALIDATION HELPER (Exported for App.js) ---
const validateReversingEntry = (entry, adj, config, isFirst) => {
    // 1. Safe Inputs & Normalization
    const type = (adj.type || '').toLowerCase();
    const desc = (adj.desc || '').toLowerCase();
    const drAcc = (adj.drAcc || '').toLowerCase(); // Adjustment Debit Account
    const crAcc = (adj.crAcc || '').toLowerCase(); // Adjustment Credit Account
    
    // 2. Determine if Reversable (STRICT LOGIC)
    let shouldReverse = false;

    // --- CHECK 1: ACCRUALS ---
    const isAccruedExpense = crAcc.includes('payable') && !crAcc.includes('accounts payable') && !crAcc.includes('notes payable');
    const isAccruedIncome = drAcc.includes('receivable') && !drAcc.includes('accounts receivable') && !drAcc.includes('notes receivable');

    if (type.includes('accrued') || desc.includes('accrued') || isAccruedExpense || isAccruedIncome) {
        shouldReverse = true;
    }

    // --- CHECK 2: DEFERRALS (EXPENSE METHOD) ---
    if (config.deferredExpenseMethod === 'Expense') {
        const isAssetAdjustment = drAcc.includes('prepaid') || drAcc.includes('supplies');
        if (isAssetAdjustment) {
            shouldReverse = true;
        }
    }

    // --- CHECK 3: DEFERRALS (INCOME METHOD) ---
    if (config.deferredIncomeMethod === 'Income') {
        const isLiabilityAdjustment = crAcc.includes('unearned') || crAcc.includes('advance');
        if (isLiabilityAdjustment) {
            shouldReverse = true;
        }
    }

    // --- VALIDATION OF USER INPUT ---

    let isDrCorrect = false;
    let isCrCorrect = false;
    let isDescCorrect = false;
    let isDateCorrect = false;
    let isYearCorrect = true;

    if (shouldReverse) {
        // [SCENARIO A] REVERSING ENTRY IS REQUIRED
        
        const hasData = entry.drAcc || entry.crAcc || entry.drAmt;
        if (!hasData) {
            return { isEntryCorrect: false, shouldReverse: true, debug: 'Missing Required Entry' };
        }

        // 1. Validate Accounts (Must be Swapped vs Adjustment)
        const userDrAcc = (entry.drAcc || '').toLowerCase().trim();
        const userCrAcc = (entry.crAcc || '').toLowerCase().trim();
        
        // 2. Validate Amounts
        const userDrAmt = Number(entry.drAmt);
        const userCrAmt = Number(entry.crAmt);

        isDrCorrect = userDrAcc === crAcc && Math.abs(userDrAmt - adj.amount) <= 1;
        isCrCorrect = userCrAcc === drAcc && Math.abs(userCrAmt - adj.amount) <= 1;
        
        // 3. Description (Must contain 'reversing')
        isDescCorrect = (entry.desc || '').toLowerCase().includes('reversing');
        
        // 4. Date Logic (Jan 1)
        const d = (entry.date || '').toLowerCase().trim();
        const validDates = ['jan 1', 'jan 01', 'jan. 1', 'jan. 01', '1/1', '01/01', '1', '01'];
        if (isFirst) {
            isDateCorrect = validDates.some(vd => d.includes(vd)) || d === '1'; 
            isYearCorrect = !!entry.year; 
        } else {
            isDateCorrect = validDates.some(vd => d.includes(vd)) || d === '1';
            isYearCorrect = !entry.year; 
        }

    } else {
        // [SCENARIO B] NO ENTRY REQUIRED
        const hasData = entry.drAcc || entry.drAmt || entry.crAcc || entry.crAmt;
        
        isDrCorrect = !hasData;
        isCrCorrect = !hasData;
        isDescCorrect = !entry.desc;
        isDateCorrect = !entry.date;
        isYearCorrect = !entry.year;
    }

    const isEntryCorrect = isDrCorrect && isCrCorrect && isDescCorrect && isDateCorrect && isYearCorrect;
    return { isDrCorrect, isCrCorrect, isDescCorrect, isDateCorrect, isYearCorrect, isEntryCorrect, shouldReverse };
};

// --- LEFT PANEL: HISTORICAL JOURNAL VIEW ---
const HistoricalJournalView = ({ entries }) => {
    const [expanded, setExpanded] = useState(true);
    const firstDate = entries.length > 0 ? new Date(entries[0].rawDate || Date.now()) : new Date();
    const year = firstDate.getFullYear();

    return html`
        <div className="mb-4 border rounded bg-white overflow-hidden shadow-sm flex flex-col h-full">
            <div className="bg-gray-100 p-2 font-bold text-gray-700 cursor-pointer flex justify-between items-center flex-shrink-0" onClick=${()=>setExpanded(!expanded)}>
                <div className="flex items-center">
                    <${Book} size=${16} className="inline mr-2 w-4 h-4"/>
                    <span>Historical General Journal (Dec 31)</span>
                </div>
                <div className="flex items-center gap-2 text-xs font-normal">
                    ${expanded ? html`<${ChevronDown} size=${16} className="w-4 h-4"/>` : html`<${ChevronRight} size=${16} className="w-4 h-4"/>`}
                </div>
            </div>
            ${expanded && html`
                <div className="flex flex-col flex-1 overflow-hidden border-t border-gray-200">
                    <div className="flex bg-gray-50 text-gray-700 border-b border-gray-300 font-bold text-xs text-center flex-shrink-0">
                        <div className="w-16 border-r p-2 flex-shrink-0">Date</div>
                        <div className="flex-1 border-r p-2 text-left">Account Titles and Explanation</div>
                        <div className="w-16 border-r p-2 flex-shrink-0">P.R.</div>
                        <div className="w-20 border-r p-2 text-right flex-shrink-0">Debit</div>
                        <div className="w-20 p-2 text-right flex-shrink-0">Credit</div>
                    </div>
                    <div className="overflow-y-auto flex-1 bg-white custom-scrollbar">
                        <div className="flex border-b border-gray-100 text-xs h-6 items-center">
                            <div className="w-16 border-r text-center font-bold text-gray-800 flex-shrink-0 bg-gray-50">${year}</div>
                            <div className="flex-1 border-r"></div>
                            <div className="w-16 border-r"></div>
                            <div className="w-20 border-r"></div>
                            <div className="w-20"></div>
                        </div>

                        ${entries.map((t, tIdx) => {
                            const isFirst = tIdx === 0;
                            const dateParts = t.date.split(' '); 
                            const dateDisplay = isFirst ? t.date : (dateParts[1] || t.date); 
                            
                            return html`
                                <React.Fragment key=${t.id + tIdx}>
                                    ${t.rows.map((row, i) => html`
                                        <div key=${i} className="flex text-xs h-6 items-center hover:bg-gray-50">
                                            <div className="w-16 border-r text-center flex-shrink-0 text-gray-600 border-gray-100">
                                                ${i === 0 ? dateDisplay : ''}
                                            </div>
                                            <div className="flex-1 border-r border-gray-100 pl-1 font-medium text-gray-800 truncate" title=${row.account}>
                                                ${row.type === 'cr' ? html`<span className="ml-8">${row.account}</span>` : row.account}
                                            </div>
                                            <div className="w-16 border-r border-gray-100 text-center flex justify-center items-center flex-shrink-0 text-gray-400">
                                                ${t.type === 'GJ' ? '1' : t.type === 'ADJ' ? '2' : '3'}
                                            </div>
                                            <div className="w-20 border-r border-gray-100 text-right pr-1 flex-shrink-0 text-gray-800">
                                                ${row.type === 'dr' ? Number(row.amount).toLocaleString() : ''}
                                            </div>
                                            <div className="w-20 text-right pr-1 flex-shrink-0 text-gray-800 border-gray-100 border-r-0">
                                                ${row.type === 'cr' ? Number(row.amount).toLocaleString() : ''}
                                            </div>
                                        </div>
                                    `)}
                                    <div className="flex text-xs h-6 items-center text-gray-500 italic mb-2">
                                        <div className="w-16 border-r border-gray-100 flex-shrink-0"></div>
                                        <div className="flex-1 border-r border-gray-100 pl-12 truncate" title=${t.description}>${t.description}</div>
                                        <div className="w-16 border-r border-gray-100 flex-shrink-0"></div>
                                        <div className="w-20 border-r border-gray-100 flex-shrink-0"></div>
                                        <div className="w-20 flex-shrink-0"></div>
                                    </div>
                                    <div className="flex h-6 border-b border-gray-100">
                                        <div className="w-16 border-r border-gray-100"></div>
                                        <div className="flex-1 border-r border-gray-100"></div>
                                        <div className="w-16 border-r border-gray-100"></div>
                                        <div className="w-20 border-r border-gray-100"></div>
                                        <div className="w-20"></div>
                                    </div>
                                </React.Fragment>
                            `;
                        })}
                        <div className="h-8"></div>
                    </div>
                </div>
            `}
        </div>
    `;
};

// --- RIGHT PANEL: REVERSING ENTRY FORM ---
const ReversingEntryForm = ({ adjustments, data, onChange, isReadOnly, showFeedback, activityData }) => {
    
    const handleChange = (adjId, field, val) => {
        const current = data[adjId] || {};
        onChange(adjId, { ...current, [field]: val });
    };

    return html`
        <div className="border rounded bg-white shadow-sm flex flex-col flex-1 min-h-0 h-full">
            <div className="bg-blue-100 p-2 font-bold text-blue-900 border-b flex items-center justify-between">
                <div className="flex items-center">
                    <${Book} size=${16} className="inline mr-2 w-4 h-4"/>
                    Journalize Reversing Entries (Jan 01)
                </div>
            </div>
            
            <div className="bg-yellow-50 p-2 text-xs border-b border-yellow-200 text-yellow-800 flex items-start gap-2">
                <${AlertCircle} size=${14} className="mt-0.5 flex-shrink-0"/>
                <span>
                    <strong>Instruction:</strong> Review the Adjusting Entries. If an adjustment requires a reversing entry (Accruals or Deferrals under Expense/Income method), record it below. If no entry is needed, leave the fields blank.
                </span>
            </div>
            <div className="overflow-y-auto p-2 flex-1 custom-scrollbar">
                
                <div className="flex bg-gray-50 text-gray-700 border-b border-gray-300 font-bold text-xs text-center flex-shrink-0 mb-2">
                    <div className="w-16 border-r p-2 flex-shrink-0">Date</div>
                    <div className="flex-1 border-r p-2 text-left">Account Titles and Explanation</div>
                    <div className="w-16 border-r p-2 flex-shrink-0">P.R.</div>
                    <div className="w-20 border-r p-2 text-right flex-shrink-0">Debit</div>
                    <div className="w-20 p-2 text-right flex-shrink-0">Credit</div>
                </div>

                ${adjustments.map((adj, idx) => {
                    const entry = data[adj.id] || {};
                    const isFirst = idx === 0;
                    
                    const { 
                        isDrCorrect, isCrCorrect, isDescCorrect, isDateCorrect, isYearCorrect, shouldReverse 
                    } = validateReversingEntry(entry, adj, activityData.config, isFirst);

                    return html`
                        <div key=${adj.id} className="mb-4 rounded overflow-hidden">
                            <div className="bg-gray-100 px-2 py-1 text-[10px] font-bold text-gray-500 border-b border-gray-200 flex justify-between">
                                <span>Ref: AJE #${idx + 1} (${adj.desc})</span>
                                <span>${shouldReverse ? "Reversing Required" : "No Entry Needed"}</span>
                            </div>

                            ${isFirst && html`
                                <div className="flex border-b border-gray-100 h-7">
                                    <div className="w-16 border-r border-gray-200 bg-white p-0 relative">
                                        <input type="text" className=${`w-full h-full text-center font-bold text-xs outline-none ${showFeedback && !isYearCorrect ? 'bg-red-50' : ''}`} placeholder="YYYY" value=${entry.year || ''} onChange=${(e) => handleChange(adj.id, 'year', e.target.value)} disabled=${isReadOnly}/>
                                    </div>
                                    <div className="flex-1 border-r border-gray-200"></div>
                                    <div className="w-16 border-r border-gray-200"></div>
                                    <div className="w-20 border-r border-gray-200"></div>
                                    <div className="w-20"></div>
                                </div>
                            `}
                            
                            <div className="flex border-b border-gray-100 h-7">
                                <div className="w-16 border-r border-gray-200 p-0 relative">
                                    <input type="text" className=${`w-full h-full text-center text-xs outline-none ${showFeedback && !isDateCorrect ? 'bg-red-50' : ''}`} placeholder=${isFirst ? "Mmm d" : "d"} value=${entry.date || ''} onChange=${(e) => handleChange(adj.id, 'date', e.target.value)} disabled=${isReadOnly}/>
                                </div>
                                <div className="flex-1 p-0 border-r border-gray-200 relative">
                                    <input type="text" className=${`w-full h-full p-1 text-xs outline-none ${showFeedback && !isDrCorrect ? 'bg-red-50' : ''}`} placeholder="Debit Account" value=${entry.drAcc || ''} onChange=${(e) => handleChange(adj.id, 'drAcc', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute right-1 top-1"><${StatusIcon} show=${showFeedback} correct=${isDrCorrect} /></div>
                                </div>
                                <div className="w-16 border-r border-gray-200"></div>
                                <div className="w-20 p-0 border-r border-gray-200 relative">
                                    <input type="number" className=${`w-full h-full p-1 text-right text-xs outline-none ${showFeedback && !isDrCorrect ? 'bg-red-50' : ''}`} placeholder="Debit" value=${entry.drAmt || ''} onChange=${(e) => handleChange(adj.id, 'drAmt', e.target.value)} disabled=${isReadOnly}/>
                                </div>
                                <div className="w-20 p-1 bg-gray-50"></div>
                            </div>

                            <div className="flex border-b border-gray-100 h-7">
                                <div className="w-16 border-r border-gray-200 bg-white"></div>
                                <div className="flex-1 p-0 border-r border-gray-200 relative pl-8">
                                    <input type="text" className=${`w-full h-full p-1 text-xs outline-none ${showFeedback && !isCrCorrect ? 'bg-red-50' : ''}`} placeholder="Credit Account" value=${entry.crAcc || ''} onChange=${(e) => handleChange(adj.id, 'crAcc', e.target.value)} disabled=${isReadOnly}/>
                                    <div className="absolute right-1 top-1"><${StatusIcon} show=${showFeedback} correct=${isCrCorrect} /></div>
                                </div>
                                <div className="w-16 border-r border-gray-200"></div>
                                <div className="w-20 p-1 bg-gray-50 border-r border-gray-200"></div>
                                <div className="w-20 p-0 relative">
                                    <input type="number" className=${`w-full h-full p-1 text-right text-xs outline-none ${showFeedback && !isCrCorrect ? 'bg-red-50' : ''}`} placeholder="Credit" value=${entry.crAmt || ''} onChange=${(e) => handleChange(adj.id, 'crAmt', e.target.value)} disabled=${isReadOnly}/>
                                </div>
                            </div>

                            <div className="flex border-b border-gray-100 h-7">
                                <div className="w-16 border-r border-gray-200 bg-white"></div>
                                <div className="flex-1 p-0 border-r border-gray-200 relative pl-12">
                                    <input type="text" className=${`w-full h-full p-1 text-xs italic text-gray-600 outline-none ${showFeedback && !isDescCorrect ? 'bg-red-50' : ''}`} placeholder="Description" value=${entry.desc || ''} onChange=${(e) => handleChange(adj.id, 'desc', e.target.value)} disabled=${isReadOnly}/>
                                </div>
                                <div className="w-16 border-r border-gray-200"></div>
                                <div className="w-20 border-r border-gray-200"></div>
                                <div className="w-20"></div>
                            </div>
                        </div>
                    `;
                })}
            </div>
        </div>
    `;
};

// --- MAIN COMPONENT ---
function Step10ReversingEntries({ activityData, data, onChange, showFeedback, isReadOnly }) {
    
    // DRY Validation Calculation
    const validationResult = useMemo(() => {
        if (!showFeedback && !isReadOnly) return null;
        
        // This relies on the helper function validateStep10 at the bottom of the file
        return validateStep10(data, activityData);
    }, [data, activityData, showFeedback, isReadOnly]);

    // Combine all historical entries for the Left Panel View
    const combinedEntries = useMemo(() => {
        const { transactions, adjustments, validAccounts, beginningBalances, config } = activityData;
        const entries = [];

        // 1. Regular Transactions
        transactions.forEach(t => {
            const dateObj = new Date(t.date);
            const dateStr = `${dateObj.toLocaleString('default', { month: 'short' })} ${dateObj.getDate().toString().padStart(2,'0')}`;
            const rows = [];
            t.debits.forEach(d => rows.push({ account: d.account, amount: d.amount, type: 'dr' }));
            t.credits.forEach(c => rows.push({ account: c.account, amount: c.amount, type: 'cr' }));
            entries.push({ id: `txn-${t.id}`, date: dateStr, rawDate: t.date, description: t.description, type: 'GJ', rows });
        });

        // 2. Adjusting Entries
        adjustments.forEach((adj, i) => {
            const rows = [
                { account: adj.drAcc, amount: adj.amount, type: 'dr' },
                { account: adj.crAcc, amount: adj.amount, type: 'cr' }
            ];
            entries.push({ id: `adj-${i}`, date: 'Dec 31', rawDate: '2023-12-31', description: adj.desc, type: 'ADJ', rows });
        });

        // 3. Closing Entries
        let totalRev = 0, totalExp = 0;
        
        const tempLedger = {};
        const getBal = (acc) => {
             if (tempLedger[acc] !== undefined) return tempLedger[acc];
             let dr = 0, cr = 0;
             if (config.isSubsequentYear && beginningBalances?.balances[acc]) { dr += beginningBalances.balances[acc].dr; cr += beginningBalances.balances[acc].cr; }
             transactions.forEach(t => { t.debits.forEach(d => { if(d.account===acc) dr+=d.amount; }); t.credits.forEach(c => { if(c.account===acc) cr+=c.amount; }); });
             adjustments.forEach(a => { if(a.drAcc===acc) dr+=a.amount; if(a.crAcc===acc) cr+=a.amount; });
             const net = dr - cr;
             tempLedger[acc] = net;
             return net;
        };

        const closingEntries = [];
        
        validAccounts.forEach(acc => {
            const net = getBal(acc);
            const type = getAccountType(acc);
            
            if (type === 'Revenue' && Math.abs(net) > 0) {
                totalRev += Math.abs(net);
                closingEntries.push({ 
                    id: `close-rev-${acc}`, date: 'Dec 31', rawDate: '2023-12-31', 
                    description: 'To close the revenue accounts.', 
                    type: 'CLS', 
                    rows: [{account: acc, amount: Math.abs(net), type: 'dr'}, {account: 'Income Summary', amount: Math.abs(net), type: 'cr'}] 
                });
            }
        });

        validAccounts.forEach(acc => {
            const net = getBal(acc);
            const type = getAccountType(acc);
            if (type === 'Expense' && net > 0) {
                totalExp += net;
                closingEntries.push({ 
                    id: `close-exp-${acc}`, date: 'Dec 31', rawDate: '2023-12-31', 
                    description: 'To close the expense accounts.', 
                    type: 'CLS', 
                    rows: [{account: 'Income Summary', amount: net, type: 'dr'}, {account: acc, amount: net, type: 'cr'}] 
                });
            }
        });

        const ni = totalRev - totalExp;
        const capAcc = validAccounts.find(a => getAccountType(a) === 'Equity' && !a.includes('Drawing') && !a.includes('Dividends'));
        
        if (ni !== 0) {
             const rows = ni >= 0 
                ? [{account: 'Income Summary', amount: ni, type: 'dr'}, {account: capAcc, amount: ni, type: 'cr'}]
                : [{account: capAcc, amount: Math.abs(ni), type: 'dr'}, {account: 'Income Summary', amount: Math.abs(ni), type: 'cr'}];
             
             closingEntries.push({ 
                id: 'close-inc', date: 'Dec 31', rawDate: '2023-12-31', 
                description: 'To close the income summary account.', 
                type: 'CLS', rows 
            });
        }

        validAccounts.forEach(acc => {
            const net = getBal(acc);
            if ((acc.includes('Drawing') || acc.includes('Dividends')) && net > 0) {
                closingEntries.push({ 
                    id: `close-drw-${acc}`, date: 'Dec 31', rawDate: '2023-12-31', 
                    description: 'To close the drawing accounts.', 
                    type: 'CLS', 
                    rows: [{account: capAcc, amount: net, type: 'dr'}, {account: acc, amount: net, type: 'cr'}] 
                });
            }
        });

        return [...entries, ...closingEntries];
    }, [activityData]);

    return html`
        <div className="flex flex-col h-[calc(100vh-140px)] min-h-[600px]">
            ${(showFeedback || isReadOnly) && validationResult && html`
                <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-4 flex justify-between items-center shadow-sm w-full flex-shrink-0">
                    <span className="font-bold flex items-center gap-2"><${AlertCircle} size=${18}/> Validation Results:</span>
                    <span className="font-mono font-bold text-lg">Score: ${validationResult.score || 0} of ${validationResult.maxScore || 0} - (${validationResult.letterGrade || 'IR'})</span>
                </div>
            `}

            <div className="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                <div className="flex-1 lg:w-1/2 h-full min-h-0">
                     <${HistoricalJournalView} entries=${combinedEntries} />
                </div>
                <div className="flex-1 lg:w-1/2 min-h-0 flex flex-col">
                     <${ReversingEntryForm} 
                        adjustments=${activityData.adjustments} 
                        data=${data} 
                        onChange=${onChange} 
                        showFeedback=${showFeedback} 
                        isReadOnly=${isReadOnly}
                        activityData=${activityData}
                     />
                </div>
            </div>
        </div>
    `;
}

// Add to bottom of Step10ReversingEntries.js
const validateStep10 = (data, activityData) => {
    let score = 0;
    let maxScore = 0;
    
    activityData.adjustments.forEach((adj, idx) => {
        const entry = data[adj.id] || {};
        const isFirst = idx === 0;
        const res = validateReversingEntry(entry, adj, activityData.config, isFirst);
        
        maxScore += 1;
        if (res.isEntryCorrect) score += 1;
    });

    return {
        score,
        maxScore,
        isCorrect: score === maxScore,
        letterGrade: getLetterGrade(score, maxScore)
    };
};






const html = htm.bind(React.createElement);

function GenericStep({ stepId, title, onChange, data }) {
    return html`
        <div className="p-4 border rounded bg-white printable-area">
             <div className="mb-4 bg-yellow-50 p-3 border border-yellow-200 rounded text-sm text-yellow-800 flex items-start gap-2"><${AlertCircle} size=${16} className="mt-0.5" /><div><strong>Task:</strong> Complete the forms below based on the generated data.<br/><em>(Prototype Note: Enter any text below for steps 6-10)</em></div></div>
            <textarea className="w-full border p-2 h-32 rounded" value=${data?.text || ''} onChange=${(e) => onChange('text', e.target.value)} />
        </div>
    `;
}
        const root = createRoot(document.getElementById('root'));        root.render(React.createElement(App));    </script></body></html>
