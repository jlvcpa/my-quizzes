<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchandising Summative Test 01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Times New Roman Font Application */
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #f4f6f8;
            /* ENHANCEMENT: Disable Text Selection */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
        
        /* Custom style to lock scrolling */
        .no-scroll {
            overflow: hidden;
            height: 100vh; 
        }

        /* Class for the printed PDF output only */
        .print-layout {
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
            padding: 0.5in;
            background: white;
            position: relative;
            min-height: 100%;
            /* Allow selection in print preview so PDF generation works */
            user-select: text; 
        }
        
        /* PDF-specific styling for correct/incorrect */
        .feedback-correct {
            background-color: #f0fdf4; /* green-50 */
            border: 1px solid #bbf7d0; /* green-200 */
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 5px;
        }
        .feedback-incorrect {
            background-color: #fef2f2; /* red-50 */
            border: 1px solid #fecaca; /* red-200 */
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 5px;
        }

        /* Question Palette Styles */
        .q-dot {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif; /* Keep UI elements legible */
        }
        .q-dot.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .q-dot.answered {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #166534;
        }
        .q-dot.active.answered {
            background-color: #15803d; /* green-700 */
            color: white;
        }
        
        /* Print Specific Utilities */
        .print-rubric {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #000;
        }

        /* Footer Styling */
        .print-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #000;
            width: 100%;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .footer-line-1 {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 10pt;
        }

        .footer-line-2 {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }

        .footer-box {
            border: 1px solid #000;
            padding: 2px 10px;
            font-style: italic;
            font-size: 9pt;
            text-align: center;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ENHANCEMENT: Black Screen Curtain for Copy/Screenshot Protection */
        #black-curtain {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            z-index: 9999;
        }

    </style>
</head>
<body class="min-h-screen antialiased no-scroll relative" oncontextmenu="return false;">

    <div id="black-curtain"></div>

    <div id="security-overlay" class="fixed inset-0 bg-gray-900 z-[60] flex items-center justify-center text-white p-6 text-center">
        <div>
            <h1 class="text-3xl font-bold mb-4 text-red-500">Access Denied</h1>
            <p id="security-msg" class="text-xl">Validating link parameters...</p>
        </div>
    </div>

    <div id="cheat-lockout" class="hidden fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center text-white p-6 text-center">
        <div class="max-w-md w-full">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h1 class="text-3xl font-bold mb-4 text-red-500">Test Paused</h1>
            <p class="text-lg mb-6">Focus lost. Navigation away from the test is monitored.</p>
            
            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                <p class="text-sm text-gray-400">To resume, click the button below <span class="font-bold text-white">3 times</span>.</p>
            </div>

            <button id="btn-unlock" onclick="window.handleUnlockClick()" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-xl shadow-lg transition-transform transform active:scale-95">
                Resume Test (3)
            </button>
        </div>
    </div>

    <div id="timer-bar" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white z-50 px-4 py-2 shadow-md flex justify-between items-center">
        <span class="font-bold font-serif text-lg">TIME REMAINING</span>
        <span id="timer-display" class="font-mono text-2xl font-bold">00:00:00</span>
    </div>

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 pt-16">

        <section id="student-info-section" class="hidden bg-white p-8 rounded-xl shadow-2xl mb-6 border-t-8 border-blue-800 max-w-2xl mx-auto mt-10">
            
            <img src="./shs-adc-logo.png" alt="School Logo" class="mx-auto mb-2 h-20 w-auto" />
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2 text-center font-serif">SUMMATIVE TEST</h2>
            <p class="text-center text-gray-500 mb-8 font-serif italic">Merchandising Business Mastery</p>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="text-blue-800 font-bold mb-3 border-b border-blue-200 pb-1">Attendance Verification</h3>
                    <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                            <input type="text" id="id-number" placeholder="Enter your Student ID" class="w-full p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <input type="hidden" id="attendance-record">
                    </div>
                    <button onclick="window.checkAttendance()" class="mt-3 w-full py-2 bg-blue-600 text-white text-sm font-bold rounded hover:bg-blue-700 transition flex justify-center items-center">
                        Verify ID & Load Data <span id="loading-spinner" class="loader hidden"></span>
                    </button>
                    <p id="firebase-msg" class="text-xs mt-2 text-center min-h-[1rem]"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Class Number</label>
                        <input type="number" id="class-number" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Grade Level & Section</label>
                        <input type="text" id="grade-section" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="full-name" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
                </div>
            </div>

            <button id="btn-start-exam" onclick="window.initializeTest()" class="mt-8 w-full px-4 py-3 bg-gray-400 text-white font-bold text-lg rounded-lg shadow-lg cursor-not-allowed font-serif" disabled>
                Start Examination
            </button>
        </section>

        <div id="main-interface" class="hidden">
            
            <header class="bg-white shadow-lg rounded-xl mb-6 overflow-hidden">
                <div class="bg-blue-900 text-white p-4 flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold font-serif">SUMMATIVE TEST</h1>
                        <p class="text-xs text-blue-200 font-serif" id="student-display-name">Student Name</p>
                    </div>
                    <div class="text-right">
                        <button onclick="window.finishAndPreview()" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-2 px-4 rounded shadow font-serif">
                            Submit & Print Results
                        </button>
                    </div>
                </div>

                <nav class="flex overflow-x-auto bg-gray-50 border-b border-gray-200">
                    <button onclick="window.switchTestPart(1)" id="tab-1" class="flex-1 py-4 px-6 text-sm font-bold text-gray-500 hover:text-blue-800 border-b-4 border-transparent hover:border-blue-300 transition-all whitespace-nowrap font-serif">
                        TEST 1: Adjustments
                    </button>
                    <button onclick="window.switchTestPart(2)" id="tab-2" class="flex-1 py-4 px-6 text-sm font-bold text-gray-500 hover:text-blue-800 border-b-4 border-transparent hover:border-blue-300 transition-all whitespace-nowrap font-serif">
                        TEST 2: Worksheet & FS
                    </button>
                    <button onclick="window.switchTestPart(3)" id="tab-3" class="flex-1 py-4 px-6 text-sm font-bold text-gray-500 hover:text-blue-800 border-b-4 border-transparent hover:border-blue-300 transition-all whitespace-nowrap font-serif">
                        TEST 3: Closing & Reversing
                    </button>
                </nav>
            </header>

            <div class="flex flex-col lg:flex-row gap-6">
                
                <div class="flex-1">
                    <div id="question-card" class="bg-white p-6 rounded-xl shadow-md min-h-[400px] relative">
                        <div id="question-content"></div>
                        
                        <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-100">
                            <button onclick="window.prevQuestion()" id="btn-prev" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 font-medium flex items-center font-serif">
                                ‚Üê Previous
                            </button>
                            <span id="question-counter" class="text-sm text-gray-500 font-mono">1 / 25</span>
                            <button onclick="window.nextQuestion()" id="btn-next" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium flex items-center font-serif">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-64 flex-shrink-0">
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider font-serif">Question Navigator</h3>
                        <div id="question-palette" class="grid grid-cols-5 gap-2">
                            </div>
                        <div class="mt-4 text-xs text-gray-500 flex flex-col gap-1 font-serif">
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full border border-gray-300 mr-2"></span> Unanswered</div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Current</div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-100 border border-green-500 mr-2"></span> Answered</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="print-preview-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-95 z-[70] flex justify-center items-start overflow-y-auto pt-10 pb-10">
        <div class="bg-white w-full max-w-4xl rounded-lg shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-xl font-bold text-gray-800 font-serif">Result Preview</h2>
                <div class="space-x-2" id="preview-actions"></div>
            </div>
            <div id="print-content" class="p-8 overflow-y-auto print-layout">
                </div>
        </div>
    </div>

    <div id="submission-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 z-[80] flex flex-col items-center justify-center text-blue-900">
        <div class="loader" style="width: 50px; height: 50px; border-width: 6px;"></div>
        <p class="mt-4 text-xl font-bold">Submitting Results to Server...</p>
        <p class="text-sm">Please wait. Do not close this window.</p>
    </div>

    <script type="module">
        // üîπ FIREBASE SETUP & LOGIC
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgOsKAZWwExUzupxSNytsfOo9BOppF0ng",
            authDomain: "jlvcpa-quizzes.firebaseapp.com",
            projectId: "jlvcpa-quizzes",
            storageBucket: "jlvcpa-quizzes.appspot.com",
            messagingSenderId: "629158256557",
            appId: "1:629158256557:web:b3d1a424b32e28cd578b24"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // URL PARAMS & SECURITY CHECK
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const attendanceId = urlParams.get('att');
            const expiry = urlParams.get('exp');
            const duration = urlParams.get('dur');
            const overlay = document.getElementById('security-overlay');
            const msg = document.getElementById('security-msg');

            if (!attendanceId || !expiry || !duration) {
                msg.innerText = "Invalid Link: Missing parameters.";
                return; 
            }

            const now = new Date().getTime();
            if (now > parseInt(expiry)) {
                msg.innerText = "This quiz link has expired.";
                return;
            }

            // Set values
            document.getElementById('attendance-record').value = attendanceId;
            window.examDurationMins = parseInt(duration);
            
            // Unlock
            overlay.classList.add('hidden');
            document.getElementById('student-info-section').classList.remove('hidden');
        };

        // Check Attendance against Param ID
        window.checkAttendance = async function() {
            const recordId = document.getElementById('attendance-record').value; // From URL
            const idNumber = document.getElementById('id-number').value.trim();
            const msg = document.getElementById('firebase-msg');
            const spinner = document.getElementById('loading-spinner');

            if (!idNumber) {
                msg.innerHTML = "<span class='text-red-600'>Please enter Student ID.</span>";
                return;
            }

            spinner.classList.remove('hidden');
            msg.innerText = "Checking database...";

            try {
                const docRef = doc(db, "attendance", recordId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const studentsArray = data.students;

                    if (Array.isArray(studentsArray)) {
                        const student = studentsArray.find(s => String(s.Idnumber) === String(idNumber));

                        if (student) {
                            const status = student.status || "";
                            if (status.includes("‚úî") || status.includes("‚úì") || status.includes("‚úîÔ∏è")) {
                                const cn = student.CN || "";
                                const name = student.fullName || "";
                                const section = data.section || ""; 

                                // ---------------------------------------------------------
                                // ENHANCEMENT: DUPLICATE SUBMISSION CHECK
                                // ---------------------------------------------------------
                                const collectionName = `results_S2T1 Summative Test 01_${recordId}`;
                                const docName = `students.${cn}-students.${idNumber}-${name}`;
                                
                                // Check if a result file already exists for this student
                                msg.innerText = "Verifying previous attempts...";
                                const resultSnap = await getDoc(doc(db, collectionName, docName));
                                
                                if (resultSnap.exists()) {
                                     msg.innerHTML = `<span class='text-red-700 font-bold'>‚õî Access Denied: You have already taken this test. No retakes allowed.</span>`;
                                     spinner.classList.add('hidden');
                                     return; // STOP EXECUTION
                                }
                                // ---------------------------------------------------------
                                // END ENHANCEMENT
                                // ---------------------------------------------------------

                                document.getElementById('class-number').value = cn;
                                document.getElementById('full-name').value = name;
                                document.getElementById('grade-section').value = section;
                                
                                // Enable Start Button
                                const btn = document.getElementById('btn-start-exam');
                                btn.disabled = false;
                                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                                btn.classList.add('bg-blue-800', 'hover:bg-blue-900', 'hover:scale-[1.02]');

                                msg.innerHTML = "<span class='text-green-600 font-bold'>‚úì Student Found & Verified!</span>";
                            } else {
                                msg.innerHTML = `<span class='text-red-600 font-bold'>‚ö† Student is marked absent (Status: ${status}). Login denied.</span>`;
                            }
                        } else {
                            msg.innerHTML = "<span class='text-red-600'>ID Number not found in this attendance record.</span>";
                        }
                    } else {
                         msg.innerHTML = "<span class='text-red-600'>Error: 'students' field is not an array.</span>";
                    }
                } else {
                    msg.innerHTML = "<span class='text-red-600'>Attendance Record not found (Invalid Link).</span>";
                }
            } catch (error) {
                console.error("Firebase Error:", error);
                msg.innerHTML = "<span class='text-red-600'>Connection Error. Please try again.</span>";
            } finally {
                spinner.classList.add('hidden');
            }
        };

        // Save to Firebase
        window.saveResultsToFirebase = async function(resultData) {
            const overlay = document.getElementById('submission-overlay');
            overlay.classList.remove('hidden');

            const attendanceId = document.getElementById('attendance-record').value;
            // Collection: results_S2T1 Summative Test 01_ATTENDANCE_ID
            const collectionName = `results_S2T1 Summative Test 01_${attendanceId}`;
            
            const docName = `students.${resultData.studentInfo.cn}-students.${resultData.studentInfo.idNumber}-${resultData.studentInfo.fn}`;

            try {
                // Sanitize data structure before saving
                // Ensure no undefined values exist in the object tree
                const cleanData = JSON.parse(JSON.stringify(resultData, (k, v) => v === undefined ? null : v));
                
                await setDoc(doc(db, collectionName, docName), cleanData);
                // This saves the Collection Name into the 'results_list' so the dashboard can see it
                await setDoc(doc(db, "results_list", collectionName), { 
                    created: new Date().toISOString() 
                            });
                return true;
            } catch (error) {
                console.error("Save Error", error);
                alert("Error saving to server: " + error.message);
                overlay.classList.add('hidden');
                return false;
            }
        };

    </script>

    <script>
        // --- DATA SOURCE ---
        // REVISED QUESTIONS: Abbreviations expanded, complete forms used.
        const allQuestionsPool = [
            { id: 1, type: 'Theory', topic: 'Adjustments', q: 'The expense recognition principle dictates that expenses should be recorded:', options: ['When cash is paid.', 'In the period the benefit or service is received.', 'At the end of the year.', 'When the invoice is received.'], a: 'In the period the benefit or service is received.', s: 'This principle (often called the matching principle) ensures that costs are matched with the revenues they helped generate in the same period.' },
            { id: 197, type: 'Theory', topic: 'Step 10', q: 'If a company *forgets* to make a reversing entry, what is the result?', options: ['The financial statements for the prior year will be wrong.', 'No financial error, but the first transaction of the next period may be recorded incorrectly if the bookkeeper is not careful.', 'The company will report a net loss.', 'The post-closing trial balance will not balance.'], a: 'No financial error, but the first transaction of the next period may be recorded incorrectly if the bookkeeper is not careful.', s: 'It\'s a bookkeeping convenience. The risk is a human error in the next period, not a flaw in the system.' },
        ];
        
        // --- STATE MANAGEMENT ---
        let activeTestParts = { 1: [], 2: [], 3: [] };
        let currentPart = 1;
        let currentQuestionIndex = 0;
        let studentInfo = {};
        let studentAnswers = { 1: {}, 2: {}, 3: {} };
        let timerInterval;
        let timeRemaining; // Seconds
        let testActive = false; // Flag for anti-cheat

        // --- ENHANCEMENT: ANTI-CHEAT VARIABLES ---
        let unlockClicks = 0; // Counts clicks to return focus

        // --- INITIALIZATION LOGIC ---
        window.initializeTest = function() {
            const cn = document.getElementById('class-number').value.trim();
            const fn = document.getElementById('full-name').value.trim();
            const gs = document.getElementById('grade-section').value.trim();
            const idNumber = document.getElementById('id-number').value.trim();

            if(!cn || !fn || !gs) {
                alert("Please complete verification first.");
                return;
            }

            studentInfo = { cn, fn, gs, idNumber };
            document.getElementById('student-display-name').innerText = `${fn} (${gs})`;
            document.getElementById('student-info-section').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.body.classList.remove('no-scroll');
            document.getElementById('timer-bar').classList.remove('hidden');

            generateQuestions();
            renderQuestionUI();
            
            // Set flag
            testActive = true;
            
            // Start Timers and Monitors
            startTimer();
            enableAntiCheat(); 
        }

        // --- ENHANCEMENT: ANTI-CHEAT LOGIC ---
        function enableAntiCheat() {
            // 1. Monitor Tab Switching / Window Minifying
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);

            // 2. Monitor Copy/Paste shortcuts
            document.addEventListener('keydown', handleKeyGuard);
            
            // 3. Monitor Context Menu is already disabled in <body> tag
        }

        function handleVisibilityChange() {
            if (document.hidden && testActive) {
                showLockout();
            }
        }

        function handleWindowBlur() {
            // Only trigger if test is active and we haven't already finished
            if (testActive) {
                showLockout();
            }
        }

        function showLockout() {
            const lockout = document.getElementById('cheat-lockout');
            lockout.classList.remove('hidden');
            // Reset click counter
            unlockClicks = 0;
            updateUnlockButton();
        }

        window.handleUnlockClick = function() {
            unlockClicks++;
            const clicksNeeded = 3 - unlockClicks;
            
            if (clicksNeeded <= 0) {
                // Unlock
                document.getElementById('cheat-lockout').classList.add('hidden');
                unlockClicks = 0;
            } else {
                updateUnlockButton();
            }
        }

        function updateUnlockButton() {
            const btn = document.getElementById('btn-unlock');
            const remaining = 3 - unlockClicks;
            btn.innerText = `Resume Test (${remaining})`;
            
            // Visual feedback animation
            btn.classList.add('scale-95');
            setTimeout(() => btn.classList.remove('scale-95'), 100);
        }

        // Key Guard for Shortcuts
        function handleKeyGuard(e) {
            if (!testActive) return;

            // Detect PrintScreen
            if (e.key === 'PrintScreen') {
                triggerBlackCurtain();
            }

            // Detect Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Shift+S (Snipping tool combos)
            if ((e.ctrlKey || e.metaKey) && 
                (['c', 'v', 'x', 'p', 's'].includes(e.key.toLowerCase()))) {
                e.preventDefault();
                triggerBlackCurtain();
                alert("Security Warning: Copying or Screenshots are not allowed.");
            }
        }

        function triggerBlackCurtain() {
            const curtain = document.getElementById('black-curtain');
            curtain.style.display = 'block';
            
            // Keep it black for 2 seconds then fade out? 
            // Or just flash it. Let's keep it for 500ms to ruin the screenshot
            setTimeout(() => {
                curtain.style.display = 'none';
            }, 1000);
        }

        // -------------------------------------

        function startTimer() {
            timeRemaining = window.examDurationMins * 60;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Time is up! Submitting your answers.");
                    // AUTO SUBMIT UPON EXPIRATION
                    window.finishAndPreview(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const h = Math.floor(timeRemaining / 3600);
            const m = Math.floor((timeRemaining % 3600) / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer-display').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if(timeRemaining < 300) { // Red alert last 5 mins
                document.getElementById('timer-bar').classList.add('animate-pulse');
            }
        }

        function generateQuestions() {
            // Logic matches original provided logic
            const pool1 = allQuestionsPool.filter(q => q.topic === 'Adjustments');
            const pool2 = allQuestionsPool.filter(q => q.topic === 'Worksheet' || q.topic === 'Statements');
            const pool3 = allQuestionsPool.filter(q => ['Step 7', 'Step 8', 'Step 9', 'Step 10'].includes(q.topic));

            activeTestParts[1] = getRandomSubset(pool1, 25);
            activeTestParts[2] = getRandomSubset(pool2, 25);
            activeTestParts[3] = getRandomSubset(pool3, 25);
        }

        function getRandomSubset(arr, size) {
            // If pool is smaller than requested size (for testing), return all
            if (arr.length <= size) return arr;
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, size);
        }

        // --- NAVIGATION LOGIC ---
        window.switchTestPart = function(partNum) {
            currentPart = partNum;
            currentQuestionIndex = 0;
            renderQuestionUI();
        }

        window.nextQuestion = function() {
            if(currentQuestionIndex < activeTestParts[currentPart].length - 1) {
                currentQuestionIndex++;
                renderQuestionUI();
            }
        }

        window.prevQuestion = function() {
            if(currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestionUI();
            }
        }

        window.jumpToQuestion = function(index) {
            currentQuestionIndex = index;
            renderQuestionUI();
        }

        // --- RENDERING LOGIC ---
        function renderQuestionUI() {
            // Update Tabs
            [1, 2, 3].forEach(n => {
                const tab = document.getElementById(`tab-${n}`);
                if(n === currentPart) {
                    tab.classList.add('text-blue-800', 'border-blue-500', 'bg-white');
                    tab.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    tab.classList.remove('text-blue-800', 'border-blue-500', 'bg-white');
                    tab.classList.add('text-gray-500', 'border-transparent');
                }
            });

            const questions = activeTestParts[currentPart];
            if(questions.length === 0) return;

            const q = questions[currentQuestionIndex];
            let optionsHtml = '';
            
            q.options.forEach((opt, i) => {
                const isChecked = studentAnswers[currentPart][q.id] === opt ? 'checked' : '';
                optionsHtml += `
                    <label class="flex items-start p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition-colors ${isChecked ? 'bg-blue-50 border-blue-400' : 'border-gray-200'}">
                        <input type="radio" name="q_${q.id}" value="${opt.replace(/"/g, '&quot;')}" 
                            onchange="saveAnswer(${q.id}, this.value)" class="mt-1 mr-3 text-blue-600" ${isChecked}>
                        <span class="text-gray-700 text-sm md:text-base font-serif">${opt}</span>
                    </label>
                `;
            });

            document.getElementById('question-content').innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded mb-2">
                        ${q.type} - ${q.topic}
                    </span>
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 leading-relaxed font-serif">
                        ${currentQuestionIndex + 1}. ${q.q}
                    </h3>
                </div>
                <div class="space-y-3">
                    ${optionsHtml}
                </div>
            `;

            document.getElementById('btn-prev').disabled = currentQuestionIndex === 0;
            document.getElementById('btn-prev').classList.toggle('opacity-50', currentQuestionIndex === 0);
            
            document.getElementById('btn-next').disabled = currentQuestionIndex === questions.length - 1;
            document.getElementById('btn-next').classList.toggle('opacity-50', currentQuestionIndex === questions.length - 1);

            document.getElementById('question-counter').innerText = `${currentQuestionIndex + 1} / ${questions.length}`;

            // Render Palette
            const palette = document.getElementById('question-palette');
            palette.innerHTML = '';
            questions.forEach((que, idx) => {
                const hasAnswer = studentAnswers[currentPart][que.id] !== undefined;
                const isActive = idx === currentQuestionIndex;
                let classes = 'q-dot';
                if (isActive) classes += ' active';
                if (hasAnswer) classes += ' answered';
                
                palette.innerHTML += `<div class="${classes}" onclick="window.jumpToQuestion(${idx})">${idx + 1}</div>`;
            });
        }

        window.saveAnswer = function(qId, value) {
            studentAnswers[currentPart][qId] = value;
            renderQuestionUI();
        }

        // --- GRADING, SUBMISSION & PRINTING LOGIC ---

        // NEW LOGIC: Submit first, then preview/download
        window.finishAndPreview = async function(isAutoSubmit = false) {
            if(!isAutoSubmit) {
                if(!confirm("Are you sure you want to submit your exam? You cannot change answers after this.")) return;
            }

            // Stop Timer
            clearInterval(timerInterval);
            document.getElementById('timer-bar').classList.add('hidden');

            // DISABLE ANTI-CHEAT (So they can print/pdf without black screens)
            testActive = false;

            // Prepare Data
            const fullData = {
                studentInfo: studentInfo,
                answers: studentAnswers,
                questions: activeTestParts,
                timestamp: new Date().toISOString(),
                scoreData: calculateScores()
            };

            // 1. SUBMIT TO FIREBASE
            const saved = await window.saveResultsToFirebase(fullData);

            if (saved) {
                // 2. GENERATE REPORT AND SHOW MODAL
                generateReportHTML();
                document.getElementById('print-preview-modal').classList.remove('hidden');
                
                // 3. UPDATE BUTTONS (No "Keep Answering", Only "Download PDF")
                const actionsDiv = document.getElementById('preview-actions');
                actionsDiv.innerHTML = `
                    <button onclick="window.downloadPDF()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold font-serif shadow-md">
                        Download PDF Result
                    </button>
                `;
                
                // Hide the overlay (it was shown by saveResultsToFirebase)
                document.getElementById('submission-overlay').classList.add('hidden');
                document.getElementById('main-interface').classList.add('hidden'); // Hide quiz
            } else {
                // If failed, remove overlay so they can try again.
                document.getElementById('submission-overlay').classList.add('hidden');
                // Re-enable manual submit if it wasn't auto (auto failed = stuck, but user can see error and try refreshing or manual)
                if (!isAutoSubmit) {
                     document.getElementById('timer-bar').classList.remove('hidden');
                     startTimer();
                     testActive = true; // Re-enable anti-cheat
                }
            }
        }

        function calculateScores() {
           let scores = {};
           [1,2,3].forEach(part => {
                scores[part] = gradePart(part);
           });
           return scores;
        }

        function gradePart(partNum) {
            const questions = activeTestParts[partNum];
            let score = 0;
            const graded = questions.map(q => {
                const ans = studentAnswers[partNum][q.id];
                // Fix for Firebase error: Ensure ans is not undefined
                const cleanAns = (ans === undefined) ? null : ans;
                
                const isCorrect = ans === q.a;
                if(isCorrect) score++;
                return { ...q, studentAns: cleanAns, isCorrect };
            });
            return { score, total: questions.length, details: graded };
        }

        function getLetterGrade(percentage) {
            if(percentage >= 95) return 'A';
            if(percentage >= 85) return 'P';
            if(percentage >= 75) return 'D';
            return 'IR'; 
        }

        function generateReportHTML() {
            const container = document.getElementById('print-content');
            const date = new Date().toLocaleDateString();
            const timeStr = new Date().toLocaleTimeString();

            let html = `
            <div class="text-center border-b-2 border-gray-800 pb-4 mb-6 font-serif">
              <img src="./shs-adc-logo.png" alt="School Logo" class="mx-auto mb-2 h-20 w-auto" />
              <p class="text-sm mt-1">SY 2025-2026 | 2nd Semester</p>
              <h1 class="text-xl font-bold uppercase mt-2">T2 Summative Test 01</h1>
              <h1 class="text-2xl font-bold uppercase mb-4">FABM 1</h1>

              <div class="flex justify-between text-sm mt-1 text-left border-t border-gray-300 pt-2">
                <div>
                    <p>CN: <b>${studentInfo.cn}</b></p>
                    <p>Name: <b>${studentInfo.fn}</b></p>
                </div>
                <div class="text-right">
                    <p>Section: <b>${studentInfo.gs}</b></p>
                    <p>Date: ${date} ${timeStr}</p>
                </div>
              </div>
            </div>
            `;

            const competencies = {
                1: "To analyze the effects of accrual and deferral transactions to the account balances, and net income or loss.",
                2: "To create the 10-Columns worksheet.",
                3: "To remember the significant purpose and procedures of the closing stage of the accounting cycle."
            };

            const parts = [
                { id: 1, title: "Test 1: Accrual & Deferral Adjustments" },
                { id: 2, title: "Test 2: Worksheet & Financial Statements" },
                { id: 3, title: "Test 3: Closing, Post-Closing & Reversing" }
            ];

            let overallScore = 0;
            let overallTotal = 0;

            parts.forEach(part => {
                const result = gradePart(part.id);
                overallScore += result.score;
                overallTotal += result.total;
                const pct = result.total > 0 ? ((result.score / result.total) * 100).toFixed(1) : 0;
                const partLetterGrade = getLetterGrade(pct);

                html += `
                    <div class="mb-8 break-inside-avoid font-serif">
                        <div class="bg-gray-100 p-3 rounded-t mb-0 flex justify-between items-center border-l-4 border-blue-600">
                            <h2 class="font-bold text-lg">${part.title}</h2>
                            <span class="font-bold text-blue-800">${result.score} / ${result.total} (${pct}%) - Grade: ${partLetterGrade}</span>
                        </div>
                        
                        <div class="print-rubric rounded-b border-t-0">
                            <div class="mb-1"><strong>Competency:</strong> ${competencies[part.id]}</div>
                            <div><strong>Criteria:</strong> 95-100%(A), 85-94.9%(P), 75-84.9%(D), <75%(IR)</div>
                        </div>
                `;

                result.details.forEach((item, idx) => {
                    // LOGIC CHANGE: Handle Unanswered Questions
                    let statusHtml = '';
                    let explanationHtml = '';
                    let statusClass = '';

                    if (!item.studentAns) {
                        // UNANSWERED
                        statusClass = 'bg-gray-100 border border-gray-300 rounded p-2 mt-1';
                        statusHtml = '<span class="text-gray-500 font-bold italic">Student did not answer</span>';
                        explanationHtml = ''; // Hide correct answer and explanation
                    } else if (item.isCorrect) {
                        // CORRECT
                        statusClass = 'feedback-correct';
                        statusHtml = '<span class="text-green-700 font-bold">‚úì Correct</span>';
                        explanationHtml = '';
                        // explanationHtml = `<div class="text-xs mt-1 text-gray-500">${item.s}</div>`;
                    } else {
                        // INCORRECT
                        statusClass = 'feedback-incorrect';
                        statusHtml = '<span class="text-red-700 font-bold">‚úó Incorrect</span>';
                        explanationHtml = `<div class="text-xs mt-1"><b>Correct Answer:</b> ${item.a}<br><b>Explanation:</b> ${item.s}</div>`;
                    }

                    html += `
                        <div class="mb-4 pb-4 border-b border-gray-200 text-sm break-inside-avoid">
                            <p class="font-semibold mb-1">${idx + 1}. ${item.q}</p>
                            <div class="ml-4">
                                <p class="text-gray-600">Student Answer: <span class="font-mono font-bold">${item.studentAns || '(No Answer)'}</span></p>
                                <div class="${statusClass}">
                                    ${statusHtml}
                                    ${explanationHtml}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`; 
            });

            const grandPct = overallTotal > 0 ? ((overallScore / overallTotal) * 100).toFixed(1) : 0;
            const overallLetter = getLetterGrade(grandPct);

            html += `
                <div class="mt-8 p-6 bg-blue-900 text-white rounded-xl text-center break-inside-avoid font-serif">
                    <h3 class="text-xl font-bold uppercase">Overall Performance</h3>
                    <div class="text-4xl font-extrabold mt-2">${overallScore} / ${overallTotal}</div>
                    <div class="text-2xl font-light mt-1">${grandPct}% - Rating: ${overallLetter}</div>
                </div>
            `;

            html += `
                <div class="print-footer">
                    <div class="footer-line-1">
                        <span class="text-left">FABM 1</span>
                        <span class="text-right">Page 1 of 1</span>
                    </div>
                    <div class="footer-line-2">
                        <div class="footer-box">4Cs: Christ-centeredness, Competence, Character, Compassion</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        window.downloadPDF = function() {
            const element = document.getElementById('print-content');
            const filename = `SummativeTest_${studentInfo.cn}_${studentInfo.gs}.pdf`;
            
            const opt = {
                margin: 0.5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: [8.5, 13], orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }

    </script>
</body>
</html>
